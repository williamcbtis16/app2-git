
angular.module("telcelApp", ['ngResource', 'ngCookies', 'localytics.directives']);

angular.module("telcelApp")
    .factory('RecommendedPlan', ['$resource',function($resource){
        var url = '/bin/telcelcom/plan/recommendedplan.:regionId.:reqType.json?bustcache=true';

        return $resource(url, {regionId:"@regionId", reqType:"@reqType"}, {
            getPlan : {method : 'GET', params:{}}
        });
    }]);


angular.module("telcelApp")
    .factory('States', ['$resource',function($resource){
        var url = '/bin/telcelcom/base/states.:path.json';
        return $resource(url, {path:"@path"}, {});
    }]);

angular.module("telcelApp")
    .factory('FamilyPlans', ['$resource',function($resource){
        var url = '/bin/telcelcom/plan/familyplans/recommended.region=:regionId.version=nueva.combo=false.json?bustcache=true';

        return $resource(url, {regionId:"@regionId", reqType:"@reqType"}, {
            getFamilyPlans : {method : 'GET', params:{}}
        });
}]);

/* Filtros */
angular.module("telcelApp").filter('currency', function(){
    return function(price, symbol){
        if (typeof price === 'undefined' || price === ""){
            return "";
        }
        price = parseInt(price);
        price = !angular.isUndefined(price)&&angular.isNumber(price)?price:0.00;
        return symbol + " " + price.toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g, "$1,");
    } ;
}).filter('htmlFilter', function(){
    return function(input) {
        /*var convert = function(convert){
            return $("<span />", { html: convert }).text();
            //return document.createElement("span").innerText;
        };
        var obj = $(input, { html: convert }).text();*/
        var obj = $(input).html().replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace(/&amp;/g,'&');
        return obj;
    };
}).filter('unsafe', function($sce) {
        return function(htmlVal) {
            return $sce.trustAsHtml(htmlVal);
        };
});



angular.module("telcelApp").filter('xkEllipsis', function () {
    /**
    * Cut a text by character numbers
    * Example: {{key | xkEllipsis:20:true}}
    *
    * @param {string} - Text to cut
    * @param {integer} - Maximum text characters
    * @param {boolean} - If true don't break words, defaults false
    * @param {string} - Text to add at the end of the cutted text
    */
     return function (value, max, wordwise, tail) {
       if (!value) return '';

       //Removes extra whitespace
       value = value.replace(/\s+/g, ' ');

       max = parseInt(max, 10);
       if (!max) return value;
       if (value.length <= max) return value;

       value = value.substr(0, max);
       if (wordwise) {
         var lastspace = value.lastIndexOf(' ');
         if (lastspace != -1) {
           value = value.substr(0, lastspace);
         }
       }

       return value + (tail || ' …');
     };
});


angular.module("telcelApp").factory('PlanesService',function(){
    /**
     * 1 DINERO
     * 2 SEGUNDOS
     * 3 MINUTOS
     * 4 INTERNET
     * 5
     * 6 TEXTO (NUMEROS GRATIS)
     * 7 BOOLEAN (REDES INCLUIDAS)
     */
    var definitionObject = {};
    definitionObject.resumenConceptos = function(conceptos){
        var obj = {};
        obj.items = [];
        var count = 0;
        angular.forEach(conceptos, function(concepto){
            if (!angular.isUndefined(concepto.tipoValor)&&concepto.tipoValor.id!=1){
                count++;
                var tipo = "number";
                var  push = true;
                var valor = concepto.valor;
                if (concepto.tipoValor.id==7){
                    tipo = "boolean"
                    push = concepto.valor==="true";
                }else if(checkForDigit(concepto.valor)){
                    tipo = "array";
                    var textVal = concepto.valor,
                    numValue = parseInt(textVal);
                    numValue = numValue.toString();
                    textVal = textVal.replace(numValue, '');
                    valor = [{tipo:"number", valor:numValue},{tipo:"text", valor:textVal}];
                }
                if (push) {
                    obj.items.push({valor: valor,
                        tipo: tipo,
                        descripcion: concepto.descripcionResumen});
                }
            }
        });
        obj.size = count;
        return obj;
    };
    return definitionObject;
});

angular.module("telcelApp").factory("roamingPackagesService", function(){
    return {

        /*
        *
        *   Process the concepts list, getting the image, color and leyend values when the package is
        *   recommended, and removing them from the concepts list.
        *
        */

        processConcepts : function (conceptos, recomendado) {

                            var objconceptos = new Object();
                            objconceptos.conceptos = conceptos;

                            if (recomendado == "1") {

                                if (conceptos != null && conceptos.length > 0) {

                                    var i = 0;
                                    var color = "";
                                    var imagen = "";
                                    var leyenda = "";
                                    var nuevosConceptos = new Array();

                                    while (i < conceptos.length) {

                                        var concepto = conceptos[i];

                                        if (concepto != null) {

                                            switch(concepto.nombre) {
                                                case "Imagen Destacado":
                                                    imagen = concepto.valor;
                                                    break;
                                                case "Leyenda Destacado":
                                                    leyenda = concepto.valor;
                                                    break;
                                                case "Color Destacado":
                                                    color = concepto.valor;
                                                    break;
                                                default:
                                                    nuevosConceptos.push(concepto);
                                                    break;
                                            }
                                        }

                                        i++;
                                    }

                                    objconceptos.imagen = imagen;
                                    objconceptos.color = color;
                                    objconceptos.leyenda = leyenda;
                                    objconceptos.conceptos = nuevosConceptos;

                                }

                            }

                            var lastIndex = objconceptos.conceptos.length - 1;

                            if (lastIndex > 0) {
                                objconceptos.ultimoconcepto = objconceptos.conceptos[lastIndex];
                            }

                            return objconceptos;

                        } //end getValidConcepts() function
    };
});

// Generated by CoffeeScript 1.8.0
(function() {
  var __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  angular.module('localytics.directives', []);

  angular.module('localytics.directives').directive('chosencompare', [
    '$timeout', function($timeout) {
      var CHOSEN_OPTION_WHITELIST, NG_OPTIONS_REGEXP, isEmpty, snakeCase;
      NG_OPTIONS_REGEXP = /^\s*(.*?)(?:\s+as\s+(.*?))?(?:\s+group\s+by\s+(.*))?\s+for\s+(?:([\$\w][\$\w]*)|(?:\(\s*([\$\w][\$\w]*)\s*,\s*([\$\w][\$\w]*)\s*\)))\s+in\s+(.*?)(?:\s+track\s+by\s+(.*?))?$/;
      CHOSEN_OPTION_WHITELIST = ['noResultsText', 'allowSingleDeselect', 'disableSearchThreshold', 'disableSearch', 'enableSplitWordSearch', 'inheritSelectClasses', 'maxSelectedOptions', 'placeholderTextMultiple', 'placeholderTextSingle', 'searchContains', 'singleBackstrokeDelete', 'displayDisabledOptions', 'displaySelectedOptions', 'width'];
      snakeCase = function(input) {
        return input.replace(/[A-Z]/g, function($1) {
          return "_" + ($1.toLowerCase());
        });
      };
      isEmpty = function(value) {
        var key;
        if (angular.isArray(value)) {
          return value.length === 0;
        } else if (angular.isObject(value)) {
          for (key in value) {
            if (value.hasOwnProperty(key)) {
              return false;
            }
          }
        }
        return true;
      };
      return {
        restrict: 'A',
        require: '?ngModel',
        terminal: true,
        link: function(scope, element, attr, ngModel) {
          var chosen, defaultText, disableWithMessage, empty, initOrUpdate, match, options, origRender, removeEmptyMessage, startLoading, stopLoading, valuesExpr, viewWatch;
          element.addClass('localytics-chosen');
          options = scope.$eval(attr.chosen) || {};
          angular.forEach(attr, function(value, key) {
            if (__indexOf.call(CHOSEN_OPTION_WHITELIST, key) >= 0) {
              return options[snakeCase(key)] = scope.$eval(value);
            }
          });
          startLoading = function() {
            return element.addClass('loading').attr('disabled', true).trigger('chosen:updated');
          };
          stopLoading = function() {
            return element.removeClass('loading').attr('disabled', false).trigger('chosen:updated');
          };
          chosen = null;
          defaultText = null;
          empty = false;
          initOrUpdate = function() {
            if (chosen) {
              return element.trigger('chosen:updated');
            } else {
              chosen = element.chosen(options).data('chosen');
              return defaultText = chosen.default_text;
            }
          };
          removeEmptyMessage = function() {
            empty = false;
            return element.attr('data-placeholder', defaultText);
          };
          disableWithMessage = function() {
            empty = true;
            return element.attr('data-placeholder', chosen.results_none_found).attr('disabled', true).trigger('chosen:updated');
          };
          if (ngModel) {
            origRender = ngModel.$render;
            ngModel.$render = function() {
              origRender();
              return initOrUpdate();
            };
            if (attr.multiple) {
              viewWatch = function() {
                return ngModel.$viewValue;
              };
              scope.$watch(viewWatch, ngModel.$render, true);
            }
          } else {
            initOrUpdate();
          }
          attr.$observe('disabled', function() {
            return element.trigger('chosen:updated');
          });
          if (attr.ngOptions && ngModel) {
            match = attr.ngOptions.match(NG_OPTIONS_REGEXP);
            valuesExpr = match[7];
            scope.$watchCollection(valuesExpr, function(newVal, oldVal) {
              var timer;
              return timer = $timeout(function() {
                if (angular.isUndefined(newVal)) {
                  return startLoading();
                } else {
                  if (empty) {
                    removeEmptyMessage();
                  }
                  stopLoading();
                  if (isEmpty(newVal)) {
                    return disableWithMessage();
                  }
                }
              });
            });
            return scope.$on('$destroy', function(event) {
              if (typeof timer !== "undefined" && timer !== null) {
                return $timeout.cancel(timer);
              }
            });
          }
        }
      };
    }
  ]);

}).call(this);

$('body').on("click",'#btnFaqSearch',function(event) {
    event.preventDefault();

    var urlVal = $('#formFaqSearchResultsPage').val();
	var infoSearchHelp = $('#search-help').val();

    var urlInfoSearchHelp = urlVal + '.mode=1.search=' + btoa(sanitizer(infoSearchHelp)) + ".go.html";

    if (infoSearchHelp != ''){
    	window.location.href = urlInfoSearchHelp;
    }
});


var sanitizer = (function() {
  var from = "ÃÀÁÄÂÈÉËÊÌÍÏÎÒÓÖÔÙÚÜÛãàáäâèéëêìíïîòóöôùúüûÑñÇç", 
      to   = "AAAAAEEEEIIIIOOOOUUUUaaaaaeeeeiiiioooouuuunncc",
      mapping = {};

  for(var i = 0, j = from.length; i < j; i++ )
      mapping[ from.charAt( i ) ] = to.charAt( i );
 
  return function( str ) {
      var ret = [];
      for( var i = 0, j = str.length; i < j; i++ ) {
          var c = str.charAt( i );
          if( mapping.hasOwnProperty( str.charAt( i ) ) )
              ret.push( mapping[ c ] );
          else
              ret.push( c );
      }      
      return ret.join( '' );
  }

})();
/*

Validacion formulario enviar SMS
    
*/

function validar_telefono_sms( elemento ){

    if( elemento.val() == "" ){
        elemento.closest('.form-group').addClass('has-error');
        elemento.closest('.form-group').find('.help-block').removeClass('hide');
        elemento.closest('.form-group').find('.help-block').html('Es necesario ingresar el número Telcel al que se enviará el mensaje.'); 
    }
    else if( elemento.val() != "" ){


        if( elemento.val().length != 10 ){
            elemento.closest('.form-group').addClass('has-error');
            elemento.closest('.form-group').find('.help-block').removeClass('hide');
            elemento.closest('.form-group').find('.help-block').html('Ingresar el número a 10 dígitos'); 
            return false;
        }else{
            elemento.closest('.form-group').removeClass('has-error');
            elemento.closest('.form-group').find('.help-block').addClass('hide');
            return true;
        }
        
    }    
}

function validar_mensaje_sms( elemento ){
    if( elemento.val() == "" ){
        elemento.closest('.form-group').addClass('has-error');
        elemento.closest('.form-group').find('.help-block').removeClass('hide');
        elemento.closest('.form-group').find('.help-block').html('Es necesario ingresar el texto del mensaje.'); 
        return false;
    }else{
        elemento.closest('.form-group').removeClass('has-error');
        elemento.closest('.form-group').find('.help-block').addClass('hide');
        return true;
    }
}

function validar_imei( elemento ){

    console.log(elemento.val());

    if( elemento.val() == "" ){
        elemento.closest('.form-group').addClass('has-error');
        elemento.closest('.form-group').find('.help-block').removeClass('hide');
        elemento.closest('.form-group').find('.help-block').html('Es necesario ingresar el IMEI al que se enviará el mensaje.'); 
    }
    else if( elemento.val() != "" ){


        if( elemento.val().length != 15 ){
            elemento.closest('.form-group').addClass('has-error');
            elemento.closest('.form-group').find('.help-block').removeClass('hide');
            elemento.closest('.form-group').find('.help-block').html('El formato del IMEI no es correcto.'); 
            return false;
        }
        else if( ! $.isNumeric( elemento.val() ) ){
            elemento.closest('.form-group').addClass('has-error');
            elemento.closest('.form-group').find('.help-block').removeClass('hide');
            elemento.closest('.form-group').find('.help-block').html('El formato del IMEI no es correcto, debe contenener solo números.'); 
            return false;
        }else{
            elemento.closest('.form-group').removeClass('has-error');
            elemento.closest('.form-group').find('.help-block').addClass('hide');
            return true;
        }
        
    }    
}

function validar_celular( elemento ){

    console.log(elemento.val());

    if( elemento.val() == "" ){
        elemento.closest('.form-group').addClass('has-error');
        elemento.closest('.form-group').find('.help-block').removeClass('hide');
        elemento.closest('.form-group').find('.help-block').html('Es necesario ingresar el número de teléfono.'); 
    }
    else if( elemento.val() != "" ){


        if( elemento.val().length != 10 ){
            elemento.closest('.form-group').addClass('has-error');
            elemento.closest('.form-group').find('.help-block').removeClass('hide');
            elemento.closest('.form-group').find('.help-block').html('Ingresar el número a 10 dígitos'); 
            return false;
        }
        else if( ! $.isNumeric( elemento.val() ) ){
            elemento.closest('.form-group').addClass('has-error');
            elemento.closest('.form-group').find('.help-block').removeClass('hide');
            elemento.closest('.form-group').find('.help-block').html('El formato del teléfono no es correcto, debe contenener solo números.'); 
            return false;
        }else{
            elemento.closest('.form-group').removeClass('has-error');
            elemento.closest('.form-group').find('.help-block').addClass('hide');
            return true;
        }
        
    }    
}

/*
    fin de validacion SMS
*/


$('body').on("click",'#btnTxt',function(event) {
    event.preventDefault();

    	if(!$("#msg-success").hasClass('hide')){
			$("#msg-success").addClass('hide');
        }
        if(!$("#msg-warning-number").hasClass('hide')){
			$("#msg-warning-number").addClass('hide');
        }
        if(!$("#msg-warning-service").hasClass('hide')){
			$("#msg-warning-service").addClass('hide');
        }
        if(!$("#msg-warning-multi").hasClass('hide')){
			$("#msg-warning-multi").addClass('hide');
        }
    if ( !$('#recipient-number').attr('disabled')  ){

    	if( validar_telefono_sms($('#recipient-number')) && validar_mensaje_sms($('#txt-message')) ){

        var urlVal = "/bin/telcelcom/service/txtmessage";
    	$.post( urlVal, $( "#msgForm" ).serialize(),function(data){
        	if(data !== ''){
                if('success' == data){
                	$("#msg-success").removeClass('hide');
                } else if ('phoneServiceUnavailable' == data) {
					$("#msg-warning-number").removeClass('hide');
                }else if ('serviceUnavailable' == data) {
					$("#msg-warning-service").removeClass('hide');
                }
        	} else {
                $("#msg-warning-service").removeClass('hide');
        	}
    	});
    	}
    }else{
         if( validacion_minimo($("#form-extra-num"),2) && validar_mensaje_sms($('#txt-message')) ){
			 var urlVal = "/bin/telcelcom/service/txtmessage";
    		 $.post( urlVal, $( "#msgForm" ).serialize(),function(data){
        	 if(data !== ''){
                    var messagesSend = data.charAt(0);
                    if(messagesSend > 0){
                        console.log("entro ");data.indexOf("<ul>")
                        var numerosSuccess = data.substring(0,data.indexOf("<ul>"));
						$("#msg-success").removeClass('hide');
                        $("#msg-success").html("<span class=\"col-md-1\"><i class=\"icon-TickNeg\"></i></span>"+
                        "<span class=\"col-md-11 f-z-18\">"+numerosSuccess.replace(numerosSuccess.charAt(0),"")+"Tu Mensaje ha sido enviado. Gracias.</span>");
                    }
					$("#msg-warning-multi").removeClass('hide');
                    $("#msg-warning-multi").html("<span class=\"col-md-1 col-sm-1 hidden-xs\"><i class=\"icon-Alert2\"></i></span>"+
                                          "<span class=\"col-md-11 col-sm-11 col-xs-12 txt\">"+data.substring(data.indexOf("<ul>"), data.length)+"</span>");

        	 } else {
                $("#msg-warning-service").removeClass('hide');
        	}
    	});
         }
    }

});

/*$('#msgForm').submit(function () {
	return false;
});*/

	$('body').on('change', '#extra-num', function() {

        $("#msgForm .help-block").each(function(){
            $(this).addClass("hide");
        });

        $("#msgForm .has-error").each(function(){
            $(this).removeClass("has-error");
        });

        if ( $('#recipient-number').attr('disabled')  ){
            $('#recipient-number').removeAttr('disabled');  
            $('#recipient_number_1').val('');
            $('#recipient_number_2').val('');
            $('#recipient_number_3').val('');
            $('#recipient_number_4').val('');
            $('#recipient_number_5').val('');
            $('#recipient_number_6').val('');
            $('#recipient_number_7').val('');
            $('#recipient_number_8').val('');
        }else{
            $('#recipient-number').val('');
            $('#recipient-number').attr('disabled','disabled');
        }
        
    });


    /*
        Validacion formulario enviar SMS  
    */

      var validacion_minimo = function( formulario , minimo ){

        var elementos_a_validar = formulario.find('input');
        var count = 0;
        var vacio = 0;
        var exito;

        elementos_a_validar.each( function(){
            if( $(this).val()!= "" ){
                    if( validar_telefono_sms( $(this) )  ){
                        count++;
                    }
            }else{
                vacio++;
                borrar_mensajes_de_error( $(this) );
            }
        } );
        if (count >= minimo && count + vacio == 8 ){
            return 1;
        }else if(count < minimo && count + vacio == 8 ){
            validar_telefono_sms($("#recipient_number_1"));
            validar_telefono_sms($("#recipient_number_2"));
        }else{
            borrar_mensajes_de_error( $("#recipient_number_1") );
            borrar_mensajes_de_error( $("#recipient_number_2") );
        }
      };

      var borrar_mensajes_de_error = function(elemento){
        $("#msgForm .has-error").each(function(){
            elemento.closest('.form-group').removeClass("has-error");
            elemento.closest('.form-group').find('.help-block').addClass('hide'); 
        });
      };

/**
 * Created by jhernandez on 07/04/15.
 */

$(function(){
    $('body').on('generic.tabcontainer', '.tabsToselect-xs', function(e) {
        $(e.target).find('.js-simpleAjaxTabs').on('click', '> li > a', function () {
            $(this).closest('.open').removeClass('open');
        });
    });
});

$(document).on("textRightImageLeft.alinear", ".container .textRightImageLeft", function(){
	var imagen = $('.c-vertical').find("img");
	imagen.on("load",function(e){
		alinear_verticalmente();
	});
});

$(document).ready(function(){
      $(window).resize( function(){
        alinear_verticalmente();
      });
      alinear_verticalmente();
});

$(window).bind("load", function() {
	alinear_verticalmente();
});

$(document).on("textLeftImageRight.alinear", ".container .textLeftImageRight", function(){
	var imagen = $('.c-vertical').find("img");
	imagen.on("load",function(e){
		alinear_verticalmente();
	});
});

$(document).ready(function(){
	  $(window).resize( function(){
	    alinear_verticalmente();
	  })
	  alinear_verticalmente();
});

$(window).bind("load", function() {
	alinear_verticalmente();
});

function putVertDataOnMobile() {
    if($(".desktop-vertmenu ul").length) {
        $(".desktop-vertmenu li").each(function(index,elem){
            $(elem).clone().appendTo(".mobile-vertmenu ul");
        });
        $(".mobile-vertmenu li").each(function(index,elem){
            if($(elem).attr("data-showInMobile") === "false") {
                //console.log($(elem).attr("data-showInMobile"));
                $(elem).toggleClass("hidden-xsm");
            }
        });
    }

}

$(document).ready(function() {
    putVertDataOnMobile();
});


angular.module("telcelApp").controller("HeaderStateController", ['$http','$scope','$cookies', 'States',
        function($http,$scope,$cookies, States){
	
        $scope.first = true;
        $scope.initSettings = function(pagePath, defaultState, defaultRegion){
            $scope.pagePath = pagePath;
            $scope.region =  angular.isUndefined($cookies.telcelcom_region)
                || $cookies.telcelcom_region === null ? defaultRegion : $cookies.telcelcom_region;
            $scope.state = angular.isUndefined($cookies.telcelcom_estado)
                || $cookies.telcelcom_estado === null  || $cookies.telcelcom_estado.trim()==""? "Selecciona tu Estado" : $cookies.telcelcom_estado;
            $scope.changeState($scope.state+"_"+$scope.region);
            $scope.states = States.query({path:window.btoa(pagePath)});
        } ;
        
        $scope.openMinicart = function() {
            console.log("Minicart: Entrando a invocación desde Angular.");
        	$http.get("/bin/telcelcom/minicart.go.json").
                    success(function(response) {
                console.log("Minicart: Invocación de angular exitosa");
                $(".shop").html(response);
            });
        }

        $scope.changeState = function(value){

            var estado = value.substring(0,value.lastIndexOf("_")),
                region = value.substring(value.lastIndexOf("_")+1,value.length);

            //use jQuery $.cookie
            $.cookie("telcelcom_estado", angular.copy(estado), {path : '/',  expires : 365*10});
            $scope.state = angular.copy(estado);

            //use jQuery $.cookie
            $.cookie("telcelcom_region", angular.copy(region), {path : '/',  expires : 365*10});
            $.cookie("telceltienda_region", angular.copy(region), {path : '/',  expires : 365*10, domain  : 'telcel.com'});
            $scope.region = angular.copy(estado);

            if (!$scope.first){
                setTimeout(function () {
                    window.location.reload();
                }, 1000);
            }
            $scope.first = false;
        };
        $scope.$watch(function() { return $cookies.telcelcom_estado; }, function(newValue) {

            $scope.state = angular.isUndefined($cookies.telcelcom_estado)
                || $cookies.telcelcom_estado === null  || $cookies.telcelcom_estado.trim()==""? "Selecciona tu Estado" : $cookies.telcelcom_estado;
        });


}]);
$( window ).load(function(){
    $('.js-select-location').on('click', 'a', function () {
        $(this).closest('ul').prev().find('span').text($(this).text());
        if( $(this).closest('ul').prev().find('span').text() === " United States" ){
          window.location="http://us.telcel.com/";
          $(this).closest('ul').prev().find('span').text(" México");
        }
    }).css({'max-height': $(window).height()-60});

    $('.js-select-location').on('mouseover', 'a', function () {
      if( !$(this).hasClass("por-defecto") ) $(this).closest('ul').find('.por-defecto').removeClass('por-defecto');
    });
});

//Función para cargar el MiniCart que desarrolló TechAspect
$(document).ready(function(){
    console.log("Minicart: Iniciando invocación.");
    $.ajax({
        url: "/bin/telcelcom/minicart.html?bustcache=" + generateTimeStamp(), 
        success: function(data)
        {
            console.log("Minicart: Invocación exitosa.");
            document.getElementById("cartdropdown").innerHTML = data;
        },
        error: function(XMLHttpRequest, textStatus, errorThrown) {
            console.log("Minicart: Error al invocar el servlet del carrito de compras: " + textStatus + " : " + errorThrown);
        }
    });
});
$(document).ready(function(){

    $('.xk-benefitscontainer[class*="bg-light-blue"]').each(function(){
		$(this).find('.xk-benefitscontainer-pdf-link').addClass('link-pdf-down');
	});

});

var app = angular.module("telcelApp")
.controller("benefitsController", ['$window','$scope','$attrs','$http', function($window, $scope, $attrs, $http) {

	$scope.createList = function(icons,descriptions,externalLinks,internalLinks,linkTypes,linksCount,pdfLinks,titles,descLinks){
	      var iconsList = icons.substring(1, icons.length-1).split(",");
	      var titleList = titles.substring(0, titles.length-1).split("|");
          var descriptionsList = descriptions.substring(0, descriptions.length-1).split("|");
	      var linkTypesList = linkTypes.substring(1, linkTypes.length-1).split(",");
	      var internalLinksList = internalLinks.substring(1, internalLinks.length-1).split(",");
	      var externalLinksList = externalLinks.substring(1, externalLinks.length-1).split(",");
	      var pdfLinksList = pdfLinks.substring(1, pdfLinks.length-1).split(",");          
	      var descLinksList = descLinks.substring(1, descLinks.length-1).split(",");
	      var benefits = [];
	      $scope.benefitsList = benefits;
	      var i = 0;
	      while (i < linksCount) {
	    	  var link = "";
	    	  var titleLink = "";
	    	  var linkTarget = "_blank";
	    	  if (linkTypesList[i].trim() == 'pdf') {
	    		  link = pdfLinksList[i].trim();
	    	  } else if (linkTypesList[i].trim() == 'internal') {
	    		  link = internalLinksList[i].trim() + ".html";
	    		  linkTarget = "_self";
	    	  } else if (linkTypesList[i].trim() == 'external') {
	    		  link = externalLinksList[i].trim();
	    	  }
	    	  if( descLinksList[i].trim() != "") {
	    		  titleLink = descLinksList[i].trim();
	    	  } else {
	    		  titleLink = "Descargar PDF";
	    	  }

	    	  var benefit = {icon:iconsList[i].trim(),title:titleList[i].trim(),description:descriptionsList[i].trim(),document:link,titleLink:titleLink,linkTarget:linkTarget};
	    	  benefits.push(benefit);
	    	  i++;
	      }
	      
	  }
}]);
$(document).ready(function(){

    $('.xk-benefitscontainer[class*="bg-light-blue"]').each(function(){
		$(this).find('.xk-benefitscontainer-pdf-link').addClass('link-pdf-down');
	});

});
$(document).ready(function(){
    $(".xk-iframe").trigger("generic.iframe");
});

//TRASLADA VALORES AL IFRAME
$(document).on("generic.iframe", ".xk-iframe", function(){

    var objiframe = $(this).find("#iframe-recarga");

    if (objiframe != null && objiframe != "undefined" && objiframe.length > 0) {

        //Ini Codigo agregado por solicitud de Ismael 23-11-2015
        var urlVesta = objiframe.attr("src");
        var PayerID = GetURLParameter('PayerID');
        var encryptedToken=GetURLParameter('encryptedToken');

        if((PayerID!=null)&&(encryptedToken!=null)){
            urlVesta=urlVesta+"&PayerID="+PayerID+"&encryptedToken="+encryptedToken;
        }

        //console.log("urlVesta: " + urlVesta);
        objiframe.attr("src", urlVesta);
        //Fin Codigo agregado por solicitud de Ismael 23-11-2015

    }

});

//Ini Codigo agregado por solicitud de Ismael 23-11-2015
function GetURLParameter(sParam) {

    //var sPageURL = getParentUrl();
    //var sPageURL = window.location.search.substring(1);
    var sPageURL = getParentUrl();
    sPageURL = sPageURL.toString();
    //console.log("sPageUrl:" + sPageURL);
    var sURLVariables = sPageURL.split('&');
    for (var i = 0; i < sURLVariables.length; i++) {
        var sParameterName = sURLVariables[i].split('=');
        if (sParameterName[0] == sParam)
        {
            return sParameterName[1];
        }
    }

}
//Fin Codigo agregado por solicitud de Ismael 23-11-2015

function getParentUrl() {
    var url = (window.location != window.parent.location) ? document.referrer : document.location;
    return url;
}
$(document).ready(function(){
    $('.xk-infobox').trigger('amigo.infobox');
});

$(document).on('amigo.infobox', '.xk-infobox', function() {

    $('.cortado-a-20').each( function( index,value ){
        //console.log("this20:" + $(this).html());
        $(value).html($(this).html().substring(0,20));
    } );


    $('.cortado-a-48').each( function( index,value ){
        //console.log("this48:" + $(this).html());
        $(value).html($(this).html().substring(0,48));        
    } );


    $('.cortado-a-65').each( function( index,value ){
        //console.log("cortado-a-65");
        $(value).html($(this).html().substring(0,65));
    } );
});

$(document).ready(function(){
	var script = document.createElement("script");
	script.innerHTML = getDlMetriScript("") + "_satellite.track(\"telHome\");";
	$("div#tabs-planes").prepend(script);

	var firstDivId = $("div.tab-pane.active.collapse.in").attr('id');
	if(firstDivId == "planesRenta"){
		insertPlanesScript();
	}
	
	$('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
		var target = $(e.target).attr("href") // activated tab
		if(target == "#planesRenta"){
			insertPlanesScript();
		}
	});
	
});

function getDlMetriScript(tabName){
	var regionId = getRegionFromCookie();
	var profile = getProfileFromCookie();
	var fecha = getDTMDate();
	var dispo = getBrowserResolution();
	var path = getBredcrum();
	var page = path.substr(path.lastIndexOf('|') + 1);
	var dlMetriScript = "var dlMetri={\n" +
			"'ecomPageName':'Home" + tabName + "',\n" +
			"'ecomFecha':'"+fecha+"',\n" +
			"'ecomPerfil':'"+profile+"',\n" +
			"'ecomZona':'"+regionId+"',\n" +
			"'ecomDispo':'"+dispo+"',\n" +
			"'ecomSec':'"+page+"',\n" +
			"'ecomJerarquia':'Personas|Home"+tabName+"',\n" +
			"'ecomEvento':'pageview'};\n";
	return dlMetriScript;
}

function insertPlanesScript(){
	var scriptTabDiv = $("#scriptPlanesTabDiv");
	if(scriptTabDiv == "undefined" || scriptTabDiv.length == 0){
		var planesScript = document.createElement("div");
		planesScript.setAttribute("id", "scriptPlanesTabDiv");
		planesScript.innerHTML = "<script>" + getDlMetriScript("|Planes de Renta") +
			"_satellite.track(\"ecomHomePlanesdeRenta\");\n</script>"
		$("div#planesRenta.xk-js-filter-plan").prepend(planesScript);
	}
}

$(window).load(function(){
	// Cambia la posicion del div enviado del servlet para el banner de msi enmedio.
	$("div#bottomDeviceLink").insertAfter("div#msiCarrusel");
	
	var deviceDetailsBtns = $(".deviceDetail.dtmClass");
	var pageNameBylocation = getDevicePageName();
	if(pageNameBylocation.indexOf("Equipos") >= 0){
		var brand = $("#brandName").text();
		var deviceName = $("#comercialName").text();
		var model = $("#model").text();
		$.each(deviceDetailsBtns, function(){
			var dataTitleTmp = $(this).attr("data-titulo");
			var brandComercialNameModel = dataTitleTmp.split("|");
			if(typeof brandComercialNameModel[1] == "undefined" || brandComercialNameModel[1] == ""){
				brandComercialNameModel[1] = brandComercialNameModel[2];
			}
			var dataTitleNew = pageNameBylocation + "|Ficha tecnica|" + brand + "|" + model + ":Ver detalles equipos-" + brandComercialNameModel[1];
			$(this).attr("data-titulo", dataTitleNew);
		});
		var link = $(".carousel-terminales.simple-carousel").find("a.btn-link");
		if(typeof deviceName == "undefined" || deviceName == ""){
			deviceName = model;
		}
		var title = pageNameBylocation + "|Ficha Tecnica|" + brand + "|" + model + ":Ver mas equipos en amigo kit";
		$(link).attr("data-titulo", title);
		$(link).attr("data-evento", "clicEvento");
	} else {
		$.each(deviceDetailsBtns, function(){
			var dataTitleTmp = $(this).attr("data-titulo");
			var brandComercialNameModel = dataTitleTmp.split("|");
			if(typeof brandComercialNameModel[1] == "undefined" || brandComercialNameModel[1] == ""){
				brandComercialNameModel[1] = brandComercialNameModel[2];
			}
			var dataTitleNew = pageNameBylocation + ":Ver detalles equipos-" + brandComercialNameModel[1];
			$(this).attr("data-titulo", dataTitleNew);
		});
	}
});
// Generated by CoffeeScript 1.6.2
(function() {
  var __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  angular.module("telcelApp");

  angular.module("telcelApp").directive('chosen', function() {
    var CHOSEN_OPTION_WHITELIST, NG_OPTIONS_REGEXP, isEmpty, snakeCase;

    NG_OPTIONS_REGEXP = /^\s*(.*?)(?:\s+as\s+(.*?))?(?:\s+group\s+by\s+(.*))?\s+for\s+(?:([\$\w][\$\w]*)|(?:\(\s*([\$\w][\$\w]*)\s*,\s*([\$\w][\$\w]*)\s*\)))\s+in\s+(.*?)(?:\s+track\s+by\s+(.*?))?$/;
    CHOSEN_OPTION_WHITELIST = ['noResultsText', 'allowSingleDeselect', 'disableSearchThreshold', 'disableSearch', 'enableSplitWordSearch', 'inheritSelectClasses', 'maxSelectedOptions', 'placeholderTextMultiple', 'placeholderTextSingle', 'searchContains', 'singleBackstrokeDelete', 'displayDisabledOptions', 'displaySelectedOptions', 'width'];
    snakeCase = function(input) {
      return input.replace(/[A-Z]/g, function($1) {
        return "_" + ($1.toLowerCase());
      });
    };
    isEmpty = function(value) {
      var key;

      if (angular.isArray(value)) {
        return value.length === 0;
      } else if (angular.isObject(value)) {
        for (key in value) {
          if (value.hasOwnProperty(key)) {
            return false;
          }
        }
      }
      return true;
    };
    return {
      restrict: 'A',
      require: '?ngModel',
      terminal: true,
      link: function(scope, element, attr, ngModel) {
        var chosen, defaultText, disableWithMessage, empty, initOrUpdate, match, options, origRender, removeEmptyMessage, startLoading, stopLoading, valuesExpr, viewWatch;

        element.addClass('localytics-chosen');
        options = scope.$eval(attr.chosen) || {};
        angular.forEach(attr, function(value, key) {
          if (__indexOf.call(CHOSEN_OPTION_WHITELIST, key) >= 0) {
            return options[snakeCase(key)] = scope.$eval(value);
          }
        });
        startLoading = function() {
          return element.addClass('loading').attr('disabled', true).trigger('chosen:updated');
        };
        stopLoading = function() {
          return element.removeClass('loading').attr('disabled', false).trigger('chosen:updated');
        };
        chosen = null;
        defaultText = null;
        empty = false;
        initOrUpdate = function() {
          if (chosen) {
            return element.trigger('chosen:updated');
          } else {
            chosen = element.chosen(options).data('chosen');
            return defaultText = chosen.default_text;
          }
        };
        removeEmptyMessage = function() {
          empty = false;
          return element.attr('data-placeholder', defaultText);
        };
        disableWithMessage = function() {
          empty = true;
          return element.attr('data-placeholder', chosen.results_none_found).attr('disabled', true).trigger('chosen:updated');
        };
        if (ngModel) {
          origRender = ngModel.$render;
          ngModel.$render = function() {
            origRender();
            return initOrUpdate();
          };
          if (attr.multiple) {
            viewWatch = function() {
              return ngModel.$viewValue;
            };
            scope.$watch(viewWatch, ngModel.$render, true);
          }
        } else {
          initOrUpdate();
        }
        attr.$observe('disabled', function() {
          return element.trigger('chosen:updated');
        });
        if (attr.ngOptions && ngModel) {
          match = attr.ngOptions.match(NG_OPTIONS_REGEXP);
          valuesExpr = match[7];
          return scope.$watchCollection(valuesExpr, function(newVal, oldVal) {
            if (angular.isUndefined(newVal)) {
              return startLoading();
            } else {
              if (empty) {
                removeEmptyMessage();
              }
              stopLoading();
              if (isEmpty(newVal)) {
                return disableWithMessage();
              }
            }
          });
        }
      }
    };
  });

}).call(this);



var app = angular.module("telcelApp")
    .controller("compareController", ['$window','$scope','$attrs','$http','$cookies', function($window, $scope, $attrs, $http, $cookies) {


    var selectors = getSelectors();
    var brand1 = "", brand2 = "", brand3 = "";
    var model1 = "", model2 = "", model3 = "";
    var devicesIDs = [0, 0, 0];
    var terminalType = 1;
    var region = $cookies.telcelcom_region === null ? "9" : $cookies.telcelcom_region;
    var showPrices = $("#showPricesHidden").val();

	for (i = 0; i < selectors.length; i++) {
	    if (selectors[i].startsWith("terminal") && selectors[i].length == 10) {
	        terminalType = selectors[i].substring(9,10);
	    } else {
	        devicesIDs[i] = selectors[i];
	    }
    }

    /*
        Phones vars
    */
    $scope.brands = [];
    $scope.models = [0, 0, 0]

    $scope.brandSelected = [0, 0, 0];
    $scope.modelSelected = [0, 0, 0];

    $scope.phones = [
        { "data": {}, "is_empty": true,  "in_change": false },
        { "data": {}, "is_empty": true,  "in_change": false },
        { "data": {}, "is_empty": true,  "in_change": false }
    ];

    $scope.devices = [];



    /*
        Load phone
    */
    var loadPhone = function(i, id) {
    };

    /*
        Change phone
    */
    $scope.changePhone = function(i){
        devicesIDs[i] = 0;
        $scope.brandSelected[i] = 0;
        $scope.models[i] = {};
        $scope.modelSelected[i] = 0;
        $scope.devices[i] = {};
        $scope.devices[i].is_empty = true;
        $scope.devices[i].in_change = true;

        var objModel = $(".slcModel").eq(i);
        objModel.html("");
        objModel.find("option").trigger('chosen:updated');

        $(".slcBrand").eq(i).find("option").trigger('chosen:updated');
    };

    /*
        Drop phone
    */
    $scope.dropPhone = function(i){
        devicesIDs[i] = 0;
        $scope.brandSelected[i] = 0;
        $scope.models[i] = {};
        $scope.modelSelected[i] = 0;
        $scope.devices[i] = {};
        $scope.devices[i].is_empty = true;
        $scope.devices[i].in_change = false;

    };

    /*
        Select phone
    */
    $scope.selectPhone = function(i){

        devicesIDs[i] = $scope.modelSelected[i];
        $scope.loadDevices(devicesIDs[0], devicesIDs[1], devicesIDs[2], i);


    };

    /*
        Change phone brand
    */

    $scope.changeBrand = function(i) {

        $http.get($attrs.componentpath + ".compare.f_brand=" + $scope.brandSelected[i] + ".f_type=" + terminalType + ".go.json?bustcache=true").
            success(function(data, status, headers, config) {
                $scope.models[i] = data;
                $scope.modelSelected[i] = 0;


                var objModel = $(".slcModel").eq(i);
                objModel.html("");
                objModel.append("<option value class></option>");
                $.each(data, function(j, item){
                    objModel.append("<option value='" + item.id + "'>" + item.name + "</option>");
                });
                objModel.find("option").trigger('chosen:updated');
            });
    };

    $http.get($attrs.componentpath + ".compare.f_brand=all.f_type="+terminalType+".go.json?bustcache=true").
            success(function(data, status, headers, config) {
                $scope.brands = data;
    });


    ////////////////
    $scope.loadDevices = function(id1, id2, id3, selectedPhoneindex) {
    	var urlParams = ".compare.f_deviceid1=" + id1 + ".f_deviceid2=" + id2 + ".f_deviceid3=" + id3 + ".f_region=" + region;
    	if(showPrices === "true"){
    		urlParams = urlParams + ".f_showprices=true"
    	}
    	$http.get($attrs.componentpath + urlParams + ".go.json?bustcache=true").
                success(function(data, status, headers, config) {

                    $scope.devices[0] = data.data[0];
                    $scope.devices[1] = data.data[1];
                    $scope.devices[2] = data.data[2];

                    $scope.mainFeaturesLabels = data.etiquetas_especificacionesPrincipales;
                    $scope.secondaryFeaturesLabels = data.etiquetas_especificacionesSecundarias;
                    $scope.featuresLabels = data.etiquetas_caracteristicas;

                    var region = $.cookie("telcelcom_region");
                    $scope.region = region;

                    for (i = 0; i < $scope.devices.length; i++) {

                        if ($scope.devices[i] != null) {
                            switch ($scope.devices[i].tipoTerminal.id) {
                                case 1:
                                    $scope.devices[i].pagePath = "/content/telcel/personas/equipos/telefonos-y-smartphones/" + $scope.devices[i].marca.nombre.trim().replaceAll(' ', '-').toLowerCase() + "/" + $scope.devices[i].modelo.trim().replaceAll(' ', '-').toLowerCase();
                                    break;
                                case 2:
                                    $scope.devices[i].pagePath = "/content/telcel/personas/equipos/modems-usb/" + $scope.devices[i].marca.nombre.trim().replaceAll(' ', '-').toLowerCase() + "/" + $scope.devices[i].modelo.trim().replaceAll(' ', '-').toLowerCase();
                                    break;
                                case 4:
                                    $scope.devices[i].pagePath = "/content/telcel/personas/equipos/wifi-movil-telcel/" + $scope.devices[i].marca.nombre.trim().replaceAll(' ', '-').toLowerCase() + "/" + $scope.devices[i].modelo.trim().replaceAll(' ', '-').toLowerCase();
                                    break;
                                case 5:
                                    $scope.devices[i].pagePath = "/content/telcel/personas/equipos/tablets/" + $scope.devices[i].marca.nombre.trim().replaceAll(' ', '-').toLowerCase() + "/" + $scope.devices[i].modelo.trim().replaceAll(' ', '-').toLowerCase();
                                    break;
                            }

                        } else {
                            $scope.devices[i] = {};
                            $scope.devices[i].is_empty = true;
                            $scope.devices[i].in_change = true;
                        }
                    }


                    if (typeof selectedPhoneindex != 'undefined') {
                        $scope.brandSelected[selectedPhoneindex] = 0;
                        $scope.modelSelected[selectedPhoneindex] = 0;
                    }

                    //$scope.phones[2].data = data;
                    //$scope.phones[2].is_empty = false;


            });
    };

    $scope.loadDevices(devicesIDs[0], devicesIDs[1], devicesIDs[2]);
    ///////////////
}]) .directive('resizable',['$window', function($window) {
    return function($scope) {
        /*
            Set template with resolution
        */
        $scope.setCompareTemplate = function() {
            //console.log("Entra");
            if($window.innerWidth >= 768) {
                $scope.compareTemplate = 'compare-desktop-template.html';
            } 
        };

        // Initialize compareTemplate
        $scope.setCompareTemplate();

        return angular.element($window).bind('resize', function() {
           $scope.setCompareTemplate();
           return $scope.$apply();
        });
    };
}]);

function getSelectors() {

    var pathArray = window.location.pathname.split( '/' );
    var lastLevelLocation = pathArray[pathArray.length-1];
    var levelArray = lastLevelLocation.split('.');
    if (levelArray[levelArray.length-1] === 'html') {
        levelArray.splice(levelArray.length-1,1);
    }
    levelArray.splice(0,1);

    return levelArray;
}

String.prototype.replaceAll = function(target, replacement) {
  return this.split(target).join(replacement);
};

String.prototype.startsWith = function(prefix) {
    return this.indexOf(prefix) === 0;
}
/*
* -----------------------------------------------------------------------------
*
* CHANGE HISTORY
* -----------------------------------------------------------------------------
* Version   | Date          | Developer             | Changes
* 1.0       | 2015/09/10    | Miguel Reyna          | Initial Creation
* -----------------------------------------------------------------------------
*/

$(document).ready(function(){
	$('.xk-unblockingdevices').trigger('mundotelcel.unblockingdevices');
    $('body').on('keypress', '.js-only-numbers', function (e) {
        if (e.which != 8 && e.which != 0 && (e.which < 48 || e.which > 57)) {
            return false;
        }
    });
    $('[data-toggle="tooltip"]').tooltip();
    $("#modeloDesbloqueoDes").attr('disabled', true).trigger("chosen:updated");
});

    $("#marcaDesbloqueoDes").on('change', function(){
		doSelectReset("#modeloDesbloqueoDes");
		loadPage();
//        console.log("SE ACTUALIZA MODELO DESBLOQUEO");
		marca = chose_get_value_select('#marcaDesbloqueoDes');
        marcaTxt = chose_get_text_select('#marcaDesbloqueoDes');
//        console.log("MARCA "+marca);
        $.get(
		    '/bin/telcelcom/worldtelcel/unblockmodel',
    		{"marcaDesbloqueo":marca},
    		function(data){                     
        		$.each(data, function(key, value){
                    $("#modeloDesbloqueoDes").append($('<option></option>').attr('value',key).text(value)).trigger('chosen:updated');
        		})
    		},
    		'json'
		);

		$("#modeloDesbloqueoDes").attr('disabled', false).trigger("chosen:updated");
	});

	$("#modeloDesbloqueoDes").on('change', function(){
		modelo = chose_get_value_select('#modeloDesbloqueoDes');
//        console.log("MODELO "+modelo);
        var marcaDiv = chose_get_text_select("#marcaDesbloqueoDes");
        var modeloDiv = chose_get_text_select("#modeloDesbloqueoDes");
        document.getElementById("marcaDiv").innerHTML = marcaDiv;
        document.getElementById("marcaDiv2").innerHTML = marcaDiv;
        document.getElementById("marcaDiv3").innerHTML = marcaDiv;  
        document.getElementById("marcaDiv4").innerHTML = marcaDiv;          
        document.getElementById("modeloDiv").innerHTML = modeloDiv;
        document.getElementById("modeloDiv2").innerHTML = modeloDiv;   
        document.getElementById("modeloDiv3").innerHTML = modeloDiv;   
        document.getElementById("modeloDiv4").innerHTML = modeloDiv;           
	});


/*FORMULARIO MARCA MODELO */
	$("#consultar_marca_modeloDes").click(function(e){
		if (e.isDefaultPrevented()) {
			//Invalid Form
  			e.preventDefault();
        } else {
        	e.preventDefault();
//			console.log( "Respuesta del captcha" + grecaptcha.getResponse());
			if ( validar_marca( $("#marcaDesbloqueoDes") ) && validar_modelo( $("#modeloDesbloqueoDes") ) && validar_captcha() ) {

				// Get some values from elements on the page:
  				var $form = $("#Form1");
			    brand = $form.find( "select[name='marca']" ).val();
				model = $form.find( "select[name='modelo']" ).val();  
			    url = "/bin/telcelcom/service/unblockdevice";
//				console.log("FORM "+$form);
//                console.log("BRAND "+brand);
//                console.log("MODEL "+model);
//                console.log("URL "+url);
				// Send the data using post
				var posting = $.post( url, { marcaDesbloqueo: brand, modeloDesbloqueo: model } );
//                console.log("POSTING "+posting);

				// Put the results in a div
			  	posting.done(function( data ) {
    				$("#contentMM").show();
                    var json = jQuery.parseJSON(data);
//                    console.log("ID "+json.id+", CASO "+json.ic);
//                    console.log("JSON VAR "+json);     
                    var casoActual = json.ic;
//console.log("CASO ACTUAL "+casoActual);                    
                    if(json.id == "3" && json.ic == "caso 1"){
						case1();
                    }
                    else if(json.id =="1" && json.ic == "caso 3.1"){
						case31();
                    }
					else if(json.id =="5" && json.ic == "caso 3.2"){
						case32();
                    }	
					else if(json.id =="NO" && json.ic == "caso 4"){
						case4();
                    }
                    else if(json.id =="NA" && json.ic == "caso 5"){
						case5();
                    }
                    else if(json.id =="2"){
						case2();
                    }
                    else{
						setTimeout(timeout(), 30000);
                    }
					directorio(marca,casoActual);
  				});
			}
        }
	});        
/*FORMULARIO MARCA MODELO */

/*FORMULARIO TELEFONO IMEI */
	$("#consulta_resultado_imei").click(function(e){
		if (e.isDefaultPrevented()) {
			//Invalid Form
  			e.preventDefault();
        } else {
        	e.preventDefault();
			if ( validar_celular( $("#numeroTelefonoPlaceholder") ) && validar_imei( $("#imeiPlaceholder") ) ) {
                var $form = $("#Form2");
				marca = marca;
                modelo = modelo;
			    number = $form.find( "input[name='number']" ).val();
				imei = $form.find( "input[name='imei']" ).val();  
			    url = "/bin/telcelcom/service/unblockdevice";
                contentType = "application/x-www-form-urlencoded; charset=UTF-8";
//				console.log("FORM "+$form);
//                console.log("NUMERO "+number);
//                console.log("IMEI "+imei);
//                console.log("URL "+url);
				// Send the data using post

				var posting = $.post( url, { marcaDesbloqueo: marca, modeloDesbloqueo: modelo, numeroTelefonoPlaceholder: number, imeiPlaceholder: imei } );
//                console.log("POSTING "+posting);

				// Put the results in a div
			  	posting.done(function(data) {
//console.log("DATA ORIGINAL "+data);
    				$("#resultado-imei").show();
					var textoError = jQuery.parseJSON(data);

                    if(textoError.DescripcionError === "Datos correctos")
                    {
//                        console.log("ENVIO SMS DATA "+textoError.EnvioSms);
//                        console.log("CODIGO ERROR DATA "+textoError.CodigoError);                        
                        if(textoError.EnvioSms == "SI")
                        {
//                            console.log("PRUEBA 1 "+textoError.EnvioSms);
                            $("#exito1").children("#msgExito").show();
                            $("#exito1").children("#msgNoExito").hide();                            
                            var formSteps = formatSteps(textoError.PasosDesbloqueo);    
                            var formRisks = formatRisks(textoError.RiesgosDesbloqueo);
							document.getElementById("unblock2").innerHTML = formSteps;
							document.getElementById("risks2").innerHTML = formRisks;                            
                            exito1();                         
    					}
						else if(textoError.EnvioSms == "NO")
                        {
//							console.log("PRUEBA 2 "+textoError.EnvioSms);
                            $("#exito1").children("#msgExito").hide();
                            $("#exito1").children("#msgNoExito").show();
                            var formSteps = formatSteps(textoError.PasosDesbloqueo);    
                            var formRisks = formatRisks(textoError.RiesgosDesbloqueo);
							document.getElementById("unblock2").innerHTML = formSteps;
							document.getElementById("risks2").innerHTML = formRisks;                              
                            exito1();
                        }    
					}   
                    else if(textoError.EnvioSms == "NO" && textoError.CodigoError == -2 || textoError.EnvioSms == "NO" && textoError.CodigoError == -1)
                    {
						var formSteps2 = formatSteps(textoError.PasosDesbloqueo);    
						var formRisks2 = formatRisks(textoError.RiesgosDesbloqueo);    
                        document.getElementById("unblock1").innerHTML = formSteps2;
                        document.getElementById("risks1").innerHTML = formRisks2;                        
						error1();
                    }
					else if(textoError.EnvioSms == "NO" && textoError.CodigoError == -9)
					{
						var formSteps3 = formatSteps(textoError.PasosDesbloqueo);    
						var formRisks3 = formatRisks(textoError.RiesgosDesbloqueo);    
                        document.getElementById("unblock3").innerHTML = formSteps3;
                        document.getElementById("risks3").innerHTML = formRisks3;                        
                        $("#minusNine").show();
						error2();
					}
                    else
                    {
						$("#timeout").show();
					}    

				});
			}
        }
	});
/*FORMULARIO TELEFONO IMEI */



    $(document).on('mundotelcel.unblockingdevices', '.xk-unblockingdevices', function() {
        $.ajax({
            url:'/bin/telcelcom/worldtelcel/unblockbrand?correlative=true',
            type: 'POST',
            dataType: 'json',
            success: function(json){
              var _len = json.length;
              var post, i;

              for (i = 0; i < _len; i++) {
                //debugger
                post = json[i];
//                console.log("VALUE "+ post.value);
//                console.log("TEXT "+ post.text);
                $("#marcaDesbloqueoDes").append("<option value="+post.value+">"+post.text+"</option>").trigger('chosen:updated');  
              }
            }
        });
		loadPage();
    });

	function chose_get_value_select(select){
		return $(select).val();
	}

	function chose_get_text_select(select){
		return $(select+" option:selected").text();
	}

	function chose_set_text_select(select, value){
  	  	$(select).attr('value',value);
  		$(select).trigger("chosen:updated");
  	}

	function loadPage(){
		$("#contentMM").hide();
        $("#resultado-imei").hide();    

        $("#caso1").hide();
        $("#caso2").hide();
        $("#caso31").hide();
        $("#caso32").hide();
        $("#caso4").hide();
        $("#caso5").hide();
        $("#error1").hide();    
        $("#exito1").hide();    
        $("#error2").hide();    
        $("#timeout").hide();

        $("#directorio").hide();   
        $("#case4PDF").hide();  

		$("#msgExito").hide;
		$("#msgNoExito").hide;

		$("#minusNine").hide();                        
		$("#minusFive").hide();   
	}

	function case1(){
		$("#caso1").show();
		$("#caso2").hide();
		$("#caso31").hide();
		$("#caso32").hide();
		$("#caso4").hide();
		$("#caso5").hide();
        $("#error1").hide();    
		$("#exito1").hide();  
        $("#error2").hide();
		$("#timeout").hide(); 

		$("#directorio").show();
    }

	function case2(){
		$('#numeroTelefonoPlaceholder').val("");
		$('#imeiPlaceholder').val("");        

		$("#caso1").hide();
		$("#caso2").show();
		$("#caso31").hide();
		$("#caso32").hide();
		$("#caso4").hide();
		$("#caso5").hide();
        $("#error1").hide();    
		$("#exito1").hide();  
        $("#error2").hide();   
		$("#timeout").hide(); 
    }

	function case31(){
		$("#caso1").hide();
		$("#caso2").hide();
		$("#caso31").show();
		$("#caso32").hide();
		$("#caso4").hide();
		$("#caso5").hide();
        $("#error1").hide();    
		$("#exito1").hide();
        $("#error2").hide();   
		$("#timeout").hide();        
    }

	function case32(){
		$("#caso1").hide();
		$("#caso2").hide();
		$("#caso31").hide();
		$("#caso32").show();
		$("#caso4").hide();
		$("#caso5").hide();
        $("#error1").hide();    
		$("#exito1").hide(); 
        $("#error2").hide();   
		$("#timeout").hide(); 

		$("#directorio").show();
    }

	function case4(){
		$("#caso1").hide();
		$("#caso2").hide();
		$("#caso31").hide();
		$("#caso32").hide();
		$("#caso4").show();
		$("#caso5").hide();
        $("#error1").hide();    
		$("#exito1").hide();  
        $("#error2").hide();     
		$("#timeout").hide();    
    }

	function case5(){
		$("#caso1").hide();
		$("#caso2").hide();
		$("#caso31").hide();
		$("#caso32").hide();
		$("#caso4").hide();
		$("#caso5").show();
        $("#error1").hide();    
		$("#exito1").hide();
        $("#error2").hide();     
		$("#timeout").hide();   
    }

	function error1(){
		$("#caso1").hide();
		$("#caso2").show();
		$("#caso31").hide();
		$("#caso32").hide();
		$("#caso4").hide();
		$("#caso5").hide();        
		$("#error1").show();
		$("#exito1").hide();
        $("#error2").hide();   
		$("#timeout").hide();  

		$("#directorio").show();
		$("#case4PDF").hide(); 
    }

	function exito1(){
		$("#caso1").hide();
		$("#caso2").show();
		$("#caso31").hide();
		$("#caso32").hide();
		$("#caso4").hide();
		$("#caso5").hide();
		$("#error1").hide();
		$("#exito1").show();
        $("#error2").hide();    
		$("#timeout").hide();  

		$("#directorio").show();
		$("#case4PDF").hide();         
    }

	function error2(){
		$("#caso1").hide();
		$("#caso2").show();
		$("#caso31").hide();
		$("#caso32").hide();
		$("#caso4").hide();
		$("#caso5").hide();
		$("#error1").hide();
		$("#exito1").hide();
        $("#error2").show(); 
		$("#timeout").hide(); 

		$("#directorio").show();
		$("#case4PDF").hide();         
    }

	function timeout(){
		$("#contentMM").show();

		$("#caso1").hide();
		$("#caso2").hide();
		$("#caso31").hide();
		$("#caso32").hide();
		$("#caso4").hide();
		$("#caso5").hide();
		$("#error1").hide();
		$("#exito1").hide();
        $("#error2").hide(); 
		$("#timeout").show();    
    }

	function validar_celular( elemento ){
        if( elemento.val() == "" ){
            elemento.closest('.form-group').addClass('has-error');
            elemento.closest('.form-group').find('.help-block').removeClass('hide');
            elemento.closest('.form-group').find('.help-block').html('Es necesario ingresar el número de teléfono.'); 
        }
        else if( elemento.val() != "" ){
            if( elemento.val().length != 10 ){
                elemento.closest('.form-group').addClass('has-error');
                elemento.closest('.form-group').find('.help-block').removeClass('hide');
                elemento.closest('.form-group').find('.help-block').html('El formato del teléfono no es correcto.'); 
                return false;
            }
            else if( ! $.isNumeric( elemento.val() ) ){
                elemento.closest('.form-group').addClass('has-error');
                elemento.closest('.form-group').find('.help-block').removeClass('hide');
                elemento.closest('.form-group').find('.help-block').html('El formato del teléfono no es correcto, debe contenener solo números.'); 
                return false;
            }else{
                elemento.closest('.form-group').removeClass('has-error');
                elemento.closest('.form-group').find('.help-block').addClass('hide');
                return true;
            }
        }    
    }

    function validar_captcha(){
        if(grecaptcha.getResponse().length == 0){
			$('.error-captcha').removeClass('hide');
			$('.error-captcha').html('Por favor ingresa el Captcha.');             
			return false;
        }else{
            $('.error-captcha').addClass('hide');
            return true;
        }
    }

	function validar_marca( elemento ){
        if ( elemento.val() == "" ){
            elemento.closest('.form-group').addClass('has-error');
            elemento.closest('.form-group').find('.help-block').removeClass('hide');
            elemento.closest('.form-group').find('.help-block').html('Es necesario seleccionar la marca de tu equipo.');     
            return false;
        }else{
            elemento.closest('.form-group').removeClass('has-error');
            elemento.closest('.form-group').find('.help-block').addClass('hide');        
            return true;
        }     
    }

    function validar_modelo( elemento ){
        if ( elemento.val() == "" ){
            elemento.closest('.form-group').addClass('has-error');
            elemento.closest('.form-group').find('.help-block').removeClass('hide');
            elemento.closest('.form-group').find('.help-block').html('Es necesario seleccionar el modelo de tu equipo.');     
            return false;
        }else{
            elemento.closest('.form-group').removeClass('has-error');
            elemento.closest('.form-group').find('.help-block').addClass('hide');
            return true;
        }     
    }

    function validar_imei( elemento ){
        if( elemento.val() == "" ){
            elemento.closest('.form-group').addClass('has-error');
            elemento.closest('.form-group').find('.help-block').removeClass('hide');
            elemento.closest('.form-group').find('.help-block').html('Es necesario ingresar el IMEI al que se enviará el mensaje.'); 
        }
        else if( elemento.val() != "" ){
            if( elemento.val().length != 15 ){
                elemento.closest('.form-group').addClass('has-error');
                elemento.closest('.form-group').find('.help-block').removeClass('hide');
                elemento.closest('.form-group').find('.help-block').html('El formato del IMEI no es correcto.'); 
                return false;
            }
            else if( ! $.isNumeric( elemento.val() ) ){
                elemento.closest('.form-group').addClass('has-error');
                elemento.closest('.form-group').find('.help-block').removeClass('hide');
                elemento.closest('.form-group').find('.help-block').html('El formato del IMEI no es correcto, debe contenener solo números.'); 
                return false;
            }else{
                elemento.closest('.form-group').removeClass('has-error');
                elemento.closest('.form-group').find('.help-block').addClass('hide');
                return true;
            }
        }    
    }

    function doSelectReset(select){
        $(select).empty();
        $(select).append($('<option></option>')).trigger('chosen:updated');
    }

    function formatSteps(text) {

        var arr = text.split("|");
        var size = arr.length;
		var html = "";
		var res = "";
        var number = 0;

        for(var i=0;i<=size-1;i++){
            number = i + 1;
//console.log("ARR ANT "+arr[i]);

			if(arr[i].match(/^[0-9]./gi)){
                arr[i] = arr[i].replace(/^[0-9]./gi, "<li><span>"+number+"</span><div class='h4'>");
//                console.log("NUMBER 4 "+arr[i]);
            }

			if(arr[i].match(/^[0-9]../gi)){
                arr[i] = arr[i].replace(/^[0-9]../gi, "<li><span>"+number+"</span><div class='h4'>");
//                console.log("NUMBER 2 "+arr[i]);
            }

			if(arr[i].match(/^.[0-9]./gi)){
                arr[i] = arr[i].replace(/^.[0-9]./gi, "<li><span>"+number+"</span><div class='h4'>");
//                console.log("NUMBER 3 "+arr[i]);
            }

			html += arr[i];
//            console.log("ARR DES "+arr[i]);
        }
        return html;
    }

    function formatRisks(text) {

        var arr = text.split("|");
        var size = arr.length;
		var html = "";
		var res = "";
        var number = 0;

        for(var i=0;i<=size-1;i++){
            number = i + 1;
			if(arr[i].match(/^/gi)){
                arr[i] = arr[i].replace(/^/gi, "<li>");
            }
			html += arr[i];
        }
        return html;
    }

    function directorio(brand,caso){
        var pathArray = window.location.pathname.split( '.' );
//        console.log(pathArray[0]);
        var directorio = pathArray[0] + "/jcr:content/mainPar/unblockingdevices/brandsContent.json";
//        console.log(directorio);
        $.getJSON(directorio, function(data) {
            $.each(data, function(key, value){
                valor=value;
            })
            $.each(valor, function(id, valores){
//                console.log("ID "+id);
//                console.log("VALORES "+valores);                
                var obj = JSON.parse(valores);
//					console.log("BRANDTITLE "+obj.brandTitle);
//					console.log("BRANDICON "+obj.brandIcon);
//					console.log("SUPPORTTEXT "+obj.supportText);
//					console.log("CASE4PDF "+obj.case4PDF);   

                    if(obj.brandTitle == marca){
//console.log("CASO ACTUAL DIVS "+caso);
//console.log("CASE4PDF "+obj.case4PDF);                        
                        if(obj.case4PDF != null && caso == "caso 4"){
//                            console.log("CASO 4");
                            var brandDataCase41 = "<img data-original="+obj.brandIcon+" src="+obj.brandIcon+" alt="+marcaTxt+"><noscript>&lt;img src="+obj.brandIcon+" alt="+marcaTxt+" class='lazyLoad'/&gt;</noscript>";
                            var brandDataCase42 = "<a href="+obj.case4PDF+" target='_blank' class='btn btn-primary top-push half btn-lg btn-block'>Descargar PDF</a>";
                            document.getElementById("brandDataCase41").innerHTML=brandDataCase41;
                            document.getElementById("brandDataCase42").innerHTML=brandDataCase42;
							$("#directorio").hide();
							$("#case4PDF").show(); 
                        }
                        else if(caso == "caso 1" || caso == "caso 3.1" || caso == "caso 3.2")
                        {
//							console.log("COINCIDEN");
                            var brandData1 = "<img data-original="+obj.brandIcon+" src="+obj.brandIcon+" alt="+marcaTxt+"><noscript>&lt;img src="+obj.brandIcon+" alt="+marcaTxt+" class='lazyLoad'/&gt;</noscript>";
                            var brandData2 = obj.supportText;
                            document.getElementById("brandData1").innerHTML=brandData1;
                            document.getElementById("brandData2").innerHTML=brandData2;
							$("#directorio").show();
							$("#case4PDF").hide();                             
						}
						else if(caso == "caso 2")
                        {
//							console.log("COINCIDE CASO 2");
                            var brandData1 = "<img data-original="+obj.brandIcon+" src="+obj.brandIcon+" alt="+marcaTxt+"><noscript>&lt;img src="+obj.brandIcon+" alt="+marcaTxt+" class='lazyLoad'/&gt;</noscript>";
                            var brandData2 = obj.supportText;
                            document.getElementById("brandData1").innerHTML=brandData1;
                            document.getElementById("brandData2").innerHTML=brandData2;
						}
						return false;
                    }
                    else
                    {
//                        console.log("NO COINCIDEN");
                        $("#brandData1").empty();
                        $("#brandData2").empty();                    
                        $("#directorio").hide();  
						$("#case4PDF").hide();    
                        return true;
                    }
           })
        });
    }
$(document).ready(function(){
    $('.xk-operatorsbycountry').trigger('mundotelcel.operatorsbycountry');
});

var componentPath = "";
$(document).on('mundotelcel.operatorsbycountry', '.xk-operatorsbycountry', function() {
    var obj = $('.xk-operatorsbycountry #country');
    componentPath = $('.xk-operatorsbycountry .country-selection').attr('data-componentpath');
    console.log("Path "+ componentPath);
	var servicepath = componentPath+".operators.f_country=all.json";
	console.log("servicePath "+servicepath);
    if(componentPath){
    	$.getJSON(servicepath, function (response) {
    		obj.find('option:not(:eq(0))').remove();
        	$.each(response, function (key, val) {
	        	obj.append('<option value="' + val.country + '">' + val.country + '</option>');
        	});
        	obj.trigger('chosen:updated');
    	});
    }
});


$(function() {
	$("#btnSearch").click( function(){
		var objResult = $('.xk-operatorsbycountry .xk-operatorsbycountry-result');
		var countrySelected = $('.xk-operatorsbycountry #country').val();
		if(countrySelected != ""){
			var servicepath = componentPath+".operators.f_country="+countrySelected+".json";
			console.log("servicePath "+servicepath);
            if(componentPath){
				$.getJSON(servicepath, function (response) {
					var opers = "";
					$.each(response, function (key, val) {
						opers = opers + val.operator + "<br>";
        	    	});
					$('.xk-operatorsbycountry .xk-countrySelected').html(countrySelected);
                	$('.xk-operatorsbycountry .xk-landnat').html(opers);
        		});
				objResult.show('fast');
            }
        }
    });
});

$('#formOperators').submit(function () {
	return false;
});

$("#printPlanDetailBtn").click(function(event){ // printDeviceSummary
	html2canvas($(this).closest('.xk-operatorsbycountry-result'), { //list-plans #contentDetailPlan
    height:12000,
    onrendered: function(canvas) {
   		var mywindow = window.open('', '', 'height=12000,width=800');
    	if(mywindow){
    		mywindow.document.write('<html><head><title></title>');
        	mywindow.document.write('</head><body>');
        	mywindow.document.body.appendChild(canvas);
        	mywindow.document.write('</body></html>');
        	mywindow.print();
        	mywindow.close();
        } else {
 		   	alert("El navegador no puede abrir ventanas emegentes.");
		}
    }
    });
});
$(document).ready(function(){
    $('.xk-js-news-carrusel').trigger('news.carrusel');
});


$(document).on('news.carrusel', '.xk-js-news-carrusel', function() {

    $(".xk-js-news-carrusel #carrusel-noticias").owlCarousel({
        navigation : true, // Show next and prev buttons
        slideSpeed : 300,
        paginationSpeed : 400,
        loop: true,
        center: true,
        HoverPause: true,
        navigation: true,
        singleItem:true,
           navigationText: [
        "<i class='icon-SliderLeft'></i>",
        "<i class='icon-SliderRight'></i>"

        ]

        // "singleItem:true" is a shortcut for:
        // items : 1,
        // itemsDesktop : false,
        // itemsDesktopSmall : false,
        // itemsTablet: false,
        // itemsMobile : false

    });
});



$(document).ready(function(){
		chose_get_country('#banner_idiomas_country');
		$("#banner_idiomas_country").attr('disabled', false).trigger("chosen:updated");
  		$('#banner_idiomas_country').change(function(){
			window.location.replace(chose_get_value_country('#banner_idiomas_country') + '.html');
  	  	});

   	});

  	function chose_get_country(select){
  		$(select).chosen().change(function(){$(select).trigger("chosen:updated");});
  	}

  	function chose_get_value_country(select){
  	  	return $(select).val();
  	}

  	function chose_get_text_country(select){
  	  	return $(select+" option:selected").text();
  	}
/*Gallery in news*/
	$('body').on('mundotelcel.imagescarousel', '.js-mundotelcel-imagescarousel', function(e, target) {

    var sync1 = $(".js-gallery-images");
    var sync2 = $(".js-gallery-thumbs");

    sync1.owlCarousel({
        singleItem : true,
        slideSpeed : 1000,
        navigation: true,
        pagination:false,
        afterAction : syncPosition,
        responsiveRefreshRate : 200,
        lazyLoad : true,
        navigationText: ['<i class="icon-SliderLeft"></i>', '<i class="icon-SliderRight"></i>']
    });
    sync2.owlCarousel({
        items : 6,
        itemsDesktop : [1199,6],
        itemsDesktopSmall : [979,5],
        itemsTablet : [768,6],
        itemsTablet : [650,5],
        itemsMobile : [479,2],
        pagination:false,
        responsiveRefreshRate : 100,
        afterInit : function(el){
            el.find(".owl-item").eq(0).addClass("synced");
        }
    });

    function syncPosition(el){
        var current = this.currentItem;

        $("#sync2")
            .find(".owl-item")
            .removeClass("synced")
            .eq(current)
            .addClass("synced")
        if($("#sync2").data("owlCarousel") !== undefined){
            center(current)
        }
    }

	$(document).on("click", ".owl-item", function(e){
    	e.preventDefault();
		$(".owl-item").removeClass("synced");
        $(this).addClass("synced");        
        var number = $(this).data("owlItem");
        sync1.trigger("owl.goTo",number);
    });

    function center(number){
        var sync2visible = sync2.data("owlCarousel").owl.visibleItems;
        var num = number;
        var found = false;
        for(var i in sync2visible){
            if(num === sync2visible[i]){
                var found = true;
            }
        }

        if(found===false){
            if(num>sync2visible[sync2visible.length-1]){
                sync2.trigger("owl.goTo", num - sync2visible.length+2)
            }else{
                if(num - 1 === -1){
                    num = 0;
                }
                sync2.trigger("owl.goTo", num);
            }
        } else if(num === sync2visible[sync2visible.length-1]){
            sync2.trigger("owl.goTo", sync2visible[1])
        } else if(num === sync2visible[0]){
            sync2.trigger("owl.goTo", num-1)
        }
    }
        });

    $(document).ready(function(){ $('.js-mundotelcel-imagescarousel').trigger('mundotelcel.imagescarousel'); });

//console.log("howToDial.js loaded");
/*
 * Trigger the 'mundotelcel.howtodial' event when the page has been loaded.
 */
$(document).ready(function(){
    $('.xk-howtodial').trigger('mundotelcel.howtodial');
});


/*
 * Add the 'mundotelcel.howtodial' event to the '.xk-howtodial' section
 * and initialize component's data.
 */
$(document).on('mundotelcel.howtodial', '.xk-howtodial', function() {
    var obj = $('.xk-howtodial #state');
    var serviceUrl = "/bin/telcelcom/mundotelcel/dialstates.json";
    fillComboHowToDial(serviceUrl, obj, 1);
});

/*
* Add states combobox functionallity
 */
$(document).on('change', '.xk-howtodial #state', function() {

    var obj = $('.xk-howtodial #city');
    var btn = $('.xk-howtodial .xk-searchButton');

    if ($(this).val() != "") {
        var serviceUrl = "/bin/telcelcom/mundotelcel/dialstates.state=" + $(this).val() + ".go.json";

        fillComboHowToDial(serviceUrl, obj, 2);

        //able/disable cities combobox and search button
        obj.removeAttr("disabled");
        obj.trigger('chosen:updated');
        btn.attr("disabled", "disabled");
    }
});

/*
 * Add cities combobox functionallity
 */
$(document).on('change', '.xk-howtodial #city', function(){
    $('.xk-howtodial .xk-searchButton').removeAttr("disabled");
});

/*
 * Add search button functionallity
 */
$(document).on('click', '.xk-howtodial .xk-searchButton', function(){
    var objCity = $('.xk-howtodial #city');
    if (objCity != null) {
        $(".xk-howtodial-spin").spin('largeSpin');
        var serviceUrl = "/bin/telcelcom/mundotelcel/dialstates.city=" + objCity.val() + ".go.json";
        $.getJSON(serviceUrl, function (response) {
            if (response.success == "true") {
                if (response.data.length > 0) {
                    var objResult = $('.xk-howtodial .xk-howtodial-result');
                    var dial = response.data[0].marcacion;
                    objResult.hide();
                    $('.xk-howtodial .xk-dialcode span').html(dial);
                    objResult.show('fast');
                }
            }
            $(".xk-howtodial-spin").spin(false).stop();
        });
    }
    return false;
});

/*
* Fill states or cities comboboxes getting the data from a service
 */
function fillComboHowToDial(serviceUrl, obj, type) {
    if (obj != null && serviceUrl != "") {
        //console.log("howtodial - service:" + serviceUrl);
        $.getJSON(serviceUrl, function (response) {
            if (response.success == "true") {
                obj.find('option:not(:eq(0))').remove();
                if (type == 1) {
                    $.each(response.data, function (key, val) {
                        obj.append('<option value="' + val.idEstado + '">' + val.estado + '</option>');
                    });
                } else if (type == 2) {
                    $.each(response.data, function (key, val) {
                        obj.append('<option value="' + val.idCiudad + '">' + val.ciudad + '</option>');
                    });
                }
                obj.trigger('chosen:updated');
            }
        });
    }
}
angular.module("telcelApp")
.controller("compareControllerSim", ['$window','$scope','$attrs' ,'$http', function($window, $scope,$attrs, $http) {

    /*
        Chip vars
    */
    $scope.versions = [];
    $scope.versionSelected = [0, 0];
    $scope.chips = [{}, {}];

    /*
        Change version
    */

    $scope.changeVersion = function(i) {
        var d = new Date();
        $http.get($attrs.componentpath + ".compareSIM.f_version="+ $scope.versionSelected[i] + ".go.json?v="+ d.getTime()).
            success(function(data, status, headers, config) {
                $scope.chips[i] = data;
            });
    };


    /*
        Load versions
    */
    $http.get($attrs.componentpath + ".compareSIM.f_versions=all.json").
        success(function(data, status, headers, config) {
            //$scope.versions = data;
            $(".xk-versions").each(function(){  
                var obj = $(this);
                $.each(data, function(j, item){
                    obj.append("<option value='" + item.name.replace(" ","_").replace(".","-") + "'>" + item.name + "</option>");
                });                                
				obj.children('option:first').remove();
            });
            $(".xk-versions").trigger('chosen:updated');

        });		

}]);

$(function(){
 var compileAngular = function($element){
     if ($element.length) {
         var $injector = angular.injector(['ng', 'telcelApp']);
         $injector.invoke(['$rootScope','$compile',function ($rootScope, $compile) {
             $compile($element[0])($rootScope);
         }]);
     }
 };

    //Apply angular compile
    $('body').on('support.simcompare','.js-support-simcompare', function (e) {
        compileAngular($(e.target));
    });
});
angular.module("telcelApp")
.controller("comparePlanesController", ['$window','$scope','$attrs' ,'$http', function($window, $scope,$attrs, $http) {

    /*
        Planes vars
    */
    $scope.versions = [];
    $scope.versionSelected = [0, 0];
    $scope.conceptos = {};

    function formatConcepto(concepto) {
        switch(concepto.tipoValor.id) {
            case 1:
                return $scope.getPriceFormat(concepto.valor, $attrs.currencysymbol);
            case 7: //boolean
                return concepto.valor == "true" ? "Si" : "No";
            default:
                return concepto.valor;
        }
    }


    $scope.loadModalContent = function( tooltip ){
        $("#modalAyuda .modal-msg").html(tooltip);
    };

    /*
        Change version
    */

    $scope.changeVersion = function(i) {
        var d = new Date();

        $http.get($attrs.componentpath + ".compare.f_plan=" + $scope.versionSelected[i] + ".go.json?bustcache=true").
            success(function(data, status, headers, config) {
                //clean before add new data in the current index
                for (var key in $scope.conceptos)
                {
                    $scope.conceptos[key].valores[i] = '';
                }

                for (var key in data.data[0].conceptos)
                {
                    var objConcepto = data.data[0].conceptos[key];
                    if ($scope.conceptos[key] == undefined)
                    {
                        $scope.conceptos[key] = {
                            name : objConcepto.concepto,
                            orden : objConcepto.orden,
                            valores : {
                                0 : '',
                                1 : ''
                            },
                            tooltip : objConcepto.condicion
                        };
                    }

                    $scope.conceptos[key].valores[i] = formatConcepto(objConcepto);
                }

                //cleaning
                for (var key in $scope.conceptos)
                {
                    var clear = true;
                    for (var k in $scope.conceptos[key].valores)
                    {
                        if ($scope.conceptos[key].valores[k] != '')
                        {
                            clear = false;
                        }
                    }

                    if (clear)
                    {
                        delete $scope.conceptos[key];
                    }
                }

            });
    };


    /*
     Load versions and first parameter
     */
    $scope.load = function(familyPlan, plan) {

    	//get Region
        var region = $.cookie("telcelcom_region");
        if ((typeof region === 'undefined') || region === "") {
            region = 9;
        }


        $http.get($attrs.componentpath +".compare.f_familyPlan=" + familyPlan + ".f_region=" + region +".go.json?bustcache=true").
            success(function(data, status, headers, config) {
                $scope.versions = data.planes;
                $scope.grupoPlan = data.grupoPlan;
            });


        if (typeof plan != 'undefined') {
        	$scope.versionSelected[0] = plan;
            $scope.changeVersion(0);
        }     

    };


    //return to before page
    $scope.doTheBack = function() {
        window.history.back();
    };

    //get Price Format
    $scope.getPriceFormat = function(price, symbol){
        var valor = "";
        if (typeof price === 'undefined' || price === ""){
            return "";
        }
        var sub = price.indexOf('.');
        if(sub > 0){
            valor = symbol + price;
        } else {
            price = parseInt(price);
        	price = !angular.isUndefined(price)&&angular.isNumber(price)?price:0.00;
        	valor = symbol + " " + price.toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g, "$1,");
        }

       return valor;
    };


	//Selectors
    $scope.getSelectors= function(){
        var pathArray = window.location.pathname.split( '/' );
        var lastLevelLocation = pathArray[pathArray.length-1];
        var levelArray = lastLevelLocation.split('.');
        levelArray.splice(levelArray.length-1,1);
        levelArray.splice(0,1);
        return levelArray;
    };

    var selectors = getSelectors();
    if (selectors !== null && selectors.length > 0){
        var familyPlan = selectors[0].split("=")[1];
        var plan;
        if (selectors.length > 1) {
        	plan = selectors[1].split("=")[1];
        }
        $scope.load(familyPlan, plan);
    }


}]).directive('resizablecompareplan',['$window', function($window) {
       return function($scope) {
           /*
               Set template with resolution
           */
           $scope.setCompareTemplate = function() {
            
               if($window.innerWidth >= 768) {
                   $scope.compareTemplate = 'compare-desktop-template.html';
               } else {
                   $scope.compareTemplate = 'compare-mobile-template.html';
               }
           };

           // Initialize compareTemplate
           $scope.setCompareTemplate();

           return angular.element($window).bind('resize', function() {
              $scope.setCompareTemplate();
              return $scope.$apply();
           });
       };
}]).filter('orderByPlansCompare', function() {
    return function(items, reverse) {
        var filtered = [];
        
        angular.forEach(items, function(item) {
            filtered.push(item);
        });

        filtered.sort(function (a, b) {
            return (parseInt(a.orden) > parseInt(b.orden))? 1: -1;
        });

        if(reverse) filtered.reverse();

        return filtered;
    };
});
angular.module("telcelApp")
.controller("generalSearchController", ['$scope','$window','$attrs','$http','$location', function($scope, $window, $attrs, $http, $location) {

    var defaults = { spin: 'defaultSpin' };
    var settings = $.extend( {}, defaults );
    var  loader = $('<div/>', {
         'class': 'spinner-holder clear'
         }).css({'position':'relative','margin':'0 auto', 'top':'60px'});

    //default values
    $scope.parametro = "";
    $scope.searchText = "";
    $scope.currentPage = 0;
    
    //categories
    $scope.categoria_seleccionada = -1;
    $scope.categoria_seleccionada_submenu = 0;
    $scope.categorias = $scope.$eval($attrs.categories);
    $scope.lista_1 = [];
    $scope.lista_2 = [];

    $scope.rango = [];
    $scope.valor_inicial = 0;
    $scope.valor_final = 0;

    //messages
    $scope.busqueda_realizada = $attrs.titulo;
    $scope.hemos_encontrado = $attrs.subtitulo1;
    $scope.articulos_interesarte = $attrs.subtitulo2;
    $scope.mensaje_error = $attrs['attrMensajeError'];

    angular.forEach( $scope.categorias, function( categoria,index ) {
        if( index <= 4 ) {
            $scope.lista_1.push( categoria );
        } else {
            $scope.lista_2.push( categoria );
        }
    });



    $scope.cambiar_categoria = function(categoria,submenu){
        $scope.categoria_seleccionada = categoria.id;
        $scope.currentPage = 0;

        if( submenu ){
            $scope.categoria_seleccionada_submenu = 1;
            
            var tmp_id = $scope.lista_1[4].id;
            var tmp_nombre = $scope.lista_1[4].name;

            angular.forEach( $scope.lista_2 , function( cat,index ){
                if( cat.id === categoria.id ){
                    $scope.lista_1[4].id = $scope.lista_2[index].id;
                    $scope.lista_1[4].name = $scope.lista_2[index].name;
                    $scope.lista_2[index].id = tmp_id;
                    $scope.lista_2[index].name = tmp_nombre;
                }
            });

        } else {
            $scope.categoria_seleccionada_submenu = 0;
        }

        currentPage = 1;
        $scope.buscar();
    };


    $scope.avanzar = function(pagesNumber){
        if ($scope.currentPage < pagesNumber ) {

            $scope.currentPage=$scope.currentPage + 1;

            if( $scope.valor_final <= pagesNumber ){
               $scope.valor_inicial++;
               $scope.valor_final++;
            }

        }
        $window.scrollTo(0,0)

    }

    $scope.retroceder = function(){
        if ($scope.currentPage > 0 && $scope.valor_inicial > 0 ) {
            $scope.currentPage=$scope.currentPage - 1;

            if( $scope.valor_inicial != 1 ){
                $scope.valor_inicial --;
                $scope.valor_final --;
            }

        }
        $window.scrollTo(0,0)

    }

    $scope.ir = function(pagina){
        $scope.currentPage=pagina;
        $window.scrollTo(0,0)
    }



    $scope.buscar = function(){

        loader.appendTo($('.has-loader')).spin(settings.spin);

        if( $scope.parametro == undefined ){ $scope.parametro = '' }
        //clean text parameter : remove all special characters
        $scope.parametro = $scope.parametro.replace(/[-'`~!@#$%^&*()_|+=?;:'",.<>\{\}\[\]\\\/]/gi, '');
        $scope.currentPage = 0;

        $http.get($attrs.componentpath +".query.f_cat="+ $scope.categoria_seleccionada + ".f_text=" + $scope.parametro + ".s.json").success (function(data) {

            $('.has-loader').find('.spinner-holder').spin(false);

            $scope.searchText = $scope.parametro;
            $scope.total = data.total;
            $scope.pageSize = $attrs['attrPageSize'];

            $scope.url = data.url;
            $scope.date = data.date;
            $scope.resultados = data.results;

            /*
            Seleccion de dos aleatorios unicos en recomendados
            */

            var numero_aleatorio = function( i , comparador ){

                var tmp = Math.floor((Math.random()*i));
                if( tmp != comparador ){ return tmp; }
                else{  return numero_aleatorio(i,comparador); }

            };


            var two_recommended;

            if (data.recommended != undefined && data.recommended.length > 1){

                var recomended1 = numero_aleatorio( data.recommended.length , 0 );
                var recomended2 = numero_aleatorio( data.recommended.length , recomended1 );

                two_recommended = [ data.recommended[recomended1], data.recommended[recomended2] ];

            }
            else if (data.recommended != undefined && data.recommended.length == 1){
                two_recommended = [ data.recommended[0] ];
            }
            else{ two_recommended = []; }

            /*
            Fin de creacion de dos aleatorios unicos para recomendados
            */


            $scope.recomendados = two_recommended;


            $scope.numeroPaginas = function() {
                return Math.ceil($scope.resultados.length/$scope.pageSize);
            };

            $scope.valor_inicial = 1;

            if( $scope.numeroPaginas() > 5 ){
                $scope.valor_final = 4;
            }else{
                $scope.valor_final = $scope.numeroPaginas();
            }

            $scope.range = function(min, max, step){
                step = 1;
                var input = [];
                for (var i = min; i <= max; i += step) input.push(i);
                return input;
            };


        });

    };

    //get parameter
    //Selectors
    $scope.getArraySelectors= function(){
        var pathArray = window.location.pathname.split( '/' );
        var lastLevelLocation = pathArray[pathArray.length-1];
        var levelArray = lastLevelLocation.split('.');
        levelArray.splice(levelArray.length-1,1);
        levelArray.splice(0,1);
        return levelArray;
    };

    $scope.getSelectors = function(nameSelector) {
        var selectors = $scope.getArraySelectors();
        var value = "";
        if (selectors !== null && selectors.length > 0) {
            for (index = 0; index < selectors.length; ++index) {
                var key = selectors[index].split("=");
                if (key.length > 1 && key[0] === nameSelector) {
                    value = key[1];
                    break;
                }
            }
        }
        return decodeURI(value);
    };


    $scope.checkIfEnterKeyWasPressed = function($event){
        var keyCode = $event.which || $event.keyCode;
        if (keyCode === 13) {
            $scope.buscar();
        }
    };

    $scope.query = $scope.getSelectors("f_text");
    //clean text: removed all special characters
    $scope.query = $scope.query.replace(/[-'`~!@#$%^&*()_|+=?;:'",.<>\{\}\[\]\\\/]/gi, '');
    if( $scope.query != ""){
        $scope.parametro = $scope.query;
        $scope.buscar();
    }


}]).filter('startFrom', function() {
    return function(input, start) {
        start = +start; //parse to int
        return input.slice(start);
    }
});
/**
 * Created by ptoc on 30/07/15.
 */
//console.log("PromotionGrid clientlib loaded");

/*
 * Call function that shows the grid.
 */
$(document).ready(function(){ 
	PromotionGridInit(); 
});

$('body').on('promotions.promotiongrid', '.xk-promotiongrid', function(e, target) {
    PromotionGridInit();
});

var promotionList = ""; 

/*
 * Initialize component.
 */
function PromotionGridInit() {
	/*
	 Get the "estado" and "region" values
	 */
	var estadoId = $.cookie("telcelcom_estado");
	if ((typeof estadoId === 'undefined') || estadoId === '' || estadoId === 'Selecciona tu Estado')
		estadoId = "Ciudad de México";

	var regionId = $.cookie("telcelcom_region");
	if ((typeof regionId === 'undefined') || regionId === '') { regionId = 9; }

	/*
	 Get the basic info for the grid.
	 */
	var promotionsPath = $(".xk-promotiongrid").eq(0).attr("data-promotionspath");
        var isAuthorMode= $(".xk-promotiongrid").eq(0).attr("data-authorMode");
	var itemsPerPage = $(".xk-promotiongrid").eq(0).attr("data-itemsperpage");
	var maxNumber = $(".xk-promotiongrid").eq(0).attr("data-maxnumber");
	if(maxNumber != null) {
		if (maxNumber != "" && maxNumber != "0") {
			maxNumber = parseInt(maxNumber);
		}
	}

	/*
	 show the promotions...
	 */
	if (promotionsPath != null) {
		promotionsPath = promotionsPath + ".context.list.json";
		//console.log(promotionsPath);
		$.getJSON(promotionsPath, function(data) {
			var i = 0;
			var cols = 1;
			var itemsInPage = 1;
			var oimg = document.getElementById('promoFeaturedBanner');            
			var html =  '<div class="xk-promotions-page">' +
						'	<ul class="row list-promociones xk-promotions-row" style="margin-bottom: 0px;">';

			if (maxNumber == 0 || maxNumber == "0") {
				maxNumber = data.pages.length;
			}

			$.each(data.pages, function(key, promoInfo) {
				if (promoInfo.promoRegion != null) {
					if (promoInfo.promoRegion.indexOf(regionId) >= 0 && i < maxNumber) {

						//Add the promotion to the row
						html = html + addPromotionItem(promoInfo, i+1,isAuthorMode);

						//If this is the third item then add the banner
						if(i == 2) {
							if(oimg != null){
                                html = html + addBanner('.xk-promotions-banner');
                            }
						}

						//If there are already 3 items in the row then use a new row
						/*if(cols >= 3) {
							//If the item doesn't exceed the page limit then use a new row
							if(!(itemsInPage >= itemsPerPage)) {
								html = html + '</ul><ul class="row  list-promociones xk-promotions-rows">';
							}
							cols = 0;
						}*/

						//If there are enough items in the page then use a new page and a new row
						if(itemsInPage >= itemsPerPage) {
							html = html + '</ul></div>' +
								'<div class="xk-promotions-page" style="display:none;">' +
								'	<ul class="row  list-promociones xk-promotions-row">';

							itemsInPage = 0;
						}
						
						promotionList = promotionList + "Promociones|" + (i+1) + "|Amigo|" + promoInfo.promoTitle + ","; 

						cols++;
						itemsInPage++;
						i++;
					}
				}
			});

			//add promotions pages and items to the grid...
			$(".xk-promotionscontent").html(html);

			//add pagination numbers...
			$(".xk-promotions-page").each(function(i){
				var rows = $(this).find('.xk-promotions-row').children();
				if (rows != null) {
					if (rows.length > 0) {
						var pageNumber = i + 1;
						var item = $('<li class="xk-promotion-pagenumber"><a href="#">' + pageNumber + '</a></li>');
						if (i == 0) {
							item.addClass("active");
						}
						$(item).insertBefore($(".xk-promotion-paginationlist .xk-promotion-pagenumber-next"));
					}
				}
			});

			//If there are less than 4 promotions then add the banner...
			var promotionRows = $(".xk-promotions-page .xk-promotions-row");
			if(i <= 3) {
                if(oimg != null){
					promotionRows.append(addBanner('.xk-promotions-banner'));
                }    
			}

            if ($(".xk-promotions-page").length <= 1) {
                $(".xk-promotion-paginationlist").hide();
            }

			//Apply the plugin again after the ajax call
			$('.xk-promotionscontent img.lazyLoad').show().lazyload();
			$('.js-mathcheight-item').matchHeight();
		}).done(function(){
			var scriptPromotion = document.createElement("script");
			scriptPromotion.innerHTML = getPromotionDlMetri();
			$("div.xk-promotiongrid").prepend(scriptPromotion);
		});
	}

	/*
	 show the state name...
	 */
	$(".xk-promotiongrid #textestado").html(estadoId);
	
}

/*
 * Page number that is NOT selected: select the page
 */
$(document).on("click", ".xk-promotion-pagenumber:not([class*='active']) a", function() {
	var obj = $(this).parent();
	if (obj != null) {
		var index = obj.index() - 1;
		selectPromotionsPage(index);
	}
	//return false;
});

/*
 * Prev Button
 */
$(document).on("click", ".xk-promotion-pagenumber-prev a", function() {
	var obj = $(".xk-promotion-pagenumber[class*='active']");
	if (obj != null) {
		var index = obj.index() - 1;
		if (index > 0) {
			//select the previous page...
			selectPromotionsPage(index - 1);
		}
	}
	//return false;
});

/*
 * Next Button
 */
$(document).on("click", ".xk-promotion-pagenumber-next a", function() {
	var obj = $(".xk-promotion-pagenumber[class*='active']");
	if (obj != null) {
		var index = obj.index() - 1;
		var pagesNumber = $(".xk-promotion-pagenumber").length-1;
		if (index < pagesNumber) {
			//select the next page...
			selectPromotionsPage(index + 1);
		}
	}
	//return false;
});

/*
 * Select a page.
 */
function selectPromotionsPage(i) {
	//show the selected page...
	var pagesList = $(".xk-promotions-page");
	pagesList.hide('fast');
	pagesList.eq(i).show('fast');

	//activate the selected number...
	var numbersList = $(".xk-promotion-pagenumber");
	numbersList.removeClass("active");
	numbersList.eq(i).addClass("active");

	//Validates prev and next button...

	//If it is the first page then hidde prev button and show the next button
	if (i == 0) {
		$(".xk-promotion-pagenumber-prev").hide();
		$(".xk-promotion-pagenumber-next").show();

	//If it is not the first page then show prev button
	} else if (i > 0) {
		$(".xk-promotion-pagenumber-prev").show();

		//If it is the last page then hide the next button
		var length = 0;
		if ($(".xk-promotion-pagenumber") != null) {
			length = $(".xk-promotion-pagenumber").length - 1;
			if (i == length) {
				$(".xk-promotion-pagenumber-next").hide();
			}
		}
	}
}

/*
* Returns the HTML of a promotion for the grid.
*/
function addPromotionItem(promoInfo, index,isAuthorMode) {
	var gridpromoImage = "";
	var promotitle = "";
	var shortDescription = "";
	var promotionpagepath = "";
	var startdate = "";
	var enddate = "";

	if (promoInfo.gridPromoImage != null) {
		gridpromoImage = promoInfo.gridPromoImage;
	}

	if (promoInfo.promoTitle != null) {
		promotitle = promoInfo.promoTitle;
	}

	if (promoInfo.shortDescription != null) {
		shortDescription = promoInfo.shortDescription;
	}

	if (promoInfo.promotionPagePath != null) {
		promotionpagepath = promoInfo.promotionPagePath;
	}

	if (promoInfo.startDate != null) {
		startdate = validateDate(promoInfo.startDate);
	}

	if (promoInfo.endDate != null) {
		enddate = validateDate(promoInfo.endDate);
	}
    if(isAuthorMode === "false"){
        if( promotionpagepath.startsWith("/content/telcel")){
            promotionpagepath = promotionpagepath.substring(15,promotionpagepath.length);
        }
        if(promotionpagepath.endsWith(".html")){
            promotionpagepath = promotionpagepath.replace(".html","");
        }
    }else{
        promotionpagepath = promotionpagepath+ '.html';
    }
	var html = '<li class="item col-sm-6 col-md-4 js-mathcheight-item hidden-media xk-promotion">' +
		'	<div class="inner">' +
		'		<img data-original="' + gridpromoImage + '" alt="Amigo Promos" class="lazyLoad" heightFix />' +
		'		<noscript><img data-src="' + gridpromoImage + '" alt="Amigo Promos" class="lazyLoad"/></noscript>' +
		'		<h4>' + promotitle + '</h4>' +
		'		<p class="text-medium">' + shortDescription + '</p>' +
		'		<a href="' + promotionpagepath + '" class="btn btn-contact btn-md"' +
					' data-titulo="Promociones|' + index + '|Amigo|' + promotitle + '" data-evento="clicBanner">' + $('#txtSeeMoreText').val() + '</a>' +
		'		<p class="note">' +
		'			Válida del ' + startdate + ' a ' + enddate +
		'		</p>' +
		'	</div>' +
		'</li>';
	return html;
}

/*
* Returns the HTML of the banner for the grid.
*/
function addBanner(bannerSelector) {
	return '<li class="item col-md-12 hidden-xsm">' + $(bannerSelector).html() + '</li>';
}

/*
*   Add a '0' when a number has 1 digit
*/
function validateDate(promoDate) {

    var newDate = promoDate;

    if (promoDate != null && promoDate != '' && promoDate != 'undefined') {

        var promoDateArr = promoDate.split('/');

        if (promoDateArr != null && promoDateArr.length > 0) {

            var day = promoDateArr[0];
            var month = promoDateArr[1];
            var year = promoDateArr[2];

            if (parseInt(day) < 10) {

                newDate = '0' + day + '/';

            } else {

                newDate = day + '/';

            }

            newDate = newDate + month + '/' + year;

        }

    }

    return newDate;

}

function getPromotionDlMetri(){
	var ecomPageName = "Telefonia|Amigo|Promociones";
	var regionId = getRegionFromCookie();
	var profile = getProfileFromCookie();
	var fecha = getDTMDate();
	var dispo = getBrowserResolution();
	var path = getBredcrum();
	var page = path.substr(path.lastIndexOf('|') + 1);
	var ecomListaPromociones = promotionList.substring(0, promotionList.length - 1);
	var dlMetri="var dlMetri={\n" +
			"'ecomPageName':'"+ecomPageName+"',\n" +
			"'ecomFecha':'"+fecha+"',\n" +
			"'ecomPerfil':'"+profile+"',\n" +
			"'ecomZona':'"+regionId+"',\n" +
			"'ecomDispo':'"+dispo+"',\n" +
			"'ecomSec':'"+page+"',\n" +
			"'ecomJerarquia':'"+path+"',\n" +
			"'ecomEvento':'promociones',\n" +
			"'ecomListaPromociones':'"+ecomListaPromociones+"'\n" +
		"}\n";
	return dlMetri;
}
var captcha3;

$(document).ready(function(){ 
    CaptchaInit();

    $(".promobtn").click(function (e){
        e.preventDefault();
        var target=$("#callToActionUrlAnchor").data("target");
        var url=$("#callToActionUrlAnchor").data("callToActionUrl");
        if($(this).data("callToActionUrlMobile") && $(this).data("callToActionUrlMobile").trim().length > 0){
            url=$(this).data("callToActionUrlMobile");
        }
        if(target === "newTab"){
        	window.open(url, target);
        } else {
        	var width=$("#callToActionUrlAnchor").data("width");
            var height=$("#callToActionUrlAnchor").data("height");
        	window.open(url, target, "height=" + height + " , width=" + width);
        }
    });
    
    var scriptPromotion = document.createElement("script");
	scriptPromotion.innerHTML = getPromoDetailDlMetri();
	$("div.dtmClassPromo").prepend(scriptPromotion);
});

function CaptchaInit() {

	recaptchaVal();
    var recaptchaResponse = $("#g-recaptcha-response-2");
    if(recaptchaResponse) {

        if (recaptchaResponse.val() != null) {
            var val = recaptchaResponse.val().trim();
            $.post("/bin/telcelcom/noncacheable/cwhataptcha/check?secret=6LeN3wETAAAAAD6oYRJVBpRYHqTauNJGjJj_CIWR&response=" + val, function (data) {
                if (data !== null) {
                    $("#buttonForm").html("<button type=̣\"submiṭ\" class=̣\"btn btn-primary btn-xtrawidth btn-lg̣\">{%global.sendFormText%}</button>");
                    $('#captcha3').remove();
                } else {
                    $("#captcha3").html("<h4 class=\"text-center\"><i class=\"icon-NoEntry\"></i>  Captcha no válido " +
                        "<br> <a href=\"" + window.location + "\"> Regresar </a></h4>");
                }
            })
        }
    
    } else {
        $( "#captcha4" ).html("<h4 class=\"text-center\"><i class=\"icon-NoEntry\"></i>  Captcha no válido " +
            "<br> <a href=\""+window.location+"\"> Regresar </a></h4>");
    }


}

var siteKeyRe = "6LeN3wETAAAAAK79CxVseevXwpGjgsFQwz2GBy1P";

function recaptchaVal() {
    if(document.getElementById('captcha3') !== null) {
        captcha3 = grecaptcha.render('captcha3', {
            'sitekey': siteKeyRe,
            'theme': 'light'
        });
    }
}

function getPromoDetailDlMetri(){
	var promoName = $("#promoTitle").text();
	var ecomPageName = "Telefonia|Amigo|Promociones|"+promoName;
	var regionId = getRegionFromCookie();
	var profile = getProfileFromCookie();
	var fecha = getDTMDate();
	var dispo = getBrowserResolution();
	var path = getBredcrum();
	var dlMetri="var dlMetri={\n" +
			"'ecomPageName':'"+ecomPageName+"',\n" +
			"'ecomFecha':'"+fecha+"',\n" +
			"'ecomPerfil':'"+profile+"',\n" +
			"'ecomZona':'"+regionId+"',\n" +
			"'ecomDispo':'"+dispo+"',\n" +
			"'ecomSec':'Promociones',\n" +
			"'ecomJerarquia':'"+path+"',\n" +
			"'ecomEvento':'promociones'\n" +
		"}\n";
	return dlMetri;
}
angular.module("telcelApp").controller('getRecommendedPlanGroup', ['$scope', '$http', '$sce', function($scope, $http, $sce) {
	var currencySymbol = $("#recommendedPlanPrice").attr("data-currencySymbol");
	var familyPlanId = $("#familyPlanIdRec").val();
    var regionId = 9;
    var reqType = "renta";
    if($.cookie("telcelcom_profile") == null || $.cookie("telcelcom_profile") === "POSPAGO") {
        reqType = "renta";
    } else if($.cookie("telcelcom_profile") == "MIXTO") {
        reqType = "mixto";
    }
    if($.cookie("telcelcom_region") && $.cookie("telcelcom_region") !== "") {
        regionId = $.cookie("telcelcom_region");
    }
    if($('.rPlanComp').length){
        $http.get("/bin/telcelcom/plan/recommendedplan/byfamily.groupid="
                + familyPlanId + ".region=" + regionId + ".recomendado.json?bustcache=false").
                success(function(response) {
            $scope.rPlan = response.data;
            if($scope.rPlan.resumenConceptos ) {
                var numEntries = Object.keys($scope.rPlan.resumenConceptos).length;
                $scope.entryList = [];
                $scope.monthlyCharge = {};
                if($scope.rPlan.conceptos.ClaVid!=null){
                	$scope.claro  = $scope.rPlan.conceptos.ClaVid.valor;
                } else {
                	$scope.claro  = "false";
                }
                if(numEntries > 1 && numEntries  < 7){
                    $.each($scope.rPlan.resumenConceptos, function(index, elem){
                        var currentEntry = angular.copy(elem);
                        currentEntry.isFirstDigit = false;
                        if(checkForDigit(currentEntry.valor)){
                            currentEntry.isFirstDigit = true;
                        }
                        if(index !== "cargoServicio"){

                            if(currentEntry.valor !== "true") {
                                if(currentEntry.tipoValor.nombre === "DINERO"){
                                	currentEntry.valor = formatPrice(parseInt(currentEntry.valor), '$'/*currencySymbol*/);
                                } else if(currentEntry.isFirstDigit) {
                                    currentEntry.valor = $sce.trustAsHtml(parseStringValue(currentEntry.valor));
                                }
                            }
                            if (currentEntry.clave != "kbFraccionAdicional") {
                            	$scope.entryList.push(currentEntry);
                            }
                        } else if(index === "cargoServicio") {

                             currentEntry.valor = formatPrice(parseInt(currentEntry.valor), '$'/*currencySymbol*/);
                            $scope.monthlyCharge = angular.copy(currentEntry);
                        }
                    });
                }
            }
            $scope.modalLink = $('.rPlanComp').attr("data-global-path") + "." + $scope.rPlan.idPlan + ".html?bustcache=true";
        });
    	
    	
    	
//        $http.get("/bin/telcelcom/plan/recommendedplan." + regionId + "." + reqType + ".json?bustcache=true")
//                .success(function(response) {
//            $scope.rPlan = response;
//            if(response.datosHome.resumenConceptos ) {
//                var numEntries = Object.keys(response.datosHome.resumenConceptos).length;
//                $scope.entryList = [];
//                $scope.monthlyCharge = {};
//                if(response.datosHome.conceptos.ClaVid!=null){
//                	$scope.claro  = response.datosHome.conceptos.ClaVid.valor;
//                } else {
//                	$scope.claro  = "false";
//                }
//                if(numEntries > 1 && numEntries  < 7){
//                    $.each(response.datosHome.resumenConceptos, function(index, elem){
//                        var currentEntry = angular.copy(elem);
//                        currentEntry.isFirstDigit = false;
//                        if(checkForDigit(currentEntry.valor)){
//                            currentEntry.isFirstDigit = true;
//                        }
//                        if(index !== "cargoServicio"){
//
//                            if(currentEntry.valor !== "true") {
//                                if(currentEntry.tipoValor.nombre === "DINERO"){
//                                    currentEntry.valor = formatPrice(parseInt(currentEntry.valor), '$'/*currencySymbol*/);
//                                } else if(currentEntry.isFirstDigit) {
//                                    currentEntry.valor = $sce.trustAsHtml(parseStringValue(currentEntry.valor));
//                                }
//                            }
//                            $scope.entryList.push(currentEntry);
//                        } else if(index === "cargoServicio") {
//
//                             currentEntry.valor = formatPrice(parseInt(currentEntry.valor), '$'/*currencySymbol*/);
//                            $scope.monthlyCharge = angular.copy(currentEntry);
//                        }
//                    });
//                }
//            }
//            $scope.modalLink = $('.rPlanComp').attr("data-global-path") + "." + response.datosHome.idPlan + ".html?bustcache=true";
//        });
    }
}]);

$('body').on('plan.recommendedplangroup', '.rPlanComp', function(e){
	alert("AasS");
    var $injector = angular.injector(['ng', 'telcelApp']);
    $injector.invoke(['$rootScope','$compile',function($rootScope, $compile) {
        $compile($(e.target)[0])($rootScope);
    }]);
});

angular.module("telcelApp").controller('getRecommendedPlan', ['$scope', '$http', '$sce', '$timeout', function($scope, $http, $sce, $timeout) {
	var currencySymbol = $("#recommendedPlanPrice").attr("data-currencySymbol");
    var regionId = 9;
    var reqType = "renta";
    if($.cookie("telcelcom_profile") == null || $.cookie("telcelcom_profile") === "POSPAGO") {
        reqType = "renta";
    } else if($.cookie("telcelcom_profile") == "MIXTO") {
        reqType = "mixto";
    }
    if($.cookie("telcelcom_region") && $.cookie("telcelcom_region") !== "") {
        regionId = $.cookie("telcelcom_region");
    }
    if($('.rPlanComp').length){
        $http.get("/bin/telcelcom/plan/recommendedplan." + regionId + "." + reqType + ".json?bustcache=true")
                .success(function(response) {
            $scope.rPlan = response;
            if(response.datosHome.resumenConceptos ) {
                var numEntries = Object.keys(response.datosHome.resumenConceptos).length;
                $scope.entryList = [];
                $scope.monthlyCharge = {};
                if(response.datosHome.conceptos.ClaVid!=null){
                	$scope.claro  = response.datosHome.conceptos.ClaVid.valor;
                } else {
                	$scope.claro  = "false";
                }
                if(numEntries > 1 && numEntries  < 7){
                    $.each(response.datosHome.resumenConceptos, function(index, elem){
                        var currentEntry = angular.copy(elem);
                        currentEntry.isFirstDigit = false;
                        if(checkForDigit(currentEntry.valor)){
                            currentEntry.isFirstDigit = true;
                        }
                        if(index !== "cargoServicio"){

                            if(currentEntry.valor !== "true") {
                                if(currentEntry.tipoValor.nombre === "DINERO"){
                                    currentEntry.valor = formatPrice(parseInt(currentEntry.valor), '$'/*currencySymbol*/);
                                } else if(currentEntry.isFirstDigit) {
                                    currentEntry.valor = $sce.trustAsHtml(parseStringValue(currentEntry.valor));
                                }
                            }
                            $scope.entryList.push(currentEntry);
                        } else if(index === "cargoServicio") {

                             currentEntry.valor = formatPrice(parseInt(currentEntry.valor), '$'/*currencySymbol*/);
                            $scope.monthlyCharge = angular.copy(currentEntry);
                        }
                    });
                    $timeout(function () { nuevasTablasTelcel.inicializar(); }, 500); 
                }
            }
            $scope.modalLink = $('.rPlanComp').attr("data-global-path") + "." + response.datosHome.idPlan + ".html?bustcache=true";
        });
    }
}]);


angular.module("telcelApp").directive('recommendedPlan',function(){

    var directiveDefinitionObject = {
        controller: 'getRecommendedPlan',
        restrict: "A"
    };
    return directiveDefinitionObject;

});

$('body').on('plan.recommendedplan', '.rPlanComp', function(e){
    var $injector = angular.injector(['ng', 'telcelApp']);
    $injector.invoke(['$rootScope','$compile',function($rootScope, $compile) {
        $compile($(e.target)[0])($rootScope);
    }]);
});


angular.module("telcelApp")
    .controller('getGeneralRecommendedPlanByDevices', ['$scope', '$http', '$sce', '$timeout', function($scope, $http, $sce, $timeout) {
    var familyPlanId = "";
    var terminalTypeId = $("#terminalTypeId").val();
    /*
     ** Check by device id
     	6 CAMARA 
		5 TABLET 
		4 WIFI MOVIL 
		3 NETBOOK 
		2 MODEMS 
		1 TELEFONO 
     */
    if (terminalTypeId == "1") {
    	familyPlanId = $("#familyPlanIdTel").val();
    	if ($("#linkButtonTel").val() != "") {
    		$("#linkEquiposRec").show();
        	$("#linkEquiposRec").attr("href",$("#linkButtonTel").val());
    	}
    } else if (terminalTypeId == "2") {
    	familyPlanId = $("#familyPlanIdModem").val();
    	if ($("#linkButtonModem").val() != "") {
    		$("#linkEquiposRec").show();
        	$("#linkEquiposRec").attr("href",$("#linkButtonModem").val());
    	}
    } else if (terminalTypeId == "3") {
    	familyPlanId = $("#familyPlanIdNetbook").val();
    	if ($("#linkButtonNetbook").val() != "") {
    		$("#linkEquiposRec").show();
        	$("#linkEquiposRec").attr("href",$("#linkButtonNetbook").val());
    	}
    } else if (terminalTypeId == "4") {
    	familyPlanId = $("#familyPlanIdWifi").val();
    	if ($("#linkButtonWifi").val() != "") {
    		$("#linkEquiposRec").show();
        	$("#linkEquiposRec").attr("href",$("#linkButtonWifi").val());
    	}
    } else if (terminalTypeId == "5") {
    	familyPlanId = $("#familyPlanIdTablet").val();
    	if ($("#linkButtonTablet").val() != "") {
    		$("#linkEquiposRec").show();
        	$("#linkEquiposRec").attr("href",$("#linkButtonTablet").val());
    	}
    } else if (terminalTypeId == "6") {
    	familyPlanId = $("#familyPlanIdCam").val();
    	if ($("#linkButtonCam").val() != "") {
    		$("#linkEquiposRec").show();
        	$("#linkEquiposRec").attr("href",$("#linkButtonCam").val());
    	}
    }
    
   	var currencySymbol = "$"; 
    var regionId = 9;
    var planType = "mixto";

    if($.cookie("telcelcom_profile") == null || $.cookie("telcelcom_profile") === "POSPAGO" || $.cookie("telcelcom_profile") === "PREPAGO") {
        var planType = "renta";
    } else {
        if ($.cookie("telcelcom_region") != null) {
            regionId = $.cookie("telcelcom_region");
        }
    }

    if (familyPlanId != "") {
    	serviceCalByFamilyPlan();
    } else {
    	serviceCall();
    }

    function serviceCall() {
        $http.get("/bin/telcelcom/plan/recommendedplan." + regionId + "." + planType + ".json?bustcache=true", {header : { 'Content-Type' : 'application/json; charset=UTF-8' }})
        .success(onSuccess);
    }
    
    function serviceCalByFamilyPlan() {
        $http.get("/bin/telcelcom/plan/recommendedplan/byfamily.groupid="
                + familyPlanId + ".region=" + regionId + ".recomendado.json?bustcache=fals", {header : { 'Content-Type' : 'application/json; charset=UTF-8' }})
        .success(onSuccessByFamily);
    }

    function onSuccess(response) {
        if (response.datosHome !== undefined) {
            $scope.rPlan = response;
            if (response.datosHome.titulo) {
                var planTitle = response.datosHome.titulo;
                if (planTitle) {
                    $scope.planTitle = planTitle;
                }
            }
            if(response.datosHome.resumenConceptos ) {
                var numEntries = Object.keys(response.datosHome.resumenConceptos).length;
                $scope.entryList = [];
                $scope.monthlyCharge = {};
                if(response.datosHome.conceptos.ClaVid!=null){
                	$scope.claro  = response.datosHome.conceptos.ClaVid.valor;
                } else {
                	$scope.claro  = "false";
                }
                if(numEntries > 1 && numEntries  < 7){
                    $.each(response.datosHome.resumenConceptos, function(index, elem){
                        var currentEntry = angular.copy(elem);
                        currentEntry.isFirstDigit = false;
                        if(checkForDigit(currentEntry.valor)){
                            currentEntry.isFirstDigit = true;
                        }
                        if(index !== "cargoServicio"){
                            if(currentEntry.valor !== "true") {
                                if(currentEntry.tipoValor.nombre === "DINERO"){
                                    //console.log(currentEntry.valor);
                                    currentEntry.valor = formatPrice(parseInt(currentEntry.valor), '$'/*currencySymbol*/);
                                } else if(currentEntry.isFirstDigit) {
                                    currentEntry.valor = $sce.trustAsHtml(parseStringValue(currentEntry.valor));
                                }
                            }
                            $scope.entryList.push(currentEntry);
                           // console.log(currentEntry);
                        } else if(index === "cargoServicio") {

                             currentEntry.valor = formatPrice(parseInt(currentEntry.valor), '$'/*currencySymbol*/);
                            $scope.monthlyCharge = angular.copy(currentEntry);
                        }
                    });
                    $timeout(function () { nuevasTablasTelcel.inicializar(); }, 500); 
                }
            }
        } else {
            if (planType === "mixto") {
				planType = "renta";
                regionId = "9";
            	serviceCall();
            }
            console.log("UNDEFINED !!");
        }
    }
    
    function onSuccessByFamily(response) {
        if (response.data !== undefined) {
        	$scope.rPlan = response;
            if (response.data.titulo) {
                var planTitle = response.data.titulo;
                if (planTitle) {
                    $scope.planTitle = planTitle;
                }
            }
            if(response.data.resumenConceptos ) {
                var numEntries = Object.keys(response.data.resumenConceptos).length;
                $scope.entryList = [];
                $scope.monthlyCharge = {};
                if(response.data.conceptos.ClaVid!=null){
                	$scope.claro  = response.data.conceptos.ClaVid.valor;
                } else {
                	$scope.claro  = "false";
                }
                if(numEntries > 1 && numEntries  < 7){
                    $.each(response.data.resumenConceptos, function(index, elem){
                        var currentEntry = angular.copy(elem);
                        currentEntry.isFirstDigit = false;
                        if(checkForDigit(currentEntry.valor)){
                            currentEntry.isFirstDigit = true;
                        }
                        if(index !== "cargoServicio"){
                            if(currentEntry.valor !== "true") {
                                if(currentEntry.tipoValor.nombre === "DINERO"){
                                    //console.log(currentEntry.valor);
                                    currentEntry.valor = formatPrice(parseInt(currentEntry.valor), '$'/*currencySymbol*/);
                                } else if(currentEntry.isFirstDigit) {
                                    currentEntry.valor = $sce.trustAsHtml(parseStringValue(currentEntry.valor));
                                }
                            }
                            $scope.entryList.push(currentEntry);
                           // console.log(currentEntry);
                        } else if(index === "cargoServicio") {

                             currentEntry.valor = formatPrice(parseInt(currentEntry.valor), '$'/*currencySymbol*/);
                            $scope.monthlyCharge = angular.copy(currentEntry);
                        }
                    });
                    $timeout(function () { nuevasTablasTelcel.inicializar(); }, 500); 
                }
            }
        } else {
            if (planType === "mixto") {
				planType = "renta";
                regionId = "9";
            	serviceCall();
            }
            console.log("UNDEFINED !!");
        }
    }


}]);







angular.module("telcelApp")
    .controller('getGeneralRecommendedPlan', ['$scope', '$http', '$sce', function($scope, $http, $sce) {
    var currencySymbol = "$"; 
    var regionId = 9;
    var planType = "mixto";

    if($.cookie("telcelcom_profile") == null || $.cookie("telcelcom_profile") === "POSPAGO" || $.cookie("telcelcom_profile") === "PREPAGO") {
        var planType = "renta";
    } else {
        if ($.cookie("telcelcom_region") != null) {
            regionId = $.cookie("telcelcom_region");
        }
    }

    serviceCall();

    function serviceCall() {
        $http.get("/bin/telcelcom/plan/recommendedplan." + regionId + "." + planType + ".json?bustcache=true", {header : { 'Content-Type' : 'application/json; charset=UTF-8' }})
        .success(onSuccess);
    }

    function onSuccess(response) {
        if (response.datosHome !== undefined) {
            $scope.rPlan = response;
            if (response.datosHome.titulo) {
                var planTitle = response.datosHome.titulo;
                if (planTitle) {
                    $scope.planTitle = planTitle;
                }
            }
            if(response.datosHome.resumenConceptos ) {
                var numEntries = Object.keys(response.datosHome.resumenConceptos).length;
                $scope.entryList = [];
                $scope.monthlyCharge = {};
                if(response.datosHome.conceptos.ClaVid!=null){
                	$scope.claro  = response.datosHome.conceptos.ClaVid.valor;
                } else {
                	$scope.claro  = "false";
                }
                if(numEntries > 1 && numEntries  < 7){
                    $.each(response.datosHome.resumenConceptos, function(index, elem){
                        var currentEntry = angular.copy(elem);
                        currentEntry.isFirstDigit = false;
                        if(checkForDigit(currentEntry.valor)){
                            currentEntry.isFirstDigit = true;
                        }
                        if(index !== "cargoServicio"){
                            if(currentEntry.valor !== "true") {
                                if(currentEntry.tipoValor.nombre === "DINERO"){
                                    //console.log(currentEntry.valor);
                                    currentEntry.valor = formatPrice(parseInt(currentEntry.valor), '$'/*currencySymbol*/);
                                } else if(currentEntry.isFirstDigit) {
                                    currentEntry.valor = $sce.trustAsHtml(parseStringValue(currentEntry.valor));
                                }
                            }
                            $scope.entryList.push(currentEntry);
                           // console.log(currentEntry);
                        } else if(index === "cargoServicio") {

                             currentEntry.valor = formatPrice(parseInt(currentEntry.valor), '$'/*currencySymbol*/);
                            $scope.monthlyCharge = angular.copy(currentEntry);
                        }
                    });
                }
            }
        } else {
            if (planType === "mixto") {
				planType = "renta";
                regionId = "9";
            	serviceCall();
            }
            console.log("UNDEFINED !!");
        }
    }


}]);






$(document).ready(function(){
    var readValues = function(flagList, $form) {
        var filters = $('.searchPlan');
        var url = "/bin/telcelcom/plan/planlistbyfilters.";
        var dataAttribute = $('#dataFilter').attr('data-pagePath');
        if(dataAttribute.indexOf("/content/telcel") == -1){

            dataAttribute = "/content/telcel" + dataAttribute;
        }
        var encodedString = btoa(dataAttribute);
        var cookie = 9;
        if ($.cookie("telcelcom_region") != null) {
            cookie = $.cookie("telcelcom_region");
        }
        url += cookie + ".0";
        url += "." + encodedString;

        for (var i = 0; i < filters.length; i++) {
            var func = filters[i];
            var valueSelect = $(func).val();
            if(!(valueSelect === "")){
                url += "." + valueSelect;
            }



        }
        if ($('#planMixto').prop("checked")) {
            url += ".mixto";
        }

        if (flagList) {
            url += ".list.html?bustcache=" + generateTimeStamp();
        }
        $form.attr('action', url);
        $('#filtrosBar').attr('action', url);
    }

    $('body').on('plan.filterplan', '.xk-js-filter-plan', function (e,targetForm) {
        //initial action ;
        var dataAttribute = $('#dataFilter').attr('data-pagePath'),
            encodedString = btoa(dataAttribute),
            url = "/bin/telcelcom/plan/planlistbyfilters.9.0." + encodedString
                + ".00.10.20.30.html?bustcache=" + generateTimeStamp();
        // Enclose search to this portion of html
        var $form = $(e.target).find(targetForm);
        $form.attr('action', url);

        //Attach before submit
        $form.click(function (evt) {
            var barValue = $(this).find('.is-checked :input').attr('value'),
                url = "/bin/telcelcom/plan/planlistbyfilters.",
                cookie = 9;
            if ($.cookie("telcelcom_region") != null) {
                cookie = $.cookie("telcelcom_region");
            }
            url += cookie + ".0";
            var dataAttribute = $('#dataFilter').attr('data-pagePath');
            if(dataAttribute.indexOf("/content/telcel") == -1){
                dataAttribute = "/content/telcel" + dataAttribute;
            }
            var encodedString = btoa(dataAttribute);
            url += "." + encodedString;
            url += "." + barValue + ".html?bustcache=" + generateTimeStamp();
            $(this).attr('action', url);
        });

        $form.on('submit', function(){
            $(e.target).find('.js-range-radio').data('ajaxRadioEnabled', true);
        });

        $(e.target).find('.js-range-radio').on('change','.js-range-position',function(evt){
            evt.preventDefault();
            var barValue = $(this).attr('value'),
                url = "/bin/telcelcom/plan/planlistbyfilters.",
                cookie = 9;
            if ($.cookie("telcelcom_region") != null) {
                cookie = $.cookie("telcelcom_region");
            }
            url += cookie + ".0";
            var dataAttribute = $('#dataFilter').attr('data-pagePath');
            if(dataAttribute.indexOf("/content/telcel") == -1){

                dataAttribute = "/content/telcel" + dataAttribute;
            }
            var encodedString = btoa(dataAttribute);
            url += "." + encodedString;
            url += "." + barValue + ".list.html?bustcache=" + generateTimeStamp();
            $(this).closest('.js-range-radio').data('url',url);
            if ($(this).closest('.js-range-radio').length&&$(this).closest('.js-range-radio').data('ajaxRadioEnabled')){
                $(this).closest('.js-range-radio').simpleAjaxForm({spin: 'largeSpin'});
            }
        });
    });


    var compileAngular = function($element){
        if ($element.length) {
            var $injector = angular.injector(['ng', 'telcelApp']);
            $injector.invoke(['$rootScope','$compile',function ($rootScope, $compile) {
                $compile($element[0])($rootScope);
            }]);
        }
    };
    //Apply angular compile
    $('body').on('plan.filteredplan','.js-filtered-plan', function (e) {

        // Update url before sumbit
        $(e.target).find('.xk-filterplan-change').on('change',function(evt){

            readValues(true, $(evt.target).closest('form'));
        });

        //Submit form on changes
        $(e.target).on('change', 'select, input', function () {
            $(this).closest('form').simpleAjaxForm({spin: 'largeSpin'});
        });

        $(e.target).find('.js-close.js-detach').on('click', function(evt){
            $(e.target).closest('.xk-js-filter-plan').find('.js-range-radio').data('ajaxRadioEnabled', false);
        });
        
    });

    //Apply angular compile
    $('body').on('plan.filter-list','.js-event-list', function (e) {
        compileAngular($(e.target));
        $('.intstring').separateIntString();
        nuevasTablasTelcel.inicializar();
    });


    $('.xk-js-filter-plan').each(function(){
        $(this).dataTriggerEvent();
    });
});

var nuevasTablasTelcel= (function(){

	  function tablasDestacadas (){
	    $.each($('.tb-planes') , function(){
	      var ultimo = $(this).find('.tb-plan').length;
	      var penultimo = ultimo-1;
	      var antepenultimo = ultimo -2;
	      $(this).find('.tb-verde .tb-plan:nth-child('+ultimo+'), .tb-verde .tb-plan:nth-child('+penultimo+'), .tb-destacada .tb-plan:nth-child('+ultimo+'), .tb-destacada .tb-plan:nth-child('+penultimo+')').addClass('white-cont');
	      $(this).find('.tb-verde .tb-plan:nth-child('+antepenultimo+'),.tb-destacada .tb-plan:nth-child('+antepenultimo+')').addClass('border-none');
	    });
	  }
	  function anchoColumnas (){
	      var ancho_pantalla = $(window).width();
	      $('.tb-plan').attr('style', '');
	      $('.tb-cont-planes').attr('style', '');
	      //Tablas Desktop
	      if ( ancho_pantalla > 768){
	        $.each( $('.tb-planes') , function(){

	          var ancho_tb_planes = $(this).width();
	          var ancho_contenedor_planes = $(this).find('.tb-cont-planes').width();
	          var diferencia = (ancho_tb_planes - ancho_contenedor_planes);
	          var numero_de_columnas = $(this).find('.tb-plan').length;
	          var agregar = (diferencia / numero_de_columnas);


	          $.each( $(this).find('.tb-plan') , function(){
	        	  

	            var contenido_plan_descripcion = $(this).find('.tb-plan-descripcion');
	            var tb_plan= $(this).width();
	            var ancho_tb_plan= tb_plan + agregar + 10;

	            if ($(this).hasClass('white-cont')){
	              $(this).css( "width" , ancho_tb_plan);
	              $(this).css( "padding" , "0" );
	            }
	            else{
	              $(this).css( "width" , ancho_tb_plan );
	              $(this).css( "margin-top" , "15px" );
	            }


	            //Dividir la celda en dos si tiene mas de 16 caracteres
	            if( contenido_plan_descripcion.html() && $(this).find('br').length === 0 ){

	              if( $(this).find('span').length === 0 && $(this).find('strong').length === 0 && $(this).find('ul').length === 0 && $(this).find('img').length === 0 && contenido_plan_descripcion.html().length > 16 ){

	            	  if ($(this).find('a').length === 0) {
	            		  var arr = contenido_plan_descripcion.html().split(" ");
		  	                contenido_plan_descripcion.empty();
		  	                arr.forEach(function(e,index){
		  	                  if( arr[index+1] ){
		  	                     if( (arr[index].length + arr[index+1].length) < 16 && (arr[index]!=arr[index+1])  ){
		  	                        contenido_plan_descripcion.append( arr[index]+" "+arr[index+1]+"<br>" );
		  	                        arr.splice(index+1,1);
		  	                     }
		  	                  }else{
		  	                    contenido_plan_descripcion.append( " "+arr[index] );
		  	                  }
	
		  	                });
	            	  } else {
	            		    contenido_plan_descripcion = contenido_plan_descripcion.find('a');
	            		    var arr = contenido_plan_descripcion.html().split(" ");
		  	                contenido_plan_descripcion.empty();
		  	                arr.forEach(function(e,index){
		  	                  if( arr[index+1] ){
		  	                     if( (arr[index].length + arr[index+1].length) < 16 && (arr[index]!=arr[index+1])  ){
		  	                        contenido_plan_descripcion.append( arr[index]+" "+arr[index+1]+"<br>" );
		  	                        arr.splice(index+1,1);
		  	                     }
		  	                  }else{
		  	                    contenido_plan_descripcion.append( " "+arr[index] );
		  	                  }
	
		  	                });
	            	  }
	              }
	            }
	            //Fin de la division del texto de celda si tiene mas de 16 caracteres


	          } );
	        } );
	      }

	      //Tablas Mobile
	      else{
	        $.each( $('.tb-planes') , function(){
	          var ultimo = $(this).find('.tb-plan').length;
	          var penultimo = ultimo-1;

	          if( $(this).find('.tb-acciones').length !== 0 ){
	            $(this).find('.tb-cont-planes .tb-plan:nth-child('+ultimo+'), .tb-cont-planes .tb-plan:nth-child('+penultimo+')').addClass('plan-stand-out');
	            $(this).find('.tb-cont-planes .tb-plan:nth-child('+penultimo+')').css({'border-top':'2px solid #F2F7F9'});
	          }


	          if( $(this).find('.tb-cont-planes').hasClass('tb-verde') || $(this).find('.tb-cont-planes').hasClass('tb-destacada') ){
	            $(this).find('.tb-plan').width( "80%" );
	          }
	          else{
	            $(this).find('.tb-plan').css( "width" , "50%" );
	            $(this).find('.tb-plan').css( "float" , "left" );
	          }

	          $(this).find('.tb-plan').css( "margin" , "0 auto" );
	          $(this).find('.tb-cont-planes').width( "80%" );


	        });
	      }
	  }

	  return{
	      inicializar: function(){
	        tablasDestacadas ();
	        anchoColumnas();
	        nuevasTablasTelcel.redimencionar();
	      },
	      redimencionar: function(){
	        $(window).resize(anchoColumnas);
	      }
	  };
	})();

 angular.module("telcelApp").controller('FamilyPlansController',
     ['$scope', '$http', '$timeout', 'FamilyPlans','PlanesService', function($scope, $http, $timeout, FamilyPlans, PlanesService){
        var cookie = 9;
        if($.cookie("telcelcom_region") != null){
            cookie = $.cookie("telcelcom_region");
        }
     $scope.planes = FamilyPlans.getFamilyPlans({regionId:cookie});
     $scope.families = [];
     $scope.planes.$promise.then(function(data){

         angular.forEach(data.recommendedFamilyPlanList, function(family){
             var tempFamily =family;
                tempFamily.planes['fixedConcepts'] = PlanesService.resumenConceptos(family.planes.resumenConceptos);
                $scope.families.push(tempFamily);
         });
         $timeout(function () { nuevasTablasTelcel.inicializar(); }, 500); 
     });
    function formatPrice(n, currency) {
        return currency + " " + n.toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g, "$1,");
    }

    $scope.planAccepted = function (plan,idx){
      return angular.isUndefined(plan)||((typeof plan != 'undefined')&&plan.planes.fixedConcepts.size>2);
    };
}]);


$(function(){
 var compileAngular = function($element){
     if ($element.length) {
         var $injector = angular.injector(['ng', 'telcelApp']);
         $injector.invoke(['$rootScope','$compile',function ($rootScope, $compile) {
             $compile($element[0])($rootScope);
         }]);
     }
 };

    //Apply angular compile
    $('body').on('plan.familyplans','.js-plan-familyplans', function (e) {
        compileAngular($(e.target));
    });
});
var region = $.cookie("telcelcom_region");
if ((typeof region === 'undefined') || region === "") {
    region = 9;
}

angular.module("telcelApp").controller("familyplansnomarketablescontroller", ['$scope', '$http', function($scope, $http) {

        $http.get("/bin/telcelcom/plan/familyplans/recommended.region=" + region + ".version=anterior.combo=false.json?bustcache=true").success(function(response) {
            var plansList = {
                plansListDetail: []
            };
            if (response.recommendedFamilyPlanList) {

                $.each(response.recommendedFamilyPlanList, function(index, value) {

                    if (value.planes && value.planes.resumenConceptos) {
                        var price = "";
                        $.each(value.planes.resumenConceptos, function(index, val) {
                            var currentEntry = angular.copy(val);
                            if (currentEntry.valor !== "true") {
                                if (currentEntry.tipoValor.nombre === "DINERO") {
                                    price = '$' + numberWithCommas(currentEntry.valor);
                                    plansList.plansListDetail.push({
                                        "title": value.grupoPlan,
                                        "description": value.descripcion,
                                        "price": price,
                                        "link": value.pathFamily
                                    });
                                }
                            }
                        });
                    }
                });
            }
            $scope.plansList = plansList;
            if (plansList.plansListDetail.length <= 0) {
                $scope.plansListNotHasItems = "true"
            }

        });
    }]);

function numberWithCommas(x) {
    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}
/**
 * Javascript that makes the print page functionality for device pages.
 * @author Aoliva
 * @version 1.1
 */

function printpage() {
    if($(".js-display-text").length) {
         console.log("wiiii~");
         var button=$(".js-display-text"),
                   target=button.prev(),
                   curHeight = 70,
                   autoHeight = target.css('height', 'auto').height(),
                   newHeight=(button.hasClass('opened'))?curHeight:autoHeight,
                   oldHeight=(button.hasClass('opened'))?autoHeight:curHeight;
               if(!button.hasClass('opened')){
                   target.height(oldHeight).animate({height: newHeight}, 0, function(){
                       button.toggleClass('opened');
                       target.toggleClass('visible');
                   });
               }
     }
    var today = getCurrentDate();
    html2canvas($("main"), {
        onrendered: function(canvas) {

            var legalText = $(".legales-telcel").attr("data-legalTextTelcel");
            var mywindow = window.open('', '', 'height=600,width=1280');
            mywindow.document.write('<html><head><title></title>');
            mywindow.document.write('<style type="text/css" media="print">@page { size: landscape; }</style>');
            mywindow.document.write('</head><body >');

            var isIE = /*@cc_on!@*/false || !!document.documentMode;   // At least IE6
            if (isIE) {
                //Ini: fix for IE
                try {
                    var imgCanvas = mywindow.document.createElement('img');
                    imgCanvas.src = canvas.toDataURL();
                    mywindow.document.body.appendChild(imgCanvas);
                }
                catch(err) { console.log(err.message); }
                //End: fix for IE
            } else {
                mywindow.document.body.appendChild(canvas);
            }

            if (typeof(legalText) !== "undefined") {
                mywindow.document.write('<div>' + legalText + '</div>');
            }
            mywindow.document.write('<div> A la fecha '+today+'</div>');
            mywindow.document.write('</body></html>');
            mywindow.document.close(); //added for IE
            mywindow.focus(); //added for IE
            mywindow.print();
            mywindow.close();
        }
    });
}

$(document).ready(function(){
    $('#printpage-btn').click(function(evt) {
        evt.preventDefault();
        printpage();
    });
});
/*
 * This script functions as a client library for searchdevice component
 */

/*
 * Populates the model combo-box
 */
function changeCombo(marcaCombo){
    var path = marcaCombo.indexOf("/content/telcel") === 0?marcaCombo:"/content/telcel" +marcaCombo;
    var encodeMarcaCombo = btoa(path);
    var service = "/bin/telcelcom/childpages." + encodeMarcaCombo + ".json";
    var $el = $("#modelo");
    $.ajax({
        url: service,
        context: document.body
    }).done(function(data) {
        $el.children('option:not(:first)').remove();
        $.each(data.results, function(index, item) {
            $el.append($("<option></option>")
                .attr("value", item.value).text(item.text)).trigger('chosen:updated');
        });
    });
}

$( document ).ready(function() {

    // When the user selects a brand from the combo-box
    $('#marca').change(function(){
        $('#modelo').prop('disabled', false);
        var marcaCombo = $('#marca option:selected').val();
        $('#modelo').children('option:not(:first)').remove()
        var pathToCategory = $('#values-dialog').attr('data-category');
        pathToCategory += "/" + marcaCombo;
        changeCombo(pathToCategory);
    });

    // When the user selects a device model
    $('#modelo').change(function(event){        
        var marcaCombo = $('#marca option:selected').val();
        var modeloCombo = $('#modelo option:selected').val();
        var pathToCategory = $('#values-dialog').attr('data-category');
        $('#btn-submit').removeAttr('disabled');
        $url = pathToCategory + "/" + marcaCombo + '/' + modeloCombo + '.html';
        $('#btn-submit').attr('formaction', $url);
    });

    //$(".form-search-terminal").on("submit", function(evt) {
    $("#form-searchdevice").on("submit", function(evt) {
       evt.preventDefault();
       var deviceUrl  = $('#btn-submit').attr('formaction');
       window.location.replace(deviceUrl);
    });
});

$('#marca option:contains("Marca")').attr("disabled","disabled");

$('#modelo option:contains("Modelo")').attr("disabled","disabled");

/**
 * This javascript is used to set attributes of imageZoom
 * Created by Jose Vasquez on 21/10/14.
 */

function update_values(selectedValue){
    var formatPriceSummary = function (n, currency) {
        return currency + n.toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g, "$1,");
    }
    var startsWith = function (originalStr, str){
		return originalStr.slice(0, str.length) == str;		
	};
    var regionId = $.cookie("telcelcom_region");
    if ((typeof regionId === 'undefined') || regionId === '') {
        regionId = 9;
    }
    var urlFinal = window.location.pathname;
    if(urlFinal.lastIndexOf(".html") > 0){
        urlFinal = urlFinal.substring(0,window.location.pathname.lastIndexOf(".html"))
    }
    if(!startsWith(urlFinal,"/content/telcel")){
		urlFinal = "/content/telcel" + urlFinal;
    }
    var pathBase64 = btoa(urlFinal);
    var urlPath = "/bin/telcelcom/device/terminal/version." + selectedValue+ "." + pathBase64 + ".json?bustcache=true";
    var images = $('.cloudzoom');
    var cont = 0;
    var imagesval = 0;
    $.getJSON(urlPath, function(data) {
        $.each(data, function(key, val) {
            if(key.indexOf("image") > -1) {
                var num = parseInt(key.substring(key.indexOf("image")+5,key.length));
                $(images[num]).attr('src',val);
                cont++;
            }
            if(key.indexOf("imgZoom") > -1) {
                var numZoom = parseInt(key.substring(key.indexOf("imgZoom")+7,key.length));
                $(images[numZoom]).attr('data-cloudzoom',val);
                //$('.cloudzoom').CloudZoom();
                imagesval++;
            }
            console.log(key);
            if (key === "currentDate") {
                console.log(val);
                $("#deviceSummaryDate").html(val);
            }
            if(key === "pricesList"){
                $.each(val, function(item, value){
                    if (value.region == regionId) {
                        var priceVersion = formatPriceSummary(value.precioIVA,"$");
                        $('.friend-price').html(priceVersion);
                    }
                });
            }
        });
    });
}

$( document ).ready(function() {
    var startsWith = function (originalStr, str){
        return originalStr.slice(0, str.length) == str;
    };
    var urlFinal = window.location.pathname;
    if(urlFinal.lastIndexOf(".html") > 0){
        urlFinal = urlFinal.substring(0,window.location.pathname.lastIndexOf(".html"))
    }
    if(!startsWith(urlFinal,"/content/telcel")){
        urlFinal = "/content/telcel" + urlFinal;
    }
    var pathBase64 = btoa(urlFinal);

        var cookieRegion = 9;
        if ($.cookie("telcelcom_region") != null) {
            cookieRegion = $.cookie("telcelcom_region");
        }
        var cookieProfile = "PREPAGO";
        if ($.cookie("telcelcom_profile") != null) {
            cookieProfile = $.cookie("telcelcom_profile");
        }
        var service = "/bin/telcelcom/device/terminal/version.cversion." + pathBase64 + "." + cookieProfile + "@" + cookieRegion + ".json";
        $.ajax({
            url: service,
            context: document.body
        }).done(function (data) {
            var $el = $("#version");
            var count = Object.keys(data).length
            if(count > 1){
                $el.empty(); // remove old options
                $.each(data, function (key, value) {
                    $el.append($("<option></option>")
                        .attr("value", value).text(key)).trigger('chosen:updated');
                });
            } else {
                $("#versionDiv").addClass("hidden");
            }

        });
});

$(function() {
    var region = $.cookie("telcelcom_region");
    if ((typeof region === 'undefined') || region === "") {
        region = 9;
    }
    var sectionTag = $("#priceRegionSummary");
    if (sectionTag.attr("data-pagePath") && sectionTag.attr("data-resourcePath")) {
        var url = sectionTag.attr("data-pagePath") + sectionTag.attr("data-resourcePath");


        $.ajax({
            type: 'GET',
            contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
            dataType: 'json',
            url: url + '.priceregion.' + region + '-region.json?bustcache=true',
            success: function(data) {
                $.each(data, function(index, value) {
                    $("#deviceSum").text(data[index].value);
                    $("#deviceSummaryDate").empty().append(data[index].currentDate);
                });
                if(data.length < 1) {
                    $(".removeDiv").empty();
                    $(".hiddeDiv").addClass("hidden");
                }
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.log("The request was not made");
                $(".removeDiv").empty();
                $(".hiddeDiv").addClass("hidden");
            }
        });
    }
});




$(function() {

    $(".printDeviceSummary").on("click",function(e){
        if($(".js-display-text").length) {
            console.log("wiiii~");
            var button=$(".js-display-text"),
                      target=button.prev(),
                      curHeight = 70,
                      autoHeight = target.css('height', 'auto').height(),
                      newHeight=(button.hasClass('opened'))?curHeight:autoHeight,
                      oldHeight=(button.hasClass('opened'))?autoHeight:curHeight;
                  if(!button.hasClass('opened')){
                      target.height(oldHeight).animate({height: newHeight}, 0, function(){
                          button.toggleClass('opened');
                          target.toggleClass('visible');
                      });
                  }

        }


        e.stopPropagation();
        var today = getCurrentDate();
        e.preventDefault();

        html2canvas($(this).closest('section'), {
          onrendered: function(canvas) {

			var mywindow = window.open('', '', 'height=600,width=800');
            mywindow.document.write('<html><head><title></title>');
            mywindow.document.write('</head><body >');
            mywindow.document.body.appendChild(canvas);
            //mywindow.document.write('<div>'+$("#copyRightsText").val()+'</div>');
            mywindow.document.write('<div>'+$("#legalText").val()+'</div>');
            mywindow.document.write('<div> A la fecha '+today+'</div>');
            mywindow.document.write('</body></html>');

            mywindow.print();
            mywindow.close();
    

          }
        });
    });
});

$(document).ready(function(){
	$(".ficha-equipo.container-fluid.top-push").spin('largeSpin');
	var scriptFichaDiv = document.createElement("script");
	scriptFichaDiv.innerHTML = getDeviceSummaryDlMetri();
	$("div.ficha-equipo.dtmFicha").prepend(scriptFichaDiv);

	var brand = $("#brandName").text();
	//var deviceName = $("#comercialName").text();
	var model = $("#model").text();
	var buyOptionsTab = $('a[href="#opciones-compra"]');
	var charsTab = $('a[href="#caracteristicas"]');
	var helpTab = $('a[href="#ayuda"]');
	var showMoreBtn = $(".dtmFicha");
	var printHref = $('a.printDeviceSummary');
	var msiLink = $("#msiLink");
	var title = getDevicePageName() + "|Ficha Tecnica|" + brand + "|" + model + ":";
	
	$(buyOptionsTab).attr("data-titulo", title + "Opciones de compra").attr("data-evento", "clicBoton");
	$(charsTab).attr("data-titulo", title + "Caracteristicas").attr("data-evento", "clicBoton");
	$(helpTab).attr("data-titulo", title + "Ayuda y tutoriales").attr("data-evento", "clicBoton");
	$(showMoreBtn).attr("data-titulo", title + "Ver mas").attr("data-evento", "clicEvento");
	$(printHref).attr("data-titulo", title + "Imprimir").attr("data-evento", "clicBoton");
	$(msiLink).attr("data-titulo", title + "Consulta las tarjetas participantes").attr("data-evento", "clicEvento");
	
	$("body").on("deviceDetailsEvent", "#deviceDetailsRow", function () {
		var attribs = getDevicePageName() + "|Ficha Tecnica|" + brand + "|" + model + ":";
    	$("#officialSiteLink").attr("data-titulo", attribs + "Ir al sitio web oficial").attr("data-evento", "clicEvento");
    	$("#othersCharsAccordion").attr("data-titulo", attribs + "Otras caracteristicas").attr("data-evento", "clicEvento");
    	$("#netAvailableAccordion").attr("data-titulo", attribs + "Disponibilidad de red").attr("data-evento", "clicEvento");
    	$("#roamingAccordion").attr("data-titulo", attribs + "Cobertura en el extranjero").attr("data-evento", "clicEvento");
    });

	$(".option-buy.section").on("click", function(){
		$(".option-buy.section").removeClass("active");
		$(this).addClass("active");
		$(".radio-seleccion-tipo-plan.fake-radio.fake-radio-top.plan").removeClass("active");
		$(this).find("div.radio-seleccion-tipo-plan.fake-radio.fake-radio-top.plan").addClass("active");
		$('.cont-btn-action-buy button').removeAttr('disabled');
	});
	
	
});

$(window).load(function() {
	finit();
	$(".ficha-equipo.container-fluid.top-push").spin(false).stop();
});

function searchProduct(arrayObject) {
	var product = [];
	$.each(arrayObject, function(key, val) {
		var precioModalidad = [];
		var precio = [];
		var precioPromo = [];
		var precioVal = (val.precioIVA).toString();
		precio = precioVal.split('.');
		precioModalidad["productId"] = val.productId;
		precioModalidad["precioInt"] = Number(precio[0]);
		precioModalidad["precioDecimal"] = precio[1];
		if(typeof precioModalidad["precioDecimal"] == "undefined"){
			precioModalidad["precioDecimal"] = "00";
		}
		if(precioModalidad["precioDecimal"].length == 1){
			var decimal = precioModalidad["precioDecimal"];
			decimal = decimal + "0";
			precioModalidad["precioDecimal"] = decimal;
		}
		precioModalidad["modalidad"] = val.modalidad;
		precioModalidad["tieneInventario"] = val.tieneInventario;
		precioModalidad["noPromotion"] = true;
		if(val.promoPriceIVA != null){	// Trae promocion
			var validPromotion = validatePromotion(val.x_endDate, val.x_eligibleDevicesForPromo);
			if(validPromotion){		// Es una promocion valida()
				var precioPromoVal = (val.promoPriceIVA).toString();
				precioModalidad["noPromotion"] = false;
				precioPromo = precioPromoVal.split('.');
				precioModalidad["precioPromoInt"] = Number(precioPromo[0]);
				precioModalidad["precioPromoDecimal"] = precioPromo[1];
				if(typeof precioModalidad["precioPromoDecimal"] == "undefined"){
					precioModalidad["precioPromoDecimal"] = "00";
				}
				if(precioModalidad["precioPromoDecimal"].length == 1){
					var decimalPromo = precioModalidad["precioPromoDecimal"];
					decimalPromo = decimalPromo + "0";
					precioModalidad["precioPromoDecimal"] = decimalPromo;
				}
			}
		}
		product.push(precioModalidad);
	});
	return product;
};

function validatePromotion(endDate, availableDevices){
	var devicesQuantity = -1;
	var onlyDateValidation = false;
	var promoDate;
	var now;
	
	//Validamos por numero de dispositivos
	if(typeof availableDevices != "undefined" && availableDevices != "null"){
		devicesQuantity = availableDevices;
		if(devicesQuantity > 0){
			return true;
		}
	} else {
		onlyDateValidation = true;
	}
	
	// Si no viene numero de dispositivos, validamos por fecha
	if(typeof endDate != "undefined" && endDate != "null" && onlyDateValidation){
		promoDate = new Date(endDate);
		now = new Date;
		if(now.getTime() < promoDate.getTime()){
			return true
		}
	}
	
	return false;
}

function updateProductSlider($slider, product_images, color){
	var html = getHtmlProductSlide(product_images, color);
	renderProductSlider($slider, html);
}

function getHtmlProductSlide(items, color){
	var html = '';
	for (var i = 0; i < items.length; i++) {
		html += '<div class="item text-center"><img src="' + items[i].thumbnail + '" alt="'+$("#model").html()+'" title="'+$("#model").html()+' '+color+'" class="cloudzoom hidden-xs col-centered" data-cloudzoom = "zoomImage: \'' + items[i].zoom + '\',autoInside: 768, zoomPosition: \'.zoom-holder\'"/><img src="' + items[i].thumbnail + '" alt="Terminal" class="visible-xs col-centered" /></div>';
	}
	return html;
}

function renderProductSlider($slider, html){
	$slider.html(html);
	reInitSlider($slider);
}

function reInitSlider($slider){
	var productSlider = $slider.data('owlCarousel');
	productSlider.reinit();
	CloudZoom.quickStart();
}

/*
function updatePrices($planes, items){
	for (var i = 0; i < items.length; i++) {
		$planes.eq(i).find('.tittle-description-buy').html(items[i].titulo);
		$planes.eq(i).find('.text1').html(items[i].texto1);
		$planes.eq(i).find('.text2').html(items[i].texto2);
		$planes.eq(i).find('.price strong').html(items[i].precio);
	}
}
*/

function finit(){
	$('.cont-btn-action-buy button').attr('disabled', 'disabled');
	
	/*Boton eleigir paquete
	$('.detail-options-buy .ficha-equipo-btn-buy').click(function(){
		if ($(this).hasClass('active')) {
			$('.detail-options-buy .ficha-equipo-btn-buy').removeClass('active');
		} else {
			$('.detail-options-buy .ficha-equipo-btn-buy').removeClass('active');
			$(this).addClass('active');
		}
	});
	*/

	//Tamanio igual en quieres comprarlo
	$(window).resize(function(){
		var altomax_tittle = 0;
		var altomax_cont_1 = 0;
		var altomax_cont_3 = 0;
		$('.tittle-description-buy, .description-buy p:nth-child(1)').css('min-height', '1px');  
		$('.tittle-description-buy').each(function(){  
			if($(this).height() > altomax_tittle){  
				altomax_tittle = $(this).height();  
			}  
		});
		$('.description-buy p:nth-child(1)').each(function(){  
			if($(this).height() > altomax_cont_1){  
				altomax_cont_1 = $(this).height();  
			}  
		});
		$('.description-buy p:nth-child(3)').each(function(){  
			if($(this).height() > altomax_cont_3){  
				altomax_cont_3 = $(this).height();  
			}  
		});  
		$('.tittle-description-buy').css('min-height', altomax_tittle); 
		$('.description-buy p:nth-child(1)').css('min-height', altomax_cont_1); 
		$('.description-buy p:nth-child(3)').css('min-height', altomax_cont_3);
	});
}

var app = angular.module("telcelApp")
.controller("DeviceCharsController", ['$scope','$cookies','$http', '$window', function($scope, $cookies, $http, $window) {
	
	$scope.coloresMap = [];
	$scope.capacidades = [];
	$scope.colores = [];
	$scope.coloresCapacidadesMap = [];
	$scope.sapPlanes = [];
	$scope.color = "";
	$scope.capacidad = "";
	$scope.productos = [];
	$scope.productIdSelected = "";
	$scope.deviceAvailable = false;
	$scope.hasPrice = false;
	var sapDefault = "";
	var colorCapacidadDefault = [];
	var catalogEntryId = "";
	
	$scope.createChars = function(){
        // datos para estadisticas de SEO. Jira 232
        $(".cloudzoom").each(function() {
            var deviceImgSrcSplitted=$(this).attr("src").split("/");
            $(this).attr("title",$(this).attr("alt")+" "+deviceImgSrcSplitted[8]);
        });
		var showPrices = $("#showPrices").val();
    	if(showPrices != "true"){
    		return;
    	}
		var urlService = "/bin/telcelcom/device/chars.colores.deviceId.region.amigo.precios.sap1.sap2.html?bustcache=" + generateTimeStamp();
    	var region = $cookies.telcelcom_region === null ? "9" : $cookies.telcelcom_region;
    	var deviceId = $("#deviceId").val();
    	var sap1 = $("#plan1").val();
    	var sap2 = $("#plan2").val();
    	urlService = urlService.replace("region", region);
		urlService = urlService.replace("deviceId", deviceId);
		urlService = urlService.replace("precios", showPrices);
		urlService = urlService.replace("sap1", sap1);
		urlService = urlService.replace("sap2", sap2);
    	$http.get(urlService)
    		.then(function(response) {
    			if(response.data.success === "true" && response.data.data != null){
    				$scope.fillMaps(response.data.data);
    				$scope.deviceAvailable = true;
    			}
    		}, function(response){
    			console.log("Error on request. Code: " + response.status + " - Message: " + response.statusText);
    		});
    };
    
    $scope.fillMaps = function(mainData) {
    	$scope.capacidades = mainData.capacidades;
    	$scope.colores = mainData.colores;
    	$scope.coloresCapacidadesMap = mainData.coloresCapacidadesMap;
    	$scope.coloresMap = mainData.coloresMap;
    	$scope.sapPlanes = mainData.sapPlanes;
    	$scope.fillImageAttr($scope.coloresMap);
    	sapDefault = mainData.sapDefault;
    	$.each(mainData.coloresCapacidadesMap, function(key, val){
            var currentSap=val[0].sap;
            var bundlespan=$("#"+currentSap);
            if(sapDefault == currentSap){
                if(bundlespan){
                    bundlespan.show();
                }
                colorCapacidadDefault = key.split("-");
            }
            if(bundlespan){
                $(bundlespan).addClass("validated");
            }
    	});

        $( ".bundlespan" ).each(function() {
            if($( this ).hasClass("validated") === false){
                //console.log( "removing bundle sapcode: " + $( this ).attr("id") );
                $( this ).remove();
            }
        });
    	$.each($scope.coloresMap, function(key){
    		if(key == colorCapacidadDefault[0]){
    			$scope.coloresMap[key]["isDefault"] = "active";
    		}else{
    			$scope.coloresMap[key]["isDefault"] = "";
    		}
    	});
    	
    	$.each($scope.capacidades, function(key, value){
    		if(value == colorCapacidadDefault[1]){
    			$scope.capacidades[key] = {'capacity': value, 'isDefault':'active'};
    		}else{
    			$scope.capacidades[key] = {'capacity': value, 'isDefault':''};
    		}
    	});
    	$scope.color = colorCapacidadDefault[0];
    	$scope.capacidad = colorCapacidadDefault[1];
    	$scope.updateColorCapacidad();
    };
    
    $scope.fillImageAttr = function(coloresMap) {
    	angular.forEach(coloresMap, function(data,color) {
    		var singleColor = data;
    		var images = data.imagenes;
	    	var dataImgAtr = "[";
	    	angular.forEach(images, function(obj,key) {
	    		dataImgAtr += "{\"thumbnail\": \"" + obj.value + "/jcr:content/renditions/cq5dam.web.250.470.jpeg\", \"zoom\": \"" + obj.value + "/_jcr_content/renditions/cq5dam.web.827.1600.jpeg\"},";
	    	});
	    	dataImgAtr = dataImgAtr.replace(/,\s*$/, "");
	    	dataImgAtr += "]";
	    	var singleColorString = JSON.stringify(singleColor);
	    	singleColorString = singleColorString.replace(/}\s*$/, "");
	    	singleColorString = singleColorString + ",\"imageDataAtribute\":" + dataImgAtr + "}";
	    	singleColor = JSON.parse(singleColorString);
	    	$scope.coloresMap[color] = singleColor;
    	});
    };
    
    $scope.updateColorCapacidad = function() {
    	var colorCapacidad = $scope.color + "-" + $scope.capacidad;
    	var productos = [];
    	var colorCapacidadFound = null;
    	colorCapacidadFound = $scope.coloresCapacidadesMap[colorCapacidad];
    	if(typeof colorCapacidadFound != "undefined" ){
    		productos = searchProduct(colorCapacidadFound);
    		$scope.productos = productos;
    		$scope.setProductId(null, productos[0]);		// Por el momento solo hay un elemento
    	} else {
    		$scope.productos = [];
    		$(".option-buy.section").addClass("disabled");
    		$(".radio-seleccion-tipo-plan.fake-radio.fake-radio-top.plan").removeClass("active");
    		//$('.cont-btn-action-buy button').attr('disabled', 'disabled');
    	}
    };
    
    $scope.redirectPrepagoCart = function(productId) {
    	var urlService = "/bin/telcelcom/device/prepagoCart.productID.region.html?bustcache=" + generateTimeStamp();
		var regionCookie = $cookies.telcelcom_region === null ? "9" : $cookies.telcelcom_region;
    	urlService = urlService.replace("productID",productId);
    	urlService = urlService.replace("region",regionCookie);
		$http.get(urlService)
			.success(function(data) {
				if(catalogEntryId != ""){
					data += "&planId=" + catalogEntryId;
				}
				$window.location.href = data;
		});
    };
    
    $scope.setColor = function(event, color) {
    	//Paso 1 elegir color
    	event.preventDefault();
    	$scope.color = color;
    	$scope.updateColorCapacidad();
    	var product_images = $(event.currentTarget).data('images');
		var $product_slider = $('.ficha-equipo .js-simple-carousel');
		$.each($scope.coloresMap, function(key, value){
    		if(key == color){
    			$scope.coloresMap[key]["isDefault"] = "active";
    		}else{
    			$scope.coloresMap[key]["isDefault"] = "";
    		}
    	});

//        if (product_images.length > 0) {
//            if (!product_images[0].thumbnail.includes("bundle01")) {
//				var firstImages = $("#imagesOrderDiv").attr('data-imagesorder').split(',');
//                for (c = 0; c < firstImages.length; c++) {
//                    if (firstImages[c].includes("bundle01")) {
//                        var dataImgAtr = "[";
//                        var img = firstImages[c].substr(firstImages[c].indexOf("=") + 1);
//                        img = img.substring(0, img.length - 1);
//                        dataImgAtr += "{\"thumbnail\": \"" + img + "/jcr:content/renditions/cq5dam.web.250.470.jpeg\", \"zoom\": \"" + img + "/_jcr_content/renditions/cq5dam.web.827.1600.jpeg\"},";
//                        dataImgAtr = dataImgAtr.replace(/,\s*$/, "");
//                        dataImgAtr += "]";
//                        product_images.unshift(JSON.parse(dataImgAtr)[0]);
//                    }
//                    if (firstImages[c].includes("bundle02")) {
//                        var dataImgAtr = "[";
//                        var img = firstImages[c].substr(firstImages[c].indexOf("=") + 1);
//                        img = img.substring(0, img.length - 1);
//                        dataImgAtr += "{\"thumbnail\": \"" + img + "/jcr:content/renditions/cq5dam.web.250.470.jpeg\", \"zoom\": \"" + img + "/_jcr_content/renditions/cq5dam.web.827.1600.jpeg\"},";
//                        dataImgAtr = dataImgAtr.replace(/,\s*$/, "");
//                        dataImgAtr += "]";
//                        product_images.splice(1, 0, JSON.parse(dataImgAtr)[0]);
//                    }
//                }
//            }
//        }
		updateProductSlider($product_slider, product_images, color);
        $(".bundlespan").hide();
        $.each($scope.coloresCapacidadesMap, function(key, val){
            var currentSap=val[0].sap;
            var currentColor= key.split("-")[0];
            var bundlespan=$("#"+currentSap);
            if(bundlespan){
                if(currentColor === color){
                    $(bundlespan).show();
                    return false;
                }
            }
    	});
		$scope.disableCapacities(color);
    };
    
    $scope.setCapacidad = function(capacidad, e) {
    	//Paso 2 Elegir Capacidad
    	if(e != null){
    		e.preventDefault();
    	}
    	$scope.capacidad = capacidad;
    	$scope.updateColorCapacidad();
    	var linkObjs = $(".ficha-tecnica-seleccionar-capacidad > li > a");
    	$.each(linkObjs, function(key, element){
    		var elementId = $(element).attr('id');
    		if(elementId == capacidad){
    			$(element).addClass('active');
    		}else{
    			$(element).removeClass('active');
    		}
    	});
    };
    
    $scope.setProductId = function(event, product) {
    	//Paso 3 Eligir tipo de compra
    	if(event != null){
    		event.preventDefault();
    	}
    	if($scope.productIdSelected != product.productId){
    		$(".option-buy.section").removeClass("active");
    		$(".radio-seleccion-tipo-plan.fake-radio.fake-radio-top.plan").removeClass("active");
    		$('.cont-btn-action-buy button').attr('disabled', 'disabled');
    		$scope.productIdSelected = product.productId;
    	}
    	if(product.precioInt == null || product.precioInt == "" || typeof product.precioInt == "undefined"){
    		$scope.hasPrice = false;
    		product.tieneInventario = false;
    	} else {
    		$scope.hasPrice = true;
    	}
    	
    	if(product.tieneInventario == true){
    		//$('.cont-btn-action-buy button').removeAttr('disabled');
    		$(".option-buy.section").removeClass("disabled");
    	}else{
    		$(".option-buy.section").addClass("disabled");
    		//$('.cont-btn-action-buy button').attr('disabled', 'disabled');
    	}
    };
    
    $scope.disableCapacities = function(color) {
    	var capacityDefault = "";
    	var capacitiesByColorObjs = $scope.coloresMap[color].capacidadesMap;
    	var capacitiesByColor = Object.keys(capacitiesByColorObjs);
    	var linkObjs = $(".ficha-tecnica-seleccionar-capacidad > li > a");
    	$.each(linkObjs, function(i, element){
    		var elementId = $(element).attr('id');
    		$.each(capacitiesByColor, function(key, val){
    			$(element).removeClass('active');
    			if(elementId != val){
    				$(element).addClass('disabled');
    				$(element).closest('li').addClass('disabled');
    			}else{
    				$(element).removeClass('disabled');
    				$(element).closest('li').removeClass('disabled');
    				return false;
    			}
    		});
    	});
    	$.each(linkObjs, function(i, element){
    		if(!$(element).hasClass("disabled")){
    			capacityDefault = $(element).attr('id');
    			return false;
    		}
    	});
    	$scope.setCapacidad(capacityDefault, null);
    };
    
    $scope.setCatalogEntry = function(sap) {
    	$.each($scope.sapPlanes, function(i, obj){
    		if(sap == obj.sap){
    			catalogEntryId = obj.catalogEntryId;
    			return false;
    		}
    	});
    };
    
    $scope.$on('ngRepeatFinished', function(ngRepeatFinishedEvent) {
    	var imageSelector = "a[id='" + colorCapacidadDefault[0] + "']";
    	var imageSapDefault = $(imageSelector).data('images');
//        if (imageSapDefault.length > 0) {
//        	var i = imageSapDefault.length;
//        	while (i--) {
//        		if (imageSapDefault[i].thumbnail.includes("bundle01")) {
//        			if (i != 0) {
//        				imageSapDefault.splice(i, 1);
//        			}
//        		}
//        		if (imageSapDefault[i].thumbnail.includes("bundle02")) {
//        			if (i != 1) {
//        				imageSapDefault.splice(i, 1);
//        			}
//        		}
//        	}
//        }  
//        var firstImages = $("#imagesOrderDiv").attr('data-imagesorder').split(',');
//        for (c = 0; c < firstImages.length; c++) {
//            if (firstImages[c].includes("bundle01")) {
//                var dataImgAtr = "[";
//                var img = firstImages[c].substr(firstImages[c].indexOf("=") + 1);
//                img = img.substring(0, img.length - 1);
//                dataImgAtr += "{\"thumbnail\": \"" + img + "/jcr:content/renditions/cq5dam.web.250.470.jpeg\", \"zoom\": \"" + img + "/_jcr_content/renditions/cq5dam.web.827.1600.jpeg\"},";
//                dataImgAtr = dataImgAtr.replace(/,\s*$/, "");
//                dataImgAtr += "]";
//                imageSapDefault.unshift(JSON.parse(dataImgAtr)[0]);
//            }
//            if (firstImages[c].includes("bundle02")) {
//                var dataImgAtr = "[";
//                var img = firstImages[c].substr(firstImages[c].indexOf("=") + 1);
//                img = img.substring(0, img.length - 1);
//                dataImgAtr += "{\"thumbnail\": \"" + img + "/jcr:content/renditions/cq5dam.web.250.470.jpeg\", \"zoom\": \"" + img + "/_jcr_content/renditions/cq5dam.web.827.1600.jpeg\"},";
//                dataImgAtr = dataImgAtr.replace(/,\s*$/, "");
//                dataImgAtr += "]";
//                imageSapDefault.splice(1, 0, JSON.parse(dataImgAtr)[0]);
//            }
//        }
    	if(typeof imageSapDefault != 'undefined' && imageSapDefault.length > 0){
    		updateProductSlider($('.ficha-equipo .js-simple-carousel'), imageSapDefault, colorCapacidadDefault[0]);
    	}
        $scope.disableCapacities($scope.color);
    });
    
}])
.directive('onFinishRender', function($timeout) {
	return {
		restrict: 'A',
        link: function (scope, element, attr) {
        	if (scope.$last) {
                $timeout(function () {
                    scope.$emit(attr.onFinishRender);
                });
            }
        }
	};
});

function getDeviceSummaryDlMetri(){
	var ecomPageName = getDevicePageName();
	var regionId = getRegionFromCookie();
	var profile = getProfileFromCookie();
	var fecha = getDTMDate();
	var dispo = getBrowserResolution();
	var path = getBredcrum();
	var page = path.substr(0, path.lastIndexOf('|') + 1);
	var deviceId = $("#deviceId").val();
	var brand = $("#brandName").text();
	var comercialName = $("#comercialName").text();
	var model = $("#model").text();
	//if(comercialName == "" || comercialName == "undefined" || comercialName == null){
	//	comercialName = model;
	//}

	var status = "";
	if ($("#isNextRelease").val() != "" && $("#isNextRelease").val() == "true"){
		status = "Lanzamiento";
	} else if($("#isNew").val() != "" && $("#isNew").val() == "true"){
		status = "Nuevo";
	} else {
		status = "Actual";
	}
	var cat = "";
	if(ecomPageName.indexOf("Telefonos y Smartphones") > 0){
		cat = "Telefonos y Smartphones";
	}else if(ecomPageName.indexOf("Tablets") > 0){
		cat = "Tablets";
	}else if(ecomPageName.indexOf("Tablets") > 0){
		cat = "Tablets";
	}else if(ecomPageName.indexOf("Wifi Movil") > 0){
		cat = "Wifi Movil";
	}else if(ecomPageName.indexOf("Modems USB") > 0){
		cat = "Modems USB";
	}
	//var promoType = "Desc";
	//var promoDesc = 0;
	var dlMetri="var dlMetri={\n" +
			"'ecomPageName':'"+ecomPageName+"|Ficha tecnica|"+brand+"|"+comercialName+"',\n" +
			"'ecomFecha':'"+fecha+"',\n" +
			"'ecomPerfil':'"+profile+"',\n" +
			"'ecomZona':'"+regionId+"',\n" +
			"'ecomDispo':'"+dispo+"',\n" +
			"'ecomSec':'Equipos',\n" +
			"'ecomEquipo':'"+comercialName+"',\n" +
			"'ecomEquipoTecnico':'"+model+"',\n" +
			"'ecomCateg':'"+cat+"',\n" +
			"'ecomMarca':'"+brand+"',\n" +
			"'ecomEstadoEq':'"+status+"',\n" +
			"'ecomJerarquia':'"+page+"Ficha tecnica|"+comercialName+"',\n" +
			"'ecomEvento':'producto',\n" +
			"'ecomProdId':'"+deviceId+"'\n" +
			//"'ecomTipoDesc':'"+promoType+"'\n" +
			//"'ecomNumDesc':'"+promoDesc+"'\n" +
		"};\n" +
		"_satellite.track(\"telProducto\");";
	return dlMetri;
}

/**
 * Created by jhernandez on 12/03/15.
 */

$(function(){
    var loadExternal = function($parent, target){
        var url = $parent.attr('data-url');
        if(url.indexOf("?bustcache=true") != -1) {
            console.log("replacing bustcache parameter!");
            url = url.replace("?bustcache=true","?bustcache=" + generateTimeStamp());
        }
        $.ajax({
            url: url, /*$parent.attr('data-url'),*/
            dataType: 'HTML'
        }).done(function(result){
            var $target =$parent.find(target);
            $target.html(result);
            onAjaxSuccess($target);
            $('.js-checkboxComparar').prettyCheckable();
            $($target).find('[data-trigger-events]').each(function() {
                $(this).dataTriggerEvent();
            });
        }).fail(function(){
            console.log("Could not retrieve data.");
        });
    };

    $('body').on('device.devicesamigo', '.xk-js-devicesamigo', function(e, target) {
        loadExternal($(e.target), target);
    });

    $('.xk-js-devicesamigo').each(function(){
        loadExternal($(this), $(this).attr('data-target'));
    });
});


$(document).ready(function(){

    var backgroundColor = $("#color").val();
    $(".small-band").css("background-color","#"+backgroundColor);

});


var printTechTable = function (techs) {
    var tablearea = document.getElementById('dipoRedTableArea'),
            table = document.createElement('table'), tbody = document.createElement('tbody');

    for (i = 0; i < techs.length; i++) {
        var tr = document.createElement('tr');
        var techTH = document.createElement('th');

        tr.appendChild(techTH);
        tr.appendChild(document.createElement('td'));

        tr.cells[0].appendChild(document.createTextNode(techs[i].tech))
        if( techs[i].bands && techs[i].bands.length >0 ){
            tr.cells[1].appendChild(document.createTextNode(techs[i].bands));
        }else{
            if( techs[i].frequencies && techs[i].frequencies.length >0 ){
                tr.cells[1].appendChild(
                        document.createTextNode(techs[i].frequencies+" MHz")
                        );
            }
        }
        tbody.appendChild(tr);
    }
    table.appendChild(tbody);
    table.classList.add("table");
    table.classList.add("table-bordered");
    tablearea.appendChild(table);
}
var showNetworkDispo = function () {
    var techsSpans = $(".techs");
    //console.log("techsSpans="+techsSpans);
    var techsArr =  new Array(techsSpans.length);
    for (i = 0; i < techsSpans.length; i++) {
        var techVal = $(techsSpans[i]).data("tech");
        var order = 0;
        if( techVal === 'GSM' ){
            order = 1;
        }else{
            if( techVal === '3G' ){
                order = 2;
            }else{
                if( techVal === '4G' || techVal === '4GLTE'){
                    order = 3;
                }else{
                    order = 4;
                }
            }
        }
        var freqBandArr = $(techsSpans[i]).text().split("|");
        techsArr[i] = {
            priority : order,
            tech: techVal,
            bands: freqBandArr[0],
            frequencies: freqBandArr[1]
        };
    }
    techsArr.sort(function(a, b){return a.priority-b.priority});
    /*console.log("techsArr tech="+techsArr[0].tech+" bands="+techsArr[0].bands);
    for (i = 0; i < techsArr.length; i++) {
        console.log(techsArr[i]);
    }*/
    printTechTable(techsArr);
}
/**
 * This javascript is used to set selector to call servlet
 * Created by Jose Vasquez on 21/10/14.
 */
function readPage(dataValue){
    var urlServlet = $('#form-filtros').attr('action');
    if(urlServlet.indexOf(".html")>0){
        urlServlet = urlServlet.substring(0,urlServlet.indexOf(".html"));
    }
    var order = $('#orden option:selected').val();
    if(urlServlet.indexOf(".pageNext-")>0){
        urlServlet = urlServlet.substring(0,urlServlet.indexOf(".pageNext-"));
    }
    urlServlet += ".pageNext-"+dataValue;
    urlServlet += getShowPricesParam() + ".html?bustcache=" + generateTimeStamp();
    $('#order-resultados').attr('action',urlServlet);
    $('#form-filtros').attr('action',urlServlet);
    $('#pagesValues').attr('action',urlServlet);
    $('html,body').scrollTop(0);
}

$('.filterSelect').change(function(){
	var barItems = $('#load-items li');
	var firstBarItem = $('#load-items li').first();
	for(var i = 0; i < barItems.length; i++){
        $(barItems[i]).removeClass("active");
    }
    $(firstBarItem).addClass("active");
	var order = $('#orden option:selected').val();
    var urlServlet = "/bin/telcelcom/device/filter.";
    urlServlet +=  buildCheckNameCookie();
    if(urlServlet.indexOf("order")>0){
        urlServlet = urlServlet.substr(0,urlServlet.indexOf(".order"));
    }
    urlServlet += ".order-" + order;
    urlServlet += getShowPricesParam() + ".html?bustcache=" + generateTimeStamp();
    $('#form-filtros').attr('action',urlServlet);
});

$('.tab-category').click(function(){
    var order = $('#orden option:selected').val();
    var call = $(this).attr('data-tag');
    var urlServlet = "/bin/telcelcom/device/filter.";
    urlServlet +=  buildCheckNameCookie();
    if(call != ""){
        urlServlet += "."+call;
    }
    if(urlServlet.indexOf("order")>0){
        urlServlet = urlServlet.substr(0,urlServlet.indexOf(".order"));
    }
    urlServlet += ".order-" + order;
    urlServlet += getShowPricesParam() + ".html?bustcache=" + generateTimeStamp();
    $(this).attr('href',urlServlet);
    $('#form-filtros').attr('action',urlServlet);
    
});

$('#categoria').change(function() {
    var urlServlet = "/bin/telcelcom/device/filter.";
    var valueCombo = $('#categoria option:selected').val();
    urlServlet += buildCheckNameCookie();
    urlServlet += ".sc&" + valueCombo + ".html?bustcache=" + generateTimeStamp();

    var url = "/bin/telcelcom/device/filter.valpage-";
    url = url + ".html?bustcache=true";
    $('#form-filtros').attr('action',urlServlet);
    $('#order-resultados').attr('action',urlServlet);
    var service = "/bin/telcelcom/device/filter.subCategories-";
    service = service + valueCombo+".json?bustcache=" + generateTimeStamp();
    $.ajax({
        url: service,
        context: document.body
    }).done(function(data) {
        var $el = $("#accesorio");
        $el.empty(); // remove old options
        $.each(data, function(key,value) {
            $el.append($("<option></option>")
                .attr("value", value).text(key)).trigger('chosen:updated');
        });
    });
    
});

$('#accesorio').change(function() {
    var urlServlet = "/bin/telcelcom/device/filter.";
    var valueCombo = $('#categoria option:selected').val();
    var accessoryValue = $('#accesorio option:selected').val();
    urlServlet += buildCheckNameCookie();
    if(!accessoryValue){
        urlServlet += ".sc&" + valueCombo + ".html?bustcache=" + generateTimeStamp();
    }else if(accessoryValue.indexOf("[[") > 0){
        urlServlet += ".sc&" + accessoryValue + ".html?bustcache=" + generateTimeStamp();
    } else {
        urlServlet += ".sc&" + valueCombo + "[[" + accessoryValue +".html?bustcache=" + generateTimeStamp();
    }
    $('#form-filtros').attr('action',urlServlet);
    $('#order-resultados').attr('action',urlServlet);

});

$('#orden').change(function() {
    var url = $('#form-filtros').attr('action');
    if(url.indexOf(".html")>0){
        url = url.substring(0,url.indexOf(".html"));
    }
    var urlServlet = url;
    //var valueCombo = $('#categoria option:selected').val();
    //var accessoryValue = $('#accesorio option:selected').val();
    var order = $('#orden option:selected').val();
    //urlServlet +=  buildCheckNameCookie();
    //urlServlet += valueCombo + "-"+accessoryValue;
    if(urlServlet.indexOf("order")>0){
        urlServlet = urlServlet.substr(0,urlServlet.indexOf(".order"));
    }
    urlServlet += ".order-" + order;
    urlServlet += getShowPricesParam() + ".html?bustcache=" + generateTimeStamp();
    $('#form-filtros').attr('action',urlServlet);
    $('#order-resultados').attr('action',urlServlet);

});

$("#searchbox").change(function() {
    if( $('#values-dialog').attr('data-category') === "9"){
        var value = $("#searchbox").val();
        var url = '/bin/telcelcom/device/filter.isAccessory';
        var valuesDialog = $('#values-dialog').attr('data-category');
        valuesDialog = valuesDialog + "-" + $('#values-dialog').attr('data-itemsPerPage');
        url = url + "." + "values-" + valuesDialog;
        url = url + '.texto-'+value+".html?bustcache=" + generateTimeStamp();
        $('#form-filtros').attr('action',url);
    } else {
        var value = $("#searchbox").val();
        var urlServlet = "/bin/telcelcom/device/filter.";
        urlServlet +=  buildCheckNameCookie();
        urlServlet = urlServlet + '.texto-'+value+".html?bustcache=" + generateTimeStamp();
        $('#form-filtros').attr('action',urlServlet);
    }
});


$( document ).ready(function() {
	var url = window.location.href;
	if(url.indexOf("?") > 0) {
		var urlParams = window.location.href.slice(window.location.href.indexOf('?') + 1);
		var deviceNameByUrl = urlParams.split("=");
		var inputToCheck = $(":checkbox.js-checkboxFilters.filterSelect[value='" + deviceNameByUrl[1] + "']");
		if(inputToCheck.length === 1){
			$(inputToCheck).next().addClass('checked');
			$(inputToCheck).trigger('click');
			return;
		} else {
			console.log("No se encontro marca con id: " + deviceNameByUrl);
		}
	}
	url = "";
    if( $('#values-dialog').attr('data-category') === "9"){
        url = '/bin/telcelcom/device/filter.'+ buildCheckNameCookie()+".order-relevancia";
    } else {
        url = '/bin/telcelcom/device/filter.'+ buildCheckNameCookie()+".predef-todos.order-relevancia";
    }
    url = url + getShowPricesParam() + ".html?bustcache=" + generateTimeStamp();
    $.ajax({
        url: url,
        context: document.body
    }).done(function(data) {
        $('#resultadosTarget').append(data);
        $('#form-filtros').attr('action',url);
        $('.js-checkboxComparar-filtros').prettyCheckable();
        $('.prettycheckbox').addClass('visible-xs visible-sm visible-md visible-lg');
        $('select#orden option[value="relevancia"]').attr("selected",true).trigger('chosen:updated');
        insertDeviceFiltersDlMetri();
    });
    
    $("body").on("deviceListShowed", "#deviceListHidden", function () {
    	insertDeviceFiltersDlMetri();
    });
});

function getCookie(){
    var cookie = 9;
    if($.cookie("telcelcom_region") != null){
        cookie = $.cookie("telcelcom_region");
    }
    return cookie;
}

function getNamePage(){
    var namePage = window.location.pathname;
    var pageNameValue = "";
    if(namePage.indexOf(".html")>0){
        pageNameValue = namePage.substring(namePage.lastIndexOf("/") + 1,namePage.lastIndexOf(".html"));
    } else if(namePage[namePage.length-1] === "/") {
        pageNameValueArray = namePage.split("/");
        pageNameValue = pageNameValueArray[pageNameValueArray.length-2];
    } else {
        pageNameValue = namePage.substring(namePage.lastIndexOf("/") + 1);
    }
    return pageNameValue;
}

function getCheckBoxSelectors(){
    var filters = $('.filterSelect');
    var filtersCheck ="";
    for(var i = 0; i < filters.length; i++){
        if($(filters[i]).prop("checked")){
            if(filtersCheck.indexOf($(filters[i]).attr('id'))<0) {
                filtersCheck = filtersCheck + "." + $(filters[i]).attr('id');
            }
        }
    }
    return filtersCheck;
}

function buildCheckNameCookie(){
    var cookie = getCookie();
    var namePage = getNamePage();
    var checkBox = getCheckBoxSelectors();
    var build = cookie + "." + namePage + checkBox;
    return build;
}

function getShowPricesParam(){
	var showPrices = $('#values-dialog').attr('data-showPrices');
	if(typeof showPrices != "undefined"){
		if(showPrices != "true"){
			showPrices = "false";	
		}
	}else{
		showPrices = "false";
	}
	return "." + showPrices;
}

function getDeviceFiltersDlMetri(){
	var ecomPageName = getDevicePageName();
	var regionId = getRegionFromCookie();
	var profile = getProfileFromCookie();
	var fecha = getDTMDate();
	var dispo = getBrowserResolution();
	var path = getBredcrum();
	var page = path.substr(path.lastIndexOf('|') + 1);
	var regex = new RegExp('ecomPageNameList', 'g');
	var deviceListField = $("#deviceListHidden");
	if(typeof deviceListField == "undefined" || deviceListField.length == 0){
		return "";
	}
	var deviceList = deviceListField.val();
	deviceList = deviceList.replace(regex, ecomPageName);
	var dlMetri = "var dlMetri={\n" +
			"'ecomPageName':'"+ecomPageName+"',\n" +
			"'ecomFecha':'"+fecha+"',\n" +
			"'ecomPerfil':'"+profile+"',\n" +
			"'ecomZona':'"+regionId+"',\n" +
			"'ecomDispo':'"+dispo+"',\n" +
			"'ecomSec':'"+page+"',\n" +
			"'ecomJerarquia':'"+path+"',\n" +
			"'ecomEvento':'equipos',\n" +
			"'ecomListaEquipos':'"+deviceList+"'\n" +
		"};\n" +
		"_satellite.track(\"ecomtelEquipos\");";
	return dlMetri;
}

function insertDeviceFiltersDlMetri(){
	var ecomPageName = getDevicePageName();
	var deviceBtn = $(".dtmDeviceFilterClass");
	$.each(deviceBtn, function(i,val){
	var dataAtt = $(this).attr("data-titulo");
		dataAtt = dataAtt.replace("ecomPageNameList", ecomPageName);
		$(this).attr("data-titulo", dataAtt);
	});
	var scriptDeviceFiltersDiv = $("#scriptDeviceFiltersDiv");
	if(scriptDeviceFiltersDiv == "undefined" || scriptDeviceFiltersDiv.length == 0){
		var script = document.createElement("div");
		script.setAttribute("id", "scriptDeviceFiltersDiv");
		script.innerHTML = "<script>" + getDeviceFiltersDlMetri() + "\n</script>"
		$("div.busqueda-equipos").prepend(script);
	}else{
		$(scriptDeviceFiltersDiv).html("");
		var script = document.createElement("script");
		script.innerHTML = getDeviceFiltersDlMetri();
		$(scriptDeviceFiltersDiv).append(script);		
	}
}
$(function() {
    var region = $.cookie("telcelcom_region");
    if ((typeof region === 'undefined') || region === "") {
        region = 9;
    }
    var sectionTag = $("#priceRegionInfo");
    if (sectionTag.attr("data-pagePath") && sectionTag.attr("data-resourcePath")) {
        var url = sectionTag.attr("data-pagePath") + sectionTag.attr("data-resourcePath");
        $.ajax({
            type: 'GET',
            contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
            dataType: 'json',
            url: url + '.priceregion.' + region + '-region.json?bustcache=true',
            success: function(data) {
                $.each(data, function(index, value) {
                    $(".puntual-lowest-price").text(data[index].value);
                    $("#amigoKitPriceDate").empty().append(data[index].currentDate);
                });
                if(data.length < 1) {
                    $(".removeDiv").empty();
                    $(".hiddeDiv").addClass("hidden");
                }
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.log("The request was not made");
            }
        });
    }
});
/*
  html2canvas 0.4.1 <http://html2canvas.hertzen.com>
  Copyright (c) 2013 Niklas von Hertzen

  Released under MIT License
*/

(function(window, document, undefined){

"use strict";

var _html2canvas = {},
previousElement,
computedCSS,
html2canvas;

_html2canvas.Util = {};

_html2canvas.Util.log = function(a) {
  if (_html2canvas.logging && window.console && window.console.log) {
    window.console.log(a);
  }
};

_html2canvas.Util.trimText = (function(isNative){
  return function(input) {
    return isNative ? isNative.apply(input) : ((input || '') + '').replace( /^\s+|\s+$/g , '' );
  };
})(String.prototype.trim);

_html2canvas.Util.asFloat = function(v) {
  return parseFloat(v);
};

(function() {
  // TODO: support all possible length values
  var TEXT_SHADOW_PROPERTY = /((rgba|rgb)\([^\)]+\)(\s-?\d+px){0,})/g;
  var TEXT_SHADOW_VALUES = /(-?\d+px)|(#.+)|(rgb\(.+\))|(rgba\(.+\))/g;
  _html2canvas.Util.parseTextShadows = function (value) {
    if (!value || value === 'none') {
      return [];
    }

    // find multiple shadow declarations
    var shadows = value.match(TEXT_SHADOW_PROPERTY),
      results = [];
    for (var i = 0; shadows && (i < shadows.length); i++) {
      var s = shadows[i].match(TEXT_SHADOW_VALUES);
      results.push({
        color: s[0],
        offsetX: s[1] ? s[1].replace('px', '') : 0,
        offsetY: s[2] ? s[2].replace('px', '') : 0,
        blur: s[3] ? s[3].replace('px', '') : 0
      });
    }
    return results;
  };
})();


_html2canvas.Util.parseBackgroundImage = function (value) {
    var whitespace = ' \r\n\t',
        method, definition, prefix, prefix_i, block, results = [],
        c, mode = 0, numParen = 0, quote, args;

    var appendResult = function(){
        if(method) {
            if(definition.substr( 0, 1 ) === '"') {
                definition = definition.substr( 1, definition.length - 2 );
            }
            if(definition) {
                args.push(definition);
            }
            if(method.substr( 0, 1 ) === '-' &&
                    (prefix_i = method.indexOf( '-', 1 ) + 1) > 0) {
                prefix = method.substr( 0, prefix_i);
                method = method.substr( prefix_i );
            }
            results.push({
                prefix: prefix,
                method: method.toLowerCase(),
                value: block,
                args: args
            });
        }
        args = []; //for some odd reason, setting .length = 0 didn't work in safari
        method =
            prefix =
            definition =
            block = '';
    };

    appendResult();
    for(var i = 0, ii = value.length; i<ii; i++) {
        c = value[i];
        if(mode === 0 && whitespace.indexOf( c ) > -1){
            continue;
        }
        switch(c) {
            case '"':
                if(!quote) {
                    quote = c;
                }
                else if(quote === c) {
                    quote = null;
                }
                break;

            case '(':
                if(quote) { break; }
                else if(mode === 0) {
                    mode = 1;
                    block += c;
                    continue;
                } else {
                    numParen++;
                }
                break;

            case ')':
                if(quote) { break; }
                else if(mode === 1) {
                    if(numParen === 0) {
                        mode = 0;
                        block += c;
                        appendResult();
                        continue;
                    } else {
                        numParen--;
                    }
                }
                break;

            case ',':
                if(quote) { break; }
                else if(mode === 0) {
                    appendResult();
                    continue;
                }
                else if (mode === 1) {
                    if(numParen === 0 && !method.match(/^url$/i)) {
                        args.push(definition);
                        definition = '';
                        block += c;
                        continue;
                    }
                }
                break;
        }

        block += c;
        if(mode === 0) { method += c; }
        else { definition += c; }
    }
    appendResult();

    return results;
};

_html2canvas.Util.Bounds = function (element) {
  var clientRect, bounds = {};

  if (element.getBoundingClientRect){
    clientRect = element.getBoundingClientRect();

    // TODO add scroll position to bounds, so no scrolling of window necessary
    bounds.top = clientRect.top;
    bounds.bottom = clientRect.bottom || (clientRect.top + clientRect.height);
    bounds.left = clientRect.left;

    bounds.width = element.offsetWidth;
    bounds.height = element.offsetHeight;
  }

  return bounds;
};

// TODO ideally, we'd want everything to go through this function instead of Util.Bounds,
// but would require further work to calculate the correct positions for elements with offsetParents
_html2canvas.Util.OffsetBounds = function (element) {
  var parent = element.offsetParent ? _html2canvas.Util.OffsetBounds(element.offsetParent) : {top: 0, left: 0};

  return {
    top: element.offsetTop + parent.top,
    bottom: element.offsetTop + element.offsetHeight + parent.top,
    left: element.offsetLeft + parent.left,
    width: element.offsetWidth,
    height: element.offsetHeight
  };
};

function toPX(element, attribute, value ) {
    var rsLeft = element.runtimeStyle && element.runtimeStyle[attribute],
        left,
        style = element.style;

    // Check if we are not dealing with pixels, (Opera has issues with this)
    // Ported from jQuery css.js
    // From the awesome hack by Dean Edwards
    // http://erik.eae.net/archives/2007/07/27/18.54.15/#comment-102291

    // If we're not dealing with a regular pixel number
    // but a number that has a weird ending, we need to convert it to pixels

    if ( !/^-?[0-9]+\.?[0-9]*(?:px)?$/i.test( value ) && /^-?\d/.test(value) ) {
        // Remember the original values
        left = style.left;

        // Put in the new values to get a computed value out
        if (rsLeft) {
            element.runtimeStyle.left = element.currentStyle.left;
        }
        style.left = attribute === "fontSize" ? "1em" : (value || 0);
        value = style.pixelLeft + "px";

        // Revert the changed values
        style.left = left;
        if (rsLeft) {
            element.runtimeStyle.left = rsLeft;
        }
    }

    if (!/^(thin|medium|thick)$/i.test(value)) {
        return Math.round(parseFloat(value)) + "px";
    }

    return value;
}

function asInt(val) {
    return parseInt(val, 10);
}

function parseBackgroundSizePosition(value, element, attribute, index) {
    value = (value || '').split(',');
    value = value[index || 0] || value[0] || 'auto';
    value = _html2canvas.Util.trimText(value).split(' ');

    if(attribute === 'backgroundSize' && (!value[0] || value[0].match(/cover|contain|auto/))) {
        //these values will be handled in the parent function
    } else {
        value[0] = (value[0].indexOf( "%" ) === -1) ? toPX(element, attribute + "X", value[0]) : value[0];
        if(value[1] === undefined) {
            if(attribute === 'backgroundSize') {
                value[1] = 'auto';
                return value;
            } else {
                // IE 9 doesn't return double digit always
                value[1] = value[0];
            }
        }
        value[1] = (value[1].indexOf("%") === -1) ? toPX(element, attribute + "Y", value[1]) : value[1];
    }
    return value;
}

_html2canvas.Util.getCSS = function (element, attribute, index) {
    if (previousElement !== element) {
      computedCSS = document.defaultView.getComputedStyle(element, null);
    }

    var value = computedCSS[attribute];

    if (/^background(Size|Position)$/.test(attribute)) {
        return parseBackgroundSizePosition(value, element, attribute, index);
    } else if (/border(Top|Bottom)(Left|Right)Radius/.test(attribute)) {
      var arr = value.split(" ");
      if (arr.length <= 1) {
          arr[1] = arr[0];
      }
      return arr.map(asInt);
    }

  return value;
};

_html2canvas.Util.resizeBounds = function( current_width, current_height, target_width, target_height, stretch_mode ){
  var target_ratio = target_width / target_height,
    current_ratio = current_width / current_height,
    output_width, output_height;

  if(!stretch_mode || stretch_mode === 'auto') {
    output_width = target_width;
    output_height = target_height;
  } else if(target_ratio < current_ratio ^ stretch_mode === 'contain') {
    output_height = target_height;
    output_width = target_height * current_ratio;
  } else {
    output_width = target_width;
    output_height = target_width / current_ratio;
  }

  return {
    width: output_width,
    height: output_height
  };
};

function backgroundBoundsFactory( prop, el, bounds, image, imageIndex, backgroundSize ) {
    var bgposition =  _html2canvas.Util.getCSS( el, prop, imageIndex ) ,
    topPos,
    left,
    percentage,
    val;

    if (bgposition.length === 1){
      val = bgposition[0];

      bgposition = [];

      bgposition[0] = val;
      bgposition[1] = val;
    }

    if (bgposition[0].toString().indexOf("%") !== -1){
      percentage = (parseFloat(bgposition[0])/100);
      left = bounds.width * percentage;
      if(prop !== 'backgroundSize') {
        left -= (backgroundSize || image).width*percentage;
      }
    } else {
      if(prop === 'backgroundSize') {
        if(bgposition[0] === 'auto') {
          left = image.width;
        } else {
          if (/contain|cover/.test(bgposition[0])) {
            var resized = _html2canvas.Util.resizeBounds(image.width, image.height, bounds.width, bounds.height, bgposition[0]);
            left = resized.width;
            topPos = resized.height;
          } else {
            left = parseInt(bgposition[0], 10);
          }
        }
      } else {
        left = parseInt( bgposition[0], 10);
      }
    }


    if(bgposition[1] === 'auto') {
      topPos = left / image.width * image.height;
    } else if (bgposition[1].toString().indexOf("%") !== -1){
      percentage = (parseFloat(bgposition[1])/100);
      topPos =  bounds.height * percentage;
      if(prop !== 'backgroundSize') {
        topPos -= (backgroundSize || image).height * percentage;
      }

    } else {
      topPos = parseInt(bgposition[1],10);
    }

    return [left, topPos];
}

_html2canvas.Util.BackgroundPosition = function( el, bounds, image, imageIndex, backgroundSize ) {
    var result = backgroundBoundsFactory( 'backgroundPosition', el, bounds, image, imageIndex, backgroundSize );
    return { left: result[0], top: result[1] };
};

_html2canvas.Util.BackgroundSize = function( el, bounds, image, imageIndex ) {
    var result = backgroundBoundsFactory( 'backgroundSize', el, bounds, image, imageIndex );
    return { width: result[0], height: result[1] };
};

_html2canvas.Util.Extend = function (options, defaults) {
  for (var key in options) {
    if (options.hasOwnProperty(key)) {
      defaults[key] = options[key];
    }
  }
  return defaults;
};


/*
 * Derived from jQuery.contents()
 * Copyright 2010, John Resig
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://jquery.org/license
 */
_html2canvas.Util.Children = function( elem ) {
  var children;
  try {
    children = (elem.nodeName && elem.nodeName.toUpperCase() === "IFRAME") ? elem.contentDocument || elem.contentWindow.document : (function(array) {
      var ret = [];
      if (array !== null) {
        (function(first, second ) {
          var i = first.length,
          j = 0;

          if (typeof second.length === "number") {
            for (var l = second.length; j < l; j++) {
              first[i++] = second[j];
            }
          } else {
            while (second[j] !== undefined) {
              first[i++] = second[j++];
            }
          }

          first.length = i;

          return first;
        })(ret, array);
      }
      return ret;
    })(elem.childNodes);

  } catch (ex) {
    _html2canvas.Util.log("html2canvas.Util.Children failed with exception: " + ex.message);
    children = [];
  }
  return children;
};

_html2canvas.Util.isTransparent = function(backgroundColor) {
  return (backgroundColor === "transparent" || backgroundColor === "rgba(0, 0, 0, 0)");
};
_html2canvas.Util.Font = (function () {

  var fontData = {};

  return function(font, fontSize, doc) {
    if (fontData[font + "-" + fontSize] !== undefined) {
      return fontData[font + "-" + fontSize];
    }

    var container = doc.createElement('div'),
    img = doc.createElement('img'),
    span = doc.createElement('span'),
    sampleText = 'Hidden Text',
    baseline,
    middle,
    metricsObj;

    container.style.visibility = "hidden";
    container.style.fontFamily = font;
    container.style.fontSize = fontSize;
    container.style.margin = 0;
    container.style.padding = 0;

    doc.body.appendChild(container);

    // http://probablyprogramming.com/2009/03/15/the-tiniest-gif-ever (handtinywhite.gif)
    img.src = "data:image/gif;base64,R0lGODlhAQABAIABAP///wAAACwAAAAAAQABAAACAkQBADs=";
    img.width = 1;
    img.height = 1;

    img.style.margin = 0;
    img.style.padding = 0;
    img.style.verticalAlign = "baseline";

    span.style.fontFamily = font;
    span.style.fontSize = fontSize;
    span.style.margin = 0;
    span.style.padding = 0;

    span.appendChild(doc.createTextNode(sampleText));
    container.appendChild(span);
    container.appendChild(img);
    baseline = (img.offsetTop - span.offsetTop) + 1;

    container.removeChild(span);
    container.appendChild(doc.createTextNode(sampleText));

    container.style.lineHeight = "normal";
    img.style.verticalAlign = "super";

    middle = (img.offsetTop-container.offsetTop) + 1;
    metricsObj = {
      baseline: baseline,
      lineWidth: 1,
      middle: middle
    };

    fontData[font + "-" + fontSize] = metricsObj;

    doc.body.removeChild(container);

    return metricsObj;
  };
})();

(function(){
  var Util = _html2canvas.Util,
    Generate = {};

  _html2canvas.Generate = Generate;

  var reGradients = [
  /^(-webkit-linear-gradient)\(([a-z\s]+)([\w\d\.\s,%\(\)]+)\)$/,
  /^(-o-linear-gradient)\(([a-z\s]+)([\w\d\.\s,%\(\)]+)\)$/,
  /^(-webkit-gradient)\((linear|radial),\s((?:\d{1,3}%?)\s(?:\d{1,3}%?),\s(?:\d{1,3}%?)\s(?:\d{1,3}%?))([\w\d\.\s,%\(\)\-]+)\)$/,
  /^(-moz-linear-gradient)\(((?:\d{1,3}%?)\s(?:\d{1,3}%?))([\w\d\.\s,%\(\)]+)\)$/,
  /^(-webkit-radial-gradient)\(((?:\d{1,3}%?)\s(?:\d{1,3}%?)),\s(\w+)\s([a-z\-]+)([\w\d\.\s,%\(\)]+)\)$/,
  /^(-moz-radial-gradient)\(((?:\d{1,3}%?)\s(?:\d{1,3}%?)),\s(\w+)\s?([a-z\-]*)([\w\d\.\s,%\(\)]+)\)$/,
  /^(-o-radial-gradient)\(((?:\d{1,3}%?)\s(?:\d{1,3}%?)),\s(\w+)\s([a-z\-]+)([\w\d\.\s,%\(\)]+)\)$/
  ];

  /*
 * TODO: Add IE10 vendor prefix (-ms) support
 * TODO: Add W3C gradient (linear-gradient) support
 * TODO: Add old Webkit -webkit-gradient(radial, ...) support
 * TODO: Maybe some RegExp optimizations are possible ;o)
 */
  Generate.parseGradient = function(css, bounds) {
    var gradient, i, len = reGradients.length, m1, stop, m2, m2Len, step, m3, tl,tr,br,bl;

    for(i = 0; i < len; i+=1){
      m1 = css.match(reGradients[i]);
      if(m1) {
        break;
      }
    }

    if(m1) {
      switch(m1[1]) {
        case '-webkit-linear-gradient':
        case '-o-linear-gradient':

          gradient = {
            type: 'linear',
            x0: null,
            y0: null,
            x1: null,
            y1: null,
            colorStops: []
          };

          // get coordinates
          m2 = m1[2].match(/\w+/g);
          if(m2){
            m2Len = m2.length;
            for(i = 0; i < m2Len; i+=1){
              switch(m2[i]) {
                case 'top':
                  gradient.y0 = 0;
                  gradient.y1 = bounds.height;
                  break;

                case 'right':
                  gradient.x0 = bounds.width;
                  gradient.x1 = 0;
                  break;

                case 'bottom':
                  gradient.y0 = bounds.height;
                  gradient.y1 = 0;
                  break;

                case 'left':
                  gradient.x0 = 0;
                  gradient.x1 = bounds.width;
                  break;
              }
            }
          }
          if(gradient.x0 === null && gradient.x1 === null){ // center
            gradient.x0 = gradient.x1 = bounds.width / 2;
          }
          if(gradient.y0 === null && gradient.y1 === null){ // center
            gradient.y0 = gradient.y1 = bounds.height / 2;
          }

          // get colors and stops
          m2 = m1[3].match(/((?:rgb|rgba)\(\d{1,3},\s\d{1,3},\s\d{1,3}(?:,\s[0-9\.]+)?\)(?:\s\d{1,3}(?:%|px))?)+/g);
          if(m2){
            m2Len = m2.length;
            step = 1 / Math.max(m2Len - 1, 1);
            for(i = 0; i < m2Len; i+=1){
              m3 = m2[i].match(/((?:rgb|rgba)\(\d{1,3},\s\d{1,3},\s\d{1,3}(?:,\s[0-9\.]+)?\))\s*(\d{1,3})?(%|px)?/);
              if(m3[2]){
                stop = parseFloat(m3[2]);
                if(m3[3] === '%'){
                  stop /= 100;
                } else { // px - stupid opera
                  stop /= bounds.width;
                }
              } else {
                stop = i * step;
              }
              gradient.colorStops.push({
                color: m3[1],
                stop: stop
              });
            }
          }
          break;

        case '-webkit-gradient':

          gradient = {
            type: m1[2] === 'radial' ? 'circle' : m1[2], // TODO: Add radial gradient support for older mozilla definitions
            x0: 0,
            y0: 0,
            x1: 0,
            y1: 0,
            colorStops: []
          };

          // get coordinates
          m2 = m1[3].match(/(\d{1,3})%?\s(\d{1,3})%?,\s(\d{1,3})%?\s(\d{1,3})%?/);
          if(m2){
            gradient.x0 = (m2[1] * bounds.width) / 100;
            gradient.y0 = (m2[2] * bounds.height) / 100;
            gradient.x1 = (m2[3] * bounds.width) / 100;
            gradient.y1 = (m2[4] * bounds.height) / 100;
          }

          // get colors and stops
          m2 = m1[4].match(/((?:from|to|color-stop)\((?:[0-9\.]+,\s)?(?:rgb|rgba)\(\d{1,3},\s\d{1,3},\s\d{1,3}(?:,\s[0-9\.]+)?\)\))+/g);
          if(m2){
            m2Len = m2.length;
            for(i = 0; i < m2Len; i+=1){
              m3 = m2[i].match(/(from|to|color-stop)\(([0-9\.]+)?(?:,\s)?((?:rgb|rgba)\(\d{1,3},\s\d{1,3},\s\d{1,3}(?:,\s[0-9\.]+)?\))\)/);
              stop = parseFloat(m3[2]);
              if(m3[1] === 'from') {
                stop = 0.0;
              }
              if(m3[1] === 'to') {
                stop = 1.0;
              }
              gradient.colorStops.push({
                color: m3[3],
                stop: stop
              });
            }
          }
          break;

        case '-moz-linear-gradient':

          gradient = {
            type: 'linear',
            x0: 0,
            y0: 0,
            x1: 0,
            y1: 0,
            colorStops: []
          };

          // get coordinates
          m2 = m1[2].match(/(\d{1,3})%?\s(\d{1,3})%?/);

          // m2[1] == 0%   -> left
          // m2[1] == 50%  -> center
          // m2[1] == 100% -> right

          // m2[2] == 0%   -> top
          // m2[2] == 50%  -> center
          // m2[2] == 100% -> bottom

          if(m2){
            gradient.x0 = (m2[1] * bounds.width) / 100;
            gradient.y0 = (m2[2] * bounds.height) / 100;
            gradient.x1 = bounds.width - gradient.x0;
            gradient.y1 = bounds.height - gradient.y0;
          }

          // get colors and stops
          m2 = m1[3].match(/((?:rgb|rgba)\(\d{1,3},\s\d{1,3},\s\d{1,3}(?:,\s[0-9\.]+)?\)(?:\s\d{1,3}%)?)+/g);
          if(m2){
            m2Len = m2.length;
            step = 1 / Math.max(m2Len - 1, 1);
            for(i = 0; i < m2Len; i+=1){
              m3 = m2[i].match(/((?:rgb|rgba)\(\d{1,3},\s\d{1,3},\s\d{1,3}(?:,\s[0-9\.]+)?\))\s*(\d{1,3})?(%)?/);
              if(m3[2]){
                stop = parseFloat(m3[2]);
                if(m3[3]){ // percentage
                  stop /= 100;
                }
              } else {
                stop = i * step;
              }
              gradient.colorStops.push({
                color: m3[1],
                stop: stop
              });
            }
          }
          break;

        case '-webkit-radial-gradient':
        case '-moz-radial-gradient':
        case '-o-radial-gradient':

          gradient = {
            type: 'circle',
            x0: 0,
            y0: 0,
            x1: bounds.width,
            y1: bounds.height,
            cx: 0,
            cy: 0,
            rx: 0,
            ry: 0,
            colorStops: []
          };

          // center
          m2 = m1[2].match(/(\d{1,3})%?\s(\d{1,3})%?/);
          if(m2){
            gradient.cx = (m2[1] * bounds.width) / 100;
            gradient.cy = (m2[2] * bounds.height) / 100;
          }

          // size
          m2 = m1[3].match(/\w+/);
          m3 = m1[4].match(/[a-z\-]*/);
          if(m2 && m3){
            switch(m3[0]){
              case 'farthest-corner':
              case 'cover': // is equivalent to farthest-corner
              case '': // mozilla removes "cover" from definition :(
                tl = Math.sqrt(Math.pow(gradient.cx, 2) + Math.pow(gradient.cy, 2));
                tr = Math.sqrt(Math.pow(gradient.cx, 2) + Math.pow(gradient.y1 - gradient.cy, 2));
                br = Math.sqrt(Math.pow(gradient.x1 - gradient.cx, 2) + Math.pow(gradient.y1 - gradient.cy, 2));
                bl = Math.sqrt(Math.pow(gradient.x1 - gradient.cx, 2) + Math.pow(gradient.cy, 2));
                gradient.rx = gradient.ry = Math.max(tl, tr, br, bl);
                break;
              case 'closest-corner':
                tl = Math.sqrt(Math.pow(gradient.cx, 2) + Math.pow(gradient.cy, 2));
                tr = Math.sqrt(Math.pow(gradient.cx, 2) + Math.pow(gradient.y1 - gradient.cy, 2));
                br = Math.sqrt(Math.pow(gradient.x1 - gradient.cx, 2) + Math.pow(gradient.y1 - gradient.cy, 2));
                bl = Math.sqrt(Math.pow(gradient.x1 - gradient.cx, 2) + Math.pow(gradient.cy, 2));
                gradient.rx = gradient.ry = Math.min(tl, tr, br, bl);
                break;
              case 'farthest-side':
                if(m2[0] === 'circle'){
                  gradient.rx = gradient.ry = Math.max(
                    gradient.cx,
                    gradient.cy,
                    gradient.x1 - gradient.cx,
                    gradient.y1 - gradient.cy
                    );
                } else { // ellipse

                  gradient.type = m2[0];

                  gradient.rx = Math.max(
                    gradient.cx,
                    gradient.x1 - gradient.cx
                    );
                  gradient.ry = Math.max(
                    gradient.cy,
                    gradient.y1 - gradient.cy
                    );
                }
                break;
              case 'closest-side':
              case 'contain': // is equivalent to closest-side
                if(m2[0] === 'circle'){
                  gradient.rx = gradient.ry = Math.min(
                    gradient.cx,
                    gradient.cy,
                    gradient.x1 - gradient.cx,
                    gradient.y1 - gradient.cy
                    );
                } else { // ellipse

                  gradient.type = m2[0];

                  gradient.rx = Math.min(
                    gradient.cx,
                    gradient.x1 - gradient.cx
                    );
                  gradient.ry = Math.min(
                    gradient.cy,
                    gradient.y1 - gradient.cy
                    );
                }
                break;

            // TODO: add support for "30px 40px" sizes (webkit only)
            }
          }

          // color stops
          m2 = m1[5].match(/((?:rgb|rgba)\(\d{1,3},\s\d{1,3},\s\d{1,3}(?:,\s[0-9\.]+)?\)(?:\s\d{1,3}(?:%|px))?)+/g);
          if(m2){
            m2Len = m2.length;
            step = 1 / Math.max(m2Len - 1, 1);
            for(i = 0; i < m2Len; i+=1){
              m3 = m2[i].match(/((?:rgb|rgba)\(\d{1,3},\s\d{1,3},\s\d{1,3}(?:,\s[0-9\.]+)?\))\s*(\d{1,3})?(%|px)?/);
              if(m3[2]){
                stop = parseFloat(m3[2]);
                if(m3[3] === '%'){
                  stop /= 100;
                } else { // px - stupid opera
                  stop /= bounds.width;
                }
              } else {
                stop = i * step;
              }
              gradient.colorStops.push({
                color: m3[1],
                stop: stop
              });
            }
          }
          break;
      }
    }

    return gradient;
  };

  function addScrollStops(grad) {
    return function(colorStop) {
      try {
        grad.addColorStop(colorStop.stop, colorStop.color);
      }
      catch(e) {
        Util.log(['failed to add color stop: ', e, '; tried to add: ', colorStop]);
      }
    };
  }

  Generate.Gradient = function(src, bounds) {
    if(bounds.width === 0 || bounds.height === 0) {
      return;
    }

    var canvas = document.createElement('canvas'),
    ctx = canvas.getContext('2d'),
    gradient, grad;

    canvas.width = bounds.width;
    canvas.height = bounds.height;

    // TODO: add support for multi defined background gradients
    gradient = _html2canvas.Generate.parseGradient(src, bounds);

    if(gradient) {
      switch(gradient.type) {
        case 'linear':
          grad = ctx.createLinearGradient(gradient.x0, gradient.y0, gradient.x1, gradient.y1);
          gradient.colorStops.forEach(addScrollStops(grad));
          ctx.fillStyle = grad;
          ctx.fillRect(0, 0, bounds.width, bounds.height);
          break;

        case 'circle':
          grad = ctx.createRadialGradient(gradient.cx, gradient.cy, 0, gradient.cx, gradient.cy, gradient.rx);
          gradient.colorStops.forEach(addScrollStops(grad));
          ctx.fillStyle = grad;
          ctx.fillRect(0, 0, bounds.width, bounds.height);
          break;

        case 'ellipse':
          var canvasRadial = document.createElement('canvas'),
            ctxRadial = canvasRadial.getContext('2d'),
            ri = Math.max(gradient.rx, gradient.ry),
            di = ri * 2;

          canvasRadial.width = canvasRadial.height = di;

          grad = ctxRadial.createRadialGradient(gradient.rx, gradient.ry, 0, gradient.rx, gradient.ry, ri);
          gradient.colorStops.forEach(addScrollStops(grad));

          ctxRadial.fillStyle = grad;
          ctxRadial.fillRect(0, 0, di, di);

          ctx.fillStyle = gradient.colorStops[gradient.colorStops.length - 1].color;
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(canvasRadial, gradient.cx - gradient.rx, gradient.cy - gradient.ry, 2 * gradient.rx, 2 * gradient.ry);
          break;
      }
    }

    return canvas;
  };

  Generate.ListAlpha = function(number) {
    var tmp = "",
    modulus;

    do {
      modulus = number % 26;
      tmp = String.fromCharCode((modulus) + 64) + tmp;
      number = number / 26;
    }while((number*26) > 26);

    return tmp;
  };

  Generate.ListRoman = function(number) {
    var romanArray = ["M", "CM", "D", "CD", "C", "XC", "L", "XL", "X", "IX", "V", "IV", "I"],
    decimal = [1000, 900, 500, 400, 100, 90, 50, 40, 10, 9, 5, 4, 1],
    roman = "",
    v,
    len = romanArray.length;

    if (number <= 0 || number >= 4000) {
      return number;
    }

    for (v=0; v < len; v+=1) {
      while (number >= decimal[v]) {
        number -= decimal[v];
        roman += romanArray[v];
      }
    }

    return roman;
  };
})();
function h2cRenderContext(width, height) {
  var storage = [];
  return {
    storage: storage,
    width: width,
    height: height,
    clip: function() {
      storage.push({
        type: "function",
        name: "clip",
        'arguments': arguments
      });
    },
    translate: function() {
      storage.push({
        type: "function",
        name: "translate",
        'arguments': arguments
      });
    },
    fill: function() {
      storage.push({
        type: "function",
        name: "fill",
        'arguments': arguments
      });
    },
    save: function() {
      storage.push({
        type: "function",
        name: "save",
        'arguments': arguments
      });
    },
    restore: function() {
      storage.push({
        type: "function",
        name: "restore",
        'arguments': arguments
      });
    },
    fillRect: function () {
      storage.push({
        type: "function",
        name: "fillRect",
        'arguments': arguments
      });
    },
    createPattern: function() {
      storage.push({
        type: "function",
        name: "createPattern",
        'arguments': arguments
      });
    },
    drawShape: function() {

      var shape = [];

      storage.push({
        type: "function",
        name: "drawShape",
        'arguments': shape
      });

      return {
        moveTo: function() {
          shape.push({
            name: "moveTo",
            'arguments': arguments
          });
        },
        lineTo: function() {
          shape.push({
            name: "lineTo",
            'arguments': arguments
          });
        },
        arcTo: function() {
          shape.push({
            name: "arcTo",
            'arguments': arguments
          });
        },
        bezierCurveTo: function() {
          shape.push({
            name: "bezierCurveTo",
            'arguments': arguments
          });
        },
        quadraticCurveTo: function() {
          shape.push({
            name: "quadraticCurveTo",
            'arguments': arguments
          });
        }
      };

    },
    drawImage: function () {
      storage.push({
        type: "function",
        name: "drawImage",
        'arguments': arguments
      });
    },
    fillText: function () {
      storage.push({
        type: "function",
        name: "fillText",
        'arguments': arguments
      });
    },
    setVariable: function (variable, value) {
      storage.push({
        type: "variable",
        name: variable,
        'arguments': value
      });
      return value;
    }
  };
}
_html2canvas.Parse = function (images, options) {
  window.scroll(0,0);

  var element = (( options.elements === undefined ) ? document.body : options.elements[0]), // select body by default
  numDraws = 0,
  doc = element.ownerDocument,
  Util = _html2canvas.Util,
  support = Util.Support(options, doc),
  ignoreElementsRegExp = new RegExp("(" + options.ignoreElements + ")"),
  body = doc.body,
  getCSS = Util.getCSS,
  pseudoHide = "___html2canvas___pseudoelement",
  hidePseudoElements = doc.createElement('style');

  hidePseudoElements.innerHTML = '.' + pseudoHide + '-before:before { content: "" !important; display: none !important; }' +
  '.' + pseudoHide + '-after:after { content: "" !important; display: none !important; }';

  body.appendChild(hidePseudoElements);

  images = images || {};

  function documentWidth () {
    return Math.max(
      Math.max(doc.body.scrollWidth, doc.documentElement.scrollWidth),
      Math.max(doc.body.offsetWidth, doc.documentElement.offsetWidth),
      Math.max(doc.body.clientWidth, doc.documentElement.clientWidth)
      );
  }

  function documentHeight () {
    return Math.max(
      Math.max(doc.body.scrollHeight, doc.documentElement.scrollHeight),
      Math.max(doc.body.offsetHeight, doc.documentElement.offsetHeight),
      Math.max(doc.body.clientHeight, doc.documentElement.clientHeight)
      );
  }

  function getCSSInt(element, attribute) {
    var val = parseInt(getCSS(element, attribute), 10);
    return (isNaN(val)) ? 0 : val; // borders in old IE are throwing 'medium' for demo.html
  }

  function renderRect (ctx, x, y, w, h, bgcolor) {
    if (bgcolor !== "transparent"){
      ctx.setVariable("fillStyle", bgcolor);
      ctx.fillRect(x, y, w, h);
      numDraws+=1;
    }
  }

  function capitalize(m, p1, p2) {
    if (m.length > 0) {
      return p1 + p2.toUpperCase();
    }
  }

  function textTransform (text, transform) {
    switch(transform){
      case "lowercase":
        return text.toLowerCase();
      case "capitalize":
        return text.replace( /(^|\s|:|-|\(|\))([a-z])/g, capitalize);
      case "uppercase":
        return text.toUpperCase();
      default:
        return text;
    }
  }

  function noLetterSpacing(letter_spacing) {
    return (/^(normal|none|0px)$/.test(letter_spacing));
  }

  function drawText(currentText, x, y, ctx){
    if (currentText !== null && Util.trimText(currentText).length > 0) {
      ctx.fillText(currentText, x, y);
      numDraws+=1;
    }
  }

  function setTextVariables(ctx, el, text_decoration, color) {
    var align = false,
    bold = getCSS(el, "fontWeight"),
    family = getCSS(el, "fontFamily"),
    size = getCSS(el, "fontSize"),
    shadows = Util.parseTextShadows(getCSS(el, "textShadow"));

    switch(parseInt(bold, 10)){
      case 401:
        bold = "bold";
        break;
      case 400:
        bold = "normal";
        break;
    }

    ctx.setVariable("fillStyle", color);
    ctx.setVariable("font", [getCSS(el, "fontStyle"), getCSS(el, "fontVariant"), bold, size, family].join(" "));
    ctx.setVariable("textAlign", (align) ? "right" : "left");

    if (shadows.length) {
      // TODO: support multiple text shadows
      // apply the first text shadow
      ctx.setVariable("shadowColor", shadows[0].color);
      ctx.setVariable("shadowOffsetX", shadows[0].offsetX);
      ctx.setVariable("shadowOffsetY", shadows[0].offsetY);
      ctx.setVariable("shadowBlur", shadows[0].blur);
    }

    if (text_decoration !== "none"){
      return Util.Font(family, size, doc);
    }
  }

  function renderTextDecoration(ctx, text_decoration, bounds, metrics, color) {
    switch(text_decoration) {
      case "underline":
        // Draws a line at the baseline of the font
        // TODO As some browsers display the line as more than 1px if the font-size is big, need to take that into account both in position and size
        renderRect(ctx, bounds.left, Math.round(bounds.top + metrics.baseline + metrics.lineWidth), bounds.width, 1, color);
        break;
      case "overline":
        renderRect(ctx, bounds.left, Math.round(bounds.top), bounds.width, 1, color);
        break;
      case "line-through":
        // TODO try and find exact position for line-through
        renderRect(ctx, bounds.left, Math.ceil(bounds.top + metrics.middle + metrics.lineWidth), bounds.width, 1, color);
        break;
    }
  }

  function getTextBounds(state, text, textDecoration, isLast, transform) {
    var bounds;
    if (support.rangeBounds && !transform) {
      if (textDecoration !== "none" || Util.trimText(text).length !== 0) {
        bounds = textRangeBounds(text, state.node, state.textOffset);
      }
      state.textOffset += text.length;
    } else if (state.node && typeof state.node.nodeValue === "string" ){
      var newTextNode = (isLast) ? state.node.splitText(text.length) : null;
      bounds = textWrapperBounds(state.node, transform);
      state.node = newTextNode;
    }
    return bounds;
  }

  function textRangeBounds(text, textNode, textOffset) {
    var range = doc.createRange();
    range.setStart(textNode, textOffset);
    range.setEnd(textNode, textOffset + text.length);
    return range.getBoundingClientRect();
  }

  function textWrapperBounds(oldTextNode, transform) {
    var parent = oldTextNode.parentNode,
    wrapElement = doc.createElement('wrapper'),
    backupText = oldTextNode.cloneNode(true);

    wrapElement.appendChild(oldTextNode.cloneNode(true));
    parent.replaceChild(wrapElement, oldTextNode);

    var bounds = transform ? Util.OffsetBounds(wrapElement) : Util.Bounds(wrapElement);
    parent.replaceChild(backupText, wrapElement);
    return bounds;
  }

  function renderText(el, textNode, stack) {
    var ctx = stack.ctx,
    color = getCSS(el, "color"),
    textDecoration = getCSS(el, "textDecoration"),
    textAlign = getCSS(el, "textAlign"),
    metrics,
    textList,
    state = {
      node: textNode,
      textOffset: 0
    };

    if (Util.trimText(textNode.nodeValue).length > 0) {
      textNode.nodeValue = textTransform(textNode.nodeValue, getCSS(el, "textTransform"));
      textAlign = textAlign.replace(["-webkit-auto"],["auto"]);

      textList = (!options.letterRendering && /^(left|right|justify|auto)$/.test(textAlign) && noLetterSpacing(getCSS(el, "letterSpacing"))) ?
      textNode.nodeValue.split(/(\b| )/)
      : textNode.nodeValue.split("");

      metrics = setTextVariables(ctx, el, textDecoration, color);

      if (options.chinese) {
        textList.forEach(function(word, index) {
          if (/.*[\u4E00-\u9FA5].*$/.test(word)) {
            word = word.split("");
            word.unshift(index, 1);
            textList.splice.apply(textList, word);
          }
        });
      }

      textList.forEach(function(text, index) {
        var bounds = getTextBounds(state, text, textDecoration, (index < textList.length - 1), stack.transform.matrix);
        if (bounds) {
          drawText(text, bounds.left, bounds.bottom, ctx);
          renderTextDecoration(ctx, textDecoration, bounds, metrics, color);
        }
      });
    }
  }

  function listPosition (element, val) {
    var boundElement = doc.createElement( "boundelement" ),
    originalType,
    bounds;

    boundElement.style.display = "inline";

    originalType = element.style.listStyleType;
    element.style.listStyleType = "none";

    boundElement.appendChild(doc.createTextNode(val));

    element.insertBefore(boundElement, element.firstChild);

    bounds = Util.Bounds(boundElement);
    element.removeChild(boundElement);
    element.style.listStyleType = originalType;
    return bounds;
  }

  function elementIndex(el) {
    var i = -1,
    count = 1,
    childs = el.parentNode.childNodes;

    if (el.parentNode) {
      while(childs[++i] !== el) {
        if (childs[i].nodeType === 1) {
          count++;
        }
      }
      return count;
    } else {
      return -1;
    }
  }

  function listItemText(element, type) {
    var currentIndex = elementIndex(element), text;
    switch(type){
      case "decimal":
        text = currentIndex;
        break;
      case "decimal-leading-zero":
        text = (currentIndex.toString().length === 1) ? currentIndex = "0" + currentIndex.toString() : currentIndex.toString();
        break;
      case "upper-roman":
        text = _html2canvas.Generate.ListRoman( currentIndex );
        break;
      case "lower-roman":
        text = _html2canvas.Generate.ListRoman( currentIndex ).toLowerCase();
        break;
      case "lower-alpha":
        text = _html2canvas.Generate.ListAlpha( currentIndex ).toLowerCase();
        break;
      case "upper-alpha":
        text = _html2canvas.Generate.ListAlpha( currentIndex );
        break;
    }

    return text + ". ";
  }

  function renderListItem(element, stack, elBounds) {
    var x,
    text,
    ctx = stack.ctx,
    type = getCSS(element, "listStyleType"),
    listBounds;

    if (/^(decimal|decimal-leading-zero|upper-alpha|upper-latin|upper-roman|lower-alpha|lower-greek|lower-latin|lower-roman)$/i.test(type)) {
      text = listItemText(element, type);
      listBounds = listPosition(element, text);
      setTextVariables(ctx, element, "none", getCSS(element, "color"));

      if (getCSS(element, "listStylePosition") === "inside") {
        ctx.setVariable("textAlign", "left");
        x = elBounds.left;
      } else {
        return;
      }

      drawText(text, x, listBounds.bottom, ctx);
    }
  }

  function loadImage (src){
    var img = images[src];
    return (img && img.succeeded === true) ? img.img : false;
  }

  function clipBounds(src, dst){
    var x = Math.max(src.left, dst.left),
    y = Math.max(src.top, dst.top),
    x2 = Math.min((src.left + src.width), (dst.left + dst.width)),
    y2 = Math.min((src.top + src.height), (dst.top + dst.height));

    return {
      left:x,
      top:y,
      width:x2-x,
      height:y2-y
    };
  }

  function setZ(element, stack, parentStack){
    var newContext,
    isPositioned = stack.cssPosition !== 'static',
    zIndex = isPositioned ? getCSS(element, 'zIndex') : 'auto',
    opacity = getCSS(element, 'opacity'),
    isFloated = getCSS(element, 'cssFloat') !== 'none';

    // https://developer.mozilla.org/en-US/docs/Web/Guide/CSS/Understanding_z_index/The_stacking_context
    // When a new stacking context should be created:
    // the root element (HTML),
    // positioned (absolutely or relatively) with a z-index value other than "auto",
    // elements with an opacity value less than 1. (See the specification for opacity),
    // on mobile WebKit and Chrome 22+, position: fixed always creates a new stacking context, even when z-index is "auto" (See this post)

    stack.zIndex = newContext = h2czContext(zIndex);
    newContext.isPositioned = isPositioned;
    newContext.isFloated = isFloated;
    newContext.opacity = opacity;
    newContext.ownStacking = (zIndex !== 'auto' || opacity < 1);

    if (parentStack) {
      parentStack.zIndex.children.push(stack);
    }
  }

  function renderImage(ctx, element, image, bounds, borders) {

    var paddingLeft = getCSSInt(element, 'paddingLeft'),
    paddingTop = getCSSInt(element, 'paddingTop'),
    paddingRight = getCSSInt(element, 'paddingRight'),
    paddingBottom = getCSSInt(element, 'paddingBottom');

    drawImage(
      ctx,
      image,
      0, //sx
      0, //sy
      image.width, //sw
      image.height, //sh
      bounds.left + paddingLeft + borders[3].width, //dx
      bounds.top + paddingTop + borders[0].width, // dy
      bounds.width - (borders[1].width + borders[3].width + paddingLeft + paddingRight), //dw
      bounds.height - (borders[0].width + borders[2].width + paddingTop + paddingBottom) //dh
      );
  }

  function getBorderData(element) {
    return ["Top", "Right", "Bottom", "Left"].map(function(side) {
      return {
        width: getCSSInt(element, 'border' + side + 'Width'),
        color: getCSS(element, 'border' + side + 'Color')
      };
    });
  }

  function getBorderRadiusData(element) {
    return ["TopLeft", "TopRight", "BottomRight", "BottomLeft"].map(function(side) {
      return getCSS(element, 'border' + side + 'Radius');
    });
  }

  var getCurvePoints = (function(kappa) {

    return function(x, y, r1, r2) {
      var ox = (r1) * kappa, // control point offset horizontal
      oy = (r2) * kappa, // control point offset vertical
      xm = x + r1, // x-middle
      ym = y + r2; // y-middle
      return {
        topLeft: bezierCurve({
          x:x,
          y:ym
        }, {
          x:x,
          y:ym - oy
        }, {
          x:xm - ox,
          y:y
        }, {
          x:xm,
          y:y
        }),
        topRight: bezierCurve({
          x:x,
          y:y
        }, {
          x:x + ox,
          y:y
        }, {
          x:xm,
          y:ym - oy
        }, {
          x:xm,
          y:ym
        }),
        bottomRight: bezierCurve({
          x:xm,
          y:y
        }, {
          x:xm,
          y:y + oy
        }, {
          x:x + ox,
          y:ym
        }, {
          x:x,
          y:ym
        }),
        bottomLeft: bezierCurve({
          x:xm,
          y:ym
        }, {
          x:xm - ox,
          y:ym
        }, {
          x:x,
          y:y + oy
        }, {
          x:x,
          y:y
        })
      };
    };
  })(4 * ((Math.sqrt(2) - 1) / 3));

  function bezierCurve(start, startControl, endControl, end) {

    var lerp = function (a, b, t) {
      return {
        x:a.x + (b.x - a.x) * t,
        y:a.y + (b.y - a.y) * t
      };
    };

    return {
      start: start,
      startControl: startControl,
      endControl: endControl,
      end: end,
      subdivide: function(t) {
        var ab = lerp(start, startControl, t),
        bc = lerp(startControl, endControl, t),
        cd = lerp(endControl, end, t),
        abbc = lerp(ab, bc, t),
        bccd = lerp(bc, cd, t),
        dest = lerp(abbc, bccd, t);
        return [bezierCurve(start, ab, abbc, dest), bezierCurve(dest, bccd, cd, end)];
      },
      curveTo: function(borderArgs) {
        borderArgs.push(["bezierCurve", startControl.x, startControl.y, endControl.x, endControl.y, end.x, end.y]);
      },
      curveToReversed: function(borderArgs) {
        borderArgs.push(["bezierCurve", endControl.x, endControl.y, startControl.x, startControl.y, start.x, start.y]);
      }
    };
  }

  function parseCorner(borderArgs, radius1, radius2, corner1, corner2, x, y) {
    if (radius1[0] > 0 || radius1[1] > 0) {
      borderArgs.push(["line", corner1[0].start.x, corner1[0].start.y]);
      corner1[0].curveTo(borderArgs);
      corner1[1].curveTo(borderArgs);
    } else {
      borderArgs.push(["line", x, y]);
    }

    if (radius2[0] > 0 || radius2[1] > 0) {
      borderArgs.push(["line", corner2[0].start.x, corner2[0].start.y]);
    }
  }

  function drawSide(borderData, radius1, radius2, outer1, inner1, outer2, inner2) {
    var borderArgs = [];

    if (radius1[0] > 0 || radius1[1] > 0) {
      borderArgs.push(["line", outer1[1].start.x, outer1[1].start.y]);
      outer1[1].curveTo(borderArgs);
    } else {
      borderArgs.push([ "line", borderData.c1[0], borderData.c1[1]]);
    }

    if (radius2[0] > 0 || radius2[1] > 0) {
      borderArgs.push(["line", outer2[0].start.x, outer2[0].start.y]);
      outer2[0].curveTo(borderArgs);
      borderArgs.push(["line", inner2[0].end.x, inner2[0].end.y]);
      inner2[0].curveToReversed(borderArgs);
    } else {
      borderArgs.push([ "line", borderData.c2[0], borderData.c2[1]]);
      borderArgs.push([ "line", borderData.c3[0], borderData.c3[1]]);
    }

    if (radius1[0] > 0 || radius1[1] > 0) {
      borderArgs.push(["line", inner1[1].end.x, inner1[1].end.y]);
      inner1[1].curveToReversed(borderArgs);
    } else {
      borderArgs.push([ "line", borderData.c4[0], borderData.c4[1]]);
    }

    return borderArgs;
  }

  function calculateCurvePoints(bounds, borderRadius, borders) {

    var x = bounds.left,
    y = bounds.top,
    width = bounds.width,
    height = bounds.height,

    tlh = borderRadius[0][0],
    tlv = borderRadius[0][1],
    trh = borderRadius[1][0],
    trv = borderRadius[1][1],
    brh = borderRadius[2][0],
    brv = borderRadius[2][1],
    blh = borderRadius[3][0],
    blv = borderRadius[3][1],

    topWidth = width - trh,
    rightHeight = height - brv,
    bottomWidth = width - brh,
    leftHeight = height - blv;

    return {
      topLeftOuter: getCurvePoints(
        x,
        y,
        tlh,
        tlv
        ).topLeft.subdivide(0.5),

      topLeftInner: getCurvePoints(
        x + borders[3].width,
        y + borders[0].width,
        Math.max(0, tlh - borders[3].width),
        Math.max(0, tlv - borders[0].width)
        ).topLeft.subdivide(0.5),

      topRightOuter: getCurvePoints(
        x + topWidth,
        y,
        trh,
        trv
        ).topRight.subdivide(0.5),

      topRightInner: getCurvePoints(
        x + Math.min(topWidth, width + borders[3].width),
        y + borders[0].width,
        (topWidth > width + borders[3].width) ? 0 :trh - borders[3].width,
        trv - borders[0].width
        ).topRight.subdivide(0.5),

      bottomRightOuter: getCurvePoints(
        x + bottomWidth,
        y + rightHeight,
        brh,
        brv
        ).bottomRight.subdivide(0.5),

      bottomRightInner: getCurvePoints(
        x + Math.min(bottomWidth, width + borders[3].width),
        y + Math.min(rightHeight, height + borders[0].width),
        Math.max(0, brh - borders[1].width),
        Math.max(0, brv - borders[2].width)
        ).bottomRight.subdivide(0.5),

      bottomLeftOuter: getCurvePoints(
        x,
        y + leftHeight,
        blh,
        blv
        ).bottomLeft.subdivide(0.5),

      bottomLeftInner: getCurvePoints(
        x + borders[3].width,
        y + leftHeight,
        Math.max(0, blh - borders[3].width),
        Math.max(0, blv - borders[2].width)
        ).bottomLeft.subdivide(0.5)
    };
  }

  function getBorderClip(element, borderPoints, borders, radius, bounds) {
    var backgroundClip = getCSS(element, 'backgroundClip'),
    borderArgs = [];

    switch(backgroundClip) {
      case "content-box":
      case "padding-box":
        parseCorner(borderArgs, radius[0], radius[1], borderPoints.topLeftInner, borderPoints.topRightInner, bounds.left + borders[3].width, bounds.top + borders[0].width);
        parseCorner(borderArgs, radius[1], radius[2], borderPoints.topRightInner, borderPoints.bottomRightInner, bounds.left + bounds.width - borders[1].width, bounds.top + borders[0].width);
        parseCorner(borderArgs, radius[2], radius[3], borderPoints.bottomRightInner, borderPoints.bottomLeftInner, bounds.left + bounds.width - borders[1].width, bounds.top + bounds.height - borders[2].width);
        parseCorner(borderArgs, radius[3], radius[0], borderPoints.bottomLeftInner, borderPoints.topLeftInner, bounds.left + borders[3].width, bounds.top + bounds.height - borders[2].width);
        break;

      default:
        parseCorner(borderArgs, radius[0], radius[1], borderPoints.topLeftOuter, borderPoints.topRightOuter, bounds.left, bounds.top);
        parseCorner(borderArgs, radius[1], radius[2], borderPoints.topRightOuter, borderPoints.bottomRightOuter, bounds.left + bounds.width, bounds.top);
        parseCorner(borderArgs, radius[2], radius[3], borderPoints.bottomRightOuter, borderPoints.bottomLeftOuter, bounds.left + bounds.width, bounds.top + bounds.height);
        parseCorner(borderArgs, radius[3], radius[0], borderPoints.bottomLeftOuter, borderPoints.topLeftOuter, bounds.left, bounds.top + bounds.height);
        break;
    }

    return borderArgs;
  }

  function parseBorders(element, bounds, borders){
    var x = bounds.left,
    y = bounds.top,
    width = bounds.width,
    height = bounds.height,
    borderSide,
    bx,
    by,
    bw,
    bh,
    borderArgs,
    // http://www.w3.org/TR/css3-background/#the-border-radius
    borderRadius = getBorderRadiusData(element),
    borderPoints = calculateCurvePoints(bounds, borderRadius, borders),
    borderData = {
      clip: getBorderClip(element, borderPoints, borders, borderRadius, bounds),
      borders: []
    };

    for (borderSide = 0; borderSide < 4; borderSide++) {

      if (borders[borderSide].width > 0) {
        bx = x;
        by = y;
        bw = width;
        bh = height - (borders[2].width);

        switch(borderSide) {
          case 0:
            // top border
            bh = borders[0].width;

            borderArgs = drawSide({
              c1: [bx, by],
              c2: [bx + bw, by],
              c3: [bx + bw - borders[1].width, by + bh],
              c4: [bx + borders[3].width, by + bh]
            }, borderRadius[0], borderRadius[1],
            borderPoints.topLeftOuter, borderPoints.topLeftInner, borderPoints.topRightOuter, borderPoints.topRightInner);
            break;
          case 1:
            // right border
            bx = x + width - (borders[1].width);
            bw = borders[1].width;

            borderArgs = drawSide({
              c1: [bx + bw, by],
              c2: [bx + bw, by + bh + borders[2].width],
              c3: [bx, by + bh],
              c4: [bx, by + borders[0].width]
            }, borderRadius[1], borderRadius[2],
            borderPoints.topRightOuter, borderPoints.topRightInner, borderPoints.bottomRightOuter, borderPoints.bottomRightInner);
            break;
          case 2:
            // bottom border
            by = (by + height) - (borders[2].width);
            bh = borders[2].width;

            borderArgs = drawSide({
              c1: [bx + bw, by + bh],
              c2: [bx, by + bh],
              c3: [bx + borders[3].width, by],
              c4: [bx + bw - borders[3].width, by]
            }, borderRadius[2], borderRadius[3],
            borderPoints.bottomRightOuter, borderPoints.bottomRightInner, borderPoints.bottomLeftOuter, borderPoints.bottomLeftInner);
            break;
          case 3:
            // left border
            bw = borders[3].width;

            borderArgs = drawSide({
              c1: [bx, by + bh + borders[2].width],
              c2: [bx, by],
              c3: [bx + bw, by + borders[0].width],
              c4: [bx + bw, by + bh]
            }, borderRadius[3], borderRadius[0],
            borderPoints.bottomLeftOuter, borderPoints.bottomLeftInner, borderPoints.topLeftOuter, borderPoints.topLeftInner);
            break;
        }

        borderData.borders.push({
          args: borderArgs,
          color: borders[borderSide].color
        });

      }
    }

    return borderData;
  }

  function createShape(ctx, args) {
    var shape = ctx.drawShape();
    args.forEach(function(border, index) {
      shape[(index === 0) ? "moveTo" : border[0] + "To" ].apply(null, border.slice(1));
    });
    return shape;
  }

  function renderBorders(ctx, borderArgs, color) {
    if (color !== "transparent") {
      ctx.setVariable( "fillStyle", color);
      createShape(ctx, borderArgs);
      ctx.fill();
      numDraws+=1;
    }
  }

  function renderFormValue (el, bounds, stack){

    var valueWrap = doc.createElement('valuewrap'),
    cssPropertyArray = ['lineHeight','textAlign','fontFamily','color','fontSize','paddingLeft','paddingTop','width','height','border','borderLeftWidth','borderTopWidth'],
    textValue,
    textNode;

    cssPropertyArray.forEach(function(property) {
      try {
        valueWrap.style[property] = getCSS(el, property);
      } catch(e) {
        // Older IE has issues with "border"
        Util.log("html2canvas: Parse: Exception caught in renderFormValue: " + e.message);
      }
    });

    valueWrap.style.borderColor = "black";
    valueWrap.style.borderStyle = "solid";
    valueWrap.style.display = "block";
    valueWrap.style.position = "absolute";

    if (/^(submit|reset|button|text|password)$/.test(el.type) || el.nodeName === "SELECT"){
      valueWrap.style.lineHeight = getCSS(el, "height");
    }

    valueWrap.style.top = bounds.top + "px";
    valueWrap.style.left = bounds.left + "px";

    textValue = (el.nodeName === "SELECT") ? (el.options[el.selectedIndex] || 0).text : el.value;
    if(!textValue) {
      textValue = el.placeholder;
    }

    textNode = doc.createTextNode(textValue);

    valueWrap.appendChild(textNode);
    body.appendChild(valueWrap);

    renderText(el, textNode, stack);
    body.removeChild(valueWrap);
  }

  function drawImage (ctx) {
    ctx.drawImage.apply(ctx, Array.prototype.slice.call(arguments, 1));
    numDraws+=1;
  }

  function getPseudoElement(el, which) {
    var elStyle = window.getComputedStyle(el, which);
    if(!elStyle || !elStyle.content || elStyle.content === "none" || elStyle.content === "-moz-alt-content" || elStyle.display === "none") {
      return;
    }
    var content = elStyle.content + '',
    first = content.substr( 0, 1 );
    //strips quotes
    if(first === content.substr( content.length - 1 ) && first.match(/'|"/)) {
      content = content.substr( 1, content.length - 2 );
    }

    var isImage = content.substr( 0, 3 ) === 'url',
    elps = document.createElement( isImage ? 'img' : 'span' );

    elps.className = pseudoHide + "-before " + pseudoHide + "-after";

    Object.keys(elStyle).filter(indexedProperty).forEach(function(prop) {
      // Prevent assigning of read only CSS Rules, ex. length, parentRule
      try {
        elps.style[prop] = elStyle[prop];
      } catch (e) {
        Util.log(['Tried to assign readonly property ', prop, 'Error:', e]);
      }
    });

    if(isImage) {
      elps.src = Util.parseBackgroundImage(content)[0].args[0];
    } else {
      elps.innerHTML = content;
    }
    return elps;
  }

  function indexedProperty(property) {
    return (isNaN(window.parseInt(property, 10)));
  }

  function injectPseudoElements(el, stack) {
    var before = getPseudoElement(el, ':before'),
    after = getPseudoElement(el, ':after');
    if(!before && !after) {
      return;
    }

    if(before) {
      el.className += " " + pseudoHide + "-before";
      el.parentNode.insertBefore(before, el);
      parseElement(before, stack, true);
      el.parentNode.removeChild(before);
      el.className = el.className.replace(pseudoHide + "-before", "").trim();
    }

    if (after) {
      el.className += " " + pseudoHide + "-after";
      el.appendChild(after);
      parseElement(after, stack, true);
      el.removeChild(after);
      el.className = el.className.replace(pseudoHide + "-after", "").trim();
    }

  }

  function renderBackgroundRepeat(ctx, image, backgroundPosition, bounds) {
    var offsetX = Math.round(bounds.left + backgroundPosition.left),
    offsetY = Math.round(bounds.top + backgroundPosition.top);

    ctx.createPattern(image);
    ctx.translate(offsetX, offsetY);
    ctx.fill();
    ctx.translate(-offsetX, -offsetY);
  }

  function backgroundRepeatShape(ctx, image, backgroundPosition, bounds, left, top, width, height) {
    var args = [];
    args.push(["line", Math.round(left), Math.round(top)]);
    args.push(["line", Math.round(left + width), Math.round(top)]);
    args.push(["line", Math.round(left + width), Math.round(height + top)]);
    args.push(["line", Math.round(left), Math.round(height + top)]);
    createShape(ctx, args);
    ctx.save();
    ctx.clip();
    renderBackgroundRepeat(ctx, image, backgroundPosition, bounds);
    ctx.restore();
  }

  function renderBackgroundColor(ctx, backgroundBounds, bgcolor) {
    renderRect(
      ctx,
      backgroundBounds.left,
      backgroundBounds.top,
      backgroundBounds.width,
      backgroundBounds.height,
      bgcolor
      );
  }

  function renderBackgroundRepeating(el, bounds, ctx, image, imageIndex) {
    var backgroundSize = Util.BackgroundSize(el, bounds, image, imageIndex),
    backgroundPosition = Util.BackgroundPosition(el, bounds, image, imageIndex, backgroundSize),
    backgroundRepeat = getCSS(el, "backgroundRepeat").split(",").map(Util.trimText);

    image = resizeImage(image, backgroundSize);

    backgroundRepeat = backgroundRepeat[imageIndex] || backgroundRepeat[0];

    switch (backgroundRepeat) {
      case "repeat-x":
        backgroundRepeatShape(ctx, image, backgroundPosition, bounds,
          bounds.left, bounds.top + backgroundPosition.top, 99999, image.height);
        break;

      case "repeat-y":
        backgroundRepeatShape(ctx, image, backgroundPosition, bounds,
          bounds.left + backgroundPosition.left, bounds.top, image.width, 99999);
        break;

      case "no-repeat":
        backgroundRepeatShape(ctx, image, backgroundPosition, bounds,
          bounds.left + backgroundPosition.left, bounds.top + backgroundPosition.top, image.width, image.height);
        break;

      default:
        renderBackgroundRepeat(ctx, image, backgroundPosition, {
          top: bounds.top,
          left: bounds.left,
          width: image.width,
          height: image.height
        });
        break;
    }
  }

  function renderBackgroundImage(element, bounds, ctx) {
    var backgroundImage = getCSS(element, "backgroundImage"),
    backgroundImages = Util.parseBackgroundImage(backgroundImage),
    image,
    imageIndex = backgroundImages.length;

    while(imageIndex--) {
      backgroundImage = backgroundImages[imageIndex];

      if (!backgroundImage.args || backgroundImage.args.length === 0) {
        continue;
      }

      var key = backgroundImage.method === 'url' ?
      backgroundImage.args[0] :
      backgroundImage.value;

      image = loadImage(key);

      // TODO add support for background-origin
      if (image) {
        renderBackgroundRepeating(element, bounds, ctx, image, imageIndex);
      } else {
        Util.log("html2canvas: Error loading background:", backgroundImage);
      }
    }
  }

  function resizeImage(image, bounds) {
    if(image.width === bounds.width && image.height === bounds.height) {
      return image;
    }

    var ctx, canvas = doc.createElement('canvas');
    canvas.width = bounds.width;
    canvas.height = bounds.height;
    ctx = canvas.getContext("2d");
    drawImage(ctx, image, 0, 0, image.width, image.height, 0, 0, bounds.width, bounds.height );
    return canvas;
  }

  function setOpacity(ctx, element, parentStack) {
    return ctx.setVariable("globalAlpha", getCSS(element, "opacity") * ((parentStack) ? parentStack.opacity : 1));
  }

  function removePx(str) {
    return str.replace("px", "");
  }

  var transformRegExp = /(matrix)\((.+)\)/;

  function getTransform(element, parentStack) {
    var transform = getCSS(element, "transform") || getCSS(element, "-webkit-transform") || getCSS(element, "-moz-transform") || getCSS(element, "-ms-transform") || getCSS(element, "-o-transform");
    var transformOrigin = getCSS(element, "transform-origin") || getCSS(element, "-webkit-transform-origin") || getCSS(element, "-moz-transform-origin") || getCSS(element, "-ms-transform-origin") || getCSS(element, "-o-transform-origin") || "0px 0px";

    transformOrigin = transformOrigin.split(" ").map(removePx).map(Util.asFloat);

    var matrix;
    if (transform && transform !== "none") {
      var match = transform.match(transformRegExp);
      if (match) {
        switch(match[1]) {
          case "matrix":
            matrix = match[2].split(",").map(Util.trimText).map(Util.asFloat);
            break;
        }
      }
    }

    return {
      origin: transformOrigin,
      matrix: matrix
    };
  }

  function createStack(element, parentStack, bounds, transform) {
    var ctx = h2cRenderContext((!parentStack) ? documentWidth() : bounds.width , (!parentStack) ? documentHeight() : bounds.height),
    stack = {
      ctx: ctx,
      opacity: setOpacity(ctx, element, parentStack),
      cssPosition: getCSS(element, "position"),
      borders: getBorderData(element),
      transform: transform,
      clip: (parentStack && parentStack.clip) ? Util.Extend( {}, parentStack.clip ) : null
    };

    setZ(element, stack, parentStack);

    // TODO correct overflow for absolute content residing under a static position
    if (options.useOverflow === true && /(hidden|scroll|auto)/.test(getCSS(element, "overflow")) === true && /(BODY)/i.test(element.nodeName) === false){
      stack.clip = (stack.clip) ? clipBounds(stack.clip, bounds) : bounds;
    }

    return stack;
  }

  function getBackgroundBounds(borders, bounds, clip) {
    var backgroundBounds = {
      left: bounds.left + borders[3].width,
      top: bounds.top + borders[0].width,
      width: bounds.width - (borders[1].width + borders[3].width),
      height: bounds.height - (borders[0].width + borders[2].width)
    };

    if (clip) {
      backgroundBounds = clipBounds(backgroundBounds, clip);
    }

    return backgroundBounds;
  }

  function getBounds(element, transform) {
    var bounds = (transform.matrix) ? Util.OffsetBounds(element) : Util.Bounds(element);
    transform.origin[0] += bounds.left;
    transform.origin[1] += bounds.top;
    return bounds;
  }

  function renderElement(element, parentStack, pseudoElement, ignoreBackground) {
    var transform = getTransform(element, parentStack),
    bounds = getBounds(element, transform),
    image,
    stack = createStack(element, parentStack, bounds, transform),
    borders = stack.borders,
    ctx = stack.ctx,
    backgroundBounds = getBackgroundBounds(borders, bounds, stack.clip),
    borderData = parseBorders(element, bounds, borders),
    backgroundColor = (ignoreElementsRegExp.test(element.nodeName)) ? "#efefef" : getCSS(element, "backgroundColor");


    createShape(ctx, borderData.clip);

    ctx.save();
    ctx.clip();

    if (backgroundBounds.height > 0 && backgroundBounds.width > 0 && !ignoreBackground) {
      renderBackgroundColor(ctx, bounds, backgroundColor);
      renderBackgroundImage(element, backgroundBounds, ctx);
    } else if (ignoreBackground) {
      stack.backgroundColor =  backgroundColor;
    }

    ctx.restore();

    borderData.borders.forEach(function(border) {
      renderBorders(ctx, border.args, border.color);
    });

    if (!pseudoElement) {
      injectPseudoElements(element, stack);
    }

    switch(element.nodeName){
      case "IMG":
        if ((image = loadImage(element.getAttribute('src')))) {
          renderImage(ctx, element, image, bounds, borders);
        } else {
          Util.log("html2canvas: Error loading <img>:" + element.getAttribute('src'));
        }
        break;
      case "INPUT":
        // TODO add all relevant type's, i.e. HTML5 new stuff
        // todo add support for placeholder attribute for browsers which support it
        if (/^(text|url|email|submit|button|reset)$/.test(element.type) && (element.value || element.placeholder || "").length > 0){
          renderFormValue(element, bounds, stack);
        }
        break;
      case "TEXTAREA":
        if ((element.value || element.placeholder || "").length > 0){
          renderFormValue(element, bounds, stack);
        }
        break;
      case "SELECT":
        if ((element.options||element.placeholder || "").length > 0){
          renderFormValue(element, bounds, stack);
        }
        break;
      case "LI":
        renderListItem(element, stack, backgroundBounds);
        break;
      case "CANVAS":
        renderImage(ctx, element, element, bounds, borders);
        break;
    }

    return stack;
  }

  function isElementVisible(element) {
    return (getCSS(element, 'display') !== "none" && getCSS(element, 'visibility') !== "hidden" && !element.hasAttribute("data-html2canvas-ignore"));
  }

  function parseElement (element, stack, pseudoElement) {
    if (isElementVisible(element)) {
      stack = renderElement(element, stack, pseudoElement, false) || stack;
      if (!ignoreElementsRegExp.test(element.nodeName)) {
        parseChildren(element, stack, pseudoElement);
      }
    }
  }

  function parseChildren(element, stack, pseudoElement) {
    Util.Children(element).forEach(function(node) {
      if (node.nodeType === node.ELEMENT_NODE) {
        parseElement(node, stack, pseudoElement);
      } else if (node.nodeType === node.TEXT_NODE) {
        renderText(element, node, stack);
      }
    });
  }

  function init() {
    var background = getCSS(document.documentElement, "backgroundColor"),
      transparentBackground = (Util.isTransparent(background) && element === document.body),
      stack = renderElement(element, null, false, transparentBackground);
    parseChildren(element, stack);

    if (transparentBackground) {
      background = stack.backgroundColor;
    }

    body.removeChild(hidePseudoElements);
    return {
      backgroundColor: background,
      stack: stack
    };
  }

  return init();
};

function h2czContext(zindex) {
  return {
    zindex: zindex,
    children: []
  };
}

_html2canvas.Preload = function( options ) {

  var images = {
    numLoaded: 0,   // also failed are counted here
    numFailed: 0,
    numTotal: 0,
    cleanupDone: false
  },
  pageOrigin,
  Util = _html2canvas.Util,
  methods,
  i,
  count = 0,
  element = options.elements[0] || document.body,
  doc = element.ownerDocument,
  domImages = element.getElementsByTagName('img'), // Fetch images of the present element only
  imgLen = domImages.length,
  link = doc.createElement("a"),
  supportCORS = (function( img ){
    return (img.crossOrigin !== undefined);
  })(new Image()),
  timeoutTimer;

  link.href = window.location.href;
  pageOrigin  = link.protocol + link.host;

  function isSameOrigin(url){
    link.href = url;
    link.href = link.href; // YES, BELIEVE IT OR NOT, that is required for IE9 - http://jsfiddle.net/niklasvh/2e48b/
    var origin = link.protocol + link.host;
    return (origin === pageOrigin);
  }

  function start(){
    Util.log("html2canvas: start: images: " + images.numLoaded + " / " + images.numTotal + " (failed: " + images.numFailed + ")");
    if (!images.firstRun && images.numLoaded >= images.numTotal){
      Util.log("Finished loading images: # " + images.numTotal + " (failed: " + images.numFailed + ")");

      if (typeof options.complete === "function"){
        options.complete(images);
      }

    }
  }

  // TODO modify proxy to serve images with CORS enabled, where available
  function proxyGetImage(url, img, imageObj){
    var callback_name,
    scriptUrl = options.proxy,
    script;

    link.href = url;
    url = link.href; // work around for pages with base href="" set - WARNING: this may change the url

    callback_name = 'html2canvas_' + (count++);
    imageObj.callbackname = callback_name;

    if (scriptUrl.indexOf("?") > -1) {
      scriptUrl += "&";
    } else {
      scriptUrl += "?";
    }
    scriptUrl += 'url=' + encodeURIComponent(url) + '&callback=' + callback_name;
    script = doc.createElement("script");

    window[callback_name] = function(a){
      if (a.substring(0,6) === "error:"){
        imageObj.succeeded = false;
        images.numLoaded++;
        images.numFailed++;
        start();
      } else {
        setImageLoadHandlers(img, imageObj);
        img.src = a;
      }
      window[callback_name] = undefined; // to work with IE<9  // NOTE: that the undefined callback property-name still exists on the window object (for IE<9)
      try {
        delete window[callback_name];  // for all browser that support this
      } catch(ex) {}
      script.parentNode.removeChild(script);
      script = null;
      delete imageObj.script;
      delete imageObj.callbackname;
    };

    script.setAttribute("type", "text/javascript");
    script.setAttribute("src", scriptUrl);
    imageObj.script = script;
    window.document.body.appendChild(script);

  }

  function loadPseudoElement(element, type) {
    var style = window.getComputedStyle(element, type),
    content = style.content;
    if (content.substr(0, 3) === 'url') {
      methods.loadImage(_html2canvas.Util.parseBackgroundImage(content)[0].args[0]);
    }
    loadBackgroundImages(style.backgroundImage, element);
  }

  function loadPseudoElementImages(element) {
    loadPseudoElement(element, ":before");
    loadPseudoElement(element, ":after");
  }

  function loadGradientImage(backgroundImage, bounds) {
    var img = _html2canvas.Generate.Gradient(backgroundImage, bounds);

    if (img !== undefined){
      images[backgroundImage] = {
        img: img,
        succeeded: true
      };
      images.numTotal++;
      images.numLoaded++;
      start();
    }
  }

  function invalidBackgrounds(background_image) {
    return (background_image && background_image.method && background_image.args && background_image.args.length > 0 );
  }

  function loadBackgroundImages(background_image, el) {
    var bounds;

    _html2canvas.Util.parseBackgroundImage(background_image).filter(invalidBackgrounds).forEach(function(background_image) {
      if (background_image.method === 'url') {
        methods.loadImage(background_image.args[0]);
      } else if(background_image.method.match(/\-?gradient$/)) {
        if(bounds === undefined) {
          bounds = _html2canvas.Util.Bounds(el);
        }
        loadGradientImage(background_image.value, bounds);
      }
    });
  }

  function getImages (el) {
    var elNodeType = false;

    // Firefox fails with permission denied on pages with iframes
    try {
      Util.Children(el).forEach(getImages);
    }
    catch( e ) {}

    try {
      elNodeType = el.nodeType;
    } catch (ex) {
      elNodeType = false;
      Util.log("html2canvas: failed to access some element's nodeType - Exception: " + ex.message);
    }

    if (elNodeType === 1 || elNodeType === undefined) {
      loadPseudoElementImages(el);
      try {
        loadBackgroundImages(Util.getCSS(el, 'backgroundImage'), el);
      } catch(e) {
        Util.log("html2canvas: failed to get background-image - Exception: " + e.message);
      }
      loadBackgroundImages(el);
    }
  }

  function setImageLoadHandlers(img, imageObj) {
    img.onload = function() {
      if ( imageObj.timer !== undefined ) {
        // CORS succeeded
        window.clearTimeout( imageObj.timer );
      }

      images.numLoaded++;
      imageObj.succeeded = true;
      img.onerror = img.onload = null;
      start();
    };
    img.onerror = function() {
      if (img.crossOrigin === "anonymous") {
        // CORS failed
        window.clearTimeout( imageObj.timer );

        // let's try with proxy instead
        if ( options.proxy ) {
          var src = img.src;
          img = new Image();
          imageObj.img = img;
          img.src = src;

          proxyGetImage( img.src, img, imageObj );
          return;
        }
      }

      images.numLoaded++;
      images.numFailed++;
      imageObj.succeeded = false;
      img.onerror = img.onload = null;
      start();
    };
  }

  methods = {
    loadImage: function( src ) {
      var img, imageObj;
      if ( src && images[src] === undefined ) {
        img = new Image();
        if ( src.match(/data:image\/.*;base64,/i) ) {
          img.src = src.replace(/url\(['"]{0,}|['"]{0,}\)$/ig, '');
          imageObj = images[src] = {
            img: img
          };
          images.numTotal++;
          setImageLoadHandlers(img, imageObj);
        } else if ( isSameOrigin( src ) || options.allowTaint ===  true ) {
          imageObj = images[src] = {
            img: img
          };
          images.numTotal++;
          setImageLoadHandlers(img, imageObj);
          img.src = src;
        } else if ( supportCORS && !options.allowTaint && options.useCORS ) {
          // attempt to load with CORS

          img.crossOrigin = "anonymous";
          imageObj = images[src] = {
            img: img
          };
          images.numTotal++;
          setImageLoadHandlers(img, imageObj);
          img.src = src;
        } else if ( options.proxy ) {
          imageObj = images[src] = {
            img: img
          };
          images.numTotal++;
          proxyGetImage( src, img, imageObj );
        }
      }

    },
    cleanupDOM: function(cause) {
      var img, src;
      if (!images.cleanupDone) {
        if (cause && typeof cause === "string") {
          Util.log("html2canvas: Cleanup because: " + cause);
        } else {
          Util.log("html2canvas: Cleanup after timeout: " + options.timeout + " ms.");
        }

        for (src in images) {
          if (images.hasOwnProperty(src)) {
            img = images[src];
            if (typeof img === "object" && img.callbackname && img.succeeded === undefined) {
              // cancel proxy image request
              window[img.callbackname] = undefined; // to work with IE<9  // NOTE: that the undefined callback property-name still exists on the window object (for IE<9)
              try {
                delete window[img.callbackname];  // for all browser that support this
              } catch(ex) {}
              if (img.script && img.script.parentNode) {
                img.script.setAttribute("src", "about:blank");  // try to cancel running request
                img.script.parentNode.removeChild(img.script);
              }
              images.numLoaded++;
              images.numFailed++;
              Util.log("html2canvas: Cleaned up failed img: '" + src + "' Steps: " + images.numLoaded + " / " + images.numTotal);
            }
          }
        }

        // cancel any pending requests
        if(window.stop !== undefined) {
          window.stop();
        } else if(document.execCommand !== undefined) {
          document.execCommand("Stop", false);
        }
        if (document.close !== undefined) {
          document.close();
        }
        images.cleanupDone = true;
        if (!(cause && typeof cause === "string")) {
          start();
        }
      }
    },

    renderingDone: function() {
      if (timeoutTimer) {
        window.clearTimeout(timeoutTimer);
      }
    }
  };

  if (options.timeout > 0) {
    timeoutTimer = window.setTimeout(methods.cleanupDOM, options.timeout);
  }

  Util.log('html2canvas: Preload starts: finding background-images');
  images.firstRun = true;

  getImages(element);

  Util.log('html2canvas: Preload: Finding images');
  // load <img> images
  for (i = 0; i < imgLen; i+=1){
    methods.loadImage( domImages[i].getAttribute( "src" ) );
  }

  images.firstRun = false;
  Util.log('html2canvas: Preload: Done.');
  if (images.numTotal === images.numLoaded) {
    start();
  }

  return methods;
};

_html2canvas.Renderer = function(parseQueue, options){

  // http://www.w3.org/TR/CSS21/zindex.html
  function createRenderQueue(parseQueue) {
    var queue = [],
    rootContext;

    rootContext = (function buildStackingContext(rootNode) {
      var rootContext = {};
      function insert(context, node, specialParent) {
        var zi = (node.zIndex.zindex === 'auto') ? 0 : Number(node.zIndex.zindex),
        contextForChildren = context, // the stacking context for children
        isPositioned = node.zIndex.isPositioned,
        isFloated = node.zIndex.isFloated,
        stub = {node: node},
        childrenDest = specialParent; // where children without z-index should be pushed into

        if (node.zIndex.ownStacking) {
          // '!' comes before numbers in sorted array
          contextForChildren = stub.context = { '!': [{node:node, children: []}]};
          childrenDest = undefined;
        } else if (isPositioned || isFloated) {
          childrenDest = stub.children = [];
        }

        if (zi === 0 && specialParent) {
          specialParent.push(stub);
        } else {
          if (!context[zi]) { context[zi] = []; }
          context[zi].push(stub);
        }

        node.zIndex.children.forEach(function(childNode) {
          insert(contextForChildren, childNode, childrenDest);
        });
      }
      insert(rootContext, rootNode);
      return rootContext;
    })(parseQueue);

    function sortZ(context) {
      Object.keys(context).sort().forEach(function(zi) {
        var nonPositioned = [],
        floated = [],
        positioned = [],
        list = [];

        // positioned after static
        context[zi].forEach(function(v) {
          if (v.node.zIndex.isPositioned || v.node.zIndex.opacity < 1) {
            // http://www.w3.org/TR/css3-color/#transparency
            // non-positioned element with opactiy < 1 should be stacked as if it were a positioned element with ‘z-index: 0’ and ‘opacity: 1’.
            positioned.push(v);
          } else if (v.node.zIndex.isFloated) {
            floated.push(v);
          } else {
            nonPositioned.push(v);
          }
        });

        (function walk(arr) {
          arr.forEach(function(v) {
            list.push(v);
            if (v.children) { walk(v.children); }
          });
        })(nonPositioned.concat(floated, positioned));

        list.forEach(function(v) {
          if (v.context) {
            sortZ(v.context);
          } else {
            queue.push(v.node);
          }
        });
      });
    }

    sortZ(rootContext);

    return queue;
  }

  function getRenderer(rendererName) {
    var renderer;

    if (typeof options.renderer === "string" && _html2canvas.Renderer[rendererName] !== undefined) {
      renderer = _html2canvas.Renderer[rendererName](options);
    } else if (typeof rendererName === "function") {
      renderer = rendererName(options);
    } else {
      throw new Error("Unknown renderer");
    }

    if ( typeof renderer !== "function" ) {
      throw new Error("Invalid renderer defined");
    }
    return renderer;
  }

  return getRenderer(options.renderer)(parseQueue, options, document, createRenderQueue(parseQueue.stack), _html2canvas);
};

_html2canvas.Util.Support = function (options, doc) {

  function supportSVGRendering() {
    var img = new Image(),
    canvas = doc.createElement("canvas"),
    ctx = (canvas.getContext === undefined) ? false : canvas.getContext("2d");
    if (ctx === false) {
      return false;
    }
    canvas.width = canvas.height = 10;
    img.src = [
    "data:image/svg+xml,",
    "<svg xmlns='http://www.w3.org/2000/svg' width='10' height='10'>",
    "<foreignObject width='10' height='10'>",
    "<div xmlns='http://www.w3.org/1999/xhtml' style='width:10;height:10;'>",
    "sup",
    "</div>",
    "</foreignObject>",
    "</svg>"
    ].join("");
    try {
      ctx.drawImage(img, 0, 0);
      canvas.toDataURL();
    } catch(e) {
      return false;
    }
    _html2canvas.Util.log('html2canvas: Parse: SVG powered rendering available');
    return true;
  }

  // Test whether we can use ranges to measure bounding boxes
  // Opera doesn't provide valid bounds.height/bottom even though it supports the method.

  function supportRangeBounds() {
    var r, testElement, rangeBounds, rangeHeight, support = false;

    if (doc.createRange) {
      r = doc.createRange();
      if (r.getBoundingClientRect) {
        testElement = doc.createElement('boundtest');
        testElement.style.height = "123px";
        testElement.style.display = "block";
        doc.body.appendChild(testElement);

        r.selectNode(testElement);
        rangeBounds = r.getBoundingClientRect();
        rangeHeight = rangeBounds.height;

        if (rangeHeight === 123) {
          support = true;
        }
        doc.body.removeChild(testElement);
      }
    }

    return support;
  }

  return {
    rangeBounds: supportRangeBounds(),
    svgRendering: options.svgRendering && supportSVGRendering()
  };
};
window.html2canvas = function(elements, opts) {
  elements = (elements.length) ? elements : [elements];
  var queue,
  canvas,
  options = {
    // general
    logging: false,
    elements: elements,
    background: "#fff",

    // preload options
    proxy: null,
    timeout: 0,    // no timeout
    useCORS: false, // try to load images as CORS (where available), before falling back to proxy
    allowTaint: false, // whether to allow images to taint the canvas, won't need proxy if set to true

    // parse options
    svgRendering: false, // use svg powered rendering where available (FF11+)
    ignoreElements: "IFRAME|OBJECT|PARAM",
    useOverflow: true,
    letterRendering: false,
    chinese: false,

    // render options

    width: null,
    height: null,
    taintTest: true, // do a taint test with all images before applying to canvas
    renderer: "Canvas"
  };

  options = _html2canvas.Util.Extend(opts, options);

  _html2canvas.logging = options.logging;
  options.complete = function( images ) {

    if (typeof options.onpreloaded === "function") {
      if ( options.onpreloaded( images ) === false ) {
        return;
      }
    }
    queue = _html2canvas.Parse( images, options );

    if (typeof options.onparsed === "function") {
      if ( options.onparsed( queue ) === false ) {
        return;
      }
    }

    canvas = _html2canvas.Renderer( queue, options );

    if (typeof options.onrendered === "function") {
      options.onrendered( canvas );
    }


  };

  // for pages without images, we still want this to be async, i.e. return methods before executing
  window.setTimeout( function(){
    _html2canvas.Preload( options );
  }, 0 );

  return {
    render: function( queue, opts ) {
      return _html2canvas.Renderer( queue, _html2canvas.Util.Extend(opts, options) );
    },
    parse: function( images, opts ) {
      return _html2canvas.Parse( images, _html2canvas.Util.Extend(opts, options) );
    },
    preload: function( opts ) {
      return _html2canvas.Preload( _html2canvas.Util.Extend(opts, options) );
    },
    log: _html2canvas.Util.log
  };
};

window.html2canvas.log = _html2canvas.Util.log; // for renderers
window.html2canvas.Renderer = {
  Canvas: undefined // We are assuming this will be used
};
_html2canvas.Renderer.Canvas = function(options) {
  options = options || {};

  var doc = document,
  safeImages = [],
  testCanvas = document.createElement("canvas"),
  testctx = testCanvas.getContext("2d"),
  Util = _html2canvas.Util,
  canvas = options.canvas || doc.createElement('canvas');

  function createShape(ctx, args) {
    ctx.beginPath();
    args.forEach(function(arg) {
      ctx[arg.name].apply(ctx, arg['arguments']);
    });
    ctx.closePath();
  }

  function safeImage(item) {
    if (safeImages.indexOf(item['arguments'][0].src ) === -1) {
      testctx.drawImage(item['arguments'][0], 0, 0);
      try {
        testctx.getImageData(0, 0, 1, 1);
      } catch(e) {
        testCanvas = doc.createElement("canvas");
        testctx = testCanvas.getContext("2d");
        return false;
      }
      safeImages.push(item['arguments'][0].src);
    }
    return true;
  }

  function renderItem(ctx, item) {
    switch(item.type){
      case "variable":
        ctx[item.name] = item['arguments'];
        break;
      case "function":
        switch(item.name) {
          case "createPattern":
            if (item['arguments'][0].width > 0 && item['arguments'][0].height > 0) {
              try {
                ctx.fillStyle = ctx.createPattern(item['arguments'][0], "repeat");
              }
              catch(e) {
                Util.log("html2canvas: Renderer: Error creating pattern", e.message);
              }
            }
            break;
          case "drawShape":
            createShape(ctx, item['arguments']);
            break;
          case "drawImage":
            if (item['arguments'][8] > 0 && item['arguments'][7] > 0) {
              if (!options.taintTest || (options.taintTest && safeImage(item))) {
                ctx.drawImage.apply( ctx, item['arguments'] );
              }
            }
            break;
          default:
            ctx[item.name].apply(ctx, item['arguments']);
        }
        break;
    }
  }

  return function(parsedData, options, document, queue, _html2canvas) {
    var ctx = canvas.getContext("2d"),
    newCanvas,
    bounds,
    fstyle,
    zStack = parsedData.stack;

    canvas.width = canvas.style.width =  options.width || zStack.ctx.width;
    canvas.height = canvas.style.height = options.height || zStack.ctx.height;

    fstyle = ctx.fillStyle;
    ctx.fillStyle = (Util.isTransparent(zStack.backgroundColor) && options.background !== undefined) ? options.background : parsedData.backgroundColor;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = fstyle;

    queue.forEach(function(storageContext) {
      // set common settings for canvas
      ctx.textBaseline = "bottom";
      ctx.save();

      if (storageContext.transform.matrix) {
        ctx.translate(storageContext.transform.origin[0], storageContext.transform.origin[1]);
        ctx.transform.apply(ctx, storageContext.transform.matrix);
        ctx.translate(-storageContext.transform.origin[0], -storageContext.transform.origin[1]);
      }

      if (storageContext.clip){
        ctx.beginPath();
        ctx.rect(storageContext.clip.left, storageContext.clip.top, storageContext.clip.width, storageContext.clip.height);
        ctx.clip();
      }

      if (storageContext.ctx.storage) {
        storageContext.ctx.storage.forEach(function(item) {
          renderItem(ctx, item);
        });
      }

      ctx.restore();
    });

    Util.log("html2canvas: Renderer: Canvas renderer done - returning canvas obj");

    if (options.elements.length === 1) {
      if (typeof options.elements[0] === "object" && options.elements[0].nodeName !== "BODY") {
        // crop image to the bounds of selected (single) element
        bounds = _html2canvas.Util.Bounds(options.elements[0]);
        newCanvas = document.createElement('canvas');
        newCanvas.width = Math.ceil(bounds.width);
        newCanvas.height = Math.ceil(bounds.height);
        ctx = newCanvas.getContext("2d");

        ctx.drawImage(canvas, bounds.left, bounds.top, bounds.width, bounds.height, 0, 0, bounds.width, bounds.height);
        canvas = null;
        return newCanvas;
      }
    }

    return canvas;
  };
};
})(window,document);
$(function() {
    $(".printAccessorySummary").click(function(e) {

        e.preventDefault();
        var today = getCurrentDate();
        html2canvas($(this).closest('section'), {
            onrendered: function(canvas) {
                var months = new Array("Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
                "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre");
                var currentDate = new Date();
                var currentDateFormatted = currentDate.getDate() + " de " + months[currentDate.getMonth()] + " de " +
                        currentDate.getFullYear() + ", " + currentDate.getHours() + ":" + currentDate.getMinutes() + "h";
                var mywindow = window.open('', '', 'height=600,width=800');
                mywindow.document.write('<html><head><title></title>');
                mywindow.document.write('</head><body >');
                mywindow.document.write('<div class="navbar-header navbar-left">');
                mywindow.document.write('<a href="#" class="navbar-brand printable" title="TelCel">');
                mywindow.document.write('<img src="' + $("#imgLogoTelcel").val() + '" />');
                mywindow.document.write('</a>');
                mywindow.document.write('<span style="display:block; float:right;">' + currentDateFormatted + '</span>');
                mywindow.document.write('</div>');
                mywindow.document.body.appendChild(canvas);
                mywindow.document.write('<div>' + $("#legalText").val() + '</div>');
                mywindow.document.write('<div> A la fecha '+today+'</div>');
                mywindow.document.write('</body></html>');
                mywindow.print();
                mywindow.close();
            }
        });
    });
});
//console.log("pointOfSale.js loaded");
/*
 * Trigger the 'amigo.pointofsaleonus' event when the page has been loaded.
 */
$(document).ready(function(){
    $('.xk-pointofsaleonus').trigger('amigo.pointofsaleonus');
});

/*
 * Add the 'amigo.pointofsaleonus' event to the '.xk-pointofsaleonus' section
 * and initialize component's data.
 */
$(document).on('amigo.pointofsaleonus', '.xk-pointofsaleonus', function() {
    var obj = $('.xk-pointofsaleonus #state');
    var serviceUrl = "/bin/telcelcom/amigo/pointofsales.json";
    fillComboPointOfSaleOnUs(serviceUrl, obj);
    obj.find("option").eq(0).attr("disabled", "disabled");
});

/*
 * Add 'change' functionallity for de 'state' combobox.
 */
$(document).on('change', '.xk-pointofsaleonus #state', function(){
    var obj = $('.xk-pointofsaleonus #city');
    var objBtn = $(".xk-pointofsaleonus .xk-searchButton");

    if (obj != null) {
        obj.removeAttr("disabled");
        obj.val("");
    }
    if (objBtn != null) {
        objBtn.removeAttr("disabled");
    }
});

/*
 * Add 'keyup' validations for de 'zipcode' textbox when a code is entered.
 */
$(document).on('keyup', '.xk-pointofsaleonus #zipcode', function(){
    var obj = $(".xk-pointofsaleonus .xk-searchButton");
    if ($(this).val() != "") {
        obj.removeAttr("disabled");
    } else  {
        if ($('.xk-pointofsaleonus #state').val() == "") {
            obj.attr("disabled", "disabled");
        }
    }
});

/*
 * Add search button functionallity
 */
$(document).on('click', '.xk-pointofsaleonus .xk-searchButton', function() {

    var objtable    = $('.xk-pointofsaleonus .xk-pointofsaleonus-table');
    var objspin     = $('.xk-pointofsaleonus .pointofsales-spin');
    var objresult   = $('.xk-pointofsaleonus .xk-pointofsaleonus-result');
    var objmsg      = $(".xk-pointofsaleonus .xk-pointsalesofsaleonus-msg");

    if (objtable != null) {

        var stateId = $('.xk-pointofsaleonus #state').val();
        var cityText = $('.xk-pointofsaleonus #city').val();
        var codeText = $('.xk-pointofsaleonus #zipcode').val();

        if (stateId != null && stateId != "")
            stateId = stateId.toUpperCase();

        if (cityText != null && cityText != "")
            cityText = cityText.toUpperCase();

        if (codeText != null && codeText != "")
            codeText = codeText.toUpperCase();

        var serviceUrl = "/bin/telcelcom/amigo/pointofsales" +
                        ".state=" + stateId +
                        ".city=" + cityText +
                        ".zipcode=" + codeText +
                        ".go.json";
        try {
            objspin.spin('largeSpin');
            $.getJSON(serviceUrl, function (response) {
                objtable.find('tr:not(:eq(0))').remove();
                if (response != null) {
                    if (response.error == null) {
                        var stores = response.stores;
                        if (stores != null && stores.store) {

                            //If 'stores.store' is an array then uses 'stores.store' else uses 'stores'...
                            if(Object.prototype.toString.call(stores.store) === '[object Array]') {
                                stores = stores.store;
                            }

                            objresult.hide();
                            $.each(stores, function (key, val) {
                                objtable.append('<tr><td>' + val.name + '</td><td>' + val.address + '</td></tr>');
                            });

                            if (objtable.find("tr").length > 1) {
                                objtable.show();
                                objmsg.hide();
                            } else  {
                                objtable.hide();
                                objmsg.show();
                            }
                            objresult.show('fast');
                        }
                    } else {
                        objtable.hide();
                        objmsg.show();
                    }
                }
                objspin.spin(false).stop();
            });
        } catch (e) {
            return false;
        }
    }
    return false;
});

/*
* Fill states or cities comboboxes getting the data from a service
 */
function fillComboPointOfSaleOnUs(serviceUrl, obj) {

    if (obj != null && serviceUrl != "") {

        $.getJSON(serviceUrl, function (response) {

            obj.find('option:not(:eq(0))').remove();

            $.each(response, function (key, val) {
                obj.append('<option value="' + val.value + '">' + val.text + '</option>');
            });

            obj.trigger('chosen:updated');
        });
    }
}
var captcha3;

$('body').on("click",'#submitNip',function(event) {
    event.preventDefault();
    var value = $("#numberNip").val();
    var urlVal = "/bin/telcelcom/amigo/nip."+value+".json";
    var recaptchaResponse = $("#g-recaptcha-response-2");
    if(recaptchaResponse) {
        $.post("/bin/telcelcom/noncacheable/captcha/check?secret=6LeN3wETAAAAAD6oYRJVBpRYHqTauNJGjJj_CIWR&response=" + recaptchaResponse.val().trim(), function(data){
            if (data.success) {
                $.ajax({
                    method: "POST",
                    url: urlVal
                }).done(function(data) {
                    $('#numberNip').remove();
                    $('#captcha3').remove();
                    $('#submitNip').remove();
                    if(data !== ''){
                        var code = data.substring(0, data.indexOf("##"));
                        var message = data.substring(data.indexOf("##") + 2, data.length);
                        if (code !== "0") {
                            code = code.substring(1);
                        }
                        var messageContent = getMessage(code);
                        if (code === "0") {
                            if (messageContent === "") {
                                $("#textInnerNip").html("<h4 class=\"text-center\"><i class=\"icon-TickNeg\"></i>  " + message +
                                    "<br> <a href=\""+window.location+"\"> Regresar </a></h4>");
                            } else {
                                $("#textInnerNip").html("<h4 class=\"text-center\"><i class=\"icon-TickNeg\"></i>  " + messageContent +
                                    "<br> <a href=\""+window.location+"\"> Regresar </a></h4>");
                            }
                            dataLayer.push({"ruta":"/personas/telefonia/la-red-de-mayor-cobertura/ven-a-telcel/obtentunip/exito","titulo":"Exito ObtenNIP | Telcel","event":"pageview"});

                        } else {
                            if (messageContent === "") {
                                $("#textInnerNip").html("<h4 class=\"text-center\"><i class=\"icon-NoEntry\"></i>  " + message +
                                    "<br> <a href=\""+window.location+"\"> Regresar </a></h4>");
                            } else {
                                $("#textInnerNip").html("<h4 class=\"text-center\"><i class=\"icon-NoEntry\"></i>  " + messageContent +
                                    "<br> <a href=\""+window.location+"\"> Regresar </a></h4>");
                            }
                        }
                    } else {
                        $("#textInnerNip").html("<h4 class=\"text-center\"><i class=\"icon-NoEntry\"></i>  No es posible establecer conexión con el servidor"+
                            "<br> <a href=\""+window.location+"\"> Regresar </a></h4>");
                    }

                });
            } else {
                $( "#textInnerNip" ).html("<h4 class=\"text-center\"><i class=\"icon-NoEntry\"></i>  Captcha no válido " +
                    "<br> <a href=\""+window.location+"\"> Regresar </a></h4>");
            }
        })
    
    } else {
        $( "#textInnerNip" ).html("<h4 class=\"text-center\"><i class=\"icon-NoEntry\"></i>  Captcha no válido " +
            "<br> <a href=\""+window.location+"\"> Regresar </a></h4>");
    }


});

function getMessage(number){
    var id = "#nip"+number;
    var textValue = "data-value";
    var value = $(id).attr(textValue);
    return value;
}

$(function(){
    $('body').on('friend.nip', '.js-friend-getNip', function(e, target) {
        reCaptchaVal();
    });

});

var siteKeyRe = "6LeN3wETAAAAAK79CxVseevXwpGjgsFQwz2GBy1P";

function reCaptchaVal(){
    if(document.getElementById('captcha3') !== null) {
        captcha3 = grecaptcha.render('captcha3', {
            'sitekey': siteKeyRe,
            'theme': 'light'
        });
    }
}
/**
 * Created by jhernandez on 12/03/15.
 */

$(function(){
    var loadExternal = function($parent, target){
        $.ajax({
            url: $parent.attr('data-url'),
            dataType: 'HTML'
        }).done(function(result){
            var $target =$parent.find(target);
            $target.html(result);
            onAjaxSuccess($target);
            $($target).find('[data-trigger-events]').each(function() {
                $(this).dataTriggerEvent();
            });
        }).fail(function(){

        });
    };

    $('body').on('amigo.feautredrateref', '.xk-js-featuredrateref', function(e, target) {
        loadExternal($(e.target), target);
    });

    $('.xk-js-featuredrateref').each(function(){
        loadExternal($(this), $(this).attr('data-target'));
    });
});

/*
  html2canvas 0.4.1 <http://html2canvas.hertzen.com>
  Copyright (c) 2013 Niklas von Hertzen

  Released under MIT License
*/

(function(window, document, undefined){

"use strict";

var _html2canvas = {},
previousElement,
computedCSS,
html2canvas;

_html2canvas.Util = {};

_html2canvas.Util.log = function(a) {
  if (_html2canvas.logging && window.console && window.console.log) {
    window.console.log(a);
  }
};

_html2canvas.Util.trimText = (function(isNative){
  return function(input) {
    return isNative ? isNative.apply(input) : ((input || '') + '').replace( /^\s+|\s+$/g , '' );
  };
})(String.prototype.trim);

_html2canvas.Util.asFloat = function(v) {
  return parseFloat(v);
};

(function() {
  // TODO: support all possible length values
  var TEXT_SHADOW_PROPERTY = /((rgba|rgb)\([^\)]+\)(\s-?\d+px){0,})/g;
  var TEXT_SHADOW_VALUES = /(-?\d+px)|(#.+)|(rgb\(.+\))|(rgba\(.+\))/g;
  _html2canvas.Util.parseTextShadows = function (value) {
    if (!value || value === 'none') {
      return [];
    }

    // find multiple shadow declarations
    var shadows = value.match(TEXT_SHADOW_PROPERTY),
      results = [];
    for (var i = 0; shadows && (i < shadows.length); i++) {
      var s = shadows[i].match(TEXT_SHADOW_VALUES);
      results.push({
        color: s[0],
        offsetX: s[1] ? s[1].replace('px', '') : 0,
        offsetY: s[2] ? s[2].replace('px', '') : 0,
        blur: s[3] ? s[3].replace('px', '') : 0
      });
    }
    return results;
  };
})();


_html2canvas.Util.parseBackgroundImage = function (value) {
    var whitespace = ' \r\n\t',
        method, definition, prefix, prefix_i, block, results = [],
        c, mode = 0, numParen = 0, quote, args;

    var appendResult = function(){
        if(method) {
            if(definition.substr( 0, 1 ) === '"') {
                definition = definition.substr( 1, definition.length - 2 );
            }
            if(definition) {
                args.push(definition);
            }
            if(method.substr( 0, 1 ) === '-' &&
                    (prefix_i = method.indexOf( '-', 1 ) + 1) > 0) {
                prefix = method.substr( 0, prefix_i);
                method = method.substr( prefix_i );
            }
            results.push({
                prefix: prefix,
                method: method.toLowerCase(),
                value: block,
                args: args
            });
        }
        args = []; //for some odd reason, setting .length = 0 didn't work in safari
        method =
            prefix =
            definition =
            block = '';
    };

    appendResult();
    for(var i = 0, ii = value.length; i<ii; i++) {
        c = value[i];
        if(mode === 0 && whitespace.indexOf( c ) > -1){
            continue;
        }
        switch(c) {
            case '"':
                if(!quote) {
                    quote = c;
                }
                else if(quote === c) {
                    quote = null;
                }
                break;

            case '(':
                if(quote) { break; }
                else if(mode === 0) {
                    mode = 1;
                    block += c;
                    continue;
                } else {
                    numParen++;
                }
                break;

            case ')':
                if(quote) { break; }
                else if(mode === 1) {
                    if(numParen === 0) {
                        mode = 0;
                        block += c;
                        appendResult();
                        continue;
                    } else {
                        numParen--;
                    }
                }
                break;

            case ',':
                if(quote) { break; }
                else if(mode === 0) {
                    appendResult();
                    continue;
                }
                else if (mode === 1) {
                    if(numParen === 0 && !method.match(/^url$/i)) {
                        args.push(definition);
                        definition = '';
                        block += c;
                        continue;
                    }
                }
                break;
        }

        block += c;
        if(mode === 0) { method += c; }
        else { definition += c; }
    }
    appendResult();

    return results;
};

_html2canvas.Util.Bounds = function (element) {
  var clientRect, bounds = {};

  if (element.getBoundingClientRect){
    clientRect = element.getBoundingClientRect();

    // TODO add scroll position to bounds, so no scrolling of window necessary
    bounds.top = clientRect.top;
    bounds.bottom = clientRect.bottom || (clientRect.top + clientRect.height);
    bounds.left = clientRect.left;

    bounds.width = element.offsetWidth;
    bounds.height = element.offsetHeight;
  }

  return bounds;
};

// TODO ideally, we'd want everything to go through this function instead of Util.Bounds,
// but would require further work to calculate the correct positions for elements with offsetParents
_html2canvas.Util.OffsetBounds = function (element) {
  var parent = element.offsetParent ? _html2canvas.Util.OffsetBounds(element.offsetParent) : {top: 0, left: 0};

  return {
    top: element.offsetTop + parent.top,
    bottom: element.offsetTop + element.offsetHeight + parent.top,
    left: element.offsetLeft + parent.left,
    width: element.offsetWidth,
    height: element.offsetHeight
  };
};

function toPX(element, attribute, value ) {
    var rsLeft = element.runtimeStyle && element.runtimeStyle[attribute],
        left,
        style = element.style;

    // Check if we are not dealing with pixels, (Opera has issues with this)
    // Ported from jQuery css.js
    // From the awesome hack by Dean Edwards
    // http://erik.eae.net/archives/2007/07/27/18.54.15/#comment-102291

    // If we're not dealing with a regular pixel number
    // but a number that has a weird ending, we need to convert it to pixels

    if ( !/^-?[0-9]+\.?[0-9]*(?:px)?$/i.test( value ) && /^-?\d/.test(value) ) {
        // Remember the original values
        left = style.left;

        // Put in the new values to get a computed value out
        if (rsLeft) {
            element.runtimeStyle.left = element.currentStyle.left;
        }
        style.left = attribute === "fontSize" ? "1em" : (value || 0);
        value = style.pixelLeft + "px";

        // Revert the changed values
        style.left = left;
        if (rsLeft) {
            element.runtimeStyle.left = rsLeft;
        }
    }

    if (!/^(thin|medium|thick)$/i.test(value)) {
        return Math.round(parseFloat(value)) + "px";
    }

    return value;
}

function asInt(val) {
    return parseInt(val, 10);
}

function parseBackgroundSizePosition(value, element, attribute, index) {
    value = (value || '').split(',');
    value = value[index || 0] || value[0] || 'auto';
    value = _html2canvas.Util.trimText(value).split(' ');

    if(attribute === 'backgroundSize' && (!value[0] || value[0].match(/cover|contain|auto/))) {
        //these values will be handled in the parent function
    } else {
        value[0] = (value[0].indexOf( "%" ) === -1) ? toPX(element, attribute + "X", value[0]) : value[0];
        if(value[1] === undefined) {
            if(attribute === 'backgroundSize') {
                value[1] = 'auto';
                return value;
            } else {
                // IE 9 doesn't return double digit always
                value[1] = value[0];
            }
        }
        value[1] = (value[1].indexOf("%") === -1) ? toPX(element, attribute + "Y", value[1]) : value[1];
    }
    return value;
}

_html2canvas.Util.getCSS = function (element, attribute, index) {
    if (previousElement !== element) {
      computedCSS = document.defaultView.getComputedStyle(element, null);
    }

    var value = computedCSS[attribute];

    if (/^background(Size|Position)$/.test(attribute)) {
        return parseBackgroundSizePosition(value, element, attribute, index);
    } else if (/border(Top|Bottom)(Left|Right)Radius/.test(attribute)) {
      var arr = value.split(" ");
      if (arr.length <= 1) {
          arr[1] = arr[0];
      }
      return arr.map(asInt);
    }

  return value;
};

_html2canvas.Util.resizeBounds = function( current_width, current_height, target_width, target_height, stretch_mode ){
  var target_ratio = target_width / target_height,
    current_ratio = current_width / current_height,
    output_width, output_height;

  if(!stretch_mode || stretch_mode === 'auto') {
    output_width = target_width;
    output_height = target_height;
  } else if(target_ratio < current_ratio ^ stretch_mode === 'contain') {
    output_height = target_height;
    output_width = target_height * current_ratio;
  } else {
    output_width = target_width;
    output_height = target_width / current_ratio;
  }

  return {
    width: output_width,
    height: output_height
  };
};

function backgroundBoundsFactory( prop, el, bounds, image, imageIndex, backgroundSize ) {
    var bgposition =  _html2canvas.Util.getCSS( el, prop, imageIndex ) ,
    topPos,
    left,
    percentage,
    val;

    if (bgposition.length === 1){
      val = bgposition[0];

      bgposition = [];

      bgposition[0] = val;
      bgposition[1] = val;
    }

    if (bgposition[0].toString().indexOf("%") !== -1){
      percentage = (parseFloat(bgposition[0])/100);
      left = bounds.width * percentage;
      if(prop !== 'backgroundSize') {
        left -= (backgroundSize || image).width*percentage;
      }
    } else {
      if(prop === 'backgroundSize') {
        if(bgposition[0] === 'auto') {
          left = image.width;
        } else {
          if (/contain|cover/.test(bgposition[0])) {
            var resized = _html2canvas.Util.resizeBounds(image.width, image.height, bounds.width, bounds.height, bgposition[0]);
            left = resized.width;
            topPos = resized.height;
          } else {
            left = parseInt(bgposition[0], 10);
          }
        }
      } else {
        left = parseInt( bgposition[0], 10);
      }
    }


    if(bgposition[1] === 'auto') {
      topPos = left / image.width * image.height;
    } else if (bgposition[1].toString().indexOf("%") !== -1){
      percentage = (parseFloat(bgposition[1])/100);
      topPos =  bounds.height * percentage;
      if(prop !== 'backgroundSize') {
        topPos -= (backgroundSize || image).height * percentage;
      }

    } else {
      topPos = parseInt(bgposition[1],10);
    }

    return [left, topPos];
}

_html2canvas.Util.BackgroundPosition = function( el, bounds, image, imageIndex, backgroundSize ) {
    var result = backgroundBoundsFactory( 'backgroundPosition', el, bounds, image, imageIndex, backgroundSize );
    return { left: result[0], top: result[1] };
};

_html2canvas.Util.BackgroundSize = function( el, bounds, image, imageIndex ) {
    var result = backgroundBoundsFactory( 'backgroundSize', el, bounds, image, imageIndex );
    return { width: result[0], height: result[1] };
};

_html2canvas.Util.Extend = function (options, defaults) {
  for (var key in options) {
    if (options.hasOwnProperty(key)) {
      defaults[key] = options[key];
    }
  }
  return defaults;
};


/*
 * Derived from jQuery.contents()
 * Copyright 2010, John Resig
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://jquery.org/license
 */
_html2canvas.Util.Children = function( elem ) {
  var children;
  try {
    children = (elem.nodeName && elem.nodeName.toUpperCase() === "IFRAME") ? elem.contentDocument || elem.contentWindow.document : (function(array) {
      var ret = [];
      if (array !== null) {
        (function(first, second ) {
          var i = first.length,
          j = 0;

          if (typeof second.length === "number") {
            for (var l = second.length; j < l; j++) {
              first[i++] = second[j];
            }
          } else {
            while (second[j] !== undefined) {
              first[i++] = second[j++];
            }
          }

          first.length = i;

          return first;
        })(ret, array);
      }
      return ret;
    })(elem.childNodes);

  } catch (ex) {
    _html2canvas.Util.log("html2canvas.Util.Children failed with exception: " + ex.message);
    children = [];
  }
  return children;
};

_html2canvas.Util.isTransparent = function(backgroundColor) {
  return (backgroundColor === "transparent" || backgroundColor === "rgba(0, 0, 0, 0)");
};
_html2canvas.Util.Font = (function () {

  var fontData = {};

  return function(font, fontSize, doc) {
    if (fontData[font + "-" + fontSize] !== undefined) {
      return fontData[font + "-" + fontSize];
    }

    var container = doc.createElement('div'),
    img = doc.createElement('img'),
    span = doc.createElement('span'),
    sampleText = 'Hidden Text',
    baseline,
    middle,
    metricsObj;

    container.style.visibility = "hidden";
    container.style.fontFamily = font;
    container.style.fontSize = fontSize;
    container.style.margin = 0;
    container.style.padding = 0;

    doc.body.appendChild(container);

    // http://probablyprogramming.com/2009/03/15/the-tiniest-gif-ever (handtinywhite.gif)
    img.src = "data:image/gif;base64,R0lGODlhAQABAIABAP///wAAACwAAAAAAQABAAACAkQBADs=";
    img.width = 1;
    img.height = 1;

    img.style.margin = 0;
    img.style.padding = 0;
    img.style.verticalAlign = "baseline";

    span.style.fontFamily = font;
    span.style.fontSize = fontSize;
    span.style.margin = 0;
    span.style.padding = 0;

    span.appendChild(doc.createTextNode(sampleText));
    container.appendChild(span);
    container.appendChild(img);
    baseline = (img.offsetTop - span.offsetTop) + 1;

    container.removeChild(span);
    container.appendChild(doc.createTextNode(sampleText));

    container.style.lineHeight = "normal";
    img.style.verticalAlign = "super";

    middle = (img.offsetTop-container.offsetTop) + 1;
    metricsObj = {
      baseline: baseline,
      lineWidth: 1,
      middle: middle
    };

    fontData[font + "-" + fontSize] = metricsObj;

    doc.body.removeChild(container);

    return metricsObj;
  };
})();

(function(){
  var Util = _html2canvas.Util,
    Generate = {};

  _html2canvas.Generate = Generate;

  var reGradients = [
  /^(-webkit-linear-gradient)\(([a-z\s]+)([\w\d\.\s,%\(\)]+)\)$/,
  /^(-o-linear-gradient)\(([a-z\s]+)([\w\d\.\s,%\(\)]+)\)$/,
  /^(-webkit-gradient)\((linear|radial),\s((?:\d{1,3}%?)\s(?:\d{1,3}%?),\s(?:\d{1,3}%?)\s(?:\d{1,3}%?))([\w\d\.\s,%\(\)\-]+)\)$/,
  /^(-moz-linear-gradient)\(((?:\d{1,3}%?)\s(?:\d{1,3}%?))([\w\d\.\s,%\(\)]+)\)$/,
  /^(-webkit-radial-gradient)\(((?:\d{1,3}%?)\s(?:\d{1,3}%?)),\s(\w+)\s([a-z\-]+)([\w\d\.\s,%\(\)]+)\)$/,
  /^(-moz-radial-gradient)\(((?:\d{1,3}%?)\s(?:\d{1,3}%?)),\s(\w+)\s?([a-z\-]*)([\w\d\.\s,%\(\)]+)\)$/,
  /^(-o-radial-gradient)\(((?:\d{1,3}%?)\s(?:\d{1,3}%?)),\s(\w+)\s([a-z\-]+)([\w\d\.\s,%\(\)]+)\)$/
  ];

  /*
 * TODO: Add IE10 vendor prefix (-ms) support
 * TODO: Add W3C gradient (linear-gradient) support
 * TODO: Add old Webkit -webkit-gradient(radial, ...) support
 * TODO: Maybe some RegExp optimizations are possible ;o)
 */
  Generate.parseGradient = function(css, bounds) {
    var gradient, i, len = reGradients.length, m1, stop, m2, m2Len, step, m3, tl,tr,br,bl;

    for(i = 0; i < len; i+=1){
      m1 = css.match(reGradients[i]);
      if(m1) {
        break;
      }
    }

    if(m1) {
      switch(m1[1]) {
        case '-webkit-linear-gradient':
        case '-o-linear-gradient':

          gradient = {
            type: 'linear',
            x0: null,
            y0: null,
            x1: null,
            y1: null,
            colorStops: []
          };

          // get coordinates
          m2 = m1[2].match(/\w+/g);
          if(m2){
            m2Len = m2.length;
            for(i = 0; i < m2Len; i+=1){
              switch(m2[i]) {
                case 'top':
                  gradient.y0 = 0;
                  gradient.y1 = bounds.height;
                  break;

                case 'right':
                  gradient.x0 = bounds.width;
                  gradient.x1 = 0;
                  break;

                case 'bottom':
                  gradient.y0 = bounds.height;
                  gradient.y1 = 0;
                  break;

                case 'left':
                  gradient.x0 = 0;
                  gradient.x1 = bounds.width;
                  break;
              }
            }
          }
          if(gradient.x0 === null && gradient.x1 === null){ // center
            gradient.x0 = gradient.x1 = bounds.width / 2;
          }
          if(gradient.y0 === null && gradient.y1 === null){ // center
            gradient.y0 = gradient.y1 = bounds.height / 2;
          }

          // get colors and stops
          m2 = m1[3].match(/((?:rgb|rgba)\(\d{1,3},\s\d{1,3},\s\d{1,3}(?:,\s[0-9\.]+)?\)(?:\s\d{1,3}(?:%|px))?)+/g);
          if(m2){
            m2Len = m2.length;
            step = 1 / Math.max(m2Len - 1, 1);
            for(i = 0; i < m2Len; i+=1){
              m3 = m2[i].match(/((?:rgb|rgba)\(\d{1,3},\s\d{1,3},\s\d{1,3}(?:,\s[0-9\.]+)?\))\s*(\d{1,3})?(%|px)?/);
              if(m3[2]){
                stop = parseFloat(m3[2]);
                if(m3[3] === '%'){
                  stop /= 100;
                } else { // px - stupid opera
                  stop /= bounds.width;
                }
              } else {
                stop = i * step;
              }
              gradient.colorStops.push({
                color: m3[1],
                stop: stop
              });
            }
          }
          break;

        case '-webkit-gradient':

          gradient = {
            type: m1[2] === 'radial' ? 'circle' : m1[2], // TODO: Add radial gradient support for older mozilla definitions
            x0: 0,
            y0: 0,
            x1: 0,
            y1: 0,
            colorStops: []
          };

          // get coordinates
          m2 = m1[3].match(/(\d{1,3})%?\s(\d{1,3})%?,\s(\d{1,3})%?\s(\d{1,3})%?/);
          if(m2){
            gradient.x0 = (m2[1] * bounds.width) / 100;
            gradient.y0 = (m2[2] * bounds.height) / 100;
            gradient.x1 = (m2[3] * bounds.width) / 100;
            gradient.y1 = (m2[4] * bounds.height) / 100;
          }

          // get colors and stops
          m2 = m1[4].match(/((?:from|to|color-stop)\((?:[0-9\.]+,\s)?(?:rgb|rgba)\(\d{1,3},\s\d{1,3},\s\d{1,3}(?:,\s[0-9\.]+)?\)\))+/g);
          if(m2){
            m2Len = m2.length;
            for(i = 0; i < m2Len; i+=1){
              m3 = m2[i].match(/(from|to|color-stop)\(([0-9\.]+)?(?:,\s)?((?:rgb|rgba)\(\d{1,3},\s\d{1,3},\s\d{1,3}(?:,\s[0-9\.]+)?\))\)/);
              stop = parseFloat(m3[2]);
              if(m3[1] === 'from') {
                stop = 0.0;
              }
              if(m3[1] === 'to') {
                stop = 1.0;
              }
              gradient.colorStops.push({
                color: m3[3],
                stop: stop
              });
            }
          }
          break;

        case '-moz-linear-gradient':

          gradient = {
            type: 'linear',
            x0: 0,
            y0: 0,
            x1: 0,
            y1: 0,
            colorStops: []
          };

          // get coordinates
          m2 = m1[2].match(/(\d{1,3})%?\s(\d{1,3})%?/);

          // m2[1] == 0%   -> left
          // m2[1] == 50%  -> center
          // m2[1] == 100% -> right

          // m2[2] == 0%   -> top
          // m2[2] == 50%  -> center
          // m2[2] == 100% -> bottom

          if(m2){
            gradient.x0 = (m2[1] * bounds.width) / 100;
            gradient.y0 = (m2[2] * bounds.height) / 100;
            gradient.x1 = bounds.width - gradient.x0;
            gradient.y1 = bounds.height - gradient.y0;
          }

          // get colors and stops
          m2 = m1[3].match(/((?:rgb|rgba)\(\d{1,3},\s\d{1,3},\s\d{1,3}(?:,\s[0-9\.]+)?\)(?:\s\d{1,3}%)?)+/g);
          if(m2){
            m2Len = m2.length;
            step = 1 / Math.max(m2Len - 1, 1);
            for(i = 0; i < m2Len; i+=1){
              m3 = m2[i].match(/((?:rgb|rgba)\(\d{1,3},\s\d{1,3},\s\d{1,3}(?:,\s[0-9\.]+)?\))\s*(\d{1,3})?(%)?/);
              if(m3[2]){
                stop = parseFloat(m3[2]);
                if(m3[3]){ // percentage
                  stop /= 100;
                }
              } else {
                stop = i * step;
              }
              gradient.colorStops.push({
                color: m3[1],
                stop: stop
              });
            }
          }
          break;

        case '-webkit-radial-gradient':
        case '-moz-radial-gradient':
        case '-o-radial-gradient':

          gradient = {
            type: 'circle',
            x0: 0,
            y0: 0,
            x1: bounds.width,
            y1: bounds.height,
            cx: 0,
            cy: 0,
            rx: 0,
            ry: 0,
            colorStops: []
          };

          // center
          m2 = m1[2].match(/(\d{1,3})%?\s(\d{1,3})%?/);
          if(m2){
            gradient.cx = (m2[1] * bounds.width) / 100;
            gradient.cy = (m2[2] * bounds.height) / 100;
          }

          // size
          m2 = m1[3].match(/\w+/);
          m3 = m1[4].match(/[a-z\-]*/);
          if(m2 && m3){
            switch(m3[0]){
              case 'farthest-corner':
              case 'cover': // is equivalent to farthest-corner
              case '': // mozilla removes "cover" from definition :(
                tl = Math.sqrt(Math.pow(gradient.cx, 2) + Math.pow(gradient.cy, 2));
                tr = Math.sqrt(Math.pow(gradient.cx, 2) + Math.pow(gradient.y1 - gradient.cy, 2));
                br = Math.sqrt(Math.pow(gradient.x1 - gradient.cx, 2) + Math.pow(gradient.y1 - gradient.cy, 2));
                bl = Math.sqrt(Math.pow(gradient.x1 - gradient.cx, 2) + Math.pow(gradient.cy, 2));
                gradient.rx = gradient.ry = Math.max(tl, tr, br, bl);
                break;
              case 'closest-corner':
                tl = Math.sqrt(Math.pow(gradient.cx, 2) + Math.pow(gradient.cy, 2));
                tr = Math.sqrt(Math.pow(gradient.cx, 2) + Math.pow(gradient.y1 - gradient.cy, 2));
                br = Math.sqrt(Math.pow(gradient.x1 - gradient.cx, 2) + Math.pow(gradient.y1 - gradient.cy, 2));
                bl = Math.sqrt(Math.pow(gradient.x1 - gradient.cx, 2) + Math.pow(gradient.cy, 2));
                gradient.rx = gradient.ry = Math.min(tl, tr, br, bl);
                break;
              case 'farthest-side':
                if(m2[0] === 'circle'){
                  gradient.rx = gradient.ry = Math.max(
                    gradient.cx,
                    gradient.cy,
                    gradient.x1 - gradient.cx,
                    gradient.y1 - gradient.cy
                    );
                } else { // ellipse

                  gradient.type = m2[0];

                  gradient.rx = Math.max(
                    gradient.cx,
                    gradient.x1 - gradient.cx
                    );
                  gradient.ry = Math.max(
                    gradient.cy,
                    gradient.y1 - gradient.cy
                    );
                }
                break;
              case 'closest-side':
              case 'contain': // is equivalent to closest-side
                if(m2[0] === 'circle'){
                  gradient.rx = gradient.ry = Math.min(
                    gradient.cx,
                    gradient.cy,
                    gradient.x1 - gradient.cx,
                    gradient.y1 - gradient.cy
                    );
                } else { // ellipse

                  gradient.type = m2[0];

                  gradient.rx = Math.min(
                    gradient.cx,
                    gradient.x1 - gradient.cx
                    );
                  gradient.ry = Math.min(
                    gradient.cy,
                    gradient.y1 - gradient.cy
                    );
                }
                break;

            // TODO: add support for "30px 40px" sizes (webkit only)
            }
          }

          // color stops
          m2 = m1[5].match(/((?:rgb|rgba)\(\d{1,3},\s\d{1,3},\s\d{1,3}(?:,\s[0-9\.]+)?\)(?:\s\d{1,3}(?:%|px))?)+/g);
          if(m2){
            m2Len = m2.length;
            step = 1 / Math.max(m2Len - 1, 1);
            for(i = 0; i < m2Len; i+=1){
              m3 = m2[i].match(/((?:rgb|rgba)\(\d{1,3},\s\d{1,3},\s\d{1,3}(?:,\s[0-9\.]+)?\))\s*(\d{1,3})?(%|px)?/);
              if(m3[2]){
                stop = parseFloat(m3[2]);
                if(m3[3] === '%'){
                  stop /= 100;
                } else { // px - stupid opera
                  stop /= bounds.width;
                }
              } else {
                stop = i * step;
              }
              gradient.colorStops.push({
                color: m3[1],
                stop: stop
              });
            }
          }
          break;
      }
    }

    return gradient;
  };

  function addScrollStops(grad) {
    return function(colorStop) {
      try {
        grad.addColorStop(colorStop.stop, colorStop.color);
      }
      catch(e) {
        Util.log(['failed to add color stop: ', e, '; tried to add: ', colorStop]);
      }
    };
  }

  Generate.Gradient = function(src, bounds) {
    if(bounds.width === 0 || bounds.height === 0) {
      return;
    }

    var canvas = document.createElement('canvas'),
    ctx = canvas.getContext('2d'),
    gradient, grad;

    canvas.width = bounds.width;
    canvas.height = bounds.height;

    // TODO: add support for multi defined background gradients
    gradient = _html2canvas.Generate.parseGradient(src, bounds);

    if(gradient) {
      switch(gradient.type) {
        case 'linear':
          grad = ctx.createLinearGradient(gradient.x0, gradient.y0, gradient.x1, gradient.y1);
          gradient.colorStops.forEach(addScrollStops(grad));
          ctx.fillStyle = grad;
          ctx.fillRect(0, 0, bounds.width, bounds.height);
          break;

        case 'circle':
          grad = ctx.createRadialGradient(gradient.cx, gradient.cy, 0, gradient.cx, gradient.cy, gradient.rx);
          gradient.colorStops.forEach(addScrollStops(grad));
          ctx.fillStyle = grad;
          ctx.fillRect(0, 0, bounds.width, bounds.height);
          break;

        case 'ellipse':
          var canvasRadial = document.createElement('canvas'),
            ctxRadial = canvasRadial.getContext('2d'),
            ri = Math.max(gradient.rx, gradient.ry),
            di = ri * 2;

          canvasRadial.width = canvasRadial.height = di;

          grad = ctxRadial.createRadialGradient(gradient.rx, gradient.ry, 0, gradient.rx, gradient.ry, ri);
          gradient.colorStops.forEach(addScrollStops(grad));

          ctxRadial.fillStyle = grad;
          ctxRadial.fillRect(0, 0, di, di);

          ctx.fillStyle = gradient.colorStops[gradient.colorStops.length - 1].color;
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(canvasRadial, gradient.cx - gradient.rx, gradient.cy - gradient.ry, 2 * gradient.rx, 2 * gradient.ry);
          break;
      }
    }

    return canvas;
  };

  Generate.ListAlpha = function(number) {
    var tmp = "",
    modulus;

    do {
      modulus = number % 26;
      tmp = String.fromCharCode((modulus) + 64) + tmp;
      number = number / 26;
    }while((number*26) > 26);

    return tmp;
  };

  Generate.ListRoman = function(number) {
    var romanArray = ["M", "CM", "D", "CD", "C", "XC", "L", "XL", "X", "IX", "V", "IV", "I"],
    decimal = [1000, 900, 500, 400, 100, 90, 50, 40, 10, 9, 5, 4, 1],
    roman = "",
    v,
    len = romanArray.length;

    if (number <= 0 || number >= 4000) {
      return number;
    }

    for (v=0; v < len; v+=1) {
      while (number >= decimal[v]) {
        number -= decimal[v];
        roman += romanArray[v];
      }
    }

    return roman;
  };
})();
function h2cRenderContext(width, height) {
  var storage = [];
  return {
    storage: storage,
    width: width,
    height: height,
    clip: function() {
      storage.push({
        type: "function",
        name: "clip",
        'arguments': arguments
      });
    },
    translate: function() {
      storage.push({
        type: "function",
        name: "translate",
        'arguments': arguments
      });
    },
    fill: function() {
      storage.push({
        type: "function",
        name: "fill",
        'arguments': arguments
      });
    },
    save: function() {
      storage.push({
        type: "function",
        name: "save",
        'arguments': arguments
      });
    },
    restore: function() {
      storage.push({
        type: "function",
        name: "restore",
        'arguments': arguments
      });
    },
    fillRect: function () {
      storage.push({
        type: "function",
        name: "fillRect",
        'arguments': arguments
      });
    },
    createPattern: function() {
      storage.push({
        type: "function",
        name: "createPattern",
        'arguments': arguments
      });
    },
    drawShape: function() {

      var shape = [];

      storage.push({
        type: "function",
        name: "drawShape",
        'arguments': shape
      });

      return {
        moveTo: function() {
          shape.push({
            name: "moveTo",
            'arguments': arguments
          });
        },
        lineTo: function() {
          shape.push({
            name: "lineTo",
            'arguments': arguments
          });
        },
        arcTo: function() {
          shape.push({
            name: "arcTo",
            'arguments': arguments
          });
        },
        bezierCurveTo: function() {
          shape.push({
            name: "bezierCurveTo",
            'arguments': arguments
          });
        },
        quadraticCurveTo: function() {
          shape.push({
            name: "quadraticCurveTo",
            'arguments': arguments
          });
        }
      };

    },
    drawImage: function () {
      storage.push({
        type: "function",
        name: "drawImage",
        'arguments': arguments
      });
    },
    fillText: function () {
      storage.push({
        type: "function",
        name: "fillText",
        'arguments': arguments
      });
    },
    setVariable: function (variable, value) {
      storage.push({
        type: "variable",
        name: variable,
        'arguments': value
      });
      return value;
    }
  };
}
_html2canvas.Parse = function (images, options) {
  window.scroll(0,0);

  var element = (( options.elements === undefined ) ? document.body : options.elements[0]), // select body by default
  numDraws = 0,
  doc = element.ownerDocument,
  Util = _html2canvas.Util,
  support = Util.Support(options, doc),
  ignoreElementsRegExp = new RegExp("(" + options.ignoreElements + ")"),
  body = doc.body,
  getCSS = Util.getCSS,
  pseudoHide = "___html2canvas___pseudoelement",
  hidePseudoElements = doc.createElement('style');

  hidePseudoElements.innerHTML = '.' + pseudoHide + '-before:before { content: "" !important; display: none !important; }' +
  '.' + pseudoHide + '-after:after { content: "" !important; display: none !important; }';

  body.appendChild(hidePseudoElements);

  images = images || {};

  function documentWidth () {
    return Math.max(
      Math.max(doc.body.scrollWidth, doc.documentElement.scrollWidth),
      Math.max(doc.body.offsetWidth, doc.documentElement.offsetWidth),
      Math.max(doc.body.clientWidth, doc.documentElement.clientWidth)
      );
  }

  function documentHeight () {
    return Math.max(
      Math.max(doc.body.scrollHeight, doc.documentElement.scrollHeight),
      Math.max(doc.body.offsetHeight, doc.documentElement.offsetHeight),
      Math.max(doc.body.clientHeight, doc.documentElement.clientHeight)
      );
  }

  function getCSSInt(element, attribute) {
    var val = parseInt(getCSS(element, attribute), 10);
    return (isNaN(val)) ? 0 : val; // borders in old IE are throwing 'medium' for demo.html
  }

  function renderRect (ctx, x, y, w, h, bgcolor) {
    if (bgcolor !== "transparent"){
      ctx.setVariable("fillStyle", bgcolor);
      ctx.fillRect(x, y, w, h);
      numDraws+=1;
    }
  }

  function capitalize(m, p1, p2) {
    if (m.length > 0) {
      return p1 + p2.toUpperCase();
    }
  }

  function textTransform (text, transform) {
    switch(transform){
      case "lowercase":
        return text.toLowerCase();
      case "capitalize":
        return text.replace( /(^|\s|:|-|\(|\))([a-z])/g, capitalize);
      case "uppercase":
        return text.toUpperCase();
      default:
        return text;
    }
  }

  function noLetterSpacing(letter_spacing) {
    return (/^(normal|none|0px)$/.test(letter_spacing));
  }

  function drawText(currentText, x, y, ctx){
    if (currentText !== null && Util.trimText(currentText).length > 0) {
      ctx.fillText(currentText, x, y);
      numDraws+=1;
    }
  }

  function setTextVariables(ctx, el, text_decoration, color) {
    var align = false,
    bold = getCSS(el, "fontWeight"),
    family = getCSS(el, "fontFamily"),
    size = getCSS(el, "fontSize"),
    shadows = Util.parseTextShadows(getCSS(el, "textShadow"));

    switch(parseInt(bold, 10)){
      case 401:
        bold = "bold";
        break;
      case 400:
        bold = "normal";
        break;
    }

    ctx.setVariable("fillStyle", color);
    ctx.setVariable("font", [getCSS(el, "fontStyle"), getCSS(el, "fontVariant"), bold, size, family].join(" "));
    ctx.setVariable("textAlign", (align) ? "right" : "left");

    if (shadows.length) {
      // TODO: support multiple text shadows
      // apply the first text shadow
      ctx.setVariable("shadowColor", shadows[0].color);
      ctx.setVariable("shadowOffsetX", shadows[0].offsetX);
      ctx.setVariable("shadowOffsetY", shadows[0].offsetY);
      ctx.setVariable("shadowBlur", shadows[0].blur);
    }

    if (text_decoration !== "none"){
      return Util.Font(family, size, doc);
    }
  }

  function renderTextDecoration(ctx, text_decoration, bounds, metrics, color) {
    switch(text_decoration) {
      case "underline":
        // Draws a line at the baseline of the font
        // TODO As some browsers display the line as more than 1px if the font-size is big, need to take that into account both in position and size
        renderRect(ctx, bounds.left, Math.round(bounds.top + metrics.baseline + metrics.lineWidth), bounds.width, 1, color);
        break;
      case "overline":
        renderRect(ctx, bounds.left, Math.round(bounds.top), bounds.width, 1, color);
        break;
      case "line-through":
        // TODO try and find exact position for line-through
        renderRect(ctx, bounds.left, Math.ceil(bounds.top + metrics.middle + metrics.lineWidth), bounds.width, 1, color);
        break;
    }
  }

  function getTextBounds(state, text, textDecoration, isLast, transform) {
    var bounds;
    if (support.rangeBounds && !transform) {
      if (textDecoration !== "none" || Util.trimText(text).length !== 0) {
        bounds = textRangeBounds(text, state.node, state.textOffset);
      }
      state.textOffset += text.length;
    } else if (state.node && typeof state.node.nodeValue === "string" ){
      var newTextNode = (isLast) ? state.node.splitText(text.length) : null;
      bounds = textWrapperBounds(state.node, transform);
      state.node = newTextNode;
    }
    return bounds;
  }

  function textRangeBounds(text, textNode, textOffset) {
    var range = doc.createRange();
    range.setStart(textNode, textOffset);
    range.setEnd(textNode, textOffset + text.length);
    return range.getBoundingClientRect();
  }

  function textWrapperBounds(oldTextNode, transform) {
    var parent = oldTextNode.parentNode,
    wrapElement = doc.createElement('wrapper'),
    backupText = oldTextNode.cloneNode(true);

    wrapElement.appendChild(oldTextNode.cloneNode(true));
    parent.replaceChild(wrapElement, oldTextNode);

    var bounds = transform ? Util.OffsetBounds(wrapElement) : Util.Bounds(wrapElement);
    parent.replaceChild(backupText, wrapElement);
    return bounds;
  }

  function renderText(el, textNode, stack) {
    var ctx = stack.ctx,
    color = getCSS(el, "color"),
    textDecoration = getCSS(el, "textDecoration"),
    textAlign = getCSS(el, "textAlign"),
    metrics,
    textList,
    state = {
      node: textNode,
      textOffset: 0
    };

    if (Util.trimText(textNode.nodeValue).length > 0) {
      textNode.nodeValue = textTransform(textNode.nodeValue, getCSS(el, "textTransform"));
      textAlign = textAlign.replace(["-webkit-auto"],["auto"]);

      textList = (!options.letterRendering && /^(left|right|justify|auto)$/.test(textAlign) && noLetterSpacing(getCSS(el, "letterSpacing"))) ?
      textNode.nodeValue.split(/(\b| )/)
      : textNode.nodeValue.split("");

      metrics = setTextVariables(ctx, el, textDecoration, color);

      if (options.chinese) {
        textList.forEach(function(word, index) {
          if (/.*[\u4E00-\u9FA5].*$/.test(word)) {
            word = word.split("");
            word.unshift(index, 1);
            textList.splice.apply(textList, word);
          }
        });
      }

      textList.forEach(function(text, index) {
        var bounds = getTextBounds(state, text, textDecoration, (index < textList.length - 1), stack.transform.matrix);
        if (bounds) {
          drawText(text, bounds.left, bounds.bottom, ctx);
          renderTextDecoration(ctx, textDecoration, bounds, metrics, color);
        }
      });
    }
  }

  function listPosition (element, val) {
    var boundElement = doc.createElement( "boundelement" ),
    originalType,
    bounds;

    boundElement.style.display = "inline";

    originalType = element.style.listStyleType;
    element.style.listStyleType = "none";

    boundElement.appendChild(doc.createTextNode(val));

    element.insertBefore(boundElement, element.firstChild);

    bounds = Util.Bounds(boundElement);
    element.removeChild(boundElement);
    element.style.listStyleType = originalType;
    return bounds;
  }

  function elementIndex(el) {
    var i = -1,
    count = 1,
    childs = el.parentNode.childNodes;

    if (el.parentNode) {
      while(childs[++i] !== el) {
        if (childs[i].nodeType === 1) {
          count++;
        }
      }
      return count;
    } else {
      return -1;
    }
  }

  function listItemText(element, type) {
    var currentIndex = elementIndex(element), text;
    switch(type){
      case "decimal":
        text = currentIndex;
        break;
      case "decimal-leading-zero":
        text = (currentIndex.toString().length === 1) ? currentIndex = "0" + currentIndex.toString() : currentIndex.toString();
        break;
      case "upper-roman":
        text = _html2canvas.Generate.ListRoman( currentIndex );
        break;
      case "lower-roman":
        text = _html2canvas.Generate.ListRoman( currentIndex ).toLowerCase();
        break;
      case "lower-alpha":
        text = _html2canvas.Generate.ListAlpha( currentIndex ).toLowerCase();
        break;
      case "upper-alpha":
        text = _html2canvas.Generate.ListAlpha( currentIndex );
        break;
    }

    return text + ". ";
  }

  function renderListItem(element, stack, elBounds) {
    var x,
    text,
    ctx = stack.ctx,
    type = getCSS(element, "listStyleType"),
    listBounds;

    if (/^(decimal|decimal-leading-zero|upper-alpha|upper-latin|upper-roman|lower-alpha|lower-greek|lower-latin|lower-roman)$/i.test(type)) {
      text = listItemText(element, type);
      listBounds = listPosition(element, text);
      setTextVariables(ctx, element, "none", getCSS(element, "color"));

      if (getCSS(element, "listStylePosition") === "inside") {
        ctx.setVariable("textAlign", "left");
        x = elBounds.left;
      } else {
        return;
      }

      drawText(text, x, listBounds.bottom, ctx);
    }
  }

  function loadImage (src){
    var img = images[src];
    return (img && img.succeeded === true) ? img.img : false;
  }

  function clipBounds(src, dst){
    var x = Math.max(src.left, dst.left),
    y = Math.max(src.top, dst.top),
    x2 = Math.min((src.left + src.width), (dst.left + dst.width)),
    y2 = Math.min((src.top + src.height), (dst.top + dst.height));

    return {
      left:x,
      top:y,
      width:x2-x,
      height:y2-y
    };
  }

  function setZ(element, stack, parentStack){
    var newContext,
    isPositioned = stack.cssPosition !== 'static',
    zIndex = isPositioned ? getCSS(element, 'zIndex') : 'auto',
    opacity = getCSS(element, 'opacity'),
    isFloated = getCSS(element, 'cssFloat') !== 'none';

    // https://developer.mozilla.org/en-US/docs/Web/Guide/CSS/Understanding_z_index/The_stacking_context
    // When a new stacking context should be created:
    // the root element (HTML),
    // positioned (absolutely or relatively) with a z-index value other than "auto",
    // elements with an opacity value less than 1. (See the specification for opacity),
    // on mobile WebKit and Chrome 22+, position: fixed always creates a new stacking context, even when z-index is "auto" (See this post)

    stack.zIndex = newContext = h2czContext(zIndex);
    newContext.isPositioned = isPositioned;
    newContext.isFloated = isFloated;
    newContext.opacity = opacity;
    newContext.ownStacking = (zIndex !== 'auto' || opacity < 1);

    if (parentStack) {
      parentStack.zIndex.children.push(stack);
    }
  }

  function renderImage(ctx, element, image, bounds, borders) {

    var paddingLeft = getCSSInt(element, 'paddingLeft'),
    paddingTop = getCSSInt(element, 'paddingTop'),
    paddingRight = getCSSInt(element, 'paddingRight'),
    paddingBottom = getCSSInt(element, 'paddingBottom');

    drawImage(
      ctx,
      image,
      0, //sx
      0, //sy
      image.width, //sw
      image.height, //sh
      bounds.left + paddingLeft + borders[3].width, //dx
      bounds.top + paddingTop + borders[0].width, // dy
      bounds.width - (borders[1].width + borders[3].width + paddingLeft + paddingRight), //dw
      bounds.height - (borders[0].width + borders[2].width + paddingTop + paddingBottom) //dh
      );
  }

  function getBorderData(element) {
    return ["Top", "Right", "Bottom", "Left"].map(function(side) {
      return {
        width: getCSSInt(element, 'border' + side + 'Width'),
        color: getCSS(element, 'border' + side + 'Color')
      };
    });
  }

  function getBorderRadiusData(element) {
    return ["TopLeft", "TopRight", "BottomRight", "BottomLeft"].map(function(side) {
      return getCSS(element, 'border' + side + 'Radius');
    });
  }

  var getCurvePoints = (function(kappa) {

    return function(x, y, r1, r2) {
      var ox = (r1) * kappa, // control point offset horizontal
      oy = (r2) * kappa, // control point offset vertical
      xm = x + r1, // x-middle
      ym = y + r2; // y-middle
      return {
        topLeft: bezierCurve({
          x:x,
          y:ym
        }, {
          x:x,
          y:ym - oy
        }, {
          x:xm - ox,
          y:y
        }, {
          x:xm,
          y:y
        }),
        topRight: bezierCurve({
          x:x,
          y:y
        }, {
          x:x + ox,
          y:y
        }, {
          x:xm,
          y:ym - oy
        }, {
          x:xm,
          y:ym
        }),
        bottomRight: bezierCurve({
          x:xm,
          y:y
        }, {
          x:xm,
          y:y + oy
        }, {
          x:x + ox,
          y:ym
        }, {
          x:x,
          y:ym
        }),
        bottomLeft: bezierCurve({
          x:xm,
          y:ym
        }, {
          x:xm - ox,
          y:ym
        }, {
          x:x,
          y:y + oy
        }, {
          x:x,
          y:y
        })
      };
    };
  })(4 * ((Math.sqrt(2) - 1) / 3));

  function bezierCurve(start, startControl, endControl, end) {

    var lerp = function (a, b, t) {
      return {
        x:a.x + (b.x - a.x) * t,
        y:a.y + (b.y - a.y) * t
      };
    };

    return {
      start: start,
      startControl: startControl,
      endControl: endControl,
      end: end,
      subdivide: function(t) {
        var ab = lerp(start, startControl, t),
        bc = lerp(startControl, endControl, t),
        cd = lerp(endControl, end, t),
        abbc = lerp(ab, bc, t),
        bccd = lerp(bc, cd, t),
        dest = lerp(abbc, bccd, t);
        return [bezierCurve(start, ab, abbc, dest), bezierCurve(dest, bccd, cd, end)];
      },
      curveTo: function(borderArgs) {
        borderArgs.push(["bezierCurve", startControl.x, startControl.y, endControl.x, endControl.y, end.x, end.y]);
      },
      curveToReversed: function(borderArgs) {
        borderArgs.push(["bezierCurve", endControl.x, endControl.y, startControl.x, startControl.y, start.x, start.y]);
      }
    };
  }

  function parseCorner(borderArgs, radius1, radius2, corner1, corner2, x, y) {
    if (radius1[0] > 0 || radius1[1] > 0) {
      borderArgs.push(["line", corner1[0].start.x, corner1[0].start.y]);
      corner1[0].curveTo(borderArgs);
      corner1[1].curveTo(borderArgs);
    } else {
      borderArgs.push(["line", x, y]);
    }

    if (radius2[0] > 0 || radius2[1] > 0) {
      borderArgs.push(["line", corner2[0].start.x, corner2[0].start.y]);
    }
  }

  function drawSide(borderData, radius1, radius2, outer1, inner1, outer2, inner2) {
    var borderArgs = [];

    if (radius1[0] > 0 || radius1[1] > 0) {
      borderArgs.push(["line", outer1[1].start.x, outer1[1].start.y]);
      outer1[1].curveTo(borderArgs);
    } else {
      borderArgs.push([ "line", borderData.c1[0], borderData.c1[1]]);
    }

    if (radius2[0] > 0 || radius2[1] > 0) {
      borderArgs.push(["line", outer2[0].start.x, outer2[0].start.y]);
      outer2[0].curveTo(borderArgs);
      borderArgs.push(["line", inner2[0].end.x, inner2[0].end.y]);
      inner2[0].curveToReversed(borderArgs);
    } else {
      borderArgs.push([ "line", borderData.c2[0], borderData.c2[1]]);
      borderArgs.push([ "line", borderData.c3[0], borderData.c3[1]]);
    }

    if (radius1[0] > 0 || radius1[1] > 0) {
      borderArgs.push(["line", inner1[1].end.x, inner1[1].end.y]);
      inner1[1].curveToReversed(borderArgs);
    } else {
      borderArgs.push([ "line", borderData.c4[0], borderData.c4[1]]);
    }

    return borderArgs;
  }

  function calculateCurvePoints(bounds, borderRadius, borders) {

    var x = bounds.left,
    y = bounds.top,
    width = bounds.width,
    height = bounds.height,

    tlh = borderRadius[0][0],
    tlv = borderRadius[0][1],
    trh = borderRadius[1][0],
    trv = borderRadius[1][1],
    brh = borderRadius[2][0],
    brv = borderRadius[2][1],
    blh = borderRadius[3][0],
    blv = borderRadius[3][1],

    topWidth = width - trh,
    rightHeight = height - brv,
    bottomWidth = width - brh,
    leftHeight = height - blv;

    return {
      topLeftOuter: getCurvePoints(
        x,
        y,
        tlh,
        tlv
        ).topLeft.subdivide(0.5),

      topLeftInner: getCurvePoints(
        x + borders[3].width,
        y + borders[0].width,
        Math.max(0, tlh - borders[3].width),
        Math.max(0, tlv - borders[0].width)
        ).topLeft.subdivide(0.5),

      topRightOuter: getCurvePoints(
        x + topWidth,
        y,
        trh,
        trv
        ).topRight.subdivide(0.5),

      topRightInner: getCurvePoints(
        x + Math.min(topWidth, width + borders[3].width),
        y + borders[0].width,
        (topWidth > width + borders[3].width) ? 0 :trh - borders[3].width,
        trv - borders[0].width
        ).topRight.subdivide(0.5),

      bottomRightOuter: getCurvePoints(
        x + bottomWidth,
        y + rightHeight,
        brh,
        brv
        ).bottomRight.subdivide(0.5),

      bottomRightInner: getCurvePoints(
        x + Math.min(bottomWidth, width + borders[3].width),
        y + Math.min(rightHeight, height + borders[0].width),
        Math.max(0, brh - borders[1].width),
        Math.max(0, brv - borders[2].width)
        ).bottomRight.subdivide(0.5),

      bottomLeftOuter: getCurvePoints(
        x,
        y + leftHeight,
        blh,
        blv
        ).bottomLeft.subdivide(0.5),

      bottomLeftInner: getCurvePoints(
        x + borders[3].width,
        y + leftHeight,
        Math.max(0, blh - borders[3].width),
        Math.max(0, blv - borders[2].width)
        ).bottomLeft.subdivide(0.5)
    };
  }

  function getBorderClip(element, borderPoints, borders, radius, bounds) {
    var backgroundClip = getCSS(element, 'backgroundClip'),
    borderArgs = [];

    switch(backgroundClip) {
      case "content-box":
      case "padding-box":
        parseCorner(borderArgs, radius[0], radius[1], borderPoints.topLeftInner, borderPoints.topRightInner, bounds.left + borders[3].width, bounds.top + borders[0].width);
        parseCorner(borderArgs, radius[1], radius[2], borderPoints.topRightInner, borderPoints.bottomRightInner, bounds.left + bounds.width - borders[1].width, bounds.top + borders[0].width);
        parseCorner(borderArgs, radius[2], radius[3], borderPoints.bottomRightInner, borderPoints.bottomLeftInner, bounds.left + bounds.width - borders[1].width, bounds.top + bounds.height - borders[2].width);
        parseCorner(borderArgs, radius[3], radius[0], borderPoints.bottomLeftInner, borderPoints.topLeftInner, bounds.left + borders[3].width, bounds.top + bounds.height - borders[2].width);
        break;

      default:
        parseCorner(borderArgs, radius[0], radius[1], borderPoints.topLeftOuter, borderPoints.topRightOuter, bounds.left, bounds.top);
        parseCorner(borderArgs, radius[1], radius[2], borderPoints.topRightOuter, borderPoints.bottomRightOuter, bounds.left + bounds.width, bounds.top);
        parseCorner(borderArgs, radius[2], radius[3], borderPoints.bottomRightOuter, borderPoints.bottomLeftOuter, bounds.left + bounds.width, bounds.top + bounds.height);
        parseCorner(borderArgs, radius[3], radius[0], borderPoints.bottomLeftOuter, borderPoints.topLeftOuter, bounds.left, bounds.top + bounds.height);
        break;
    }

    return borderArgs;
  }

  function parseBorders(element, bounds, borders){
    var x = bounds.left,
    y = bounds.top,
    width = bounds.width,
    height = bounds.height,
    borderSide,
    bx,
    by,
    bw,
    bh,
    borderArgs,
    // http://www.w3.org/TR/css3-background/#the-border-radius
    borderRadius = getBorderRadiusData(element),
    borderPoints = calculateCurvePoints(bounds, borderRadius, borders),
    borderData = {
      clip: getBorderClip(element, borderPoints, borders, borderRadius, bounds),
      borders: []
    };

    for (borderSide = 0; borderSide < 4; borderSide++) {

      if (borders[borderSide].width > 0) {
        bx = x;
        by = y;
        bw = width;
        bh = height - (borders[2].width);

        switch(borderSide) {
          case 0:
            // top border
            bh = borders[0].width;

            borderArgs = drawSide({
              c1: [bx, by],
              c2: [bx + bw, by],
              c3: [bx + bw - borders[1].width, by + bh],
              c4: [bx + borders[3].width, by + bh]
            }, borderRadius[0], borderRadius[1],
            borderPoints.topLeftOuter, borderPoints.topLeftInner, borderPoints.topRightOuter, borderPoints.topRightInner);
            break;
          case 1:
            // right border
            bx = x + width - (borders[1].width);
            bw = borders[1].width;

            borderArgs = drawSide({
              c1: [bx + bw, by],
              c2: [bx + bw, by + bh + borders[2].width],
              c3: [bx, by + bh],
              c4: [bx, by + borders[0].width]
            }, borderRadius[1], borderRadius[2],
            borderPoints.topRightOuter, borderPoints.topRightInner, borderPoints.bottomRightOuter, borderPoints.bottomRightInner);
            break;
          case 2:
            // bottom border
            by = (by + height) - (borders[2].width);
            bh = borders[2].width;

            borderArgs = drawSide({
              c1: [bx + bw, by + bh],
              c2: [bx, by + bh],
              c3: [bx + borders[3].width, by],
              c4: [bx + bw - borders[3].width, by]
            }, borderRadius[2], borderRadius[3],
            borderPoints.bottomRightOuter, borderPoints.bottomRightInner, borderPoints.bottomLeftOuter, borderPoints.bottomLeftInner);
            break;
          case 3:
            // left border
            bw = borders[3].width;

            borderArgs = drawSide({
              c1: [bx, by + bh + borders[2].width],
              c2: [bx, by],
              c3: [bx + bw, by + borders[0].width],
              c4: [bx + bw, by + bh]
            }, borderRadius[3], borderRadius[0],
            borderPoints.bottomLeftOuter, borderPoints.bottomLeftInner, borderPoints.topLeftOuter, borderPoints.topLeftInner);
            break;
        }

        borderData.borders.push({
          args: borderArgs,
          color: borders[borderSide].color
        });

      }
    }

    return borderData;
  }

  function createShape(ctx, args) {
    var shape = ctx.drawShape();
    args.forEach(function(border, index) {
      shape[(index === 0) ? "moveTo" : border[0] + "To" ].apply(null, border.slice(1));
    });
    return shape;
  }

  function renderBorders(ctx, borderArgs, color) {
    if (color !== "transparent") {
      ctx.setVariable( "fillStyle", color);
      createShape(ctx, borderArgs);
      ctx.fill();
      numDraws+=1;
    }
  }

  function renderFormValue (el, bounds, stack){

    var valueWrap = doc.createElement('valuewrap'),
    cssPropertyArray = ['lineHeight','textAlign','fontFamily','color','fontSize','paddingLeft','paddingTop','width','height','border','borderLeftWidth','borderTopWidth'],
    textValue,
    textNode;

    cssPropertyArray.forEach(function(property) {
      try {
        valueWrap.style[property] = getCSS(el, property);
      } catch(e) {
        // Older IE has issues with "border"
        Util.log("html2canvas: Parse: Exception caught in renderFormValue: " + e.message);
      }
    });

    valueWrap.style.borderColor = "black";
    valueWrap.style.borderStyle = "solid";
    valueWrap.style.display = "block";
    valueWrap.style.position = "absolute";

    if (/^(submit|reset|button|text|password)$/.test(el.type) || el.nodeName === "SELECT"){
      valueWrap.style.lineHeight = getCSS(el, "height");
    }

    valueWrap.style.top = bounds.top + "px";
    valueWrap.style.left = bounds.left + "px";

    textValue = (el.nodeName === "SELECT") ? (el.options[el.selectedIndex] || 0).text : el.value;
    if(!textValue) {
      textValue = el.placeholder;
    }

    textNode = doc.createTextNode(textValue);

    valueWrap.appendChild(textNode);
    body.appendChild(valueWrap);

    renderText(el, textNode, stack);
    body.removeChild(valueWrap);
  }

  function drawImage (ctx) {
    ctx.drawImage.apply(ctx, Array.prototype.slice.call(arguments, 1));
    numDraws+=1;
  }

  function getPseudoElement(el, which) {
    var elStyle = window.getComputedStyle(el, which);
    if(!elStyle || !elStyle.content || elStyle.content === "none" || elStyle.content === "-moz-alt-content" || elStyle.display === "none") {
      return;
    }
    var content = elStyle.content + '',
    first = content.substr( 0, 1 );
    //strips quotes
    if(first === content.substr( content.length - 1 ) && first.match(/'|"/)) {
      content = content.substr( 1, content.length - 2 );
    }

    var isImage = content.substr( 0, 3 ) === 'url',
    elps = document.createElement( isImage ? 'img' : 'span' );

    elps.className = pseudoHide + "-before " + pseudoHide + "-after";

    Object.keys(elStyle).filter(indexedProperty).forEach(function(prop) {
      // Prevent assigning of read only CSS Rules, ex. length, parentRule
      try {
        elps.style[prop] = elStyle[prop];
      } catch (e) {
        Util.log(['Tried to assign readonly property ', prop, 'Error:', e]);
      }
    });

    if(isImage) {
      elps.src = Util.parseBackgroundImage(content)[0].args[0];
    } else {
      elps.innerHTML = content;
    }
    return elps;
  }

  function indexedProperty(property) {
    return (isNaN(window.parseInt(property, 10)));
  }

  function injectPseudoElements(el, stack) {
    var before = getPseudoElement(el, ':before'),
    after = getPseudoElement(el, ':after');
    if(!before && !after) {
      return;
    }

    if(before) {
      el.className += " " + pseudoHide + "-before";
      el.parentNode.insertBefore(before, el);
      parseElement(before, stack, true);
      el.parentNode.removeChild(before);
      el.className = el.className.replace(pseudoHide + "-before", "").trim();
    }

    if (after) {
      el.className += " " + pseudoHide + "-after";
      el.appendChild(after);
      parseElement(after, stack, true);
      el.removeChild(after);
      el.className = el.className.replace(pseudoHide + "-after", "").trim();
    }

  }

  function renderBackgroundRepeat(ctx, image, backgroundPosition, bounds) {
    var offsetX = Math.round(bounds.left + backgroundPosition.left),
    offsetY = Math.round(bounds.top + backgroundPosition.top);

    ctx.createPattern(image);
    ctx.translate(offsetX, offsetY);
    ctx.fill();
    ctx.translate(-offsetX, -offsetY);
  }

  function backgroundRepeatShape(ctx, image, backgroundPosition, bounds, left, top, width, height) {
    var args = [];
    args.push(["line", Math.round(left), Math.round(top)]);
    args.push(["line", Math.round(left + width), Math.round(top)]);
    args.push(["line", Math.round(left + width), Math.round(height + top)]);
    args.push(["line", Math.round(left), Math.round(height + top)]);
    createShape(ctx, args);
    ctx.save();
    ctx.clip();
    renderBackgroundRepeat(ctx, image, backgroundPosition, bounds);
    ctx.restore();
  }

  function renderBackgroundColor(ctx, backgroundBounds, bgcolor) {
    renderRect(
      ctx,
      backgroundBounds.left,
      backgroundBounds.top,
      backgroundBounds.width,
      backgroundBounds.height,
      bgcolor
      );
  }

  function renderBackgroundRepeating(el, bounds, ctx, image, imageIndex) {
    var backgroundSize = Util.BackgroundSize(el, bounds, image, imageIndex),
    backgroundPosition = Util.BackgroundPosition(el, bounds, image, imageIndex, backgroundSize),
    backgroundRepeat = getCSS(el, "backgroundRepeat").split(",").map(Util.trimText);

    image = resizeImage(image, backgroundSize);

    backgroundRepeat = backgroundRepeat[imageIndex] || backgroundRepeat[0];

    switch (backgroundRepeat) {
      case "repeat-x":
        backgroundRepeatShape(ctx, image, backgroundPosition, bounds,
          bounds.left, bounds.top + backgroundPosition.top, 99999, image.height);
        break;

      case "repeat-y":
        backgroundRepeatShape(ctx, image, backgroundPosition, bounds,
          bounds.left + backgroundPosition.left, bounds.top, image.width, 99999);
        break;

      case "no-repeat":
        backgroundRepeatShape(ctx, image, backgroundPosition, bounds,
          bounds.left + backgroundPosition.left, bounds.top + backgroundPosition.top, image.width, image.height);
        break;

      default:
        renderBackgroundRepeat(ctx, image, backgroundPosition, {
          top: bounds.top,
          left: bounds.left,
          width: image.width,
          height: image.height
        });
        break;
    }
  }

  function renderBackgroundImage(element, bounds, ctx) {
    var backgroundImage = getCSS(element, "backgroundImage"),
    backgroundImages = Util.parseBackgroundImage(backgroundImage),
    image,
    imageIndex = backgroundImages.length;

    while(imageIndex--) {
      backgroundImage = backgroundImages[imageIndex];

      if (!backgroundImage.args || backgroundImage.args.length === 0) {
        continue;
      }

      var key = backgroundImage.method === 'url' ?
      backgroundImage.args[0] :
      backgroundImage.value;

      image = loadImage(key);

      // TODO add support for background-origin
      if (image) {
        renderBackgroundRepeating(element, bounds, ctx, image, imageIndex);
      } else {
        Util.log("html2canvas: Error loading background:", backgroundImage);
      }
    }
  }

  function resizeImage(image, bounds) {
    if(image.width === bounds.width && image.height === bounds.height) {
      return image;
    }

    var ctx, canvas = doc.createElement('canvas');
    canvas.width = bounds.width;
    canvas.height = bounds.height;
    ctx = canvas.getContext("2d");
    drawImage(ctx, image, 0, 0, image.width, image.height, 0, 0, bounds.width, bounds.height );
    return canvas;
  }

  function setOpacity(ctx, element, parentStack) {
    return ctx.setVariable("globalAlpha", getCSS(element, "opacity") * ((parentStack) ? parentStack.opacity : 1));
  }

  function removePx(str) {
    return str.replace("px", "");
  }

  var transformRegExp = /(matrix)\((.+)\)/;

  function getTransform(element, parentStack) {
    var transform = getCSS(element, "transform") || getCSS(element, "-webkit-transform") || getCSS(element, "-moz-transform") || getCSS(element, "-ms-transform") || getCSS(element, "-o-transform");
    var transformOrigin = getCSS(element, "transform-origin") || getCSS(element, "-webkit-transform-origin") || getCSS(element, "-moz-transform-origin") || getCSS(element, "-ms-transform-origin") || getCSS(element, "-o-transform-origin") || "0px 0px";

    transformOrigin = transformOrigin.split(" ").map(removePx).map(Util.asFloat);

    var matrix;
    if (transform && transform !== "none") {
      var match = transform.match(transformRegExp);
      if (match) {
        switch(match[1]) {
          case "matrix":
            matrix = match[2].split(",").map(Util.trimText).map(Util.asFloat);
            break;
        }
      }
    }

    return {
      origin: transformOrigin,
      matrix: matrix
    };
  }

  function createStack(element, parentStack, bounds, transform) {
    var ctx = h2cRenderContext((!parentStack) ? documentWidth() : bounds.width , (!parentStack) ? documentHeight() : bounds.height),
    stack = {
      ctx: ctx,
      opacity: setOpacity(ctx, element, parentStack),
      cssPosition: getCSS(element, "position"),
      borders: getBorderData(element),
      transform: transform,
      clip: (parentStack && parentStack.clip) ? Util.Extend( {}, parentStack.clip ) : null
    };

    setZ(element, stack, parentStack);

    // TODO correct overflow for absolute content residing under a static position
    if (options.useOverflow === true && /(hidden|scroll|auto)/.test(getCSS(element, "overflow")) === true && /(BODY)/i.test(element.nodeName) === false){
      stack.clip = (stack.clip) ? clipBounds(stack.clip, bounds) : bounds;
    }

    return stack;
  }

  function getBackgroundBounds(borders, bounds, clip) {
    var backgroundBounds = {
      left: bounds.left + borders[3].width,
      top: bounds.top + borders[0].width,
      width: bounds.width - (borders[1].width + borders[3].width),
      height: bounds.height - (borders[0].width + borders[2].width)
    };

    if (clip) {
      backgroundBounds = clipBounds(backgroundBounds, clip);
    }

    return backgroundBounds;
  }

  function getBounds(element, transform) {
    var bounds = (transform.matrix) ? Util.OffsetBounds(element) : Util.Bounds(element);
    transform.origin[0] += bounds.left;
    transform.origin[1] += bounds.top;
    return bounds;
  }

  function renderElement(element, parentStack, pseudoElement, ignoreBackground) {
    var transform = getTransform(element, parentStack),
    bounds = getBounds(element, transform),
    image,
    stack = createStack(element, parentStack, bounds, transform),
    borders = stack.borders,
    ctx = stack.ctx,
    backgroundBounds = getBackgroundBounds(borders, bounds, stack.clip),
    borderData = parseBorders(element, bounds, borders),
    backgroundColor = (ignoreElementsRegExp.test(element.nodeName)) ? "#efefef" : getCSS(element, "backgroundColor");


    createShape(ctx, borderData.clip);

    ctx.save();
    ctx.clip();

    if (backgroundBounds.height > 0 && backgroundBounds.width > 0 && !ignoreBackground) {
      renderBackgroundColor(ctx, bounds, backgroundColor);
      renderBackgroundImage(element, backgroundBounds, ctx);
    } else if (ignoreBackground) {
      stack.backgroundColor =  backgroundColor;
    }

    ctx.restore();

    borderData.borders.forEach(function(border) {
      renderBorders(ctx, border.args, border.color);
    });

    if (!pseudoElement) {
      injectPseudoElements(element, stack);
    }

    switch(element.nodeName){
      case "IMG":
        if ((image = loadImage(element.getAttribute('src')))) {
          renderImage(ctx, element, image, bounds, borders);
        } else {
          Util.log("html2canvas: Error loading <img>:" + element.getAttribute('src'));
        }
        break;
      case "INPUT":
        // TODO add all relevant type's, i.e. HTML5 new stuff
        // todo add support for placeholder attribute for browsers which support it
        if (/^(text|url|email|submit|button|reset)$/.test(element.type) && (element.value || element.placeholder || "").length > 0){
          renderFormValue(element, bounds, stack);
        }
        break;
      case "TEXTAREA":
        if ((element.value || element.placeholder || "").length > 0){
          renderFormValue(element, bounds, stack);
        }
        break;
      case "SELECT":
        if ((element.options||element.placeholder || "").length > 0){
          renderFormValue(element, bounds, stack);
        }
        break;
      case "LI":
        renderListItem(element, stack, backgroundBounds);
        break;
      case "CANVAS":
        renderImage(ctx, element, element, bounds, borders);
        break;
    }

    return stack;
  }

  function isElementVisible(element) {
    return (getCSS(element, 'display') !== "none" && getCSS(element, 'visibility') !== "hidden" && !element.hasAttribute("data-html2canvas-ignore"));
  }

  function parseElement (element, stack, pseudoElement) {
    if (isElementVisible(element)) {
      stack = renderElement(element, stack, pseudoElement, false) || stack;
      if (!ignoreElementsRegExp.test(element.nodeName)) {
        parseChildren(element, stack, pseudoElement);
      }
    }
  }

  function parseChildren(element, stack, pseudoElement) {
    Util.Children(element).forEach(function(node) {
      if (node.nodeType === node.ELEMENT_NODE) {
        parseElement(node, stack, pseudoElement);
      } else if (node.nodeType === node.TEXT_NODE) {
        renderText(element, node, stack);
      }
    });
  }

  function init() {
    var background = getCSS(document.documentElement, "backgroundColor"),
      transparentBackground = (Util.isTransparent(background) && element === document.body),
      stack = renderElement(element, null, false, transparentBackground);
    parseChildren(element, stack);

    if (transparentBackground) {
      background = stack.backgroundColor;
    }

    body.removeChild(hidePseudoElements);
    return {
      backgroundColor: background,
      stack: stack
    };
  }

  return init();
};

function h2czContext(zindex) {
  return {
    zindex: zindex,
    children: []
  };
}

_html2canvas.Preload = function( options ) {

  var images = {
    numLoaded: 0,   // also failed are counted here
    numFailed: 0,
    numTotal: 0,
    cleanupDone: false
  },
  pageOrigin,
  Util = _html2canvas.Util,
  methods,
  i,
  count = 0,
  element = options.elements[0] || document.body,
  doc = element.ownerDocument,
  domImages = element.getElementsByTagName('img'), // Fetch images of the present element only
  imgLen = domImages.length,
  link = doc.createElement("a"),
  supportCORS = (function( img ){
    return (img.crossOrigin !== undefined);
  })(new Image()),
  timeoutTimer;

  link.href = window.location.href;
  pageOrigin  = link.protocol + link.host;

  function isSameOrigin(url){
    link.href = url;
    link.href = link.href; // YES, BELIEVE IT OR NOT, that is required for IE9 - http://jsfiddle.net/niklasvh/2e48b/
    var origin = link.protocol + link.host;
    return (origin === pageOrigin);
  }

  function start(){
    Util.log("html2canvas: start: images: " + images.numLoaded + " / " + images.numTotal + " (failed: " + images.numFailed + ")");
    if (!images.firstRun && images.numLoaded >= images.numTotal){
      Util.log("Finished loading images: # " + images.numTotal + " (failed: " + images.numFailed + ")");

      if (typeof options.complete === "function"){
        options.complete(images);
      }

    }
  }

  // TODO modify proxy to serve images with CORS enabled, where available
  function proxyGetImage(url, img, imageObj){
    var callback_name,
    scriptUrl = options.proxy,
    script;

    link.href = url;
    url = link.href; // work around for pages with base href="" set - WARNING: this may change the url

    callback_name = 'html2canvas_' + (count++);
    imageObj.callbackname = callback_name;

    if (scriptUrl.indexOf("?") > -1) {
      scriptUrl += "&";
    } else {
      scriptUrl += "?";
    }
    scriptUrl += 'url=' + encodeURIComponent(url) + '&callback=' + callback_name;
    script = doc.createElement("script");

    window[callback_name] = function(a){
      if (a.substring(0,6) === "error:"){
        imageObj.succeeded = false;
        images.numLoaded++;
        images.numFailed++;
        start();
      } else {
        setImageLoadHandlers(img, imageObj);
        img.src = a;
      }
      window[callback_name] = undefined; // to work with IE<9  // NOTE: that the undefined callback property-name still exists on the window object (for IE<9)
      try {
        delete window[callback_name];  // for all browser that support this
      } catch(ex) {}
      script.parentNode.removeChild(script);
      script = null;
      delete imageObj.script;
      delete imageObj.callbackname;
    };

    script.setAttribute("type", "text/javascript");
    script.setAttribute("src", scriptUrl);
    imageObj.script = script;
    window.document.body.appendChild(script);

  }

  function loadPseudoElement(element, type) {
    var style = window.getComputedStyle(element, type),
    content = style.content;
    if (content.substr(0, 3) === 'url') {
      methods.loadImage(_html2canvas.Util.parseBackgroundImage(content)[0].args[0]);
    }
    loadBackgroundImages(style.backgroundImage, element);
  }

  function loadPseudoElementImages(element) {
    loadPseudoElement(element, ":before");
    loadPseudoElement(element, ":after");
  }

  function loadGradientImage(backgroundImage, bounds) {
    var img = _html2canvas.Generate.Gradient(backgroundImage, bounds);

    if (img !== undefined){
      images[backgroundImage] = {
        img: img,
        succeeded: true
      };
      images.numTotal++;
      images.numLoaded++;
      start();
    }
  }

  function invalidBackgrounds(background_image) {
    return (background_image && background_image.method && background_image.args && background_image.args.length > 0 );
  }

  function loadBackgroundImages(background_image, el) {
    var bounds;

    _html2canvas.Util.parseBackgroundImage(background_image).filter(invalidBackgrounds).forEach(function(background_image) {
      if (background_image.method === 'url') {
        methods.loadImage(background_image.args[0]);
      } else if(background_image.method.match(/\-?gradient$/)) {
        if(bounds === undefined) {
          bounds = _html2canvas.Util.Bounds(el);
        }
        loadGradientImage(background_image.value, bounds);
      }
    });
  }

  function getImages (el) {
    var elNodeType = false;

    // Firefox fails with permission denied on pages with iframes
    try {
      Util.Children(el).forEach(getImages);
    }
    catch( e ) {}

    try {
      elNodeType = el.nodeType;
    } catch (ex) {
      elNodeType = false;
      Util.log("html2canvas: failed to access some element's nodeType - Exception: " + ex.message);
    }

    if (elNodeType === 1 || elNodeType === undefined) {
      loadPseudoElementImages(el);
      try {
        loadBackgroundImages(Util.getCSS(el, 'backgroundImage'), el);
      } catch(e) {
        Util.log("html2canvas: failed to get background-image - Exception: " + e.message);
      }
      loadBackgroundImages(el);
    }
  }

  function setImageLoadHandlers(img, imageObj) {
    img.onload = function() {
      if ( imageObj.timer !== undefined ) {
        // CORS succeeded
        window.clearTimeout( imageObj.timer );
      }

      images.numLoaded++;
      imageObj.succeeded = true;
      img.onerror = img.onload = null;
      start();
    };
    img.onerror = function() {
      if (img.crossOrigin === "anonymous") {
        // CORS failed
        window.clearTimeout( imageObj.timer );

        // let's try with proxy instead
        if ( options.proxy ) {
          var src = img.src;
          img = new Image();
          imageObj.img = img;
          img.src = src;

          proxyGetImage( img.src, img, imageObj );
          return;
        }
      }

      images.numLoaded++;
      images.numFailed++;
      imageObj.succeeded = false;
      img.onerror = img.onload = null;
      start();
    };
  }

  methods = {
    loadImage: function( src ) {
      var img, imageObj;
      if ( src && images[src] === undefined ) {
        img = new Image();
        if ( src.match(/data:image\/.*;base64,/i) ) {
          img.src = src.replace(/url\(['"]{0,}|['"]{0,}\)$/ig, '');
          imageObj = images[src] = {
            img: img
          };
          images.numTotal++;
          setImageLoadHandlers(img, imageObj);
        } else if ( isSameOrigin( src ) || options.allowTaint ===  true ) {
          imageObj = images[src] = {
            img: img
          };
          images.numTotal++;
          setImageLoadHandlers(img, imageObj);
          img.src = src;
        } else if ( supportCORS && !options.allowTaint && options.useCORS ) {
          // attempt to load with CORS

          img.crossOrigin = "anonymous";
          imageObj = images[src] = {
            img: img
          };
          images.numTotal++;
          setImageLoadHandlers(img, imageObj);
          img.src = src;
        } else if ( options.proxy ) {
          imageObj = images[src] = {
            img: img
          };
          images.numTotal++;
          proxyGetImage( src, img, imageObj );
        }
      }

    },
    cleanupDOM: function(cause) {
      var img, src;
      if (!images.cleanupDone) {
        if (cause && typeof cause === "string") {
          Util.log("html2canvas: Cleanup because: " + cause);
        } else {
          Util.log("html2canvas: Cleanup after timeout: " + options.timeout + " ms.");
        }

        for (src in images) {
          if (images.hasOwnProperty(src)) {
            img = images[src];
            if (typeof img === "object" && img.callbackname && img.succeeded === undefined) {
              // cancel proxy image request
              window[img.callbackname] = undefined; // to work with IE<9  // NOTE: that the undefined callback property-name still exists on the window object (for IE<9)
              try {
                delete window[img.callbackname];  // for all browser that support this
              } catch(ex) {}
              if (img.script && img.script.parentNode) {
                img.script.setAttribute("src", "about:blank");  // try to cancel running request
                img.script.parentNode.removeChild(img.script);
              }
              images.numLoaded++;
              images.numFailed++;
              Util.log("html2canvas: Cleaned up failed img: '" + src + "' Steps: " + images.numLoaded + " / " + images.numTotal);
            }
          }
        }

        // cancel any pending requests
        if(window.stop !== undefined) {
          window.stop();
        } else if(document.execCommand !== undefined) {
          document.execCommand("Stop", false);
        }
        if (document.close !== undefined) {
          document.close();
        }
        images.cleanupDone = true;
        if (!(cause && typeof cause === "string")) {
          start();
        }
      }
    },

    renderingDone: function() {
      if (timeoutTimer) {
        window.clearTimeout(timeoutTimer);
      }
    }
  };

  if (options.timeout > 0) {
    timeoutTimer = window.setTimeout(methods.cleanupDOM, options.timeout);
  }

  Util.log('html2canvas: Preload starts: finding background-images');
  images.firstRun = true;

  getImages(element);

  Util.log('html2canvas: Preload: Finding images');
  // load <img> images
  for (i = 0; i < imgLen; i+=1){
    methods.loadImage( domImages[i].getAttribute( "src" ) );
  }

  images.firstRun = false;
  Util.log('html2canvas: Preload: Done.');
  if (images.numTotal === images.numLoaded) {
    start();
  }

  return methods;
};

_html2canvas.Renderer = function(parseQueue, options){

  // http://www.w3.org/TR/CSS21/zindex.html
  function createRenderQueue(parseQueue) {
    var queue = [],
    rootContext;

    rootContext = (function buildStackingContext(rootNode) {
      var rootContext = {};
      function insert(context, node, specialParent) {
        var zi = (node.zIndex.zindex === 'auto') ? 0 : Number(node.zIndex.zindex),
        contextForChildren = context, // the stacking context for children
        isPositioned = node.zIndex.isPositioned,
        isFloated = node.zIndex.isFloated,
        stub = {node: node},
        childrenDest = specialParent; // where children without z-index should be pushed into

        if (node.zIndex.ownStacking) {
          // '!' comes before numbers in sorted array
          contextForChildren = stub.context = { '!': [{node:node, children: []}]};
          childrenDest = undefined;
        } else if (isPositioned || isFloated) {
          childrenDest = stub.children = [];
        }

        if (zi === 0 && specialParent) {
          specialParent.push(stub);
        } else {
          if (!context[zi]) { context[zi] = []; }
          context[zi].push(stub);
        }

        node.zIndex.children.forEach(function(childNode) {
          insert(contextForChildren, childNode, childrenDest);
        });
      }
      insert(rootContext, rootNode);
      return rootContext;
    })(parseQueue);

    function sortZ(context) {
      Object.keys(context).sort().forEach(function(zi) {
        var nonPositioned = [],
        floated = [],
        positioned = [],
        list = [];

        // positioned after static
        context[zi].forEach(function(v) {
          if (v.node.zIndex.isPositioned || v.node.zIndex.opacity < 1) {
            // http://www.w3.org/TR/css3-color/#transparency
            // non-positioned element with opactiy < 1 should be stacked as if it were a positioned element with ‘z-index: 0’ and ‘opacity: 1’.
            positioned.push(v);
          } else if (v.node.zIndex.isFloated) {
            floated.push(v);
          } else {
            nonPositioned.push(v);
          }
        });

        (function walk(arr) {
          arr.forEach(function(v) {
            list.push(v);
            if (v.children) { walk(v.children); }
          });
        })(nonPositioned.concat(floated, positioned));

        list.forEach(function(v) {
          if (v.context) {
            sortZ(v.context);
          } else {
            queue.push(v.node);
          }
        });
      });
    }

    sortZ(rootContext);

    return queue;
  }

  function getRenderer(rendererName) {
    var renderer;

    if (typeof options.renderer === "string" && _html2canvas.Renderer[rendererName] !== undefined) {
      renderer = _html2canvas.Renderer[rendererName](options);
    } else if (typeof rendererName === "function") {
      renderer = rendererName(options);
    } else {
      throw new Error("Unknown renderer");
    }

    if ( typeof renderer !== "function" ) {
      throw new Error("Invalid renderer defined");
    }
    return renderer;
  }

  return getRenderer(options.renderer)(parseQueue, options, document, createRenderQueue(parseQueue.stack), _html2canvas);
};

_html2canvas.Util.Support = function (options, doc) {

  function supportSVGRendering() {
    var img = new Image(),
    canvas = doc.createElement("canvas"),
    ctx = (canvas.getContext === undefined) ? false : canvas.getContext("2d");
    if (ctx === false) {
      return false;
    }
    canvas.width = canvas.height = 10;
    img.src = [
    "data:image/svg+xml,",
    "<svg xmlns='http://www.w3.org/2000/svg' width='10' height='10'>",
    "<foreignObject width='10' height='10'>",
    "<div xmlns='http://www.w3.org/1999/xhtml' style='width:10;height:10;'>",
    "sup",
    "</div>",
    "</foreignObject>",
    "</svg>"
    ].join("");
    try {
      ctx.drawImage(img, 0, 0);
      canvas.toDataURL();
    } catch(e) {
      return false;
    }
    _html2canvas.Util.log('html2canvas: Parse: SVG powered rendering available');
    return true;
  }

  // Test whether we can use ranges to measure bounding boxes
  // Opera doesn't provide valid bounds.height/bottom even though it supports the method.

  function supportRangeBounds() {
    var r, testElement, rangeBounds, rangeHeight, support = false;

    if (doc.createRange) {
      r = doc.createRange();
      if (r.getBoundingClientRect) {
        testElement = doc.createElement('boundtest');
        testElement.style.height = "123px";
        testElement.style.display = "block";
        doc.body.appendChild(testElement);

        r.selectNode(testElement);
        rangeBounds = r.getBoundingClientRect();
        rangeHeight = rangeBounds.height;

        if (rangeHeight === 123) {
          support = true;
        }
        doc.body.removeChild(testElement);
      }
    }

    return support;
  }

  return {
    rangeBounds: supportRangeBounds(),
    svgRendering: options.svgRendering && supportSVGRendering()
  };
};
window.html2canvas = function(elements, opts) {
  elements = (elements.length) ? elements : [elements];
  var queue,
  canvas,
  options = {
    // general
    logging: false,
    elements: elements,
    background: "#fff",

    // preload options
    proxy: null,
    timeout: 0,    // no timeout
    useCORS: false, // try to load images as CORS (where available), before falling back to proxy
    allowTaint: false, // whether to allow images to taint the canvas, won't need proxy if set to true

    // parse options
    svgRendering: false, // use svg powered rendering where available (FF11+)
    ignoreElements: "IFRAME|OBJECT|PARAM",
    useOverflow: true,
    letterRendering: false,
    chinese: false,

    // render options

    width: null,
    height: null,
    taintTest: true, // do a taint test with all images before applying to canvas
    renderer: "Canvas"
  };

  options = _html2canvas.Util.Extend(opts, options);

  _html2canvas.logging = options.logging;
  options.complete = function( images ) {

    if (typeof options.onpreloaded === "function") {
      if ( options.onpreloaded( images ) === false ) {
        return;
      }
    }
    queue = _html2canvas.Parse( images, options );

    if (typeof options.onparsed === "function") {
      if ( options.onparsed( queue ) === false ) {
        return;
      }
    }

    canvas = _html2canvas.Renderer( queue, options );

    if (typeof options.onrendered === "function") {
      options.onrendered( canvas );
    }


  };

  // for pages without images, we still want this to be async, i.e. return methods before executing
  window.setTimeout( function(){
    _html2canvas.Preload( options );
  }, 0 );

  return {
    render: function( queue, opts ) {
      return _html2canvas.Renderer( queue, _html2canvas.Util.Extend(opts, options) );
    },
    parse: function( images, opts ) {
      return _html2canvas.Parse( images, _html2canvas.Util.Extend(opts, options) );
    },
    preload: function( opts ) {
      return _html2canvas.Preload( _html2canvas.Util.Extend(opts, options) );
    },
    log: _html2canvas.Util.log
  };
};

window.html2canvas.log = _html2canvas.Util.log; // for renderers
window.html2canvas.Renderer = {
  Canvas: undefined // We are assuming this will be used
};
_html2canvas.Renderer.Canvas = function(options) {
  options = options || {};

  var doc = document,
  safeImages = [],
  testCanvas = document.createElement("canvas"),
  testctx = testCanvas.getContext("2d"),
  Util = _html2canvas.Util,
  canvas = options.canvas || doc.createElement('canvas');

  function createShape(ctx, args) {
    ctx.beginPath();
    args.forEach(function(arg) {
      ctx[arg.name].apply(ctx, arg['arguments']);
    });
    ctx.closePath();
  }

  function safeImage(item) {
    if (safeImages.indexOf(item['arguments'][0].src ) === -1) {
      testctx.drawImage(item['arguments'][0], 0, 0);
      try {
        testctx.getImageData(0, 0, 1, 1);
      } catch(e) {
        testCanvas = doc.createElement("canvas");
        testctx = testCanvas.getContext("2d");
        return false;
      }
      safeImages.push(item['arguments'][0].src);
    }
    return true;
  }

  function renderItem(ctx, item) {
    switch(item.type){
      case "variable":
        ctx[item.name] = item['arguments'];
        break;
      case "function":
        switch(item.name) {
          case "createPattern":
            if (item['arguments'][0].width > 0 && item['arguments'][0].height > 0) {
              try {
                ctx.fillStyle = ctx.createPattern(item['arguments'][0], "repeat");
              }
              catch(e) {
                Util.log("html2canvas: Renderer: Error creating pattern", e.message);
              }
            }
            break;
          case "drawShape":
            createShape(ctx, item['arguments']);
            break;
          case "drawImage":
            if (item['arguments'][8] > 0 && item['arguments'][7] > 0) {
              if (!options.taintTest || (options.taintTest && safeImage(item))) {
                ctx.drawImage.apply( ctx, item['arguments'] );
              }
            }
            break;
          default:
            ctx[item.name].apply(ctx, item['arguments']);
        }
        break;
    }
  }

  return function(parsedData, options, document, queue, _html2canvas) {
    var ctx = canvas.getContext("2d"),
    newCanvas,
    bounds,
    fstyle,
    zStack = parsedData.stack;

    canvas.width = canvas.style.width =  options.width || zStack.ctx.width;
    canvas.height = canvas.style.height = options.height || zStack.ctx.height;

    fstyle = ctx.fillStyle;
    ctx.fillStyle = (Util.isTransparent(zStack.backgroundColor) && options.background !== undefined) ? options.background : parsedData.backgroundColor;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = fstyle;

    queue.forEach(function(storageContext) {
      // set common settings for canvas
      ctx.textBaseline = "bottom";
      ctx.save();

      if (storageContext.transform.matrix) {
        ctx.translate(storageContext.transform.origin[0], storageContext.transform.origin[1]);
        ctx.transform.apply(ctx, storageContext.transform.matrix);
        ctx.translate(-storageContext.transform.origin[0], -storageContext.transform.origin[1]);
      }

      if (storageContext.clip){
        ctx.beginPath();
        ctx.rect(storageContext.clip.left, storageContext.clip.top, storageContext.clip.width, storageContext.clip.height);
        ctx.clip();
      }

      if (storageContext.ctx.storage) {
        storageContext.ctx.storage.forEach(function(item) {
          renderItem(ctx, item);
        });
      }

      ctx.restore();
    });

    Util.log("html2canvas: Renderer: Canvas renderer done - returning canvas obj");

    if (options.elements.length === 1) {
      if (typeof options.elements[0] === "object" && options.elements[0].nodeName !== "BODY") {
        // crop image to the bounds of selected (single) element
        bounds = _html2canvas.Util.Bounds(options.elements[0]);
        newCanvas = document.createElement('canvas');
        newCanvas.width = Math.ceil(bounds.width);
        newCanvas.height = Math.ceil(bounds.height);
        ctx = newCanvas.getContext("2d");

        ctx.drawImage(canvas, bounds.left, bounds.top, bounds.width, bounds.height, 0, 0, bounds.width, bounds.height);
        canvas = null;
        return newCanvas;
      }
    }

    return canvas;
  };
};
})(window,document);

$(function() {

    $("#print-steps").click(function(e){
        var today = getCurrentDate();
        $(".local").hide();

        e.preventDefault();

        html2canvas($(this).closest('article').find('.list-circle-number'), {
          onrendered: function(canvas) {

              var windowRef = null; //Reference of the printing window
              var months = new Array("Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
                                      + "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre");

              var currentDate = new Date();
              var currentDateFormatted =
                  currentDate.getDate() + " de " + months[currentDate.getMonth()] + " de "
                      + currentDate.getFullYear() + ", " + currentDate.getHours() + ":"
                      + currentDate.getMinutes() + "h";


              if(windowRef == null || windowRef.closed) {

                windowRef = window.open('',
                    'Impresión de Tarifas',
                    'height=500,' +
                        'width=700,' +
                        'resizable,' +
                        'scrollbars,' +
                        'status');
                windowRef.document.write('<html><head><title></title>');
                windowRef.document.write('</head><body >');
                windowRef.document.body.appendChild(canvas);
                windowRef.document.write('<span>'+$("#legalText").val() + '</span><br><br>');
                windowRef.document.write('<div> A la fecha '+today+'</div>');
                windowRef.document.write('<span style="display:block; float:right;">' + currentDateFormatted + '</span>');
                windowRef.document.write('</body></html>');

                windowRef.print();
                $(".local").show();
                windowRef.close();
              } else {
                  windowRef.focus();
              }
          }
        });
    });
});
/**
 * Created by ptoc on 13/07/15.
 */
$(function(){
	var loadExternalListDomesticPlan = function($parent, target){
		listOfDomesticPlansInit();
	};

	$('body').on('superiorcoveragenetwork.listofdomesticplans', '.xk-js-listofdomesticplans', function(e, target) {
		loadExternalListDomesticPlan($(e.target), target);

        var urlsClass = document.getElementsByClassName("url-class");

        for (var i = 0; i < urlsClass.length; i++) {
            var urlVal = urlsClass[i].getAttribute("href");

            if ("" !== urlVal && typeof urlVal !== 'undefined') {
                var newURL = formatURL(urlVal);
                urlsClass[i].setAttribute("href", newURL);
            }
        }
	});
});

//append .html if needed
function formatURL(URL) {
    if (URL.endsWith(".html")) {
        return URL;
    } else {
        if (URL.endsWith("/")) {
            URL = URL.substring(0, URL.length -1);
        }
        return URL + ".html";
    }
}

function listOfDomesticPlansInit() {
	//show only the plans for the region...
	$(".planitem[data-planregion*='" + obtenerRegion() + "']").show();
	//show the state name...
	$(".list-plans #textestado").html(obtenerEstado());
}

function obtenerRegion() {
	var regionId = $.cookie("telcelcom_region");
	if ((typeof regionId === 'undefined') || regionId === '') { return 9; }
	return regionId;
}

function obtenerEstado() {
	var estadoId = $.cookie("telcelcom_estado");
	if ((typeof estadoId === 'undefined') || estadoId === '' || estadoId === 'Selecciona tu Estado') { return "Ciudad de México"; }
	return estadoId;
}
$(document).ready(function(){
    $('.xk-alreadyonforeigncountry').trigger('telcelcom.alreadyonforeigncountry', ['page']);
});

var componentPath = "";
$(document).on('telcelcom.alreadyonforeigncountry', '.xk-alreadyonforeigncountry', function(e, comesFrom) {

    var obj = $('.xk-alreadyonforeigncountry #country');
	var servicepath = "/bin/telcelcom/roaming/countries.json";

    $.getJSON(servicepath, function (response) {
        obj.find('option:not(:eq(0))').remove();
        $.each(response.results, function (key, country) {
            obj.append('<option value="' + country.value + '">' + country.text + '</option>');
        });
        obj.trigger('chosen:updated');
    });

    $(this).attr('data-comesFrom', comesFrom);

});


$(document).on('click', '.xk-alreadyonforeigncountry #btnSearchAFC', function(e){

        var comesFrom = $('.xk-alreadyonforeigncountry').eq(0).attr('data-comesfrom');

        $('.xk-howtodialsuperior').trigger('section.howtodialsuperior', ['', comesFrom, 'SAFC']);

        $('.xk-alreadyonforeigncountry-result').show('fast');

        return false;

});


$(function(){
	var loadExternal = function($parent, target){
		domesticdevicegrid();
        domesticdevicegridmatchheight();
	};

	$('body').on('superiorcoveragenetwork.domesticdevicegrid', '.xk-js-domesticdevicegrid', function(e, target) {
		loadExternal($(e.target), target);
	});

	$('.xk-js-domesticdevicegrid').each(function(){
		loadExternal($(this), $(this).attr('data-target'));
	});
});



function domesticdevicegrid() {
    var url = "/bin/telcelcom/domesticdevicedetail/date.json?bustcache=true";

    $.ajax({
        type: 'GET',
        contentType: 'application/json',
        dataType: 'json',
        url: url,
        success: function(data) {

            $.each(data, function(index, value) {
               
               $(".extras").empty().append(data[index]);
            });

        },
        error: function(jqXHR, textStatus, errorThrown) {
           console.log("The request was not made");
        }
     });
}

function domesticdevicegridmatchheight(){
    if($('.js-mathcheight-holder').length>0) {
        $('.js-mathcheight-item').matchHeight();
    }
}

angular.module("telcelApp").controller("plansCtrl", ['$scope', '$cookies', '$http', 'RecommendedPlan', '$sce',
    function($scope, $cookies, $http, RecommendedPlan, $sce) {
        $scope.familyPlanId = $(".data-family-plan").attr("data-idfamilyplan");

        var regionId = angular.isUndefined($cookies.telcelcom_region)
                || $cookies.telcelcom_region === null
                || $cookies.telcelcom_region.trim() == "" ? 9 : $cookies.telcelcom_region,
                reqType = angular.isUndefined($cookies.telcelcom_profile)
                || $cookies.telcelcom_profile === null ? "renta" : $cookies.telcelcom_profile;

        if (reqType == "POSPAGO") {
            reqType = "renta"
        } else if (reqType == "MIXTO") {
            reqType = "mixto"
        }

        reqType = "renta";
        $scope.recommendedPlan = RecommendedPlan.getPlan({regionId: regionId, reqType: reqType});

        $scope.recommendedPlan.$promise.then(function() {
            $scope.idGrupoPlan = $scope.recommendedPlan.idGrupoPlan || null;
            $scope.recomendado = $scope.familyPlanId == $scope.idGrupoPlan ? true : false;
        });

        $http.get("/bin/telcelcom/plan/recommendedplan/byfamily.groupid="
                + $scope.familyPlanId + ".region=" + regionId + ".recomendado.json?bustcache=false").
                success(function(response) {
            var value = response.data;
            if (value) {
                var resumenConceptosLength = Object.keys(value.resumenConceptos).length;
                if (resumenConceptosLength >= 1) {
                    $scope.validData = true;
                    var counter = 0;
                    var claro = "false";
                    if(value.conceptos.ClaVid!=null){
                    	claro  = value.conceptos.ClaVid.valor;
                    } 
                    var infoPlan = {"title": value.titulo, "id": value.idPlan, "descripcion": value.grupoPlanLightDTO.descripcion, "claro": claro, recommendedPlanByFamily: []};
                    $.each(value.resumenConceptos, function(index, val) {
                        counter++;
                        var currentEntry = angular.copy(val);
                        currentEntry.isFirstDigit = false;
                        if (checkForDigit(currentEntry.valor)) {
                            currentEntry.isFirstDigit = true;
                        }
                        if (index !== "cargoServicio") {
                            if (counter <= 5) {
                                if (currentEntry.valor !== "true") {
                                    if (currentEntry.tipoValor.nombre === "DINERO") {
                                        currentEntry.valor = formatPrice(parseInt(currentEntry.valor), '$');
                                    } else if (currentEntry.isFirstDigit) {
                                        currentEntry.valor = $sce.trustAsHtml(parseStringValue(currentEntry.valor));
                                    }
                                }
                                infoPlan.recommendedPlanByFamily.push(currentEntry);
                            }
                        } else if (index === "cargoServicio") {
                            currentEntry.valor = formatPrice(parseInt(currentEntry.valor), '$');
                            infoPlan.formattedPrice = angular.copy(currentEntry);
                        }
                    });
                    $scope.recommendedPlanInfo = infoPlan;
                }
            }
        });

    }
]);
angular.module("telcelApp").controller('getDataPlansByFamily', ['$scope', '$http', '$sce', '$timeout', function($scope, $http, $sce, $timeout) {
    $scope.getData = function() {
	    var familyId = $(".data-family-plan").attr("data-idfamilyplan");
	    var familyPlanText = $(".plans-all-item").attr("data-namePlanFamily");
	    var region = $.cookie("telcelcom_region");
	    if ((typeof region === 'undefined') || region === "") {
	        region = 9;
	    }

	    //GLUO: Cuando es recomendado, la familia es -1 ya que el id y nombre no estan en las propiedades de page.
	    if(familyId === '-1') {
	        var reqType = "renta";
	        if($.cookie("telcelcom_profile") == null || $.cookie("telcelcom_profile") === "POSPAGO") {
	            reqType = "renta";
	        } else if($.cookie("telcelcom_profile") == "MIXTO") {
	            reqType = "mixto";
	        }
	        //GLUO: Se busca id y nombre de plan en servicio de recomendado
	        $http.get("/bin/telcelcom/plan/recommendedplan." + region + "." + reqType + ".light.json?bustcache=true")
	        	.success(function(response) {
		        	familyId = response.id;
		        	familyPlanText = response.nombre;
		        	$scope.getPlansByFam(familyPlanText, familyId, region);
	        });
	    } else {
	        $scope.getPlansByFam(familyPlanText, familyId, region);
	    }    	
    }

    $scope.getPlansByFam = function(familyPlanText, familyId, region) {
		console.log("FamilyPlanText: " + familyPlanText);
		var mainTitle = $(".main-title-component").html();
	    var currencySymbol = $(".plans-all-item").attr("data-currencySymbol");
		mainTitle = mainTitle.replace("${familia}", familyPlanText);
		$(".main-title-component").html(mainTitle);
	    $http.get("/bin/telcelcom/plan/plansbyfamily." + familyId + "." + region + "." + "afterdigitsltr" + ".json?bustcache=true")
		    .success(function(response) {
			if (response.data instanceof Array) {
			    $scope.plans = response;
			    $.each(response.data, function(index, value) {
			        var resumenConceptosLength = Object.keys(value.resumenConceptos).length;
			        if (resumenConceptosLength >= 1) {
			            $scope.validData = true;
			            var counter = 0;
			            var infoPlan;
                        if(value.conceptos.ClaVid!=null){
                            infoPlan = {"title": value.titulo, "claro": value.conceptos.ClaVid.valor, plansByFamily: []};
                        }else{
                            infoPlan = {"title": value.titulo, "claro": "", plansByFamily: []};
                        }
			            $.each(value.resumenConceptos, function(index, val) {
			                counter++;
			                var currentEntry = angular.copy(val);
			                currentEntry.isFirstDigit = false;
			                if(checkForDigit(currentEntry.valor)){
			                    currentEntry.isFirstDigit = true;
			                }
			                if(index !== "cargoServicio" && index !== "costoMensual"){
			                    //if (counter <= 5) {
			                    if(currentEntry.valor !== "true") {
			                        if(currentEntry.tipoValor.nombre === "DINERO"){
			                            currentEntry.valor = formatPrice(parseInt(currentEntry.valor), currencySymbol);
			                        } else if(currentEntry.isFirstDigit) {
			                            currentEntry.valor = $sce.trustAsHtml(parseStringValue(currentEntry.valor));
			                        }
			                    }
			                    infoPlan.plansByFamily.push(currentEntry);
			                //}
			                } else if(index === "cargoServicio" || index === "costoMensual") {
			                    currentEntry.valor = formatPrice(parseInt(currentEntry.valor), currencySymbol);
			                    infoPlan.formattedPrice = angular.copy(currentEntry);
			                }
			            });
			            value.resumenConceptos = infoPlan;
			            $timeout(function () { nuevasTablasTelcel.inicializar(); }, 500); 
			        }
			    });
			}
		});
    };
}]);

$(function(){
	var compileAngular = function($element){
		if ($element.length) {
			var $injector = angular.injector(['ng', 'telcelApp']);
			$injector.invoke(['$rootScope','$compile',function ($rootScope, $compile) {
				$compile($element[0])($rootScope);
			}]);
		}
	};

	//Compila Angular y ejecuta la llamada al controller.
	$('body').on('plan.plansbyfamily','.data-family-plan', function (e) {
		var familyId = $(".data-family-plan").attr("data-idfamilyplan");
		if (familyId === '-1') {
			compileAngular($(e.target));
			angular.element('[ng-controller=getDataPlansByFamily]').scope().getData();
		}
	});
});

$(document).ready(function(){
	var familyId = $(".data-family-plan").attr("data-idfamilyplan");
	// Si no hay valor definido quiere decir que está entrando por Ajax.
	// En caso de que haya valor definido entonces está entrando por una página y
	// se ejecuta el getData().
	if(undefined == familyId){
		console.log("FamilyId no se encuentra: " + familyId);	
	} else {
		angular.element('[ng-controller=getDataPlansByFamily]').scope().getData();
	}
});
/*$(document).ready(function(){

    $('.xk-roamingratesandpackages').trigger('section.roamingrates', ['page']);

});*/

$(document).on('section.planlist', '.xk-planlist', function(e, comesFrom) {

   if (comesFrom == 'ajax') {

        //recompile the angular
        var $injector = angular.injector(['ng', 'telcelApp']);
        $injector.invoke(['$rootScope','$compile',function ($rootScope, $compile, $scope) {
            $compile($(e.target)[0])($rootScope);
        }]);

    }
});

$('#modalPlan').on('shown.bs.modal hidden.bs.modal', function (e) {
    $("#printPlanDetailBtn").click(function(event){ // printDeviceSummary
   		html2canvas($(this).closest('.content'), { //list-plans #contentDetailPlan

            height:12000,
            onrendered: function(canvas) {
   			var mywindow = window.open('', '', 'height=12000,width=800');
               mywindow.document.write('<html><head><title></title>');
               mywindow.document.write('</head><body>');

               mywindow.document.body.appendChild(canvas);

               //mywindow.document.write('<div>'+$("#copyRightsText").val()+'</div>');
               //mywindow.document.write('<div>'+$("#legalText").val()+'</div>');
               mywindow.document.write('</body></html>');

               mywindow.print();
               mywindow.close();





             }
           });

       });

    $("#printPlanDetailBtn2").click(function(event){ // printDeviceSummary
        $("#modalPlan").scrollTop(0);
   		html2canvas($("#contentDetailPlan").closest('.content'), { //list-plans #contentDetailPlan

            height:12000,
            onrendered: function(canvas) {
   			var mywindow = window.open('', '', 'height=12000,width=800');
               mywindow.document.write('<html><head><title></title>');
               mywindow.document.write('</head><body>');
               mywindow.document.body.appendChild(canvas);

               //mywindow.document.write('<div>'+$("#copyRightsText").val()+'</div>');
               //mywindow.document.write('<div>'+$("#legalText").val()+'</div>');
               mywindow.document.write('</body></html>');

               mywindow.print();
               mywindow.close();





             }
           });

       });
});


var template = '<div class="test"><div class="test2">' +
    '  <button type="button" class="btn btn-close-modal"  data-dismiss="modal">' +
    '    <i class="icon-Close"></i>' +
    '  </button><br>' +
    '  <p>{{description}}</p>' +
    '</div></div>';


angular.module("telcelApp").directive('openPlanDescriptionModal', ['$http','$compile',function ($http, $compile) {


    function getHtml(url) {
        return $http.get(url);
    }

    return {
        restrict: 'A',
        link: function (scope, element, attrs) {

            var targetElement;
            var compiledHtmlFn;
            var modalContainer;
            var modalContent;

            modalContainer = $(attrs.modalTarget);
            modalContent = $('.modalInfoDescription', modalContainer);

            modalContainer.on('hidden.bs.modal', function (e) {
                compiledHtmlFn = null;
                modalContent.empty();
            });


            element.on('click', '.openDescriptionModal', function (event) {
                targetElement = $(event.target);

                getHtml(targetElement.data('url')).then(function (responseHtml) {

                    scope.description = targetElement.data('description');
                    compiledHtmlFn = $compile(template);
                    modalContent.append(compiledHtmlFn(scope));
                    modalContainer.modal('show');

                });

            });

        }
    }
}]);

angular.module("telcelApp").directive('openPlanModal', ['$http','$sce','$compile', function ($http, $sce, $compile) {

    function getHtml(url) {
        return $http.get(url);
    }

    function getData(selector) {
        console.log("selector> " , selector);
        return $http.get("/bin/telcelcom/plan/plandetail." + selector + ".plan.json?bustcache=true");
    }

    return {
        restrict: 'A',
        link: function (scope, element, attrs) {
            var html;
            var targetElement;
            var compiledHtmlFn;
            var modalContainer;
            var modalContent;

            $(attrs.modalTarget).on('hidden.bs.modal', function (e) {
                html = null;
                compiledHtmlFn = null;
                modalContent.empty();
            });

            modalContainer = $(attrs.modalTarget);
            modalContent = $('.modal-content', modalContainer);


            element.on('click', '.openModal', function (event) {

                targetElement = $(event.target);

                getHtml(targetElement.data('url')).then(function (responseHtml) {
                    html = responseHtml.data;
                    getData(targetElement.data('selector')).then(function (response) {
                        if (response.data.data != undefined) {
                            var scopeData = response.data.data[0];
                            if (scopeData != null) {

                                if(typeof scopeData.titulo !== 'undefined') {
                                    scope.title = scopeData.titulo;								// title
                                }
                                scope.isMarketable = scopeData.grupoPlanLightDTO.version;	// is marketable (0 = Comercializable y 1 = No Comercializable)


                                scope.one = "1";
                                scope.legal1 = scopeData.grupoPlanLightDTO.legal1;			//legal1
                                scope.legal1HTML = function () {
                                    return $sce.trustAsHtml(scope.legal1);
                                };

                                scope.two = "2";
                                scope.legal2 = scopeData.grupoPlanLightDTO.legal2;			//legal2
                                scope.legal2HTML = function () {
                                    return $sce.trustAsHtml(scope.legal2);
                                };

                                scope.three = "3";
                                scope.legal3 = scopeData.grupoPlanLightDTO.legal3; 			//legal3
                                scope.legal3HTML = function () {
                                    return $sce.trustAsHtml(scope.legal3);
                                };

                                scope.four = "4";
                                scope.legal4 = scopeData.grupoPlanLightDTO.legal4; 			//legal4
                                scope.legal4HTML = function () {
                                    return $sce.trustAsHtml(scope.legal4);
                                };

                                scope.five = "5";
                                scope.legal5 = scopeData.grupoPlanLightDTO.legal5; 			//legal5
                                scope.legal5HTML = function () {
                                    return $sce.trustAsHtml(scope.legal5);
                                };

                                scope.six = "6";
                                scope.legal6 = scopeData.grupoPlanLightDTO.legal6; 			//legal6
                                scope.legal6HTML = function () {
                                    return $sce.trustAsHtml(scope.legal6);
                                };

                                scope.seven = "7";
                                scope.legal7 = scopeData.grupoPlanLightDTO.legal7; 			//legal7
                                scope.legal7HTML = function () {
                                    return $sce.trustAsHtml(scope.legal7);
                                };
                                
                                scope.eight = "8";
                                scope.legal8 = scopeData.grupoPlanLightDTO.legal8; 			//legal8
                                scope.legal8HTML = function () {
                                    return $sce.trustAsHtml(scope.legal8);
                                };

                                scope.nine = "9";
                                scope.footer = scopeData.grupoPlanLightDTO.footer;			//footer
                                scope.footerHTML = function () {
                                    return $sce.trustAsHtml(scope.footer);
                                };





                                $.each(scopeData.resumenConceptos, function(index, val) {
                                    var currentEntry = angular.copy(val);
                                    currentEntry.isFirstDigit = false;
                                    if(currentEntry.tipoValor.nombre === "DINERO"){
                                        scope.price = formatPrice(parseInt(currentEntry.valor), '$');
                                    } else if(currentEntry.isFirstDigit) {
                                        scope.price = $sce.trustAsHtml(parseStringValue(currentEntry.valor));
                                    }
                                });



                                var detailList = {                                              //detail list BEGIN
                                    details: []
                                };

                                $.each(scopeData.conceptos, function (index, value) {

                                    var valor = "";

                                    var idTipoValor = value.tipoValor.id;

                                    if (idTipoValor === 1) {
                                        if (value.valor != null) {
                                            //valor = '$' + value.valor;
                                                if(value.valor.indexOf('.') >= 0){
                                                    var sub = value.valor.substr(value.valor.indexOf('.')+1);
                                                    if(sub.length > 2){
                                                        valor = '$ ' + value.valor;
                                                    } else {
                                                        valor = formatPrice(parseFloat(value.valor), '$');
                                                    }
                                                } else {
                                                    valor = formatPrice(parseFloat(value.valor), '$');
                                                }



                                        }

                                    } else {
                                        valor = value.valor;
                                    }

                                    if (!((typeof valor==='undefined')||null==valor||valor.trim()==="")) {

                                        detailList.details.push({
                                            "concepto": value.concepto,
                                            "clave": value.clave,
                                            "valor": checkIfIsBooleanOrString(valor),
                                            "condicion": value.condicion,
                                            "hasCondicion": hasDescription(value.condicion)
                                        });
                                    }

                                });

                                scope.detailList = detailList;										//detail list END




                                var adicionalServicesList = {                                       // services list BEGIN
                                    adicionalServices: []
                                };


                                $.each(scopeData.grupoPlanLightDTO.servicios, function (index, value) {

                                    adicionalServicesList.adicionalServices.push({
                                        "servicio": value.servicio,
                                        "costo": costeValidation(value.costo),
                                        "incluido": value.incluido ,
                                        "descripcion": value.descripcion,
                                        "hasDescription": hasDescription(value.descripcion)

                                    });


                                });
                            }
                        }

                        scope.adicionalServicesList = adicionalServicesList;				// services list END


                        compiledHtmlFn = $compile(html);
                        modalContent.append(compiledHtmlFn(scope));
                        $(modalContent).find('.close-modal').click(function(){
                            modalContainer.modal('hide');
                        });
                        modalContainer.modal('show');

                    });
                });

            });

        }
    }
}]);


function numberWithCommas(x) {
    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

function costeValidation(coste){
    if(coste != null && typeof(coste) != "undefined"){
        if(coste > 0){
            var valor  = "";
            if(coste != null && typeof(coste) != "undefined"){
                if(coste.indexOf('.') >= 0){
                    var sub = coste.substr(coste.indexOf('.')+1);
                    if(sub.length > 2){
                        valor = '$ ' + coste.valor;
                    } else {
                        valor = formatPrice(parseFloat(coste), '$');
                    }
                } else {
                    valor = formatPrice(parseFloat(coste), '$');
                }

            }
            return valor;
        }else{
            return'';
        }

    }

}

function hasDescription(text){

    var  hasDescription = false;
    if(text != null){
        hasDescription = true;
    }

    return hasDescription;
}


function checkIfIsBooleanOrString(value){

    if( typeof value === "string" && value === "true"){
        return true;
    }else if( typeof value === "string" && value === "false"){
        return false;
    }else if( typeof value === "boolean"){
        return value;
    }else {
        return value;
    }
}

/**
 * @author jhernandez 04/02/15
 */

//TODO: Change to global app , move  filter and resource


angular.module("telcelApp").controller('BannerPlanController', ['$scope','$cookies', 'RecommendedPlan','PlanesService',
    function($scope, $cookies, RecommendedPlan,PlanesService){
        $scope.currencySymbol = $("#bannerPlanPrice").attr("data-currencySymbol");
        $scope.totalPrice = "";
        var regionId = angular.isUndefined($cookies.telcelcom_region)||$cookies.telcelcom_region===null||$cookies.telcelcom_region.trim()==""?9:$cookies.telcelcom_region,
            reqType =  angular.isUndefined($cookies.telcelcom_profile)||$cookies.telcelcom_profile===null?"renta":$cookies.telcelcom_profile;
        if (reqType=="POSPAGO"){
            reqType = "renta"
        }else if (reqType == "MIXTO"){
            reqType = "mixto"
        }
        //Fixed type
        reqType = "renta";
        $scope.recommendedPlan = RecommendedPlan.getPlan({regionId:regionId,reqType:reqType});
        //Wait data to be loaded
        $scope.recommendedPlan.$promise.then(function(){
            $scope.conceptos = PlanesService.resumenConceptos($scope.recommendedPlan.datosHome.resumenConceptos);
            $scope.totalPrice = $scope.recommendedPlan.datosHome.resumenConceptos.cargoServicio.valor;
            if($scope.recommendedPlan.datosHome.conceptos.ClaVid!=null){
            	$scope.claro  = $scope.recommendedPlan.datosHome.conceptos.ClaVid.valor;
            } else {
            	$scope.claro  = "false";
            }
        });
    }
]);

angular.module("telcelApp").controller('BannerGrupoPlanController', ['$scope','$cookies', '$http', 'RecommendedPlan','PlanesService',
    function($scope, $cookies, $http, RecommendedPlan,PlanesService){
		$scope.currencySymbol = $("#bannerPlanPrice").attr("data-currencySymbol");
		var familyPlanId = $("#familyPlanId").val();
        $scope.totalPrice = "";
        var regionId = angular.isUndefined($cookies.telcelcom_region)||$cookies.telcelcom_region===null||$cookies.telcelcom_region.trim()==""?9:$cookies.telcelcom_region,
            reqType =  angular.isUndefined($cookies.telcelcom_profile)||$cookies.telcelcom_profile===null?"renta":$cookies.telcelcom_profile;
        if (reqType=="POSPAGO"){
            reqType = "renta"
        }else if (reqType == "MIXTO"){
            reqType = "mixto"
        }
        //Fixed type
        reqType = "renta";
        
        $http.get("/bin/telcelcom/plan/recommendedplan/byfamily.groupid="
                + familyPlanId + ".region=" + regionId + ".recomendado.json?bustcache=false").
                success(function(response) {
            $scope.recommendedPlan = response.data;
        	$scope.conceptos = PlanesService.resumenConceptos($scope.recommendedPlan.resumenConceptos);
        	$scope.totalPrice = $scope.recommendedPlan.resumenConceptos.cargoServicio.valor;
        	if($scope.recommendedPlan.conceptos.ClaVid!=null){
        		$scope.claro  = $scope.recommendedPlan.conceptos.ClaVid.valor;
        	} else {
        		$scope.claro  = "false";
        	}
        });
//        $scope.recommendedPlan = RecommendedPlan.getPlan({regionId:regionId,reqType:reqType});
        //Wait data to be loaded
//        $scope.recommendedPlan.$promise.then(function(){
//            $scope.conceptos = PlanesService.resumenConceptos($scope.recommendedPlan.datosHome.resumenConceptos);
//            $scope.totalPrice = $scope.recommendedPlan.datosHome.resumenConceptos.cargoServicio.valor;
//            if($scope.recommendedPlan.datosHome.conceptos.ClaVid!=null){
//            	$scope.claro  = $scope.recommendedPlan.datosHome.conceptos.ClaVid.valor;
//            } else {
//            	$scope.claro  = "false";
//            }
//        });
    }
]);

$(document).ready(function () {
    var pagePath = $('#statesOptions').attr('pagePath');
    //in case there are more than one states combo in the same page
    //showing one at a time preferentially
    var statesOptions = $('select[id="statesOptions"]');// $('#statesOptions');
    if (pagePath) {

        $.ajax({
            type: 'GET',
            contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
            dataType: 'json',
            url: '/bin/telcelcom/base/states.json',
            success: function (data) {
                $.each(statesOptions, function (idx, stateSelect) {
                    $.each(data, function (index, value) {
                        $(stateSelect)
                                .append(
                                        $("<option />")
                                        .val(value.value)
                                        .text(value.text))
                                .trigger('chosen:updated');
                    });
                });
            },
            error: function (jqXHR, textStatus, errorThrown) {
                console.err("Error to retrive all STATES : ", errorThrown)
            }
        });
    }
});

angular.module("telcelApp").controller('GetSupportPhoneCtrl', ['$scope', '$http', function($scope, $http) {
    var sectionTag = $("#tramitesbyphone");
    var pagePath = sectionTag.attr("data-pagePath");
    var requestUrl = pagePath;
    var requestUrlModalities = requestUrl + ".modality.modalidades.json";
    var statesOptions = $('#estadocombobox');
    var modalitiesOptions = $('#productocombobox');
    var selectedState;
    var selectedMod;
    
    var regionId = $.cookie("telcelcom_region");
    var stateName = $.cookie("telcelcom_estado");
    var stateValue = stateName + "_" + regionId;
    var profileName = $.cookie("telcelcom_profile");
    var profileId = 0;
    if (typeof profileName !== 'undefined') {
        if (profileName === 'PREPAGO') {
            profileId = 2;
        } else if (profileName === 'POSPAGO') {
            profileId = 1;
        }
    }
    
    $http.get('/bin/telcelcom/base/states.json')
            .success(function(response) {
        $scope.regiones = response.data;
        $.each(response, function(index, value) {
            if (stateValue === value.value) {
                statesOptions.append($("<option />").val(value.value).text(value.text).attr('selected', 'selected'));
                selectedState = value.value;
                selectedState = selectedState.split("_");
                selectedState = selectedState[1];
            } else {
                statesOptions.append($("<option />").val(value.value).text(value.text));
            }
        });
        $('#estadocombobox').trigger('chosen:updated');
    });
   
    $http.get(requestUrlModalities)
            .success(function(response) {
        $.each(response.data, function(index, value) {
            if (value.id === profileId) {
                modalitiesOptions.append($("<option />").val(value.id).text(value.nombre).attr('selected', 'selected'));
                selectedMod = profileId;
                getInfoTable($scope, $http, requestUrl, selectedMod, selectedState);
            } else {
                modalitiesOptions.append($("<option />").val(value.id).text(value.nombre));
            }
        });
        $('#productocombobox').trigger('chosen:updated');
    });
    
    $('#estadocombobox').chosen().change(function(){
        selectedState = $(this).find('option:selected').val();
        selectedState = selectedState.split("_");
        selectedState = selectedState[1];
        if (typeof selectedState !== "undefined" && typeof selectedMod !== "undefined") {
            getInfoTable($scope, $http, requestUrl, selectedMod, selectedState);
        }
    });
    
    $('#productocombobox').chosen().change(function(){
        selectedMod = $(this).find('option:selected').val();
        if (typeof selectedState !== "undefined" && typeof selectedMod !== "undefined") {
            getInfoTable($scope, $http, requestUrl, selectedMod, selectedState);
        }
        var textfortitles= $("#textfortitles").val();
        var textNoCost= $("#textNoCost").val();
        var textWithCost= $("#textWithCost").val();
        if(textfortitles =='' &&  textNoCost =='' && textWithCost != ''){
            $("#simpleHeaderTR").show();
            $("#complexHeadersTR").hide();
        }
    });
}]);

function getInfoTable($scope, $http, urlRequest, selectedMode, selectedState) {
    var requestUrlInfoTable = urlRequest + ".tableinfophone." + selectedMode + "~modality." + selectedState + "~region.json";
    $http.get(requestUrlInfoTable)
            .success(function(response) {
        if (response.data instanceof Array) {
            $scope.tableinfophone = response.data;
            $.each(response.data, function(index, value) {
                $scope.phoneWithoutCost = value.telfijosincosto;
                $scope.phoneWithCost = value.telfijo;
                $scope.mobilWithoutCost = value.celularsincosto;
                $scope.mobilWithCost = value.celular;
                $scope.regionLabel = value.region.region;
                $scope.statesValue = value.region.estados;
            });
        }
    });
}

$(function(){
 var compileAngular = function($element){
     if ($element.length) {
         var $injector = angular.injector(['ng', 'telcelApp']);
         $injector.invoke(['$rootScope','$compile',function ($rootScope, $compile) {
             $compile($element[0])($rootScope);
         }]);
     }
 };

    //Apply angular compile
    $('body').on('support.supportbyphone','.js-suppor-supportbyphone', function (e) {
        compileAngular($(e.target));
    });
});
$(".glossary-item").click(function(e) {

    e.preventDefault();
    var today = getCurrentDate();
    var $_item = $(this);

    var $cloned = $(this).closest('.inner') ;
    $_item.hide();
    html2canvas($cloned, {
        onrendered: function(canvas) {
            $_item.show();
            var mywindow = window.open('', '', 'height=600,width=800');
            var months = new Array("Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
                "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre");
            var currentDate = new Date();
            var currentDateFormatted = currentDate.getDate() + " de " + months[currentDate.getMonth()] + " de " +
                currentDate.getFullYear() + ", " + currentDate.getHours() + ":" + currentDate.getMinutes() + "h";
            mywindow.document.write('<html><head><title></title>');
            mywindow.document.write('</head><body >');
            mywindow.document.write('<div class="navbar-header navbar-left">');
            mywindow.document.write('<a href="#" class="navbar-brand" title="TelCel">');
            mywindow.document.write('<img src="'+ $_item.data('logo')+'" />');
            mywindow.document.write('</a> <br />');
            mywindow.document.write('<span style="display:block; float:right;">' + currentDateFormatted + '</span>');
            mywindow.document.write('</div>');
            mywindow.document.body.appendChild(canvas);
            mywindow.document.write('<div> A la fecha '+today+'</div>');
            mywindow.document.write('</body></html>');
            mywindow.print();
            mywindow.close();

        }
    });
});
//console.log("faqReference.js loaded");
angular.module("telcelApp").controller("faqReferenceController", ['$window','$scope','$attrs','$http',
    function($window, $scope, $attrs, $http) {

        /*
         * Initialize variables...
         */
        var modeSelectorObj     = getFaqReferenceSelector(1, false);
        var searchSelectorObj   = getFaqReferenceSelector(2, true);

        $scope.inClass = "";
        $scope.activeClass = "";
        $scope.noResults = false;
        $scope.questionResults  = [];
        $scope.searchMode = modeSelectorObj.value;
        $scope.searchText = $scope.searchMode == "1" ? searchSelectorObj.decodedValue : "";
        $scope.serviceUrl = "/bin/telcelcom/support/faqreference" +
                            "." + modeSelectorObj.fullString +
                            "." + searchSelectorObj.fullString +
                            ".go.json";

        /*
        * Get the list of questions that matches...
        */
        $http.get($scope.serviceUrl).success(function(data, status) {
            if (data != null) {
                if (data.length <= 0 ) {
                    $scope.noResults = true;
                }
                $scope.questionResults = data;
                angular.element(document.querySelector(".xk-faqReference")).show();
                angular.element(document.querySelector(".icon-AccordionDownNeg")).click();
            }
        });
    }])
    .directive('questionDirective', function() {

        return function (scope, element, attrs) {
            //css classes used to display an accordion item
            //(at the beginning each item is collapsed).
            scope.inClass = "";
            scope.activeClass = "";

            //get the id of the question to display
            var pathArray = window.location.href.split('/');
            var lastLevelLocation = pathArray[pathArray.length - 1];
            var levelArray = lastLevelLocation.split('#');

            //display the question
            if (levelArray != null && levelArray.length >= 2) {
                var afterHashTag = levelArray[levelArray.length - 1];
                if (afterHashTag != "") {
                    var questionId = "#" + afterHashTag;
                    if (attrs.href == questionId) {
                        scope.inClass = "in";
                        scope.activeClass = "active";
                    }
                }
            }
        };

    //This directive show the content of the answer without showing the html tags of the answer's content.
    }).directive('answerDirective', function() {

        return function(scope, element, attrs) {
            var content = attrs.datacontent;
            if (content != null && content != 'undefined') {
                var obj = angular.element(element);
                if (obj != null) {
                    obj.html(attrs.datacontent);
                    element.removeAttr("datacontent");
                }
            }
        };
    });


/*
* Add the click event to each question. Jquery is used for this to prevent dom issues in the future.
 */
/*$(document).on('click', '.xk-faqReference .xk-faqQuestion', function() {
    var obj = $(this).find('.xk-answerContent');
    var dataContent = obj.attr('data-content');
    obj.html(dataContent);*/
    /*var questionId = $(this).attr("data-questionId");
    var categoryPath = $(this).attr("data-categoryPath");
    var serviceUrl = "/bin/telcelcom/support/faqreference" +
                     ".faqselected=" + questionId +
                     ".categoryPath=" + btoa(categoryPath) +
                     ".json";

    $.ajax({
        dataType: 'html',
        url: serviceUrl,
        success: function(data) {
            //console.log("data:" + data);
            return true;
        }
    });*/
//});

/*
* Get the selector at the specified position. Position starts at 0.
 */
function getFaqReferenceSelector(selector_pos, decodeValue) {
    var selectorObj = new Object();
    var defaultValue = "";

    selectorObj.fullString = "search="+defaultValue;
    selectorObj.key = "search";
    selectorObj.value = defaultValue;
    selectorObj.decodedValue = defaultValue;

    try {
        var pathArray = window.location.pathname.split( '/' );
        var lastLevelLocation = pathArray[pathArray.length-1];
        var levelArray = lastLevelLocation.split('.');

        if (selector_pos == (levelArray.length - 1)) {
            return selectorObj;
        }

        var selector = levelArray[selector_pos];
        var index = selector.indexOf("=");
        var selectorKey = selector.substr(0, index);
        var selectorValue = selector.substr(index + 1, selector.length);

        selectorObj.fullString = selector;
        selectorObj.key = selectorKey;
        selectorObj.value = selectorValue;
        selectorObj.decodedValue = selectorValue;

        if (decodeValue) { selectorObj.decodedValue = atob(selectorValue); }

    } catch(e) {

    }

    return selectorObj;
}


//Search the anchor of the accordion that has the id in the URL and clicks it to display the accordion
$(document).ready(function(){
    var pathArray = window.location.href.split( '/' );
    var lastLevelLocation = pathArray[pathArray.length-1];

    var levelArray = lastLevelLocation.split('#');
    if (levelArray != null && levelArray.length >= 2) {
        var afterHashTag = levelArray[levelArray.length -1];
        if (afterHashTag != "") {
            var selectedQuestion = $(".xk-faqQuestionContainer a[href='#" + afterHashTag + "']");
            if (selectedQuestion != null) {
                selectedQuestion.click();
            }
        }
    }
    $(".xk-faqQuestionContainer h2[title='[\"true\"]']").hide();
});

/**
 * Created by Luis Lopez on 26/10/15.
 */

$(document).on('support.faqcategories', '#preguntas-frecuentes-slider-div', function() {

    var lista_completa_faqs = $('#preguntas-frecuentes-slider li');
    var contador = 0;
    var ul = $("<ul class='row bordered-grid-primary define-faq'></ul>");

    var inicializar_carrusel = function(){

        $('#preguntas-frecuentes-slider-div').empty();
        lista_completa_faqs.each(function(key, val){
            
            
            if (contador == 0 ){
                ul = $("<ul class='row bordered-grid-primary define-faq'></ul>");
                agregar_lista( $('#preguntas-frecuentes-slider-div') , ul , val );
                contador ++;
            }
            
    
            else if ( contador < 12 ){
                agregar_lista( $('#preguntas-frecuentes-slider-div') , ul , val );
                contador ++;
            }
            
            
            else if ( contador == 12 ){
                ul = $("<ul class='row bordered-grid-primary define-faq'></ul>");
                agregar_lista( $('#preguntas-frecuentes-slider-div') , ul , val );
                contador = 1;
            }
            

            
        });

        //simpleCarouselNoResponsive( $('#preguntas-frecuentes-slider-div') ) ;

    }

    function agregar_lista( contenedor , lista , elemento ){
        contenedor.append(lista.append(elemento));
    }

	inicializar_carrusel();
});



angular.module("telcelApp").controller("ElectronicInvoice", ['$scope', '$http', '$sce', '$attrs',

    function($scope, $http, $sce, $attrs) {
        $scope.getInvoice = function(type, invoiceNum,rfc) {
            var failMsg = document.getElementById("failMessage");
                                        failMsg.style.display = "none";
            var emptyFailMsg = document.getElementById("emptyFailMessage");
                            emptyFailMsg.style.display = "none";
            if ((invoiceNum != undefined) && (rfc != undefined)){
                if (rfc.indexOf("&") > -1){
                    rfc = rfc.replace("&", "%26");
                }
                if(grecaptcha.getResponse().length != 0){
                $('.error-captcha').addClass('hide');
                $.ajax({
                   type: "GET",
                   url: "http://www2.telcel.com/rs/FacturaElectronica.php?noDocumento="+ invoiceNum +"&rfc="+ rfc +"&callback=function",
                   dataType: 'jsonp' })
                .done(function(result) {
                   if(result != null){
                        if (result.mensaje == 0){
                            if (type == "pdf"){
                                var link = result.url;
                                var  initPos = link.indexOf("getPDF?folioSAP=")
                                var  endPos = link.length;
                                if ((initPos < endPos) && (initPos > 0)){
                                    var method = link.substring(initPos, endPos);
                                    var redirectLink = "/bin/telcelcom/noncacheable/invoice/getPDF";
                                    $("#invoiceForm").attr("action", redirectLink);
                                    $("#folioSAP").val(link.substr(link.indexOf("=") + 1));
                                    if (method != null){
                                    	$("#invoiceForm").submit();
//                                        window.open(redirectLink, '_blank');
                                    }
                                }
                            }
                            if (type == "xml"){
                                var link = result.xml;
                                var  initPos = link.indexOf("getCFD?folioSAP=")
                                var  endPos = link.length;
                                if ((initPos < endPos) && (initPos > 0)){
                                    var method = link.substring(initPos, endPos);
                                    var redirectLink = "/bin/telcelcom/noncacheable/invoice/getCFD"
                                    $("#invoiceForm").attr("action", redirectLink);
                                    $("#folioSAP").val(link.substr(link.indexOf("=") + 1));
                                    if (method != null){
                                    	$("#invoiceForm").submit();
//                                        window.open(redirectLink, '_blank');
                                    }
                                }
                            }
                        }else{
                            var failMessage = document.getElementById("failMessage");
                            failMessage.style.display = "block";
                        }
                   }

                }).fail(function() {

                });
                }else{
                    $('.error-captcha').removeClass('hide');
                    $('.error-captcha').html('Por favor ingresa el Captcha.');
                }
            }else{
                var failMessage = document.getElementById("emptyFailMessage");
                failMessage.style.display = "block";
            }

        }
    }
]);

var PROFILER_URL = "http://www2.telcel.com/rs/Perfil.php?telefono=";
var PROFILE_PREPAID = "PREPAGO";
var PROFILE_PLAN = "POSPAGO";
var PROFILE_HYBRID = "MIXTO";
var captcha1;
var captcha2;

function openChatWindow(mylink, windowname) {
    if (! window.focus)return true;
    var href;
    if (typeof(mylink) == 'string')
       href=mylink;
    else
       href=mylink.href;
    window.location=href;
    window.resizeTo(426, 468);                             // Resizes the new window
    window.focus();
    return false;
}

function chatURL(valreg, valnom, valpla, valcons, valtel) {
    var URL = "";
    var consultaMap = [];
    consultaMap[1] = "Aclaracion-de-saldos";
    consultaMap[2] = "circuloAzul-Telcel";
    consultaMap[3] = "configuracion-de-Equipos";
    consultaMap[4] = "Informacion-de-Promociones";
    consultaMap[5] = "Informacion-de-Tramites";
    consultaMap[6] = "Internet-Telcel";
    consultaMap[7] = "Planes-de-Renta-Mensual";
    consultaMap[8] = "Roaming-Internacional";
    consultaMap[9] = "Servicios-adicionales";
    consultaMap[10] = "Suspension-o-reactivacion";
    consultaMap[11] = "Quejas-y-sugerencias";
    consultaMap[12] = "Tienda-en-linea";
    consultaMap[13] = "Otros";
    consultaMap[15] = "Contratar-o-cancelar-una-linea";
    
    if ((valpla == 1) && (valreg == 9)) {
	URL = "http://187.174.192.187:8080/acc-manager/chat/ChatClient?channel=chat_telcel_58&width=426&height=468&vr="+valreg+"&vn="+valnom;
        URL += "&vi="+valpla+"&ve="+valcons+"&vp="+valtel+"&iq=&curl=telcel.com";
    }
    else if ((valpla == 2) && (valreg == 9)) {
        URL = "http://dispatcher.ccmservicios.com.mx/visitas/tracker?fuente=TelcelR9WEB&vr="+valreg+"&vn="+valnom;
        URL += "&vi="+consultaMap[valcons]+"&ve="+valcons+"&vp="+valtel+"&iq=&curl=telcel.com";
    }
    else if (((valpla == 1) || (valpla == 2)) && ((valreg >= 1) && (valreg <= 8))) {
        URL = "http://dispatcher.ccmservicios.com.mx/visitas/tracker?fuente=TelcelDEURWEB&vr="+valreg+"&vn="+valnom;
        URL += "&vi="+consultaMap[valcons]+"&ve="+valcons+"&vp="+valtel+"&iq=&curl=telcel.com";
    }
    else if ((valpla == 0) && (valreg == 9)) {
	URL = "http://187.174.192.187:8080/acc-manager/chat/ChatClient?channel=chat_telcel_58&width=426&height=468&vr="+valreg+"&vn="+valnom;
        URL += "&vi="+valpla+"&ve="+valcons+"&vp="+valtel+"&iq=&curl=telcel.com";
    }
    else if ((valpla == 0) && ((valreg >= 1) && (valreg <= 8))) {
        URL = "http://dispatcher.ccmservicios.com.mx/visitas/tracker?fuente=TelcelDEURWEB&vr="+valreg+"&vn="+valnom;
        URL += "&vi="+consultaMap[valcons]+"&ve="+valcons+"&vp="+valtel+"&iq=&curl=telcel.com";
    }
    if (valcons == 12) {
        //URL = "http://dispatcher.ccmservicios.com.mx/visitas/tracker?fuente=TiendaLineaTLWEP&vr="+valreg+"&vn="+valnom+"&vi="+valpla;
        //URL += "&ve="+valcons+"&vp="+valtel+"&iq=&curl=telcel.com";
    	var fuente = (valreg == 9) ? "TelcelR9WEB" : "TelcelDEURWEB";
    	URL = "https://dispatcher.ccmservicios.com.mx/visitas/tracker?fuente="+fuente+"&vn="+valnom+"&vr="+valreg+"&vi="+consultaMap[valcons];
    	URL += "&ve=&vp="+valtel+"&iq=&curl=telcel.com";
    }
    else if ((valcons == 15) && (valreg == 9)) {
        URL = "http://dispatcher.ccmservicios.com.mx/visitas/tracker?fuente=RetencionesR9&vr="+valreg+"&vn="+valnom+"&vi="+consultaMap[valcons];
        URL += "&ve="+valcons+"&vp="+valtel+"&iq=&curl=telcel.com";
    }
    else if ((valcons == 15) && ((valreg >= 1) && (valreg <= 8))) {
		URL = "http://dispatcher.ccmservicios.com.mx/visitas/tracker?fuente=RetencionesDEUR&vr="+valreg+"&vn="+valnom+"&vi="+consultaMap[valcons]+"&ve=VAL";
    }

    return URL;
}   

function openVisitorChat(name, region, question) {
	var url = chatURL(region, name, 0, question, "");
    if (url !== "") {
		openChatWindow(url, "");
    }
}

function openClientChat(name, region, question, plan, phone) {
	var url = chatURL(region, name, plan, question, phone);
    if (url !== "") {
		openChatWindow(url, "");
    }
}

function getRegion(state) {
    var region = state.substring(state.indexOf("_")+1);
    return region;
}

function getUserProfile(phone, name, question) {
	$.post(
            PROFILER_URL + phone,
            function(data) {
                var opCode = data.codigo;
                var profile = data.perfil;
                var region = data.region;
                if(opCode && opCode === "0") {
                    if(isNaN(region) || profile === '?'){
                        alert("Tu número no es Telcel,"
                        +" por favor accede como visitante.");
                         grecaptcha.reset(captcha1);
                        //location.reload(true);
                    }else{
                        var plan = 0;
                        if (profile == PROFILE_PREPAID) {
                            plan = 1;
                        } else if ((profile == PROFILE_PLAN)
                                || (profile == PROFILE_HYBRID)) {
                            plan = 2;
                        }
                        region = parseInt(region);
                        openClientChat(name, region, question, plan, phone);
                    }
                }  
            },
            "json"
        );
}

function getCaptchaVerification(form, captchaResId, name, region
, phone, question) {
        var recaptchaResponse = $(captchaResId);
        if(recaptchaResponse && $(captchaResId).val().trim() != '') {
            $.post("/bin/telcelcom/noncacheable/captcha/check"
            + "?secret=6LeN3wETAAAAAD6oYRJVBpRYHqTauNJGjJj_CIWR&response="
            + recaptchaResponse.val().trim(), function(data){
                //console.log("aah!!!");
                //console.log(data.success);
                //console.log(data["error-codes"]);
                //Insert rest of the logic for the chat here!!

                if (data.success) {
                    if (form == "visitor_form") {
                        grecaptcha.reset(captcha1);
			openVisitorChat(name, region, question);
                    }
                    else if (form == "customer_form") {
                        grecaptcha.reset(captcha2);
                        getUserProfile(phone, name, question);
                    }
                }
            });
        }else{
            alert("Debe confirmar que no es un robot!");
        }

};

/*creates the captcha fields on the html*/
var siteKey = "6LeN3wETAAAAAK79CxVseevXwpGjgsFQwz2GBy1P";

var onloadCallback = function() {
    // Renders the HTML element with id 'example1' as a reCAPTCHA widget.
    // The id of the reCAPTCHA widget is assigned to 'widgetId1'.
	if (document.getElementById('captcha1') != null) {
	    captcha1 = grecaptcha.render(document.getElementById('captcha1'), {
	        'sitekey' : siteKey,
	        'theme' : 'light'
	    });
	}

	if (document.getElementById('captcha2') != null) {
		captcha2 = grecaptcha.render('captcha2', {
	        'sitekey' : siteKey,
	        'theme' : 'light'
	    });
	}
	
    if(document.getElementById('captcha3') !== null) {
        grecaptcha.render('captcha3', {
            'sitekey': siteKey,
            'theme': 'light'
        });
    }

    //Added for forms captcha.. 
    //section/general/formularios/form-container/clientlib/addCaptcha.js
    if ($(".xk-formcontainer #formCaptcha").length) {
        $(".xk-formcontainer #formCaptcha")
                .trigger("formcontainer.generatescaptcha");
    }
};


$(function() {
    var $chat = $('#chat');
    var $chat_footer = $(".btn-chat-footer");
    if ($chat.length<1){
        return; // Prevent continue if no chat found
    }
    var start = 1999
    $.each( $('.chosen-container'), function (index,value){
        $(this).css('z-index', start);
        start--;
    });
    var timeStart = $chat.data('timeStart').split(","),
        timeEnd = $chat.data('timeEnd').split(",");
    var nowTime  = moment.tz(moment(), 'America/Mexico_City'),
        startTime = moment.tz(moment(), 'America/Mexico_City')
                .hours(timeStart[0]).minutes(timeStart[1]),
        endTime = moment.tz(moment(), 'America/Mexico_City')
                .hours(timeEnd[0]).minutes(timeEnd[1]);
    if (!nowTime.isBetween(startTime, endTime)){
        $chat.hide();
        if ($chat_footer.length){
            $chat_footer.hide();
        }
         return;
    }
    $('#form-chat-2').validator().on('submit', function (e) {
		var question = $('#collapse-chat-2').find('select').val();
        var name = "";
        var phone = "";
        $('#collapse-chat-2 input[type="text"]').each(function( index ) {
            if (index == 0) {
                name = $( this ).val().trim();
            } else if (index == 1) {
                phone = $( this ).val().trim();
            }
        });
        if (e.isDefaultPrevented()) {
            //Invalid Form
            if(!name || name==null || name === ''){
                alert("Debe indicar su nombre!");
			}else{
                if(!phone || phone == null || phone === ''){
                    	alert("Debe especificar su teléfono!");
                }else{
                    if(isNaN(phone) || phone.length<10){
                        alert("El campo 'Teléfono' debe "
                        + " ser numérico de 10 dígitos!");
                    }else{
                        if(!question || question == null || question === ''){
                            alert("Debe seleccionar el tipo de consulta!");
                        }
                    }
                }
            }
        } else {
            e.preventDefault();
            question = parseInt(question);
            name = encodeURIComponent(name);
            getCaptchaVerification("customer_form", "#g-recaptcha-response-1"
            , name, "", phone, question);
        }
    });

    $('#form-chat-1').validator().on('submit', function (e) {
        var state = $('#collapse-chat-1').find('select').first().val();
        var question = $('#collapse-chat-1').find('select').last().val();
        var name = $('#collapse-chat-1').
                find('input[type="text"]').val().trim();
	if (e.isDefaultPrevented() == false) {
            e.preventDefault();            
            var region = "";
            if (state !== "") {
                region = getRegion(state);
            } else {
                region = "9";
            }
            region = parseInt(region);
            question = parseInt(question);
                name = encodeURIComponent(name);
            getCaptchaVerification("visitor_form", "#g-recaptcha-response"
            ,name, region, "", question);
        }else{

            if(!name || name==null || name === ''){
                alert("Debe indicar su nombre!");
			}else{
                if(!state || state==null || state === ''){
                    alert("Debe seleccionar un estado!");
                }else{
                    if(!question || question == null || question === ''){
                        alert("Debe seleccionar el tipo de consulta!");
                    }
                }
            }
        }

    });
});


$(document).ready(function(){
	
	
	
	$(document).on("click","#comunicarme-con-mexico",function(e){
		e.preventDefault();
		cambiar_codigo_pais_mexico();
	});

});

function cambiar_codigo_pais(){
	var valueSelected = $('#howtodialsuperiorselectdialer').find('option:selected').val();
	if( valueSelected != 52 ){

		$('.roaming-marcacion-otros-paises').removeClass('hidden');
		$('.roaming-marcacion-mexico').addClass('hidden');
		$("#howtodialsuperiorselectdialer option[value='-1']").prop("disabled",true); 
		var countrySelected = $('#howtodialsuperiorselectdialer').find('option:selected').text();
		var codigoSpan = $("#codigoArea");
		var pais = $("#nombrePais");
		$(codigoSpan).html('<span>(+)</span>' + valueSelected);
		$(pais).html('C&oacute;digo de ' + countrySelected);
		$(".titulo-como-marcar-pais").html(countrySelected);
		$('#howtodialsuperiorselectdialer').trigger('chosen:updated');

	}else{
		cambiar_codigo_pais_mexico();
	}
}

function cambiar_codigo_pais_mexico(){
	$('.roaming-marcacion-otros-paises').addClass('hidden');
	$('.roaming-marcacion-mexico').removeClass('hidden');
	$(".titulo-como-marcar-pais").html(" M&eacute;xico");
	var codeMexico = $("#howtodialsuperiorselectdialer option[value='52']");
	if(codeMexico.length > 0){
		$("#howtodialsuperiorselectdialer").val("52").trigger('chosen:updated');
	} else {
		$("#howtodialsuperiorselectdialer option[value='-1']").prop('disabled', false);
		$("#howtodialsuperiorselectdialer").val("-1").trigger('chosen:updated');
	}
	
}

$(document).on('section.howtodialsuperior', '.xk-howtodialsuperior', function(e, postParameters, comesFrom, caller) {

    //Provides the comboboxes data of the RoamingSearch component.
    $(this).attr('data-postparameters', postParameters);

    if (!$(this).hasClass('xk-SAFC') && !$(this).hasClass('xk-RS')) {
		$(this).addClass('xk-'+caller);
    }

    //If the page has been loaded normally it just calls the getRates() function
    if (comesFrom == 'page') {

        angular.element($(this)).scope().getData(caller);

        //If the page has been loaded by ajax it recompiles the angular code and then it calls the getRates() function
    } else if (comesFrom == 'ajax') {

        //recompile the angular
        var $injector = angular.injector(['ng', 'telcelApp']);
        $injector.invoke(['$rootScope','$compile',function ($rootScope, $compile, $scope) {
            $compile($(e.target)[0])($rootScope);
        }]);

        //call getData() function
        angular.element($(this)).scope().getData(caller);

    } else {

        angular.element($(this)).scope().getData(caller);

    }

});

angular.module("telcelApp").controller('getSupportPhone', ['$scope', '$http', function($scope, $http) {

    $scope.getData = function(caller) {

        try {

            var objCoverage = $('.xk-roamingsearch .xk-coverage');
            var objAFC = $('.xk-alreadyonforeigncountry #country');
            var firstCountry = "";

            if ((objCoverage.length !== 0) && (caller === 'RS')) {
                objCoverage.each(function(){

                    //If it is in land then get its country value
                    if ($(this).val() == '3') {
                        var objCountry = $(this).parent('.form-group')
                            .parent('.xk-trip-row')
                            .eq(0)
                            .find('.form-group')
                            .find('.xk-country')
                            .eq(0);
                        if (objCountry != null) {
                            firstCountry = objCountry.find('option:selected').text();
                        }
                    }
                });
            } else if ((objAFC.length !== 0) && (caller === 'SAFC')) {

                firstCountry = objAFC.find('option:selected').text();
            }


            if (firstCountry != "") {
                var howtodialsuperiordialers = $('.active.r-tabs-state-active .xk-howtodialsuperior #howtodialsuperiordialers');


                $('.active.r-tabs-state-active #howtodialsuperiorselectsms').find('option').each(function(){
                    if ($(this).text() == firstCountry ) {
                        $(this).attr('selected', 'selected');
                    }
                });

                $('.active.r-tabs-state-active #howtodialsuperiorselectsms').trigger('chosen:updated');

                var howtodialsuperiordialers = $('.active.r-tabs-state-active #howtodialsuperiordialers');
                var initialLabelDialer = howtodialsuperiordialers.html();

                var howtodialsuperiorsms = $('.active.r-tabs-state-active #howtodialsuperiorsms');
                var initialLabelSms = howtodialsuperiorsms.html();

                var howtodialsuperiortitle = $('.active.r-tabs-state-active #howtodialsuperiortitle');
                var initialLabelTitle = howtodialsuperiortitle.html();

                valueSelected = $('.active.r-tabs-state-active #howtodialsuperiorselectsms').find('option:selected').val();
                countrySelected = $('.active.r-tabs-state-active #howtodialsuperiorselectsms').find('option:selected').text();

                $('.active.r-tabs-state-active #codeDialerSms').html(initialLabelSms.replace("%CP%", valueSelected).replace("%DD%", valueSelected));
                $('.active.r-tabs-state-active #howtodialtitle').html(initialLabelTitle + " " + countrySelected);



                $('.active.r-tabs-state-active #howtodialsuperiorselectdialer').find('option').each(function(){
                    if ($(this).text() == firstCountry ) {
                        $(this).attr('selected', 'selected');
                    }
                });

                valueSelected = $('.active.r-tabs-state-active #howtodialsuperiorselectdialer').find('option:selected').val();
                countrySelected = $('.active.r-tabs-state-active #howtodialsuperiorselectdialer').find('option:selected').text();

                $('.active.r-tabs-state-active #codeDialer').html(initialLabelDialer.replace("%CP%", valueSelected).replace("%DD%", valueSelected));
                $('.active.r-tabs-state-active #howtodialtitle').html(initialLabelTitle + " " + countrySelected);

                $('.active.r-tabs-state-active #howtodialsuperiorselectdialer').trigger('chosen:updated');

            }

            var howtodialsuperiordialers = $('.active.r-tabs-state-active #howtodialsuperiordialers');
            var initialLabelDialer = howtodialsuperiordialers.html();

            var howtodialsuperiorsms = $('.active.r-tabs-state-active #howtodialsuperiorsms');
            var initialLabelSms = howtodialsuperiorsms.html();

            var howtodialsuperiortitle = $('.active.r-tabs-state-active #howtodialsuperiortitle');
            var initialLabelTitle = howtodialsuperiortitle.html();

            $('.active.r-tabs-state-active #howtodialsuperiorselectsms').chosen().change(function(){
                valueSelected = $(this).find('option:selected').val();
                countrySelected = $(this).find('option:selected').text();

                $('.active.r-tabs-state-active #codeDialerSms').html(initialLabelSms.replace("%CP%", valueSelected).replace("%DD%", valueSelected));
                $('.active.r-tabs-state-active #howtodialtitle').html(initialLabelTitle + " " + countrySelected);
            });

            $('.active.r-tabs-state-active #howtodialsuperiorselectdialer').chosen().change(function(){
                valueSelected = $(this).find('option:selected').val();
                countrySelected = $(this).find('option:selected').text();

                $('.active.r-tabs-state-active #codeDialer').html(initialLabelDialer.replace("%CP%", valueSelected).replace("%DD%", valueSelected));
                $('.active.r-tabs-state-active #howtodialtitle').html(initialLabelTitle + " " + countrySelected);
            });

            howtodialsuperiordialers.trigger('chosen:updated');
            howtodialsuperiorsms.trigger('chosen:updated');
            
        } catch(e) {

        }

    };

}]);

$(function(){
	var loadExternal = function($parent, target){
        servicegroupthumbnailsmatchheight();
	};

	$('body').on('service.servicegroupthumbnails', '.xk-js-servicegroupthumbnails', function(e, target) {
		loadExternal($(e.target), target);
	});

	$('.xk-js-servicegroupthumbnails').each(function(){
		loadExternal($(this), $(this).attr('data-target'));
	});
});
function servicegroupthumbnailsmatchheight(){
    if($('.js-mathcheight-holder').length>0) {
        $('.js-mathcheight-item').matchHeight();
    }
}

$(function() {

    $('body').on("click",'.printParsysContent', function(e){
        e.preventDefault();
        var today = getCurrentDate();
        $('.panel-collapse').each(function(i, obj){
            obj.classList.add('in');
        });
        html2canvas($(e.target).closest('section').find('.cobroAmigoPar'), {
          onrendered: function(canvas) {

              var windowRef = null; //Reference of the printing window
              var months = new Array("Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
                                      + "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre");

              var currentDate = new Date();
              var currentDateFormatted =
                  currentDate.getDate() + " de " + months[currentDate.getMonth()] + " de "
                      + currentDate.getFullYear() + ", " + currentDate.getHours() + ":"
                      + currentDate.getMinutes() + "h";


              if(windowRef == null || windowRef.closed) {

                windowRef = window.open('','',
                    'height=500,' +
                        'width=700,' +
                        'resizable,' +
                        'scrollbars,' +
                        'status');
                windowRef.document.write('<html><head><title>Impresión de Tarifas</title>');
                windowRef.document.write('</head><body >');
                windowRef.document.write('<div class="navbar-header navbar-left">');
                windowRef.document.write('<a href="#" class="navbar-brand printable" title="TelCel">');
                windowRef.document.write('<img src="' + $("#imgLogoTelcel").val() + '" />');
                windowRef.document.write('</a></div>');
                windowRef.document.write('<span style="display:block; float:right;">'  + $("#featured-rate-title").val() + '</span>');

                  try {
                      //windowRef.document.body.appendChild(canvas);
                      var imgCanvas = windowRef.document.createElement('img');
                      imgCanvas.src = canvas.toDataURL();
                      windowRef.document.body.appendChild(imgCanvas);

                  }
                  catch(err) {
                      console.log(err.message);
                  }
                  
                windowRef.document.write('<div>'+$(".cobroAmigoPar").val()+'</div>');
                windowRef.document.write('<span>'+$("#legalText").val() + '</span><br><br>');
                windowRef.document.write('<div> A la fecha '+today+'</div>');
                windowRef.document.write('<span style="display:block; float:left;">' + document.URL + '</span>');
                windowRef.document.write('<span style="display:block; float:right;">' + currentDateFormatted + '</span>');
                windowRef.document.write('</body></html>');

                windowRef.document.close();  
                windowRef.focus();  
                windowRef.print();
                windowRef.close();
              } else {
                  windowRef.focus();
              }
          }
        });
    });
});
/*
 * This script works as a client library for searchdevice component
 */

/*
 * Populates the model combo-box
 */
//console.log('se cargó la clientlib videotutorials');
function changeComboSearch(marcaCombo){
    var path = marcaCombo.indexOf("/content/telcel") === 0?marcaCombo:"/content/telcel" +marcaCombo;
    var encodeMarcaCombo = btoa(path);
    var service = "/bin/telcelcom/device/vtg.path=" + encodeMarcaCombo + ".models=true.json";
    var el = $("#modeloSearch");
    //console.log("models service url:" + service);

    $.ajax({
        url: service,
        type: 'GET',
        success: function(data, status){
            el.children('option:not(:first)').remove();
            if(status == "success") {
                $.each(data, function(index, item) {
                    el.append($("<option></option>")
                        .attr("value", item.page_name).text(item.title)).trigger('chosen:updated');
                });

                /* Activate on modeloCombo list success */
                activateCombobox('#modeloSearch');
                //activateCombobox('#ayudaSearch');
            }
            else {
                console.log("Error loading devices, response status: " + status);
            }
        },
        error: function(data, status, error){
            console.log("An AJAX error occured: " + status + "\nError: " + error);
        }
    });
}

$(document).ready(function() {

    $(document).on('regComboEventListeners', function(){
        //console.log("search bar loaded");
        // When the user selects a brand from the combo-box
        $('#marcaSearch').change(function(){
            //var marcaCombo = $('#marcaSearch_chosen .chosen-single span').html();
            var marcaCombo = $('#marcaSearch').val();
            var pathToCategory = $('#values-dialog').attr('data-category');
            pathToCategory += "/" + marcaCombo;

            /* disable 'modelo','ayuda' and 'button' on 'marca' changed */
            resetCombobox("#modeloSearch");
            resetCombobox("#ayudaSearch");
            $('#btn-submitSearch').attr("disabled", "disabled");
            $('#modeloSearch option:contains("Modelo")').prop('selected',true);
            changeComboSearch(pathToCategory);
        });

        // When the user selects a device model
        $('#modeloSearch').change(function(event){
            //var marcaCombo = $('#marcaSearch_chosen .chosen-single span').html();
            //var modeloCombo = $('#modeloSearch_chosen .chosen-single span').html().split(" - ");
            var marcaCombo = $('#marcaSearch').val();
            var modeloCombo = $('#modeloSearch').val();
            var pathToCategory = $('#values-dialog').attr('data-category');
            var pathToCategory = pathToCategory.indexOf("/content/telcel") === 0?pathToCategory:"/content/telcel" +pathToCategory;
            $('#btn-submitSearch').removeAttr('disabled');

            $('#ayudaSearch option').eq(0).hide(); //Se oculta la opción para que no se vea repetitivo con el título, según solicitó telcel.

            activateCombobox('#ayudaSearch');
            $url = pathToCategory + "/" + marcaCombo + '/' + modeloCombo;
            $('#btn-submitSearch').attr('formaction', $url);
            $('.txtService').val($url);
            $('#modeloSearch option:selected').prop("selected",true);
        });

        $("#btn-submitSearch").click(function() { getVideoTutorials(); });

        $("#form-search-terminalSearch").on("submit", function(evt) { return false; });

        $('#marcaSearch option').eq(0).attr("disabled","disabled");
        $('#modeloSearch option').eq(0).attr("disabled","disabled");
        $('#ayudaSearch option').eq(0).attr("disabled","disabled");

    });
});

function getVideoTutorials() {
    var service = "/bin/telcelcom/device/vtg.json?path=" + $("#txtService").val();
    var tipoAyuda = $("#ayudaSearch").val();
    //console.log("video service:" + service);
    $("#form-search-terminalSearch").spin('largeSpin');
    $.ajax({
        url: service,
        type: 'GET',
        success: function(data, status){
            if(status == "success") {

                if(tipoAyuda == "3") {

                    if (data.videos != null && data.videos.length > 0) {
                        listVideos(1, data.videos);
                        $("#videosSection").show("fast");
                    }
                    else{
                        $("#videosSection").hide("fast");
                    }

                    if (data.tutoriales != null && data.tutoriales.length > 0) {
                        listVideos(2, data.tutoriales);
                        $("#tutorialsSection").show("fast");
                    }
                    else{
                        $("#tutorialsSection").hide("fast");
                    }

                }
                else if(tipoAyuda == "1") {
                    if (data.videos != null && data.videos.length > 0) {
                        listVideos(1, data.videos);
                        $("#videosSection").show("fast");
                    }
                    else{
                        $("#videosSection").hide("fast");
                    }
                    $("#tutorialsSection").hide("fast");
                }
                else if(tipoAyuda == "2") {
                    if (data.tutoriales != null && data.tutoriales.length > 0) {
                        listVideos(2, data.tutoriales);
                        $("#tutorialsSection").show("fast");
                    }
                    else{
                        $("#tutorialsSection").hide("fast");
                    }
                    $("#videosSection").hide("fast");
                }
                $(".js-showPanelInGrid").showPanelInGrid();
            }
            else {
                console.log("Error loading devices, response status: " + status);
            }
            $("#form-search-terminalSearch").spin(false).stop();
        },
        error: function(data, status, error){
            console.log("An AJAX error occured: " + status + "\nError: " + error);
            $("#form-search-terminalSearch").spin(false).stop();
        }
    });
}

function listVideos(tipo, videosList) {

    var globalVideoUrl = $("#txtGlobalVideoUrl").val();
    var videoUrl = "";
    var videoHtml = "";
    var parentId = "";
    var pathButtonGuide = "";

    if (tipo == 1) {
        parentId = "#videosList";
    }
    else {
        parentId = "#tutorialsList";
    }

    $.each(videosList, function(index, item) {
        if (tipo == 2) { pathButtonGuide = item.pathButtonGuide; } else { pathButtonGuide = ""; }
        videoUrl = globalVideoUrl + item.videoId;
        videoHtml = videoHtml + getVideoHtml(item.videoId, item.title, item.imgPath, videoUrl, item.subtitle, item.description, pathButtonGuide);
    });

    videoHtml = "<ul class='row thumbnails list-unstyled js-showPanelInGrid' style='position:relative;'>" + videoHtml + "</ul>";
    $(parentId).html(videoHtml);
}

function getVideoHtml(idVideo, titulo, imgPath, videoUrl, subtitulo, descripcion, pathButtonGuide) {

    var descriptionButtonGuide = $("#descriptionButtonGuide").val();
    var textButtonGuide = $("#textButtonGuide").val();

    var videoHtml = "<li class=\"col-xxs-12 col-xs-4 col-md-3\" id=\"" + idVideo + "\" >";
    videoHtml = videoHtml + "<button class='open button-unstyled' >";
    videoHtml = videoHtml + "    <h3>" + titulo + "</h3>";
    videoHtml = videoHtml + "   <div class='thumbnail'>";
    videoHtml = videoHtml + "       <img src='" + imgPath + "' alt='Ayuda 1'>";
    videoHtml = videoHtml + "   </div>";
    videoHtml = videoHtml + "</button>";
    videoHtml = videoHtml + "<div class='expanded' id='expanded" + idVideo + "'>";
    videoHtml = videoHtml + "   <div class=\"arrow\" style=\"left: 95px;\"></div>";
    videoHtml = videoHtml + "   <div class=\"row\">";
    videoHtml = videoHtml + "       <div class=\"col-xs-12\">";
    videoHtml = videoHtml + "           <div class=\"inner\">";
    videoHtml = videoHtml + "               <button class=\"close\"><i class=\"icon-Close\"></i></button>";
    videoHtml = videoHtml + "               <div class=\"row\">";
    videoHtml = videoHtml + "                   <div class=\"col-sm-6\">";
    videoHtml = videoHtml + "                       <div class=\"embed-container\">";
    videoHtml = videoHtml + "                           <iframe src=\""+ videoUrl + "\" frameborder=\"0\" webkitallowfullscreen='' mozallowfullscreen='' allowfullscreen='' idvideo='" + idVideo + "' frmVideo></iframe>";
    videoHtml = videoHtml + "                       </div>";
    videoHtml = videoHtml + "                   </div>";
    videoHtml = videoHtml + "                   <div class=\"col-sm-5\">";
    videoHtml = videoHtml + "                       <h3>" + titulo + "<small>" + subtitulo + "</small></h3>";
    videoHtml = videoHtml + "                       <p class='xk-description'>" + descripcion + "</p>";

    if (pathButtonGuide != "") {
        videoHtml = videoHtml + "                       <p>" + descriptionButtonGuide + "</p>";
        videoHtml = videoHtml + "                       <a href='" + pathButtonGuide + "' target='_blank' class='btn btn-md btn-primary'>" + textButtonGuide + "</a>";
    }

    videoHtml = videoHtml + "                   </div>";
    videoHtml = videoHtml + "               </div>";
    videoHtml = videoHtml + "           </div>";
    videoHtml = videoHtml + "       </div>";
    videoHtml = videoHtml + "   </div>";
    videoHtml = videoHtml + "</div>";
    videoHtml = videoHtml + "</li>";

    return videoHtml;
}

function activateCombobox(id) {
    $(id).removeAttr("disabled");
    $(id + ' option').trigger('chosen:updated');
}

function resetCombobox(id) {
    $(id).attr("disabled","disabled"); //disable de combobox
    $(id + ' option').eq(0).attr("selected","selected"); // select the default value
    $(id  + ' option').trigger('chosen:updated'); //update for jquery plugin functionallity
}

angular.module("telcelApp")
.controller("UltimasNoticias", ['$scope','$http', '$attrs', function($scope, $http, $attrs) {



       
            $scope.currentPage = 0;
            $scope.rango = [];
            $scope.valor_inicial = 0;
            $scope.valor_final = 0;

            $scope.avanzar = function(pagesNumber){
                    if ($scope.currentPage < pagesNumber ) {

                        $scope.currentPage=$scope.currentPage + 1;

                        if( $scope.valor_final <= pagesNumber ){
                           $scope.valor_inicial++;
                           $scope.valor_final++;
                        }

                    }

                }

                $scope.retroceder = function(){
                    if ($scope.currentPage > 0 && $scope.valor_inicial > 0 ) {
                        $scope.currentPage=$scope.currentPage - 1;

                        if( $scope.valor_inicial != 1 ){
                            $scope.valor_inicial --;
                            $scope.valor_final --;
                        }

                    }

                }

                $scope.ir = function(pagina){
                    $scope.currentPage=pagina;
                }

            $scope.cargar_ajax = function(buscar){

                $(".noticias-ajax").css({'opacity': '1','height':'auto'});
                var monthValue = $(".buscadorDeNoticias #month").val();
                var yearValue = $(".buscadorDeNoticias #year").val();
                $scope.month = monthValue;
                $scope.year = yearValue;
                $http.get($attrs.path + '.results.json?'+'keyword='+$scope.key +'&month='+$scope.month +'&year='+ $scope.year)
                .success (function(data){
                    $scope.busqueda_realizada = data.newsResultsTitle;
                    $scope.hemos_encontrado = data.newsResultsSubtitle1;
                    $scope.articulos_interesarte = data.newsResultsSubtitle2;

                    $scope.pageSize = 5;
                    $scope.currentPage = 0;
                    $scope.urlText = data.newsLink;
                    $scope.total = data.total;
                    $scope.url = data.url;
                    $scope.date = data.date;    
                    $scope.noticias = data.results;


                    $scope.numeroPaginas = function() {
                                    return Math.ceil($scope.noticias.length/$scope.pageSize);
                                };

                    $scope.valor_inicial = 1;

                    if( $scope.numeroPaginas() > 5 ){
                        $scope.valor_final = 4;
                    }else{
                        $scope.valor_final = $scope.numeroPaginas();
                    }

                    $scope.range = function(min, max, step){
                        step = 1;
                        var input = [];
                        for (var i = min; i <= max; i += step) input.push(i);
                        return input;
                    };

                }).error(function(e, msg){
                    
                });

            };


        }]
);

angular.module("telcelApp").filter('startFrom', function() {
    return function(input, start) {
        start = +start; //parse to int
        return input.slice(start);
    }
});


$(function(){
 var compileAngular = function($element){
     if ($element.length) {
         var $injector = angular.injector(['ng', 'telcelApp']);
         $injector.invoke(['$rootScope','$compile',function ($rootScope, $compile) {
             $compile($element[0])($rootScope);
         }]);
     }
 };

    //Apply angular compile
    $('body').on('news.search','.xk-buscadorDeNoticias', function (e) {
        compileAngular($(e.target));
    });
});

//console.log("entro a js - roamingrates");


$(document).on('section.roamingratesonly', '.xk-roamingratesonly', function(e, postParameters, comesFrom) {

    //console.log('section.roamingratesonly triggered, comesFrom:' + comesFrom);

    //Provides the comboboxes data of the RoamingSearch component.
    $(this).attr('data-postparameters', postParameters);

    //If the page has been loaded normally it just calls the getRates() function
    if (comesFrom == 'page') {

        angular.element($(this)).scope().getData();

    //If the page has been loaded by ajax it recompiles the angular code and then it calls the getRates() function
    } else if (comesFrom == 'ajax') {

        //recompile the angular
        var $injector = angular.injector(['ng', 'telcelApp']);
        $injector.invoke(['$rootScope','$compile',function ($rootScope, $compile, $scope) {
            $compile($(e.target)[0])($rootScope);
        }]);

        //call getData() function
        angular.element($(this)).scope().getData();

    } else {

        angular.element($(this)).scope().getData();

    }
});

angular.module("telcelApp")
    .controller("RoamingRatesOnlyController", ['$window','$scope', '$http', '$attrs','$rootScope', '$compile', '$sce', 'roamingPackagesService',
        function($window, $scope, $http, $attrs,  $rootScope, $compile, $sce, roamingPackagesService) {

            $scope.resultdata = [];
            $scope.correlativoServicio  = 1;
            $scope.correlativoCobertura = 1;
            $scope.correlativoLegales   = 1;

            $scope.getData = function() {	


                var objrates = $('.xk-roamingratesonly');
            	var modalidad = $('.xk-roamingsearch .xk-modes').val();
                var postParameters = objrates.attr('data-postparameters');

                if (postParameters == null || postParameters == "" || postParameters=="undefined") {
                    postParameters = $('.xk-roamingsearch #txtPostParameters').val();
                }

             	$scope.mode = objrates.attr('data-mode');

                var serviceUrl = "/bin/telcelcom/roaming/rates" +
                    			 ".mode=" + modalidad +
                    			 ".param=" + postParameters +
                                 ".go.json?bustcache=true";

                objrates.spin('largeSpin');
                if (postParameters != "" && modalidad != null) {

                    //console.log("roaming rates only url:" + serviceUrl + ", mode:" + modalidad);

                    $http.get(serviceUrl)
                        .success(function(data, status, headers, config) {
                            $scope.resultdata = data;
                            //console.log(data);
                            objrates.spin(false).stop();
                        })
                        .error(function(e, msg){
                            objrates.spin(false).stop();
                            //console.log("rates only error:" + msg);
                        });
                }
            };

            /*
            *
            *   Process the concepts list, getting the image, color and leyend values when the package is
            *   recommended, and removing them from the concepts list.
            *
            */

            $scope.getValidConcepts = function (conceptos, recomendado) {

                return roamingPackagesService.processConcepts(conceptos, recomendado);

            };

            $scope.getCorrelativoServicio = function () {

                return $scope.correlativoServicio++;

            };

            $scope.getCorrelativoCobertura = function () {

                return $scope.correlativoCobertura++;

            };

            $scope.getCorrelativoLegales = function () {

                return $scope.correlativoLegales++;

            };

        }
    ]);




angular.module("telcelApp").controller("queryMailBoxCtrl", ['$scope', '$http', '$sce',
    function($scope, $http, $sce) {

        var shortDial = [], autoDial = [];
        var short_header, short_descripcion, legal, isArray;

        $http.get("/bin/telcelcom/roaming/mailbox/instructions.json").success(function(response) {

            var data = response;
            
            if (data.success == 'true') {

                for (var index in data) {

                    if (index == 'islegal') {
                        $scope.legal = data.islegal[index];

                    } else if (index == 'short_dial') {
                        $scope.shortDial = data[index];

                        isArray = is_array($scope.shortDial);
                        if (!isArray) continue;

                        for (var element_s in $scope.shortDial) {
                            $scope.short_header = $scope.shortDial[element_s].header;
                            $scope.short_descripcion = $scope.shortDial[element_s].descripcion;
                            break;
                        }
                    } else if (index == 'auto_dial') {
                        $scope.autoDial = data[index];

                        isArray = is_array($scope.autoDial);
                        if (!isArray) continue;

                        for (var element_a in $scope.autoDial) {
                            $scope.auto_header = $scope.autoDial[element_a].header;
                            $scope.auto_descripcion = $scope.autoDial[element_a].descripcion;
                            break;
                        }
                    }
                }
            }
        })
        .error(function (err) {
            console.log("An error has ocurred!" + err)
        });
    }
]).filter('unsafe', function($sce) {
    return function(htmlVal) {
        return $sce.trustAsHtml(htmlVal);
    };
});

$(function(){
 var compileMailBoxAngular = function($element){
     if ($element.length) {
         var $injector = angular.injector(['ng', 'telcelApp']);
         $injector.invoke(['$rootScope','$compile',function ($rootScope, $compile) {
             $compile($element[0])($rootScope);
         }]);
     }
 };

    //Apply angular compile
    $('body').on('query.mailbox','.xk-js-mailbox', function (e) {
        compileMailBoxAngular($(e.target));
    });
});

var is_array = function (value) {
    return Object.prototype.toString.apply(value) === '[object Array]';
};
//console.log("roamingSearch.js loaded");
/*
 * Trigger the 'section.roamingsearch' event when the page has been loaded.
 */
$(document).ready(function(){
    $('.xk-roamingsearch').trigger('section.roamingsearch', ['page']);
});


/*
 * Add the 'section.roamingsearch' event to the '.xk-roamingsearch' section
 * and initialize component's data.
 */
$(document).on('section.roamingsearch', '.xk-roamingsearch', function(e, comesFrom) {

    //console.log("section.roamingsearch triggered. comesFrom " + comesFrom);

    //var modesServiceUrl = "/bin/telcelcom/roaming/roamingsearch.modalidades.go.json";
    //var brandsServiceUrl = "/bin/telcelcom/roaming/roamingsearch.marcas.go.json";
    //var coverageServiceUrl = "/bin/telcelcom/roaming/roamingsearch.tipos-cobertura.go.json";
    var inidataServiceUrl = "/bin/telcelcom/roaming/roamingsearch.inidata.go.json";

    //Initialize comboboxes
    var objModes = $('.xk-roamingsearch .xk-modes');
    var objBrands = $('.xk-roamingsearch .xk-brands');
    var objCoverage = $('.xk-roamingsearch .xk-coverage');

    $.getJSON(inidataServiceUrl, function (response) {
        if (response != null) {
            //console.log(response);
            //objModes.find('option:not(:eq(0))').remove();
            objBrands.find('option:not(:eq(0))').remove();
            objCoverage.find('option:not(:eq(0))').remove();

            //selectTypeRoamingSearch(response.modalidades, objModes, 1);
            selectTypeRoamingSearch(response.marcas, objBrands, 2);
            selectTypeRoamingSearch(response.tiposcobertura, objCoverage, 3);

            changeComboStateRoamingSearch(objModes, "enabled");
            changeComboStateRoamingSearch(objBrands, "enabled");
            changeComboStateRoamingSearch(objCoverage, "enabled");

            objModes.trigger('chosen:updated');
            objBrands.trigger('chosen:updated');
            objCoverage.trigger('chosen:updated');
        }
    });

    //fillComboRoamingSearch(modesServiceUrl, objModes, 1, "");
    //fillComboRoamingSearch(brandsServiceUrl, objBrands, 2, "");
    //fillComboRoamingSearch(coverageServiceUrl, objCoverage, 3, "");

    $(this).attr('data-comesFrom', comesFrom);
});

/*
 * Add the 'init.combos' event to the '.xk-trip-row' object to fill its comoboxes.
 */
$(document).on('init.combos', '.xk-trip-row', function(){
    var coverageServiceUrl = "/bin/telcelcom/roaming/roamingsearch.tipos-cobertura.go.json";
    var objCoverage = $(this).find('.form-group').find('.xk-coverage');
    var objCountry = $(this).find('.form-group').find('.xk-country');
    var objCity = $(this).find('.form-group').find('.xk-city');

    fillComboRoamingSearch(coverageServiceUrl, objCoverage, 3, "");
    resetComboRoamingSearch(objCountry, "disabled");
    resetComboRoamingSearch(objCity, "disabled");
});

/*
* Add 'brands' combobox functionallity
 */
$(document).on('change', '.xk-roamingsearch .xk-brands', function() {

    var objModels = $('.xk-roamingsearch .xk-models');

    if ($(this).val() != "") {
        var modelsServiceUrl = "/bin/telcelcom/roaming/roamingsearch.marcas=" + $(this).val() + ".equipos.go.json";
        fillComboRoamingSearch(modelsServiceUrl, objModels, 4, "enabled");
    }
});

/*
 * Add 'coverage' combobox functionallity
 */
$(document).on('change', '.xk-roamingsearch .xk-coverage', function(){
    var value = $(this).val();
    var serviceUrl = null;
    var countryHelp = null;
    var cityHelp = null;
    var comboType = 7;

    var objCountry = $(this).parent('.form-group')
        .parent('.xk-trip-row')
        .eq(0)
        .find('.form-group')
        .find('.xk-country')
        .eq(0);

    var objCity = $(this).parent('.form-group')
        .parent('.xk-trip-row')
        .eq(0)
        .find('.form-group')
        .find('.xk-city')
        .eq(0);


    var objfirstcountry = $('.xk-roamingsearch .xk-country-' + value);

    //if it is the first combo to load then use ajax

        var getfirstcombo = true;
        switch(value) {
            case '1': //Aérea
                countryHelp = $('.xk-roamingsearch').data('airlinehelp');
                cityHelp = $('.xk-roamingsearch').data('cityhelp');
                serviceUrl = "/bin/telcelcom/roaming/roamingsearch.lineas-aereas.go.json";

                if (objfirstcountry.length == 0 || objfirstcountry.find('option').length == 1) {
                    fillComboRoamingSearch(serviceUrl, objCountry, 7, "enabled");
                    getfirstcombo = false;
                }

                objCity.parent().hide('fast');
                break;
            case '2': //Marítimo
                countryHelp = $('.xk-roamingsearch').data('shippinghelp');
                cityHelp = $('.xk-roamingsearch').data('cruisehelp');
                serviceUrl = "/bin/telcelcom/roaming/roamingsearch.lineas-navieras.go.json";

                if (objfirstcountry.length == 0 || objfirstcountry.find('option').length == 1) {
                    fillComboRoamingSearch(serviceUrl, objCountry, 7, "enabled");
                    getfirstcombo = false;
                }

                objCity.parent().show('fast');
                break;
            case '3': //Terrestre
                countryHelp = $('.xk-roamingsearch').data('countryhelp');
                cityHelp = $('.xk-roamingsearch').data('cityhelp');
                serviceUrl = "/bin/telcelcom/roaming/roamingsearch.paises.go.json";

                if (objfirstcountry.length == 0 || objfirstcountry.find('option').length == 1) {
                    fillComboRoamingSearch(serviceUrl, objCountry, 5, "enabled");
                    getfirstcombo = false;
                }

                objCity.parent().hide('fast');
                break;
        }


    //use the options of the first country combo loaded
        if (getfirstcombo == true) {
            //console.log("get from first");
            objCountry.find('option').remove();

            objfirstcountry.eq(0).find('option').each(function() {
                objCountry.append('<option value="' + $(this).val() +  '">' + $(this).text() + '</option>');
            });

            objCountry.find('option:first').attr("disabled", "disabled");
            objCountry.find('option:first').attr("selected", "");
            objCountry.removeAttr("disabled");
            objCountry.trigger('chosen:updated');
        } // else { console.log("get from ajax"); }


    objCountry.removeClass("xk-country-1");
    objCountry.removeClass("xk-country-2");
    objCountry.removeClass("xk-country-3");
    objCountry.addClass("xk-country-" + value);

    $(this).removeClass("xk-coveragetype-1");
    $(this).removeClass("xk-coveragetype-2");
    $(this).removeClass("xk-coveragetype-3");
    $(this).addClass("xk-coveragetype-" + value);

    resetComboRoamingSearch(objCity, "disabled");

    objCountry.find('option').eq(0).text(countryHelp);
    objCountry.find('option').eq(0).attr('selected');
    objCountry.trigger('chosen:updated');


    objCity.find('option').eq(0).text(cityHelp);
    objCity.find('option').eq(0).attr('selected');
    objCity.trigger('chosen:updated');

});

/*
 * Add 'country' combobox functionallity
 */
$(document).on('change', '.xk-roamingsearch .xk-country', function(){
    var value = $(this).val();
    var citiesServiceUrl = "/bin/telcelcom/roaming/roamingsearch.paises=" + value +".ciudades.go.json";
    var naviesServiceUrl = "/bin/telcelcom/roaming/roamingsearch.lineas=" + value +".cruceros.go.json";

    var parentRow =  $(this).parent('.form-group')
                    .parent('.xk-trip-row')
                    .eq(0);

    var objCoverage = parentRow.find('.form-group')
                        .find('.xk-coverage')
                        .eq(0);

    var objCity = parentRow.find('.form-group')
                    .find('.xk-city')
                    .eq(0);

    if (objCoverage != null) {

        //Marititmo
        if (objCoverage.val() == '2') {
            fillComboRoamingSearch(naviesServiceUrl, objCity, 6, "enabled");
            objCity.parent().show('fast');
        }
        //Terrestre
        else if (objCoverage.val() == '3') {

            //Country = Estados Unidos
            if ($(this).val() == "180") {
                objCity.parent().show('fast');
                fillComboRoamingSearch(citiesServiceUrl, objCity, 6, "enabled");
            } else {
                objCity.parent().hide('fast');
                resetComboRoamingSearch(objCity, "disabled");
            }
        } else if (objCoverage.val() == '1') {
            objCity.parent().hide('fast');
        }
    }
});

/*
 * Add search button functionallity
 */
$(document).on('click', '.xk-roamingsearch .xk-roamingSearchBtn', function(e){

        //validates comboboxes data
        var objerror = $('.xk-roamingsearch #mensaje-error-modalidad-viaje');
        if (validateFormDataRoamingSearch() == false) {
            objerror.hide();
            objerror.show();
            return false;
        } else {
            objerror.hide();
        }


        var aereosList = [];
        var maritimosList = [];
        var paisesList = [];

        var paises = "[";
        var maritimos = "[";
        var aereos = "[";

        var objmode = $('.xk-roamingsearch .xk-modes');
        var objdevice = $('.xk-roamingsearch .xk-models');
        var objcoverage = $('.xk-roamingsearch .xk-coverage');

        objcoverage.each(function(){

            var coveragevalue = $(this).find('option:selected').val();

            if (coveragevalue != "0") {

                var objCountry = $(this).parent('.form-group')
                    .parent('.xk-trip-row')
                    .eq(0)
                    .find('.form-group')
                    .find('.xk-country')
                    .eq(0);

                var objCity = $(this).parent('.form-group')
                    .parent('.xk-trip-row')
                    .eq(0)
                    .find('.form-group')
                    .find('.xk-city')
                    .eq(0);

                var countryoption = objCountry.find('option:selected');
                var cityoption = objCity.find('option:selected');

                switch(coveragevalue) {
                    case '1': //Aereo

                        if (countryoption.val() != "0") {
                            aereosList.push(countryoption.text());
                            aereos = aereos + "\"" + countryoption.text() + "\"" + ",";
                        }
                        break;

                    case '2': //Maritimo

                        if (cityoption.val() != "0") {
                            maritimosList.push(cityoption.text());
                            maritimos = maritimos + "\"" + cityoption.text() + "\"" + ",";
                        }
                        break;

                    case '3': //Terrestre

                        if (countryoption.val() != "0") {
                            paisesList.push(countryoption.text());
                            paises = paises + "\"" + countryoption.text() + "\"" + ",";
                        }
                        break;
                }
            }
        });

        paises = paises + "]";
        maritimos = maritimos + "]";
        aereos = aereos + "]";

        paises = paises.replace(",]", "]");
        maritimos = maritimos.replace(",]", "]");
        aereos = aereos.replace(",]", "]");

        //Get data for trigger the components that are into de tabs..
        var postParameters = "{\"paises\":" + paises + ",\"maritimos\":"+ maritimos + ",\"aereos\":"+ aereos +  "}";
        var comesFrom = $('.xk-roamingsearch').eq(0).attr('data-comesfrom');
        $('.xk-roamingsearch #txtPostParameters').val(postParameters);

        var modeval = objmode.val();
        var coverageval = objcoverage.val();
        var deviceval = objdevice.val();

        //validates if it is the first search
        //console.log("firstsearch:" + $(this).attr('data-firstsearch'));
        switch($(this).attr('data-firstsearch')) {
            case '0':
                comesFrom = comesFrom + "-firstsearch";
                break;
            case '1':
                $(this).attr('data-firstsearch', '0');
                break;
        }
                 
        //show tabs...
        var target = $('.xk-roamingsearch .search-form-target');
        target.show('fast');

        //show loader
        $(target).animate({'opacity': '.5'}, function() {
            loader = $('<div/>', {
                'class': 'spinner-holder clear'
            }).css({'position': 'absolute', 'bottom': '50%', 'right': '50%'}).appendTo(target).spin('defaultSpin');

            //Call triggers of components that are into the tabs..
            $('.xk-roamingratesonly').trigger('section.roamingratesonly', [postParameters, comesFrom]);
            $('.xk-howtodialsuperior').trigger('section.howtodialsuperior', [postParameters, comesFrom, 'RS']);
            $('.xk-roamingpackages').trigger('section.roamingpackages', [postParameters, comesFrom, modeval, deviceval]);
            $('.xk-roamingcoverage').trigger('section.roamingcoverage', [postParameters, comesFrom, objmode, deviceval]);

            //hide loader
            $(target).delay('800').css({'opacity': '1','height':'auto'});
            $(target).find('.spinner-holder').spin(false);
        });

    return false;
});

/*
* Fill comboboxes getting the data from a service
 */
function fillComboRoamingSearch(serviceUrl, obj, type, state) {
    try {

        if (obj != null && serviceUrl != "") {

            $.getJSON(serviceUrl, function (response) {
                if (response.success == "true") {

                    obj.find('option:not(:eq(0))').remove();

                    selectTypeRoamingSearch(response, obj, type);

                    changeComboStateRoamingSearch(obj, state, type);
                    obj.trigger('chosen:updated');
                }
            });
        }

    } catch (e) {

    }
}

function selectTypeRoamingSearch(response, obj, type) {
    if (response != null && response.data != null) {

        switch(type) {
            case 1: //Modes
                $.each(response.data, function (key, val) {
                    obj.append('<option value="' + key + '">' + val + '</option>');
                });
                break;
            case 2: // Brands
                $.each(response.data, function (key, val) {
                    obj.append('<option value="' + val + '">' + val + '</option>');
                });
                break;
            case 3: //Coverage type
                $.each(response.data, function (key, val) {
                    obj.append('<option value="' + key + '">' + val + '</option>');
                });
                break;
            case 4: //Models
                $.each(response.data, function (key, val) {
                    obj.append('<option value="' + val.id + '">' + val.nombre + '</option>');
                });
                break;
            case 5: //Countries
                $.each(response.data, function (key, val) {
                    obj.append('<option value="' + val.idpais + '">' + val.nombreespanol + '</option>');
                });
                break;
            case 6: //Cities
                $.each(response.data, function (key, val) {
                    obj.append('<option value="' + key + '">' + val + '</option>');
                });
                break;
            case 7: // Air lines and navy lines
                $.each(response.data, function (key, val) {
                    obj.append('<option value="' + key + '">' + val + '</option>');
                });
                break;
            default:
                console.log("Unknown type");
                break;
        }
    }
}

/*
* Reset combo to its initial state
 */
function resetComboRoamingSearch(target, state) {
    if (target != null) {
        var firstOption = target.find('option').eq(0);

        firstOption.attr("disabled");
        firstOption.attr("selected");
        target.find('option:not(:eq(0))').remove();

        changeComboStateRoamingSearch(target, state);
        target.trigger('chosen:updated');
    }
}

/*
* Enables or disables the target combobox
 */
function changeComboStateRoamingSearch(target, state) {
    if (target != null && state != "") {
        if (state == "enabled") {
            target.removeAttr("disabled");
        }
        else if (state == "disabled") {
            target.attr(state, state);
        }
    }
}

function validateFormDataRoamingSearch() {

    //comboboxes to validate
    var objmodes    = $('.xk-roamingsearch .xk-modes');
    var objmodels   = $('.xk-roamingsearch .xk-models');
    var objcoverage  = $('.xk-roamingsearch .xk-coverage');
    var objcountry  = $('.xk-roamingsearch .xk-country');
    var objcity     = $('.xk-roamingsearch .xk-city');

    //Validate modes combobox
    if (objmodes.val() == null || objmodes.val() == "0") {
        return false;
    }

    //Validate devices combobox
    if (objmodels.val() == null || objmodels.val() == "0") {
        return false;
    }

    //Validates that there is at least one 'terrestre' combobox
    /*if ($('.xk-roamingsearch .xk-coveragetype-3').length == 0) {
        return false;
    }*/

    //Validate countries combobox
    if (objcountry.val() == null || objcountry.val() == "0") {

        return false;

    //Validate cities combobox
    } else {

        //Validate city combobox depending of the coverage
        var coverage = objcoverage.val();

        switch(coverage) {

            case '2': //Maritimo. Debe seleccionar un crucero

                if (objcity.val() == null || objcity.val() == "0") { return false; }

                break;

            /*case '3'://Terrestre. Si es Estados Unidos debe validar ciudad.

                if (objcountry.val() == "180") {
                    if (objcity.val() == null || objcity.val() == "0") { return false; }
                }

                break;*/
        }
    }

    return true;
}
//console.log("roamingRates.js loaded");

$(document).ready(function(){

    /*
    *   - Trigger the 'section.roamingrates' event when the page is loaded.
    *
    *   - This event calls to the getData() angular function.
    *
    *   - This event is triggered just for all components founded in the page (there is a component for each tab of the page).
    *
    *   - Each component makes its own get with its own configuration by using the getData() function.
    */
    $('.xk-roamingratesandpackages').trigger('section.roamingrates', ['', 'page']);

});

/*
 * Add the 'section.roamingrates' event to the '.xk-roamingratesandpackages' section
 *
 * This event will call the getData() function that is declared in the controller.
 *
 * If the page has been loaded by ajax it will recompile the angular code first
 * and then it will call the getData() function.
 *
 * If the page has been loaded normally, it will just call the getData() function.
 */
$(document).on('section.roamingrates', '.xk-roamingratesandpackages', function(e, postParameters, comesFrom) {

    //console.log('section.roamingrates triggered comesFrom:' + comesFrom);

    //Get modal url
    var objmodal = $(this).find('.xk-roamingmodal');
    var urlmodal = "";
    if (objmodal != null) {
        urlmodal = objmodal.attr('data-modalurl');
        if (urlmodal != null && urlmodal != '' && urlmodal != 'undefined') {
            urlmodal = urlmodal + '.html';
        }
    }

    //Provides the comboboxes data of the RoamingSearch component.
    $(this).attr('data-postparameters', postParameters);

    //gets the configuration of the component
    var confmode = $(this).attr('data-mode');
    var conftype = $(this).attr('data-infotype');

    //If the page has been loaded normally it just calls the getRates() function
    if (comesFrom == 'page') {

        angular.element($(this)).scope().getData(confmode, conftype, urlmodal);

    //If the page has been loaded by ajax it recompiles the angular code and then it calls the getRates() function
    } else if (comesFrom == 'ajax') {

        //recompile the angular
        var $injector = angular.injector(['ng', 'telcelApp']);
        $injector.invoke(['$rootScope','$compile',function ($rootScope, $compile, $scope) {
            $compile($(e.target)[0])($rootScope);
        }]);

        //call getData() function
        angular.element($(this)).scope().getData(confmode, conftype, urlmodal);

    } else {

        angular.element($(this)).scope().getData(confmode, conftype, urlmodal);

    }
});

angular.module("telcelApp")
    .controller("RoamingRatesPackController", ['$window','$scope', '$http', '$attrs','$rootScope', '$compile', '$sce', 'roamingPackagesService',
        function($window, $scope, $http, $attrs,  $rootScope, $compile, $sce, roamingPackagesService) {


            $scope.resultdata = [];
            $scope.correlativoServicio  = 1;
            $scope.correlativoCobertura = 1;
            $scope.correlativoLegales   = 1;

            /*
            * Function that contains the main functionallity to get data from the service
            */
            $scope.getData = function(confmode, conftype, urlmodal) {

                /*

                //Descomentar este bloque para utilizar una sola llamada para todos los componentes.

                //Get the ratesandpackages components that hasn't been processed yet
                var objrates = $(".xk-roamingratesandpackages[data-processed='0']");
                var configs = "";

                objrates.each( function () {

                    var infotype = $(this).attr('data-infotype');
                    var mode = $(this).attr('data-mode');
                    configs = configs + '{"mode":"' + mode + '","infotype":"' + infotype + '"},';

                });

                configs = "[" + configs + "]";
                configs = configs.replace(",]", "]");
                //var postParameters = objrates.attr('data-postparameters');
                //console.log("length:" + objrates.length);

                 if (objrates.length > 0 && configs != "[]") {

                     var serviceUrl = "/bin/telcelcom/roaming/roamingratespackages" +
                     ".paquetes" +
                     ".configuraciones=" + configs +
                     ".go.json";

                */
                $scope.urlmodal = urlmodal;

                if (confmode != "" && conftype != "" && confmode != "undefined" && conftype != "undefined") {

                    var serviceUrl = "/bin/telcelcom/roaming/roamingratespackages" +
                        ".paquetes" +
                        ".modalidad=" + confmode +
                        ".tipo=" + conftype +
                        ".go.json?bustcache=true";

                    //console.log("roaming rates packages url:" + serviceUrl);
                    var objrates = $(".xk-roamingratesandpackages");
                    objrates.spin('xlargeSpin');

                    $http.get(serviceUrl)
                        .success(function(data, status, headers, config) {
                            $scope.resultdata = data;
                            objrates.spin(false).stop();
                            $('.xk-roamingratesandpackages .xk-show-after-load').show();
                            //objrates.each(function(){ $(this).attr('data-processed', '1'); });
                        })
                        .error(function(e, msg){
                            objrates.spin(false).stop();
                            //console.log("rates request error:" + msg);
                        });
                }

            }; //end getData() function


            /*
            *
            *   Process the concepts list, getting the image, color and leyend values when the package is
            *   recommended, and removing them from the concepts list.
            *
            */

            $scope.getValidConcepts = function (conceptos, recomendado) {

                return roamingPackagesService.processConcepts(conceptos, recomendado);

            };

            $scope.getCorrelativoServicio = function () {

                return $scope.correlativoServicio++;
                
            };

            $scope.getCorrelativoCobertura = function () {

                return $scope.correlativoCobertura++;

            };

            $scope.getCorrelativoLegales = function () {

                return $scope.correlativoLegales++;

            };

        }
    ]);

$(document).on('click', '.xk-termsopen-btn', function() {
   $(this).parent().find('.xk-termsopen-content').toggle();
});
$(document).on('section.roamingpackages', '.xk-roamingpackages', function(e, postParameters, comesFrom , mode , device) {

    //console.log('section.roamingratesonly triggered, comesFrom:' + comesFrom);

    //Provides the comboboxes data of the RoamingSearch component.
    $(this).attr('data-postparameters', postParameters);

    //If the page has been loaded normally it just calls the getRates() function
    if (comesFrom == 'page') {

        angular.element($(this)).scope().getData(mode, device, postParameters);

    //If the page has been loaded by ajax it recompiles the angular code and then it calls the getRates() function
    } else if (comesFrom == 'ajax') {

        //recompile the angular
        var $injector = angular.injector(['ng', 'telcelApp']);
        $injector.invoke(['$rootScope','$compile',function ($rootScope, $compile, $scope) {
            $compile($(e.target)[0])($rootScope);
        }]);

        //call getData() function
        angular.element($(this)).scope().getData(mode, device, postParameters);

    } else {

        angular.element($(this)).scope().getData(mode, device, postParameters);

    }
});
angular.module("telcelApp").controller("RoamingPackagesDisplay", ['$scope', '$http', '$sce', '$attrs', 'roamingPackagesService',

    function($scope, $http, $sce, $attrs, roamingPackagesService) {
        $scope.urlmodal = "";


        $scope.getData = function(mode, device, postparams){
            /*var mode = $attrs.mode;
            var device = $attrs.device;
            var postparams = $attrs.postparameters;*/
            //modal
            var objmodal = $('#xk-roaming-packages').find('.xk-roamingmodal');
                var urlmodal = "";
                if (objmodal != null) {
                    urlmodal = objmodal.attr('data-modalurl');
                    if (urlmodal != null && urlmodal != '' && urlmodal != 'undefined') {
                        $scope.urlmodal = urlmodal + '.html';
                    }
                }

            $http.post("/bin/telcelcom/roaming/roamingpackages."+ mode  + "."+ device+".mx.json?params=" + postparams )
                .success(function(response) {
                    $scope.resultdata = response;
             });
         }

         /*
        *
        *   Process the concepts list, getting the image, color and leyend values when the package is
        *   recommended, and removing them from the concepts list.
        *
        */
        $scope.getValidConcepts = function (conceptos, recomendado) {
            return roamingPackagesService.processConcepts(conceptos, recomendado);
        };
    }
]);
//console.log("roamingCoverage.js loaded");
/*
 * Trigger the 'section.roamingsearch' event when the page has been loaded.
 */

$(document).on('section.roamingcoverage', '.xk-roamingcoverage', function(e, postParameters, comesFrom, mode, device) {

    //console.log('section.roamingcoverage triggered, comesFrom:' + comesFrom);

    //Provides the comboboxes data of the RoamingSearch component.
    $(this).attr('data-postparameters', postParameters);

    //If the page has been loaded normally it just calls the getData() function
    if (comesFrom == 'page') {

        angular.element($(this)).scope().getData(mode, device, postParameters);

        //If the page has been loaded by ajax it recompiles the angular code and then it calls the getData() function
    } else if (comesFrom == 'ajax') {

        //recompile the angular
        var $injector = angular.injector(['ng', 'telcelApp']);
        $injector.invoke(['$rootScope','$compile',function ($rootScope, $compile, $scope) {
            $compile($(e.target)[0])($rootScope);
        }]);

        //call getData() function
        angular.element($(this)).scope().getData(mode, device, postParameters);

    } else {

        angular.element($(this)).scope().getData(mode, device, postParameters);

    }
});

angular.module("telcelApp")
    .controller("RoamingCoverageController", ['$window','$scope', '$http', '$attrs','$rootScope', '$compile', '$sce',
        function($window, $scope, $http, $attrs,  $rootScope, $compile, $sce) {

            $scope.resultdata = [];
            $scope.mode = "-1";

            $scope.getData = function(modalidad, equipo, postParameters) {

                $scope.resultdata = [];
                $scope.mode = modalidad.val();
                $scope.modetext = modalidad.find('option:selected').text();
                $scope.modeindex = -1;

                if (postParameters == null || postParameters == "" || postParameters=="undefined") {

                    postParameters = $('.xk-roamingsearch #txtPostParameters').val();

                }

                var serviceUrl = "/bin/telcelcom/roaming/roamingcoverage" +
                    ".cobertura=1" + //it is always = 1 (based on jwm's documentation)
                    ".equipo=" + equipo +
                    ".data=" + postParameters +
                    ".modalidad=" + modalidad.val() +
                    ".go.json";

                var objcoverage = $('.xk-roamingcoverage');
                objcoverage.spin('largeSpin');

                if (postParameters != "" && equipo != "" && modalidad.val() != "") {

                    //console.log("roaming coverage url:" + serviceUrl + ", mode:" + modalidad + ", equ:" + equipo);

                    $http.get(serviceUrl)
                        .success(function(data, status, headers, config) {
                            $scope.resultdata = data;
                            //console.log(data);
                            objcoverage.spin(false).stop();

                        })
                        .error(function(e, msg){
                            objcoverage.spin(false).stop();
                            //console.log("roamingcoverage error:" + msg);
                        });
                }
            };

            $scope.getServiceByMode = function(serviceList, mode) {

                if (serviceList != null && serviceList.length > 0) {

                    var i = 0;
                    var result = serviceList[0];

                    while (i < serviceList.length) {

                        var service = serviceList[i];
                        var roaming = service.roamingModalidad;

                        if (roaming != null && roaming.id == mode) {
                            result = service;
                            i = serviceList.length;
                        }

                        i++;
                    }
                }

                return result;
            };

            $scope.validUrl = function(url) {

                if (url != null && url != "" && url != "undefined") {
                    return true;
                }

                return false;
            };

            $scope.hasMaps = function(operatorRow) {

                return $scope.validUrl(operatorRow.mapaUrlGsm) || $scope.validUrl(operatorRow.mapaUrl3g) || $scope.validUrl(operatorRow.mapaUrl4g);

            }

        }
    ]).filter('embedUrl', function ($sce) {
        return function(url) {

            if (url != null && url != "") {

                var temp = url.substring(0, 7);
                if (temp != "http://" && temp != "http//") {
                    url = "http://" + url;
                }

                return $sce.trustAsResourceUrl(url);
            }

            return "";


        };
    }).directive('groupModal', function(){

        return function(scope, element, attrs) {

            //if (attrs.grouplast=="true") {
            //    if (scope.$last) {
            $('.xk-roamingcoverage').trigger('roamingcoverage.carousel', [element]); //execute carousel plugin
            //console.log("last:" + attrs.class + ", i:" + scope.$index + ", count:" + $('.js-gallery-images-cov').length + ",grouplast:" + attrs.grouplast);
            //    }
            //}
            $('.xk-roamingcoverage').spin(false).stop();
        };
    });



$(document).on('roamingcoverage.carousel', '.xk-roamingcoverage', function(e, obj) {

    /*
     *   Código tomado del archivo js/galerias_dinamicas.js de multiplica.
     *
     *   Se cambió el selector de sync1 y sync2 para que
     *   este código se ejecute solamente para el carousel
     *   de este componente y no afecte a los otros carouseles existentes.
     *
     */

    /*
     Galerias de ganadores dinamicas
     */

    //var sync1 = $(".xk-roamingcoverage .js-gallery-images-cov");
    //var sync2 = $(".xk-roamingcoverage .js-gallery-thumbs-cov");

    var sync1 = obj.find(".js-gallery-images-cov");
    var sync2 = obj.find(".js-gallery-thumbs-cov");

    sync2.each( function(index,value){

        $(this).owlCarousel({
            items : 6,
            itemsDesktop : [1199,6],
            itemsDesktopSmall : [979,5],
            itemsTablet : [768,6],
            itemsTablet : [650,5],
            itemsMobile : [479,2],
            pagination:false,
            responsiveRefreshRate : 100,
            afterInit : function(el){
                el.find(".owl-item").eq(0).addClass("synced");
            }
        });
    } );



    sync1.each(function(index,value){

        $(this).owlCarousel({
            singleItem : true,
            slideSpeed : 1000,
            navigation: true,
            pagination:false,
            afterAction : syncPosition,
            responsiveRefreshRate : 200,
            lazyLoad : true,
            navigationText: ['<i class="icon-SliderLeft"></i>', '<i class="icon-SliderRight"></i>']
        });
    });


    sync2.each(function(){

        $(this).on("click", ".owl-item", function(e){
            e.preventDefault();
            var number = $(this).data("owlItem");
            sync1.each(function(){
                $(this).trigger("owl.goTo",number);
            });
        });

    });


    function syncPosition(el){

        var s2 = el.closest('.owl-carousel').next('.js-gallery-thumbs-cov');

        var current = this.currentItem;
        s2
            .find(".owl-item")
            .removeClass("synced")
            .eq(current)
            .addClass("synced")
        if(s2.data("owlCarousel") !== undefined){
            center(current,s2)
        }
    }


    function center(number,s2){
        var sync2visible = s2.data("owlCarousel").owl.visibleItems;
        var num = number;
        var found = false;
        for(var i in sync2visible){
            if(num === sync2visible[i]){
                var found = true;
            }
        }

        if(found===false){
            if(num>sync2visible[sync2visible.length-1]){
                s2.trigger("owl.goTo", num - sync2visible.length+2)
            }else{
                if(num - 1 === -1){
                    num = 0;
                }
                s2.trigger("owl.goTo", num);
            }
        } else if(num === sync2visible[sync2visible.length-1]){
            s2.trigger("owl.goTo", sync2visible[1])
        } else if(num === sync2visible[0]){
            s2.trigger("owl.goTo", num-1)
        }
    }

    /*
     Fin de Galerias de ganadores dinamicas
     */

});

//console.log("roamingSearch.js loaded");
/*
 * Trigger the 'section.roamingsearch' event when the page has been loaded.
 */
$(document).ready(function(){
	
	
	$('.xk-roamingsearchcober').trigger('section.roamingsearchcober', ['page']);
	
    $( "#panel_plan_link" ).click(function() {
    	hideAllPanelsCobertura($("#panel_plan"));
        //Call triggers of components that are into the tabs..
        
        angular.element($(this)).scope().getDataResumen("1", "");
	});
	
    $( "#panel_amigo_link" ).click(function() {
    	hideAllPanelsCobertura($("#panel_amigo"));
        //Call triggers of components that are into the tabs..
        
        angular.element($(this)).scope().getDataResumen("2", "");
	});
	
});

$(document).on('section.roamingsearchcober', '.xk-roamingsearchcober', function(e, comesFrom) {
	var agregar_pais_contador = 1; //1 porque ya existe uno creado
	 var agregar_aerolinea_contador = 0;
	 var agregar_naviera_contador = 0;
	 var windowWidth = $(window).width();
	 
	$(document).on('click','.agregar-itinerario-roaming',function(e){
		e.preventDefault();
		$(this).html( $(this).data('msjQuitar') );
		$(this).removeClass('agregar-itinerario-roaming');
		$(this).addClass('quitar-itinerario-roaming');
		$(this).closest('.contenedor-itinerarios-roaming').find('.it-extra').removeClass('hidden');
	});


	$(document).on('click','.quitar-itinerario-roaming',function(e){
		e.preventDefault();
		$(this).html( $(this).data('msjAnadir') );
		$(this).removeClass('quitar-itinerario-roaming');
		$(this).addClass('agregar-itinerario-roaming');
		$(this).closest('.contenedor-itinerarios-roaming').find('.it-extra').addClass('hidden');
	});
	 
	 function agregar_pais(){
		if( agregar_pais_contador < 7 ){
			agregar_pais_contador++;
			generar_select_pais( $('#paises_contenedor') , '' );
		}
		if( agregar_pais_contador === 7 ) $('#agregar_pais').hide();
	}
	 
	 function generar_select_pais( contenedor , clase){
		var countryAttribute = $('.xk-roamingsearchcober').attr('data-countryhelp');
		var serviceUrl = "/bin/telcelcom/roaming/roamingsearch.paises.go.json";
		var contenedor_select = $("<div class='"+clase+" form-group'></div>");
		var select = $("<select class='form-control customSelect itinerario_paises_select' data-placeholder='"+countryAttribute+"' placeholder='"+countryAttribute+"' data-width='96' data-search='10'></select>");
		select.append('<option value="0" disabled selected>'+countryAttribute+'</option>')
	    contenedor_select.append( select );
		contenedor.append( contenedor_select );

		cargar_chosen( select );
		ordenar_chosen();
		$.getJSON(serviceUrl, function (response) {
	        if (response.success == "true") {
	        	$.each( response.data , function(key, val){
	        		select.append('<option value="' + val.idpais + "," + val.mostrarciudades +'">' + val.nombreespanol + '</option>');
	        	} );
	        	if( agregar_pais_contador != 1 ) asociar_eliminar( select );
	        	select.trigger("chosen:updated");
	        	
	        }
	    });
	}
	generar_select_cruise('','');
	generar_select_air('','');
	$(document).on('click','#restablecer-paises',function(e){
		e.preventDefault();
		reestablecer();
	});

	$(document).on('click','.agregar_mas_paises',function(e){
		e.preventDefault();

		$('.control-paises').addClass('hidden');
		$('.agregar-mas-paises').removeClass('hidden');

		agregar_pais();

	});
	
	$(document).on( 'click' , '.eliminar_transporte' , function( e ){
		e.preventDefault();
		
		var contenedor_id = $(this).closest('.medio-transporte').attr('id');
		if( contenedor_id === "paises_contenedor" ){
			agregar_pais_contador--;
			if(agregar_pais_contador < 7){
				$('#agregar_pais').show();
 			}
			if( agregar_pais_contador === 1 ) reestablecer();
 		}
 		else if( contenedor_id === "naviera_contenedor" ){
 			agregar_naviera_contador--;
 			if(agregar_naviera_contador < 1){
 				$('#agregar_naviera').show();
 			}
 		}
 		else if( contenedor_id === "transporte_contenedor" ){
 			agregar_aerolinea_contador--;
 			if(agregar_aerolinea_contador < 2){
 				$('#agregar_aerolinea').show();
 			}
 		}
		
		$(this).closest('.form-group').remove();
	} );
	
	 check_chosen();
	 
	window.onresize = function(event) {
		if ($(window).width() != windowWidth) {
        windowWidth = $(window).width();
				responsive_tables();
    }
		/*
			Chosen enhancement
		*/
		check_chosen();
	};
	
	function check_chosen(){
		//If window's width is less than 767 (tablet), destroy chosen
		if( windowWidth <= 767 ){
			$.each( $('.customSelect') ,function(i,v){
				if( $(this).next().hasClass('chosen-container') ){
					$(this).chosen('destroy');
				}
			});
		}else{
			$.each( $('.customSelect') ,function(i,v){
				if( !$(this).next().hasClass('chosen-container') ){
					cargar_chosen( $(this) );
				}
			});
		}
	}

	/*
	 * Add 'country' combobox functionallity
	 */
	$(document).on( 'change' , '.itinerario_paises_select' , function( e ){
		e.preventDefault();
		verificar_itinerario_paises( $(this) );
	} );
	
	$(document).on('click','#agregar_pais',function( e ){
		e.preventDefault();
		agregar_pais();
	});

	$(document).on('click','#agregar_aerolinea',function( e ){
		e.preventDefault();
		if( agregar_aerolinea_contador < 2 ){
			generar_select_air( $('#transporte_contenedor') , 'col-xs-12 col-sm-12');
 			agregar_aerolinea_contador++;
 		}
 		if( agregar_aerolinea_contador === 2 ) $('#agregar_aerolinea').hide();
	});

	$(document).on('click','#agregar_naviera',function( e ){
		e.preventDefault();
 		if( agregar_naviera_contador < 1 ){
 			generar_select_cruise( $('#naviera_contenedor') , 'col-xs-12 col-sm-12');
 			agregar_naviera_contador++;
 		}
 		if( agregar_naviera_contador === 1 ) $('#agregar_naviera').hide();
	});

	
	
	$(".seleccionarModelo").change(function() {
		angular.element($(this)).scope().getDataCobertura();
	});
	
	generar_select_pais( $('#paises_contenedor') , '');
	/*
	Acciones del boton buscar roaming
	*/
	$(document).on('click','#buscar-roaming-cober',function(e){
		e.preventDefault();
		hideAllCobertura();
		//validates comboboxes data
        var objerror = $('.xk-roamingsearchcober #mensaje-error-modalidad-viaje');
        if (validateFormDataRoamingCoberSearch() == false) {
            objerror.hide();
            objerror.show();
            return false;
        } else {
            objerror.hide();
        }

        var paises = "[";
        var maritimos = "[";
        var cruceros = "[";
        var aereos = "[";
        var flotillas = "[";
        var ciudades = "[";
        var paisesCiudades = "[";
        var paisesOrder = "[";

        var objpaises = $('#paises_contenedor');
        objpaises.find('.form-group').each(function(){

            var countryoption = $(this).find(".itinerario_paises_select").find('option:selected');
            var cityoption = $(this).find(".ciudad-select").find('option:selected');

            if (cityoption.val() != "0" && cityoption.val() != undefined) {
            	paisesCiudades = paisesCiudades + "\"" + countryoption.text() + "\"" + ",";
            	ciudades = ciudades + "\"" + cityoption.text() + "\"" + ",";
            	paisesOrder = paisesOrder + "\"" + countryoption.text() + " - " + cityoption.text() + "\"" + ",";
            } else {
            	if (countryoption.val() != "0") {
	                paises = paises + "\"" + countryoption.text() + "\"" + ",";
	                paisesOrder = paisesOrder + "\"" + countryoption.text() + "\"" + ",";
            	}
            }
        });
        
        var objnaviera1 = $('#itinerario_ship_select1');
        var objnaviera2 = $('#itinerario_ship_select2');
        	
    	var maroption1 = objnaviera1.find('option:selected');
    	var maroption2 = objnaviera2.find('option:selected');
        var cruiseoption1 = $('#itinerario_cruise_select1').find('option:selected');
        var cruiseoption2 = $('#itinerario_cruise_select2').find('option:selected');

        if (cruiseoption1.val() != "0"  && cruiseoption1.val() != null) {
        	maritimos = maritimos + "\"" + maroption1.text() + "\"" + ",";
            cruceros = cruceros + "\"" + cruiseoption1.text() + "\"" + ",";
        }
        
        if ($("#it-extra-ship").is(":visible") ){
            if (cruiseoption2.val() != "0" && cruiseoption2.val() != null) {
            	maritimos = maritimos + "\"" + maroption2.text() + "\"" + ",";
                cruceros = cruceros + "\"" + cruiseoption2.text() + "\"" + ",";
            }
        }
        
        var objair1 = $('#itinerario_air_select1');
        var objair2 = $('#itinerario_air_select2');
        	
    	var airoption1 = objair1.find('option:selected');
    	var airoption2 = objair2.find('option:selected');
        var flotoption1 = $('#itinerario_flot_select1').find('option:selected');
        var flotoption2 = $('#itinerario_flot_select2').find('option:selected');

        if (flotoption1.val() != "0"  && flotoption1.val() != null) {
        	aereos = aereos + "\"" + airoption1.text() + "\"" + ",";
        	flotillas = flotillas + "\"" + flotoption1.text() + "\"" + ",";
        }
        
        if ($("#it-extra-air").is(":visible") ){
            if (flotoption2.val() != "0"  && flotoption2.val() != null) {
            	aereos = aereos + "\"" + airoption2.text() + "\"" + ",";
            	flotillas = flotillas + "\"" + flotoption2.text() + "\"" + ",";
            }
        }

        paises = paises + "]";
        cruceros = cruceros + "]";
        maritimos = maritimos + "]";
        flotillas = flotillas + "]";
        aereos = aereos + "]";
        ciudades = ciudades + "]";
        paisesCiudades = paisesCiudades + "]";
        paisesOrder = paisesOrder + "]";

        paises = paises.replace(",]", "]");
        maritimos = maritimos.replace(",]", "]");
        aereos = aereos.replace(",]", "]");
        ciudades = ciudades.replace(",]", "]");
        paisesCiudades = paisesCiudades.replace(",]", "]");
        paisesOrder = paisesOrder.replace(",]", "]");
        cruceros = cruceros.replace(",]", "]");
        flotillas = flotillas.replace(",]", "]");
        
        //Get data for trigger the components that are into de tabs..
        var postParameters = "{\"paises\":" + paises + ",\"ciudades\":" + ciudades + ",\"paisesCiudades\":" + paisesCiudades + ",\"paisesOrder\":" + paisesOrder + ",\"maritimos\":"+ maritimos + ",\"cruceros\":"+ cruceros + ",\"flotillas\":"+ flotillas + ",\"aereos\":"+ aereos +  "}";
//        var comesFrom = $('.xk-roamingsearchcober').eq(0).attr('data-comesfrom');
        $('.xk-roamingsearchcober #txtPostParameters').val(postParameters);

        var modeval = 1;
//        var coverageval = objcoverage.val();
//        var deviceval = objdevice.val();

        //validates if it is the first search
        //console.log("firstsearch:" + $(this).attr('data-firstsearch'));
//        switch($(this).attr('data-firstsearch')) {
//            case '0':
//                comesFrom = comesFrom + "-firstsearch";
//                break;
//            case '1':
//                $(this).attr('data-firstsearch', '0');
//                break;
//        }
        var target = $('#contenedor-seleccion-planes');
        target.show('fast');
        
        //show loader
        $(target).animate({'opacity': '.5'}, function() {
            loader = $('<div/>', {
                'class': 'spinner-holder clear'
            }).css({'position': 'absolute', 'bottom': '50%', 'right': '50%'}).appendTo(target).spin('defaultSpin');

            //Call triggers of components that are into the tabs..
            $('.xk-roamingcobertura').trigger('section.roamingcobertura', [postParameters, comesFrom]);

            //hide loader
            $(target).delay('800').css({'opacity': '1','height':'auto'});
            $(target).find('.spinner-holder').spin(false);
        });
        
		$('.js-tooltip').tooltip();
		
    return false;
        

	});
	
	function reestablecer(){

		$.each( $('.lista-paises .form-group') , function( i , v ){

				if( i !== 0 ){
					$(this).remove();
				}else{
					$(this).find('select').val("0").trigger('chosen:updated');
					verificar_itinerario_paises( $(this) );
				}
				$('#agregar_pais').show();

				agregar_pais_contador = 1;

		} );
		
		$.each( $('.it-extra') , function(){
 			$(this).addClass('hidden');
 			$('.selectFlotilla').find('option:not(:eq(0))').remove();
 			$('.selectCrucero').find('option:not(:eq(0))').remove();
 			
 			$('.selectFlotilla').val("0").trigger('chosen:updated');
 			$('.selectCrucero').val("0").trigger('chosen:updated');
 			$('.selectAerolinea').val("0").trigger('chosen:updated');
 			$('.selectNaviera').val("0").trigger('chosen:updated');
 		} );
 
 		$.each( $('.quitar-itinerario-roaming') , function(){
 			$(this).removeClass('quitar-itinerario-roaming');
 			$(this).addClass('agregar-itinerario-roaming');
 			$(this).html( $(this).data('msjAnadir') );
 		} );

	}
	
});


function cargar_chosen( select ){

	var search = select.data('search');
    var ancho = select.data('width') + '%';

    var inherit = $(this).data('inherit');
    select.chosen({
    	disable_search_threshold: search,
        width: ancho,
        inherit_select_classes: inherit
    });
}

function ordenar_chosen(){
	var start = 1998;
	$.each( $('.chosen-container') , function( index , value ){
		$(this).css('z-index' , start );
		start -- ;
	} );
}

function asociar_eliminar( select ){
	var boton_eliminar;

	var contenedor_id = select.closest('.medio-transporte').attr('id');

	if( contenedor_id === "paises_contenedor" ){
		boton_eliminar = $("<div class='eliminar_transporte'><a href='' class=''><i class='icon-Close'></i><span> Quitar país</span></a><div>");
	}
	else if( contenedor_id === "naviera_contenedor" ){
		boton_eliminar = $("<div class='eliminar_transporte'><a href='' class=''><i class='icon-Close'></i> Quitar Crucero</a><div>");
	}
	else if( contenedor_id === "transporte_contenedor" ){
		boton_eliminar = $("<div class='eliminar_transporte'><a href='' class=''><i class='icon-Close'></i> Quitar Avión</a><div>");
	}

	select.closest('.form-group').append( boton_eliminar );
}

function verificar_itinerario_paises( elemento ){
	//Country = Estados Unidos
	var valueArr = elemento.val().split(",");
	var ciudad = elemento.closest('.form-group').find('.ciudad-select');
	elemento.closest('.form-group').find('.chosen-container').css('width','96%');
	elemento.data("width","96");
	ciudad.chosen("destroy");
	ciudad.remove();
	if( valueArr[1] == "1"){
		elemento.data("width","46");
		var cityAttribute = $('.xk-roamingsearchcober').attr('data-cityhelp');
		var contenedor_select = $("<div class='col-sm-12 col-xs-12 form-group'></div>");
		var ciudades = $("<select class='customSelect form-control ciudad-select' disabled data-placeholder='"+cityAttribute+"' placeholder='"+cityAttribute+"' data-search='10' data-width='46'></select>");
		ciudades.append('<option value="0" disabled selected>'+cityAttribute+'</option>');
		elemento.closest('.form-group').find('.chosen-container').css('width','46%');
		elemento.closest('.form-group').append( ciudades );
		cargar_chosen( elemento.closest('.form-group').find('.ciudad-select') );
		ordenar_chosen();
		var citiesServiceUrl = "/bin/telcelcom/roaming/roamingsearch.paises=" + valueArr[0] +".ciudadesList.go.json";
		$.getJSON(citiesServiceUrl, function (response) {
	        if (response.success == "true") {
	        	$.each( response.data , function(key, val){
	        		ciudades.append('<option value="' + val.idciudad + '">' + val.nombreespanol + '</option>');
	        	} );
	    		ciudades.prop('disabled', false).trigger("chosen:updated");
	        }
	    });
	}
}

function generar_select_cruise( contenedor , clase){
//	var contenedor_select = $("<div class='"+clase+" form-group'></div>");
//	var shipAttribute = $('.xk-roamingsearchcober').attr('data-shippinghelp');
//	var cruiseAttribute = $('.xk-roamingsearchcober').attr('data-cruisehelp');
	var serviceUrl = "/bin/telcelcom/roaming/roamingsearch.lineas-navierasList.go.json";
	var select_categoria1 = $("#itinerario_ship_select1");
	var select_categoria2 = $("#itinerario_ship_select2");
//	var select_categoria = $("<select class='customSelect form-control itinerario_ship_select' data-placeholder='"+shipAttribute+"' placeholder='"+shipAttribute+"' data-width='40' data-search='10'></select>");
//	var select_subcategoria = $("<select class='customSelect form-control cruise_select' disabled data-placeholder='"+cruiseAttribute+"' placeholder='"+cruiseAttribute+"' data-search='10' data-width='40'></select>");
	
	$.getJSON(serviceUrl, function (response) {
        if (response.success == "true") {
//        	select_categoria.append('<option value="0" disabled selected>'+shipAttribute+'</option>')
//        	select_subcategoria.append('<option value="0" disabled selected>'+cruiseAttribute+'</option>')
        	$.each( response.data , function(key, val){
        		select_categoria1.append('<option value="' + val.idlineanaviera + '">' + val.lineanaviera + '</option>');
        		select_categoria2.append('<option value="' + val.idlineanaviera + '">' + val.lineanaviera + '</option>');
        	} );
//    		contenedor_select.append(select_categoria);
//    		contenedor_select.append(select_subcategoria);
//    		contenedor.append( contenedor_select );

    		select_categoria1.trigger("chosen:updated");
    		select_categoria2.trigger("chosen:updated");
//    		cargar_chosen( select_subcategoria );
    		

    		ordenar_chosen();
//    		asociar_eliminar( select_categoria );
    		
        	/*
        	 * Add 'cruise' combobox functionallity
        	 */
        	$(document).on( 'change' , '#itinerario_ship_select1' , function( e ){
        		e.preventDefault();
        		verificar_itinerario_ship( $(this), $("#itinerario_cruise_select1") );
        	} );
        	$(document).on( 'change' , '#itinerario_ship_select2' , function( e ){
        		e.preventDefault();
        		verificar_itinerario_ship( $(this), $("#itinerario_cruise_select2") );
        	} );
        }
    });
}

function generar_select_air( contenedor , clase){
	var contenedor_select1 = $("#itinerario_air_select1");
	var contenedor_select2 = $("#itinerario_air_select2");
//	var airlineAttribute = $('.xk-roamingsearchcober').attr('data-airlinehelp');
//	var flotillaAttribute = $('.xk-roamingsearchcober').attr('data-flotillahelp');
	var serviceUrl = "/bin/telcelcom/roaming/roamingsearch.lineas-aereasList.go.json";

//	var select_categoria = $("<select class='customSelect form-control itinerario_ship_select' data-placeholder='"+airlineAttribute+"' placeholder='"+airlineAttribute+"' data-width='40' data-search='10'></select>");
//	var select_subcategoria = $("<select class='customSelect form-control cruise_select' disabled data-placeholder='"+flotillaAttribute+"' placeholder='"+flotillaAttribute+"' data-search='10' data-width='40'></select>");
	
	$.getJSON(serviceUrl, function (response) {
        if (response.success == "true") {
//        	select_categoria.append('<option value="0" disabled selected>'+airlineAttribute+'</option>')
//        	select_subcategoria.append('<option value="0" disabled selected>'+flotillaAttribute+'</option>')
        	$.each( response.data , function(key, val){
        		contenedor_select1.append('<option value="' + val.idlineanaviera + '">' + val.lineanaviera + '</option>');
        		contenedor_select2.append('<option value="' + val.idlineanaviera + '">' + val.lineanaviera + '</option>');
        	} );
//    		contenedor_select.append(select_categoria);
//    		contenedor_select.append(select_subcategoria);
//    		contenedor.append( contenedor_select );
        	contenedor_select1.trigger("chosen:updated");
        	contenedor_select2.trigger("chosen:updated");
//    		cargar_chosen( select_categoria );
//    		cargar_chosen( select_subcategoria );
    		

    		ordenar_chosen();
//    		asociar_eliminar( select_categoria );
    		
        	/*
        	 * Add 'cruise' combobox functionallity
        	 */
        	$(document).on( 'change' , '#itinerario_air_select1' , function( e ){
        		e.preventDefault();
        		verificar_itinerario_flot( $(this), $("#itinerario_flot_select1") );
        	} );
        	
        	$(document).on( 'change' , '#itinerario_air_select2' , function( e ){
        		e.preventDefault();
        		verificar_itinerario_flot( $(this), $("#itinerario_flot_select2") );
        	} );
        }
    });
}

function verificar_itinerario_flot( elemento, select_subcategoria ){
	
	var cruiseAttribute = $('.xk-roamingsearchcober').attr('data-cruisehelp');
	var naviesServiceUrl = "/bin/telcelcom/roaming/roamingsearch.lineas=" + elemento.val() +".crucerosList.go.json";
	$.getJSON(naviesServiceUrl, function (response) {
        if (response.success == "true") {
        	resetComboRoamingCoberSearch(select_subcategoria);
        	$.each( response.data , function(key, val){
        		select_subcategoria.append('<option value="' + val.idcrucero + '">' + val.crucero + '</option>');
        	} );
        	select_subcategoria.trigger('chosen:updated');
        	cargar_chosen( select_subcategoria );
        	ordenar_chosen();
        }
    });
}

function verificar_itinerario_ship( elemento, select_subcategoria ){
	
	var cruiseAttribute = $('.xk-roamingsearchcober').attr('data-cruisehelp');
	var naviesServiceUrl = "/bin/telcelcom/roaming/roamingsearch.lineas=" + elemento.val() +".crucerosList.go.json";
	$.getJSON(naviesServiceUrl, function (response) {
        if (response.success == "true") {
        	resetComboRoamingCoberSearch(select_subcategoria);
        	$.each( response.data , function(key, val){
        		select_subcategoria.append('<option value="' + val.idcrucero + '">' + val.crucero + '</option>');
        	} );
        	select_subcategoria.trigger('chosen:updated');
        	cargar_chosen( select_subcategoria );
        	ordenar_chosen();
        }
    });
}

/*
* Reset combo to its initial state
 */
function resetComboRoamingCoberSearch(target) {
    if (target != null) {
        var firstOption = target.find('option').eq(0);

        firstOption.attr("disabled");
        firstOption.attr("selected");
        target.find('option:not(:eq(0))').remove();
        target.prop('disabled', false)
        target.trigger('chosen:updated');
    }
}

function validateFormDataRoamingCoberSearch() {

    //comboboxes to validate
    var objcountry  = $('.xk-roamingsearchcober .itinerario_paises_select');
    var objtransporte  = $('.xk-roamingsearchcober .itinerario_ship_select');
    var hasEmptyPais = false;
    //Validate countries combobox
    if (objcountry.val() == null || objcountry.val() == "0") {
    	hasEmptyPais = true;
    } 
    
    var hasEmptyShip = false;
    var cruiseoption1 = $('#itinerario_cruise_select1');

    if (cruiseoption1.val() == "0" || cruiseoption1.val() == null) {
    	hasEmptyShip = true;
    }
    
    var hasEmptyAir = false;
    var flotoption1 = $('#itinerario_flot_select1');

    if (flotoption1.val() == "0" || flotoption1.val() == null) {
    	hasEmptyAir = true;
    }

    if(hasEmptyShip && hasEmptyAir && hasEmptyPais) {
    	return false;
    }
    
    return true;
}

function hideAllCobertura() {
	var panelActivo = $("#panel_plan");
    if ($("#panel_amigo").hasClass("active")) {
    	panelActivo = $("#panel_amigo");
    }
	$(panelActivo).find("#seleccionarModelo").html("+ Ver si mi equipo tiene cobertura en este destino");
	$(panelActivo).find("#seleccionarMarca").find('option').remove().trigger('chosen:updated');
	$(panelActivo).find("#seleccionarModelo").attr("disabled", "disabled");
	$(panelActivo).find("#seleccionarModelo").find('option').remove().trigger('chosen:updated');
	$(panelActivo).find('#contenedor-seleccion-planes').hide('fast');
	$(panelActivo).find("#seleccionar-marca-modelo").hide('fast');
	$(panelActivo).find('#resultado-cobertura-equipo').hide('fast');
}


//console.log("roamingCoverage.js loaded");
/*
 * Trigger the 'section.roamingsearch' event when the page has been loaded.
 */
$(document).on('section.roamingcobertura', '.xk-roamingcobertura', function(e, postParameters, comesFrom) {

    //console.log('section.roamingcoverage triggered, comesFrom:' + comesFrom);

    //Provides the comboboxes data of the RoamingSearch component.
    $(this).attr('data-postparameters', postParameters);
    
	var windowWidth = $(window).width();

	window.onresize = function(event) {

		if ($(window).width() != windowWidth) {
        windowWidth = $(window).width();
        responsive_tables();
    }

	};
    
    var panelPlan = $("#panel_plan");
    var panelAmigo = $("#panel_amigo");
    var modalidad = 1;
    if (panelAmigo.hasClass("active")) {
    	modalidad = 2;
    }
    //If the page has been loaded normally it just calls the getDataResumen() function
    if (comesFrom == 'page') {
        angular.element($(this)).scope().getDataResumen(modalidad, postParameters);

        //If the page has been loaded by ajax it recompiles the angular code and then it calls the getDataResumen() function
    } else if (comesFrom == 'ajax') {
        //recompile the angular
    	if ($("#searchesCount").val() == 0) {
            var $injector = angular.injector(['ng', 'telcelApp']);
            $injector.invoke(['$rootScope','$compile',function ($rootScope, $compile, $scope) {
                $compile($("#contenedor-seleccion-planes"))($rootScope);
            }]);
        	$(".seleccionarModelo").change(function() {
        		angular.element($(this)).scope().getDataCobertura();
        	});
    	}
    	$("#searchesCount").val(1);
        angular.element($(this)).scope().getDataResumen(modalidad, postParameters);

    } else {
        angular.element($(this)).scope().getDataResumen(modalidad, postParameters);
    }
});

angular.module("telcelApp")
	.filter('filterFunction', function () {
	  return function (items) {
	    var filtered = [];
	    filtered.push(items.a_Voz);
	    filtered.push(items.b_Sms);
	    filtered.push(items.d_Gprs);
	    filtered.push(items.e_Tresg);
	    filtered.push(items.f_Lte);
	    return filtered;
	  };
	});

angular.module("telcelApp")
    .controller("RoamingCoberturaController", ['$window','$scope', '$http', '$attrs','$rootScope', '$compile', '$sce',
        function($window, $scope, $http, $attrs,  $rootScope, $compile, $sce) {
    		$scope.resultdatacober = [];
    		$scope.resultdatacoberamigo = [];
			$(document).on("change","#seleccionarMarca",function(){
	            var panelActivo = getPanelActivo();
				var modelsServiceUrl = "/bin/telcelcom/roaming/roamingsearch.marcas=" + $(this).val() + ".modelos.go.json";
            	var objModelo = $(panelActivo).find("#seleccionarModelo");
            	objModelo.find('option').remove();
            	$.getJSON(modelsServiceUrl, function (response) {
                    if (response.success == "true") {
                    	var modelAttribute = $('.xk-roamingcobertura').attr('data-modelhelp');
                    	objModelo.append('<option value="0" disabled selected>'+modelAttribute+'</option>');
                    	$.each( response.data , function(key, val){
                    		objModelo.append('<option value="' + val.id + '">' + val.nombre + '</option>');
                    	} );
                    	objModelo.prop('disabled', false).trigger("chosen:updated");
                    }
                });
            	
				
			});
	    	$(document).on("click","#cobertura-equipos",function( e ){
	    		e.preventDefault();
	            var panelActivo = getPanelActivo();

	    		cargar_chosen( $(panelActivo).find("#seleccionarMarca") );
	    		cargar_chosen( $(panelActivo).find("#seleccionarModelo") );
	
	    		$("#seleccionar-marca-modelo").toggle();
	
	    		if( $("#seleccionar-marca-modelo").css("display") === "block" ){
	    			var msjOcultarAttribute = $('.xk-roamingcobertura').attr('data-txtbtnocultar');
	    			$(this).html("- "+msjOcultarAttribute);
	    			$(panelActivo).find("#seleccionar-marca-modelo").show();
                                //alert("Paso 3");
	    			
	    				var postParameters = $('.xk-roamingsearchcober #txtPostParameters').val();
	    				var json = jQuery.parseJSON( postParameters );
	            		var paises = json.paises.toString().replaceAll(",", "|");
	            		var navieras = "";
	            		var aeros = "";
	            		for (a = 0; a < json.aereos.length; a++) {
	            			aeros += json.aereos[a] + "-" + json.flotillas[a] + "|";
	            		}
	            		for (c = 0; c < json.maritimos.length; c++) {
	            			navieras += json.maritimos[c] + "-" + json.cruceros[c] + "|";
	            		}
	     	 		   
	    				dlMetri={ 'roamingPageName':'Roaming|Cobertura |Paso 3 |Elegir marca y modelo', 'portaFecha':d+'|'+h,
        	 					'roamingPais':paises,
         	 					'roamingAerolinea':aeros,
         	 					'roamingNaviera':navieras}; 
	    				_satellite.track("vpvRoaming3");
		    			dataLayer.push({ 'ruta':'/personas/telefonia/roaming/cobertura/pas3/elegir-marca-y-modelo', 'titulo':'Roaming|Cobertura |Paso 3 |Elegir marca y modelo', 'event':'pageview' });

	            	var serviceUrl = "/bin/telcelcom/roaming/roamingsearch.marcas.go.json";
	            	var obj = $(panelActivo).find("#seleccionarMarca");
	            	$.getJSON(serviceUrl, function (response) {
	            		obj.find('option').remove();
	                    if (response.success == "true") {
	                    	var brandAttribute = $('.xk-roamingcobertura').attr('data-brandhelp');
	                    	obj.append('<option value="0" disabled selected>'+brandAttribute+'</option>');
	                    	$.each( response.data , function(key, val){
	                    		obj.append('<option value="' + val + '">' + val + '</option>');
	                    	} );
	                    	obj.trigger('chosen:updated');
	                    }
	                });
	    		    $(panelActivo).find("#seleccionarModelo").find('option').remove();
	    		    $(panelActivo).find("#seleccionarModelo").attr("disabled", "disabled");
	    		    $(panelActivo).find("#seleccionarModelo").trigger('chosen:updated');
	    			
	    		}else{
	    			var msjMostrarAttribute = $('.xk-roamingcobertura').attr('data-txtbtnmostrar');
	    			$(this).html("+ "+msjMostrarAttribute);
	    			$(panelActivo).find("#seleccionar-marca-modelo").hide();
	    			$(panelActivo).find('#resultado-cobertura-equipo').hide();
	    		}
	
	
	
	    	});
            $scope.mode = "-1";
            
            $scope.getDataCobertura = function() {
	            $scope.resultdatacober = [];
	            $scope.resultdatacoberamigo = [];
	            $scope.mode = "-1";
	            var panelAmigo = $("#panel_amigo");
	            var panelActivo = $("#panel_plan");
	            var modalidad = 1;
	            var text = "Plan de Renta";
	            if (panelAmigo.hasClass("active")) {
	            	modalidad = 2;
	            	text = "Amigo y Plan Mixto";
	            	panelActivo = $("#panel_amigo");
	            }

                $scope.mode = modalidad;
                $scope.modetext = text;
                $scope.modeindex = -1;


                var postParameters = $('.xk-roamingsearchcober #txtPostParameters').val();


                var serviceUrlCober = "/bin/telcelcom/roaming/roamingallcoveragebydestino" +
                ".cobertura=1" + //it is always = 1 (based on jwm's documentation)
                ".equipo=" + $(panelActivo).find("#seleccionarModelo").val() +
//                ".data=" + postParameters +
                ".modalidad=" + modalidad +
                ".go.json?params=" + encodeURIComponent(postParameters);

               
                var objcoverage =  $(panelActivo).find("#seleccionar-marca-modelo");
                objcoverage.spin('largeSpin');

                if (postParameters != "") {

                    //console.log("roaming coverage url:" + serviceUrl + ", mode:" + modalidad + ", equ:" + equipo);

                    $http.post(serviceUrlCober)
                        .success(function(data, status, headers, config) {
                        	$(panelActivo).find("#resultado-cobertura-equipo").show();
    	    				$scope.resultdatacober = data;
                                        //alert("Paso 4");
	    						var postParameters = $('.xk-roamingsearchcober #txtPostParameters').val();
	    	    				var json = jQuery.parseJSON( postParameters );
	    	            		var paises = json.paises.toString().replaceAll(",", "|");
	    	            		var navieras = "";
	    	            		var aeros = "";
	    	            		for (a = 0; a < json.aereos.length; a++) {
	    	            			aeros += json.aereos[a] + "-" + json.flotillas[a] + "|";
	    	            		}
	    	            		for (c = 0; c < json.maritimos.length; c++) {
	    	            			navieras += json.maritimos[c] + "-" + json.cruceros[c] + "|";
	    	            		}
	    	            		var modelo = $(panelActivo).find("#seleccionarModelo option:selected").text()
	    	    	    		var marca = $(panelActivo).find("#seleccionarMarca").val();
	    	     	 		   
    	    					dlMetri={ 'roamingPageName':'Roaming|Cobertura|Paso 4|Cobertura del equipo', 'portaFecha':d+'|'+h ,
	            	 					'roamingPais':paises,
	             	 					'roamingAerolinea':aeros,
	             	 					'roamingNaviera':navieras,
	                    				'roamingMarcaModelo': marca+ '|' + modelo}; 
    	    					_satellite.track("vpvRoaming4");
                            	dataLayer.push({ 'ruta':'/personas/telefonia/roaming/cobertura/paso4/cobertura-del-equipo', 'titulo':'Roaming|Cobertura|Paso 4|Cobertura del equipo', 'event':'pageview' });
                            objcoverage.spin(false).stop();
                            setTimeout( 
                                	function () { 
                                	  var resolution = findBootstrapEnvironment();
                              		  if( $('.js-tc').length > 0 && resolution === "xs"){
                              		    $('.tc-div').remove();
                              		    $.each( $('.js-tc') , function(){
                              		        var self = $(this);
                              		        var t_head = function(){
                              		          var th = [];
                              		          $.each( self.find('thead tr th') , function(){
                              		            th.push( $(this).html() );
                              		          } );
                              		          return th;
                              		        }();
                              		        var t_rows = function(){
                              		          var tr = [];
                              		          var container_tables = document.createElement('div');
                              		          $.each( self.find('tbody tr') , function(){
                              		            var new_table = document.createElement("table");
                              		            new_table.className += " table-card";
                              		            $.each( $(this).find('td') , function( i , v ){
                              		              if( t_head[i] === "Mapa" ) $(new_table).append('<tr><td class="n-p" colspan="2">'+ $(this).html() +'</td></tr>');
                              		              else $(new_table).append('<tr><td>'+ t_head[i] +'</td><td>'+ $(this).html() +'</td></tr>');
                              		            } );
                              		            container_tables.className = 'owl-carousel';
                              		            container_tables.className = ' tc-div';
                              		            container_tables.appendChild(new_table);
                              		          } );
                              		          $(container_tables).owlCarousel({
                              		              stagePadding: 100,
                              		              loop: true,
                              		              center: true,
                              		              HoverPause: true,
                              		              navigation: false,
                              		              singleItem:true,
                              		              lazyLoad: true
                              		          });
                              		          self.closest('.tc-container').append(container_tables);
                              		        }();
                              		        self.hide();
                              		    } );
                              		  }else{
                              		    $('.js-tc').show();
                              		    $('.table-card').hide();
                              		    $('.tc-container .owl-pagination').hide();
                              		  }
                                	}, 50);
                        })
                        .error(function(e, msg){
                            objcoverage.spin(false).stop();
                            //console.log("roamingcoverage error:" + msg);
                        });
                }
            };

            $scope.getDataResumen = function(modalidad, postParameters) {
                if (postParameters == null || postParameters == "" || postParameters=="undefined") {
                    postParameters = $('.xk-roamingsearchcober #txtPostParameters').val();
                }
            		var json = jQuery.parseJSON( postParameters );
            		var paises = json.paises.toString().replaceAll(",", "|");
            		var navieras = "";
            		var aeros = "";
            		for (a = 0; a < json.aereos.length; a++) {
            			aeros += json.aereos[a] + "-" + json.flotillas[a] + "|";
            		}
            		for (c = 0; c < json.maritimos.length; c++) {
            			navieras += json.maritimos[c] + "-" + json.cruceros[c] + "|";
            		}
     	 		   if (modalidad == "1") {
     	 			   dlMetri={ 'roamingPageName':'Roaming|Cobertura|Paso 2|Planes de renta', 'portaFecha':d+'|'+h,
     	 					'roamingPais':paises,
     	 					'roamingAerolinea':aeros,
     	 					'roamingNaviera':navieras}; 
     	 			   _satellite.track("vpvRoaming2");
     	 			   dataLayer.push({ 'ruta':'/personas/telefonia/roaming/cobertura/paso2/planes de renta', 'titulo':'Roaming|Cobertura|Paso 2|Planes de renta', 'event':'pageview' });
     	 		   } else {
     	 			   dlMetri={ 'roamingPageName':'Roaming|Cobertura |Paso 2 |Amigo y plan mixto', 'portaFecha':d+'|'+h,
        	 					'roamingPais':paises,
         	 					'roamingAerolinea':aeros,
         	 					'roamingNaviera':navieras}; 
         	 			   _satellite.track("vpvRoaming2");
     	 			   dataLayer.push({ 'ruta':'/personas/telefonia/roaming/cobertura/paso2/amigo y plan mixto', 'titulo':'Roaming|Cobertura |Paso 2 |Amigo y plan mixto', 'event':'pageview' });
     	 		   }
            	
            	$scope.resumenServices = [];
            	$scope.resultdataresumen = [];
                $scope.modeindex = -1;

                

                var serviceUrl = "/bin/telcelcom/roaming/roamingcoveragebydestino" +
                    ".cobertura=1" + //it is always = 1 (based on jwm's documentation)
//                    ".data=" + postParameters +
                    ".modalidad=" + modalidad +
                    ".go.json?params=" + encodeURIComponent(postParameters);

                var objcoverage = $('.xk-roamingcobertura');
                objcoverage.spin('largeSpin');

                if (postParameters != "") {

                    //console.log("roaming coverage url:" + serviceUrl + ", mode:" + modalidad + ", equ:" + equipo);

                    $http.post(serviceUrl)
                        .success(function(data, status, headers, config) {
                        	$scope.resultdataresumen = data;
                            //console.log(data);
                            var resumenArr = [];
                            for (i = 0; i < data.data.length; i++) {
                            	var serviciosArr = {"nombre": data.data[i].nombre, servicios: []};
                            	var hasServicios = false, hasVoz = false,hasSMS = false,hasGSM = false,has3G = false, has4G = false;
                    			var objVoz = null,objSMS = null,objGprs = null,obj3G = null,obj4G = null;
                        		for (c = 0; c < data.data[i].data.length; c++) {
                        			var serviciosL = data.data[i].data[c].servicios.length
                        			for (s = 0; s < serviciosL; s++) {
                            			if (modalidad == "1") {
                            				if (data.data[i].data[c].servicios[s].j_RoamingModalidad.id != modalidad) {
                            					continue;
                            				}
                            			} else {
                            				if (data.data[i].data[c].servicios[s].j_RoamingModalidad.id == "1") {
                            					continue;
                            				}
                            			}
    	                        		objVoz = data.data[i].data[c].servicios[s].a_Voz;
    	                        		objSMS = data.data[i].data[c].servicios[s].b_Sms;
    	                        		objGprs = data.data[i].data[c].servicios[s].d_Gprs;
    	                        		obj3G = data.data[i].data[c].servicios[s].e_Tresg;
    	                        		obj4G = data.data[i].data[c].servicios[s].f_Lte;
    	                        	    if (objVoz.valor) { 
    	                        	    	hasVoz = true;
    	                        	    }  
    	                        	    if (objSMS.valor) { 
    	                        	    	hasSMS = true;
    	                        	    }  
    	                        	    if (objGprs.valor) { 
    	                        	    	hasGSM = true;
    	                        	    }  
    	                        	    if (obj3G.valor) { 
    	                        	    	has3G = true;
    	                        	    }  
    	                        	    if (obj4G.valor) { 
    	                        	    	has4G = true;
    	                        	    }  
    	                        	}
                        		}
                        		if (hasVoz || hasSMS || hasGSM || has3G || has4G) {
	                        		if (hasVoz) {
	                                	objVoz.valor = true;
	                                } else if (!hasVoz) {
	                                	objVoz.valor = false;
	                                }
	                    			serviciosArr.servicios.push(objVoz);
	                                if (hasSMS) {
	                                	objSMS.valor = true;
	                                } else if (!hasSMS) {
	                                	objSMS.valor = false;
	                                }
	                                serviciosArr.servicios.push(objSMS);
	                                if (hasGSM) {
	                                	objGprs.valor = true;
	                                } else if (!hasGSM) {
	                                	objGprs.valor = false;
	                                }
	                                serviciosArr.servicios.push(objGprs);
	                                if (has3G) {
	                                	obj3G.valor = true;
	                                } else if (!has3G) {
	                                	obj3G.valor = false;
	                                }
	                                serviciosArr.servicios.push(obj3G);
	                                if (has4G) {
	                                	obj4G.valor = true;
	                                } else if (!has4G) {
	                                	obj4G.valor = false;
	                                }
	                                serviciosArr.servicios.push(obj4G);
                        		}
                        		resumenArr.push(serviciosArr);
                        		
                        	}
                            $scope.resumenServices = resumenArr;
                            objcoverage.spin(false).stop();
                            setTimeout( 
                            	function () { 
                            	  var resolution = findBootstrapEnvironment();
                          		  if( $('.js-tc').length > 0 && resolution === "xs"){
                          		    $('.tc-div').remove();
                          		    $.each( $('.js-tc') , function(){
                          		        var self = $(this);
                          		        var t_head = function(){
                          		          var th = [];
                          		          $.each( self.find('thead tr th') , function(){
                          		            th.push( $(this).html() );
                          		          } );
                          		          return th;
                          		        }();
                          		        var t_rows = function(){
                          		          var tr = [];
                          		          var container_tables = document.createElement('div');
                          		          $.each( self.find('tbody tr') , function(){
                          		            var new_table = document.createElement("table");
                          		            new_table.className += " table-card";
                          		            $.each( $(this).find('td') , function( i , v ){
                          		              if( t_head[i] === "Mapa" ) $(new_table).append('<tr><td class="n-p" colspan="2">'+ $(this).html() +'</td></tr>');
                          		              else $(new_table).append('<tr><td>'+ t_head[i] +'</td><td>'+ $(this).html() +'</td></tr>');
                          		            } );
                          		            container_tables.className = 'owl-carousel';
                          		            container_tables.className = ' tc-div';
                          		            container_tables.appendChild(new_table);
                          		          } );
                          		          $(container_tables).owlCarousel({
                          		              stagePadding: 100,
                          		              loop: true,
                          		              center: true,
                          		              HoverPause: true,
                          		              navigation: false,
                          		              singleItem:true,
                          		              lazyLoad: true
                          		          });
                          		          self.closest('.tc-container').append(container_tables);
                          		        }();
                          		        self.hide();
                          		    } );
                          		  }else{
                          		    $('.js-tc').show();
                          		    $('.table-card').hide();
                          		    $('.tc-container .owl-pagination').hide();
                          		  }
                            	}, 50);
                        })
                        .error(function(e, msg){
                            objcoverage.spin(false).stop();
                            //console.log("roamingcoverage error:" + msg);
                        });
                }
                
            };
            
            
            $scope.showBtnEquipos = function(show) {
            	var panelActivo = getPanelActivo();
            	if (show == 0) {
            		$(panelActivo).find(".cobertura-en-destino").hide();
            	} else {
            		$(panelActivo).find(".cobertura-en-destino").show();
            	}
            };
            

            $scope.getServiceByModeCober = function(serviceList, mode) {
                if (serviceList != null && serviceList.length > 0) {

                    var i = 0;
                    var result = serviceList[0];

                    while (i < serviceList.length) {

                        var service = serviceList[i];
                        var roaming = service.j_RoamingModalidad;

                        if (roaming != null && roaming.id == mode) {
                            result = service;
                            i = serviceList.length;
                        }

                        i++;
                    }
                }

                return result;
            };

            $scope.validUrl = function(url) {

                if (url != null && url != "" && url != "undefined") {
                    return true;
                }
                return false;
            };
            
            $scope.validUrlClass = function(url) {

                if (url != null && url != "" && url != "undefined") {
                    return true;
                }
                return false;
            };

            $scope.hasMaps = function(operatorRow) {

                return $scope.validUrl(operatorRow.mapaUrlGsm) || $scope.validUrl(operatorRow.mapaUrl3g) || $scope.validUrl(operatorRow.mapaUrl4g);

            }
            
            $scope.openModalMapsCober = function(operatorRow) {
            	//alert("Paso 5");
            		var panelActivo = getPanelActivo();
    	    		var modelo = $(panelActivo).find("#seleccionarModelo option:selected").text()
    	    		var marca = $(panelActivo).find("#seleccionarMarca").val();
            		dlMetri={ 'roamingPageName':'Roaming|Cobertura |Paso 5 |Mapa|'+operatorRow.pais.nombre+'|'+operatorRow.operador.nombre, 'portaFecha':d+'|'+h,
            				'roamingPaisSeleccionado': operatorRow.pais.nombre,
            				'roamingMarcaModelo': marca+ '|' + modelo
            		}; _satellite.track("vpvRoaming5");
            		dataLayer.push({ 'ruta':'/personas/telefonia/roaming/cobertura/paso5/mapa/'+operatorRow.pais.nombre+'/'+operatorRow.operador.nombre, 'titulo':'Roaming|Cobertura |Paso 5 |Mapa|'+operatorRow.pais.nombre+'|'+operatorRow.operador.nombre, 'event':'pageview' });            	
            }
            	
            $scope.openModalSO = function(operatorRow) {
                //alert("_no conozco_");
            		dlMetri={ 'roamingPageName':'Roaming|Cobertura|Paso 3|Cobertura del equipo|No conozco el sistema operativo', 'portaFecha':d+'|'+h }; _satellite.track("vpvRoaming3");
                	dataLayer.push({ 'ruta':'/personas/telefonia/roaming/cobertura/paso3/cobertura-del-equipo/no-conozco-el-sistema-operativo', 'titulo':'Roaming|Cobertura|Paso 3|Cobertura del equipo|No conozco el sistema operativo', 'event':'pageview' });
            }

        }
    ]).filter('embedUrl', function ($sce) {
        return function(url) {

            if (url != null && url != "") {

                var temp = url.substring(0, 7);
                if (temp != "http://" && temp != "http//") {
                    url = "http://" + url;
                }

                return $sce.trustAsResourceUrl(url);
            }

            return "";


        };
    }).directive('groupModal', function(){

        return function(scope, element, attrs) {
            $('.xk-roamingcobertura').trigger('roamingcobertura.carousel', [element]); //execute carousel plugin
            $('.xk-roamingcobertura').spin(false).stop();
        };
    }).filter('groupByTecno', function() {
    	return function(tasks, tags) {
            return tasks.filter(function(task) {

                for (var i in task.Tags) {
                    if (tags.indexOf(task.Tags[i]) != -1) {
                        return true;
                    }
                }
                return false;

            });
        };
    });



$(document).on('roamingcobertura.carousel', '.xk-roamingcobertura', function(e, obj) {

    /*
     *   Código tomado del archivo js/galerias_dinamicas.js de multiplica.
     *
     *   Se cambió el selector de sync1 y sync2 para que
     *   este código se ejecute solamente para el carousel
     *   de este componente y no afecte a los otros carouseles existentes.
     *
     */

    /*
     Galerias de ganadores dinamicas
     */

    //var sync1 = $(".xk-roamingcoverage .js-gallery-images-cov");
    //var sync2 = $(".xk-roamingcoverage .js-gallery-thumbs-cov");

    var sync1 = obj.find(".js-gallery-images-cob");
    var sync2 = obj.find(".js-gallery-thumbs-cob");

    sync2.each( function(index,value){

        $(this).owlCarousel({
            items : 6,
            itemsDesktop : [1199,6],
            itemsDesktopSmall : [979,5],
            itemsTablet : [768,6],
            itemsTablet : [650,5],
            itemsMobile : [479,2],
            pagination:false,
            responsiveRefreshRate : 100,
            afterInit : function(el){
                el.find(".owl-item").eq(0).addClass("synced");
            }
        });
    } );



    sync1.each(function(index,value){

        $(this).owlCarousel({
        	singleItem : true,
	        slideSpeed : 1000,
	        navigation: true,
	        pagination:false,
	        afterAction : syncPosition,
	        responsiveRefreshRate : 200,
	        lazyLoad : true,
	        navigationText: ['<i class="icon-SliderLeft"></i>', '<i class="icon-SliderRight"></i>']
        });
    });


    sync2.each(function(){

        $(this).on("click", ".owl-item", function(e){
            e.preventDefault();
            var number = $(this).data("owlItem");
            sync1.each(function(){
                $(this).trigger("owl.goTo",number);
            });
        });

    });


    function syncPosition(el){

        var s2 = el.closest('.owl-carousel').next('.js-gallery-thumbs-cob');

        var current = this.currentItem;
        s2
            .find(".owl-item")
            .removeClass("synced")
            .eq(current)
            .addClass("synced")
        if(s2.data("owlCarousel") !== undefined){
            center(current,s2)
        }
    }


    function center(number,s2){
        var sync2visible = s2.data("owlCarousel").owl.visibleItems;
        var num = number;
        var found = false;
        for(var i in sync2visible){
            if(num === sync2visible[i]){
                var found = true;
            }
        }

        if(found===false){
            if(num>sync2visible[sync2visible.length-1]){
                s2.trigger("owl.goTo", num - sync2visible.length+2)
            }else{
                if(num - 1 === -1){
                    num = 0;
                }
                s2.trigger("owl.goTo", num);
            }
        } else if(num === sync2visible[sync2visible.length-1]){
            s2.trigger("owl.goTo", sync2visible[1])
        } else if(num === sync2visible[0]){
            s2.trigger("owl.goTo", num-1)
        }
    }

    /*
     Fin de Galerias de ganadores dinamicas
     */

});

function getPanelActivo () {
    var panelActivo = $("#panel_plan");
    if ($("#panel_amigo").hasClass("active")) {
    	panelActivo = $("#panel_amigo");
    }
    return panelActivo;
}

function hideAllPanelsCobertura(panel) {
    $(panel).find("#seleccionarModelo").html("+ Ver si mi equipo tiene cobertura en este destino");
    $(panel).find("#seleccionarMarca").find('option[value!="0"]').remove().trigger('chosen:updated');
    $(panel).find("#seleccionarModelo").attr("disabled", "disabled");
    $(panel).find("#seleccionar-marca-modelo").hide('fast');
    $(panel).find("#seleccionar-marca-modelo").css("display","none");
    $(panel).find("#seleccionarModelo").find('option[value!="0"]').remove().trigger('chosen:updated');
    $(panel).find('#resultado-cobertura-equipo').hide('fast');
}

	function responsive_tables(){
		var resolution = findBootstrapEnvironment();

		  if( $('.js-tc').length > 0 && resolution === "xs"){

		    $('.tc-div').remove();

		    $.each( $('.js-tc') , function(){

		        var self = $(this);


		        var t_head = function(){
		          var th = [];
		          $.each( self.find('thead tr th') , function(){
		            th.push( $(this).html() );
		          } );
		          return th;
		        }();


		        var t_rows = function(){

		          var tr = [];
		          var container_tables = document.createElement('div');

		          $.each( self.find('tbody tr') , function(){

		            var new_table = document.createElement("table");
		            new_table.className += " table-card";

		            $.each( $(this).find('td') , function( i , v ){

		              if( t_head[i] === "Mapa" ) $(new_table).append('<tr><td class="n-p" colspan="2">'+ $(this).html() +'</td></tr>');
		              else $(new_table).append('<tr><td style="text-align:left !important;">'+ t_head[i] +'</td><td>'+ $(this).html() +'</td></tr>');
		            } );

		            container_tables.className = 'owl-carousel';
		            container_tables.className = ' tc-div';
		            container_tables.appendChild(new_table);

		          } );

		          $(container_tables).owlCarousel({
		              stagePadding: 100,
		              loop: true,
		              center: true,
		              HoverPause: true,
		              navigation: false,
		              singleItem:true,
		              lazyLoad: true
		          });

		          self.closest('.tc-container').append(container_tables);

		        }();

		        self.hide();

		    } );



		  }else{
		    $('.js-tc').show();
		    $('.table-card').hide();
		    $('.tc-container .owl-pagination').hide();
		  }


		}
$(document).ready(function(){
    $(".xk-iframe").trigger("generic.iframe");
});

//TRASLADA VALORES AL IFRAME
$(document).on("generic.iframe", ".xk-iframe", function(){

    var objiframe = $(this).find("#iframe-recarga");

    if (objiframe != null && objiframe != "undefined" && objiframe.length > 0) {

        //Ini Codigo agregado por solicitud de Ismael 23-11-2015
        var urlVesta = objiframe.attr("src");
        var PayerID = GetURLParameter('PayerID');
        var encryptedToken=GetURLParameter('encryptedToken');

        if((PayerID!=null)&&(encryptedToken!=null)){
            urlVesta=urlVesta+"&PayerID="+PayerID+"&encryptedToken="+encryptedToken;
        }

        //console.log("urlVesta: " + urlVesta);
        objiframe.attr("src", urlVesta);
        //Fin Codigo agregado por solicitud de Ismael 23-11-2015

    }

});

//Ini Codigo agregado por solicitud de Ismael 23-11-2015
function GetURLParameter(sParam) {

    //var sPageURL = getParentUrl();
    //var sPageURL = window.location.search.substring(1);
    var sPageURL = getParentUrl();
    sPageURL = sPageURL.toString();
    //console.log("sPageUrl:" + sPageURL);
    var sURLVariables = sPageURL.split('&');
    for (var i = 0; i < sURLVariables.length; i++) {
        var sParameterName = sURLVariables[i].split('=');
        if (sParameterName[0] == sParam)
        {
            return sParameterName[1];
        }
    }

}
//Fin Codigo agregado por solicitud de Ismael 23-11-2015

function getParentUrl() {
    var url = (window.location != window.parent.location) ? document.referrer : document.location;
    return url;
}

$(document).ready(function(){

    $(".xk-formcontrol-statesselect").trigger("general.statesselect");

});

$(document).on("general.statesselect", ".xk-formcontrol-statesselect", function(){

    var objselect = $(this).find("select");

    if (objselect != null && objselect != "undefined" && objselect.length > 0) {

        var estado = "";

        if($.cookie("telcelcom_estado") != null){
            estado = $.cookie("telcelcom_estado");
        }

        var serviceUrl = "/bin/telcelcom/base/states.json";

        $.getJSON(serviceUrl, function (data) {

            if (estado == "") {

                $.each(data, function(i, val){

                    objselect.append("<option value='" + val.value + "'>" + val.text + "</option>");

                });

            } else {

                $.each(data, function(i, val){

                    if (estado == val.text) {

                        objselect.append("<option value='" + val.value + "' selected>" + val.text + "</option>");

                    } else {

                        objselect.append("<option value='" + val.value + "'>" + val.text + "</option>");

                    }


                });

            }

            objselect.trigger("chosen:updated");

        });

    }
});
//console.log("simpleselect loaded");

$(document).ready(function(){
    $(".xk-formcontrol-simpleselect").trigger("general.simpleselect");
});

$(document).on("general.simpleselect", ".xk-formcontrol-simpleselect", function(){

    var objselect = $(this).find("select");

    if (objselect != null && objselect != "undefined" && objselect.length > 0) {

        var optionsList = $(this).attr("data-options");

        if (optionsList != null && optionsList != "undefined" && optionsList != "") {

            var data = JSON.parse(optionsList);

            $.each(data, function(i, val){

                objselect.append("<option value='" + val.value + "'>" + val.text + "</option>");

            });

            objselect.trigger("chosen:updated");

        }
    }
});

$(document).ready(function(){
    $(".xk-formcontrol-checkboxradio").trigger("general.checkboxradio");
});

$(document).on("general.checkboxradio", ".xk-formcontrol-checkboxradio", function(){

    var objcheckradio = $(this).find(".xk-checkboxradio");

    if (objcheckradio != null && objcheckradio != "undefined" && objcheckradio.length > 0) {

        objcheckradio.each(function(){

            var datavalues = $(this).attr("data-values");

            if (datavalues != null && datavalues != "undefined" && datavalues != "") {

                var data = JSON.parse(datavalues);

                if (data != null && data != "undefined") {

                    $(this).addClass("customRadio");
                    $(this).val(data.value);
                    $(this).attr("data-label", data.text);
                    $(this).prettyCheckable();

                }
            }
        });

    }
});
/*
*   This code runs the captcha's plugin. If the component is in an ajax tab then this code is executed
*   from the data-trigger-events of the component.html, else, it is executed from the 'onloadCallback'
*   function that is placed in section/support/chatmovil/clientlibs/openchat.js
*/
$(document).on("formcontainer.generatescaptcha", ".xk-formcontainer #formCaptcha", function(){
    var siteKey = "6LeN3wETAAAAAK79CxVseevXwpGjgsFQwz2GBy1P";
    var recaptcha_id = grecaptcha.render($(this)[0], {
        'sitekey': siteKey,
        'theme': 'light'
    });

    //get the captcha centered
    $(this).parents(".xk-formcontainer").find("#recaptcha-id").val(recaptcha_id);
    var captchacontainer = $(this).find("div").find("div");
    captchacontainer.css("margin-left", "auto");
    captchacontainer.css("margin-right", "auto");
});

/*
*   Code for validate captcha before submitting the form. This event (formcontainer.validatecaptcha) is called from
*   the "click" of the ".validate-before-submit" button, after validating the fields of the form.
*   You can find the code in telcel-form-validator.js
*/
$(document).on("formcontainer.validatecaptcha", ".xk-formcontainer", function(){

    var captchaUrl = "/bin/telcelcom/sendemail.json";
    var objcaptcha = $(".xk-formcontainer #formCaptcha");
    var objform = $(this).find("form");
    var recaptchaResponse = $(this).find(".g-recaptcha-response");

    if(recaptchaResponse) {

        if (recaptchaResponse.val() != null && recaptchaResponse.val() != "") {
            objform.submit();
        } else {
            addCaptchaErrorMessage(objcaptcha)
        }
    
    } else {
        addCaptchaErrorMessage(objcaptcha)
    }

});

function addCaptchaErrorMessage(objcaptcha){
    if (!objcaptcha.hasClass("has-error")) {
        objcaptcha.append("<h4 class=\"text-center xk-captchaerror\"><i class=\"icon-NoEntry\"></i>  Captcha no válido ");
        objcaptcha.addClass("has-error");
    }
}
